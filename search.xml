<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Go 调度器（译）</title>
    <url>/2020/04/28/The-Go-scheduler/</url>
    <content><![CDATA[<blockquote>
<p>原文 <a href="https://morsmachine.dk/go-scheduler" target="_blank" rel="noopener">The Go scheduler</a></p>
</blockquote>
<a id="more"></a>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>Go 1.1 的一大功能是由 Dmitry Vyukov 贡献的新的调度器。新的调度器极大地提高了并行 Go 程序的性能，没什么比为此写一篇文章更好的了。</p>
<p><a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw" target="_blank" rel="noopener">最初的设计文档</a>已经涵盖了此博文的大部分内容。这是一个相当全面的文档，但是技术性很强。</p>
<p>你需要了解的有关新的调度器程序的所有信息都在设计文档中，但是本文配有图片更加方便理解。</p>
<h2 id="Go-运行时对调度程序有什么要求？"><a href="#Go-运行时对调度程序有什么要求？" class="headerlink" title="Go 运行时对调度程序有什么要求？"></a>Go 运行时对调度程序有什么要求？</h2><p>在研究新的调度器之前，我们需要了解为什么需要它。当操作系统可以为你调度线程时，为什么还要创建用户空间的调度程序？</p>
<p>POSIX 线程 API 在很大程度上是对现有 Unix 进程模型的逻辑扩展，因此，线程获得了许多与进程相同的控件。线程具有自己的信号掩码，更贴近于 CPU 资源的分配，可以放入 cgroups 中，并可以查询它们使用了哪些资源。所有这些控件增加了 Go 程序使用 goroutine 之外不需要的功能开销，并且当你程序中有 100,000 个线程时，资源占用会迅速增加。</p>
<p>另一个问题是操作系统无法基于 Go 模型做出明智的调度决策。例如， Go 的垃圾回收器要求在运行时停止所有线程，并且内存必须处于一致状态。这涉及等待运行的线程到达我们知道的一致状态。</p>
<p>当你在随机点安排了许多线程时，可能免不了等待许多线程到达一致状态。 Go 调度程序可以决定仅在已知的内存一致的点上调度。这意味着，当我们停止垃圾回收时，只需要等到正在 CPU 内核上主动运行的线程即可。</p>
<h2 id="我们的角色"><a href="#我们的角色" class="headerlink" title="我们的角色"></a>我们的角色</h2><p>通常有 3 种线程模型。一个是 N:1 ，在操作系统线程上运行多个用户空间线程。这样的优势时可以非常快速地进行上下文切换，但是不能利用多核系统的优势。另一个是 1:1 ，一个执行线程与一个操作系统线程匹配。它利用了计算机上所有的内核，但是上下文切换很慢，因为它不许通过操作系统捕获。</p>
<p>Go 尝试通过使用 M:N 调度程序融合以上两者的优势。它将任意数量的 goroutine 调度到任意数量的操作系统线程上。你可以快速进行上下文切换，并利用系统中的所有核心。这种方法的主要缺点是它增加了调度程序的复杂性。</p>
<p>为了完成调度任务，Go 调度器使用了 3 个主要实体：</p>
<p><img src="entities.jpg" alt="entities"></p>
<p>三角形代表操作系统线程。它是由操作系统管理的执行线程，其工作原理与你的标准 POSIX 线程非常相似。在运行时代码中，它被称为 M 表示机器。</p>
<p>圆形代表一个 goroutine 。它包括栈，指令指针和其他对调度 goroutine 至关重要的信息，例如可能会阻塞它的任何通道。在运行时代码中，它被称为 G 。</p>
<p>矩形代表调度的上下文。你可以将其视为调度程序的本地化版本，该调度程序在单个线程上运行 Go 代码。这是让我们从 N:1 调度程序转到 M:N 调度程序的重要部分。在运行时代码中，它被称为 P 表示处理器。这部分内容多一点。</p>
<p><img src="in-motion.jpg" alt="M P G"></p>
<p>在这里，我们看到 2 个线程（M），每个线程都有一个上下文（P），每个线程都运行一个 goroutine（G）。为了运行 goroutine ，线程必须拥有一个上下文。</p>
<p>上下文数量在启动时由 GOMAXPROCS 环境变量的值设置。或者通过运行时函数 GOMAXPROCS() 设置。通常，在程序执行期间这个值不会改变。实际上上下文数量是固定的，这意味着在任何时候只有 GOMAXPROCS 个线程在运行 Go 代码。我们可以使用它来调整 Go 进程对计算机的调用，例如在 4 核 PC 上用 4 个线程运行 Go 代码。</p>
<p>变成灰色的 goroutine 尚未运行，但已准备好进行调度。它们被排列在称为运行队列（runqueues）的列表中。每当 goroutine 执行 Go 语句时，就会将 goroutine 添加到运行队列的末尾。一旦上下文要在调度点运行 goroutine ，它便将 goroutine 从其运行队列中弹出，设置栈和指令指针，然后开始运行这个 goroutine 。</p>
<p>为了减少互斥锁争用，每个上下文都有自己的本地队列。 Go 调度器的早期版本仅具有全局运行队列并带有互斥量来保护它。线程为了等待互斥锁经常被阻塞。如果有一台 32 核心的计算机想要充分利用其性能，这就变得很糟糕。</p>
<p>只要所有上下文都有运行的 goroutine ，调度器就会稳定保持这个状态继续调度。但是，有两种情形可以改变这种状态。</p>
<h2 id="你要做什么（系统）调用？"><a href="#你要做什么（系统）调用？" class="headerlink" title="你要做什么（系统）调用？"></a>你要做什么（系统）调用？</h2><p>你现在可能想知道，为什么要有上下文？我们为什么不摆脱上下文将运行队列直接放到线程上？不是这么理解的。之所以要有上下文，是因为如果正在运行的线程处于某种原因需要阻塞，我们还可以将它们移交给其他线程。</p>
<p>举个例子，当我们需要执行系统调用时，就需要阻塞。由于线程既不能执行代码，也不能在系统调用中被阻塞，所以我们要移交上下文，以便它可以保持调度。</p>
<p><img src="syscall.jpg" alt="syscall"></p>
<p>在这里，我们看到一个线程放弃其上下文，以便另一个线程可以运行它。调度程序确保有足够的线程来运行所有上下文。上图中的 M1 可能仅为了处理此系统调用而创建，也可能来自线程缓存。正在执行系统调用的线程将保留系统调用的 goroutine ，因为它仍然在执行，尽管在操作系统中被阻塞了。</p>
<p>当系统调用返回时，线程必须尝试获取上下文才能运行返回的 goroutine 。正常的操作模式是从其他线程窃取上下文。如果偷不到，它将把 goroutine 放在全局运行队列中，将自身放在线程缓存中并进入睡眠状态。</p>
<p>全局运行队列是上下文从本地运行队列用尽时再去提取的运行队列。上下文也会定期检查全局运行队列中的 goroutine 。否则，全局运行队列上的 goroutine 可能永远无法运行。</p>
<p>这种处理系统调用方式下，即使 GOMAXPROCS 设置为 1 ， Go 程序也可以运行多个线程。运行时使用唤起系统调用的 goroutine 将线程留在后面。</p>
<h2 id="工作窃取"><a href="#工作窃取" class="headerlink" title="工作窃取"></a>工作窃取</h2><p>改变系统稳定状态的另一种情况是，上下文用尽了要调度的 goroutine 。如果上下文的运行队列上的工作量不平衡，则会发生这种情况。当系统中仍有工作要做时，这可能导致上下文最终耗尽其运行队列。为了继续运行 Go 代码，上下文可以将 goroutine 从全局运行队列中取出，但是如果其中没有 goroutine ，则必须从其他地方获取它们。</p>
<p><img src="steal.jpg" alt="steal"></p>
<p>这里其他地方就是其他上下文。当上下文耗尽时，它将尝试从另一个上下文中窃取大约一半的运行队列。这样可以确保每个上下文上始终在工作，从而确保所有线程都在最大承载量下工作。</p>
<h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><p>调度器还有许多的细节，比如 cgo 线程、 LockOSThread() 函数以及与网络轮询器集成。这些超出本文的范围，但仍然值得研究。我可能以后会写。 Go 运行时库中肯定有很多有趣的构造。</p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>translation</tag>
      </tags>
  </entry>
  <entry>
    <title>通过通信共享内存（译）</title>
    <url>/2020/04/27/Share-Memory-By-Communicating/</url>
    <content><![CDATA[<blockquote>
<p>原文 <a href="https://blog.golang.org/codelab-share" target="_blank" rel="noopener">The Go Blog - Share Memory By Communicating</a></p>
</blockquote>
<a id="more"></a>
<p>传统线程模型（例如，在编写 Java、 C++ 和 Python 程序时常用）要求程序员使用共享内存在线程之间通信。通常，共享数据结构受锁的保护，线程将争夺这些锁以访问数据。在某些情况下，通过使用线程安全的数据结构（例如 Python 的队列）可以使此操作变得更容易。</p>
<p>Go 的并发原语 —— goroutine 和 channel ，提供了一种优雅而独特的方式来构造并发软件。（这些概念有一段有趣的历史，始于 C.A.R Hoare 的<a href="http://www.usingcsp.com/" target="_blank" rel="noopener">通信顺序流程 CSP</a>。）与其明确使用锁来调解对共享数据的访问，Go 鼓励使用 channels 在 goroutine 之间传递对数据引用。这种方法确保在给定时间只有一个 goroutine 可以访问数据。该概念在 <a href="https://golang.org/doc/effective_go.html" target="_blank" rel="noopener">Effective Go</a>（Go 程序员必读）中进行了总结。</p>
<p><code>不要通过共享内存通信，而是，通过通信共享内存。</code></p>
<p>考虑一个轮询 URL 列表的程序。在传统的线程环境中，人们可能会这样构造其数据：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Resource <span class="keyword">struct</span> &#123;</span><br><span class="line">    url        <span class="keyword">string</span></span><br><span class="line">    polling    <span class="keyword">bool</span></span><br><span class="line">    lastPolled <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Resources <span class="keyword">struct</span> &#123;</span><br><span class="line">    data []*Resource</span><br><span class="line">    lock *sync.Mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，一个轮询器函数（其中的许多函数将在单独线程中运行）可能看起来像这样：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Poller</span><span class="params">(res *Resources)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 获取最近最少轮询的资源</span></span><br><span class="line">        <span class="comment">// 并将其标记为已轮询</span></span><br><span class="line">        res.lock.Lock()</span><br><span class="line">        <span class="keyword">var</span> r *Resource</span><br><span class="line">        <span class="keyword">for</span> _, v := <span class="keyword">range</span> res.data &#123;</span><br><span class="line">            <span class="keyword">if</span> v.polling &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> r == <span class="literal">nil</span> || v.lastPolled &lt; r.lastPolled &#123;</span><br><span class="line">                r = v</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</span><br><span class="line">            r.polling = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        res.lock.Unlock()</span><br><span class="line">        <span class="keyword">if</span> r == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 轮询 URL</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新资源的 polling 和 lastPolled</span></span><br><span class="line">        res.lock.Lock()</span><br><span class="line">        r.polling = <span class="literal">false</span></span><br><span class="line">        r.lastPolled = time.Nanoseconds()</span><br><span class="line">        res.lock.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此函数大约要写一页纸，并且需要更多细节才能完成。它甚至不包括 URL 轮询逻辑（它本身只有几行），也不能优雅地处理资源池耗尽的问题。</p>
<p>让我们看一下使用 Go 惯用语实现的相同功能。在这个例子中，轮询器是一个函数，可以从输入 channel 接收要轮询地资源，并在完成后将其发送给输入 channel 。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Resource <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Poller</span><span class="params">(in, out <span class="keyword">chan</span> *Resource)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> r := <span class="keyword">range</span> in &#123;</span><br><span class="line">        <span class="comment">// 轮询 URL</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将处理后地资源发送出去</span></span><br><span class="line">        out &lt;- r</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上一个示例中地微妙逻辑显然不存在，并且我们的资源数据结构不再包含用作标记的字段。实际上，剩下的就是重要的部分。这应该使你对这些简单语言功能的强大之处有所了解了。</p>
<p>上述代码有很多遗漏之处。使用 Go 的惯用写法的完整实现，移步 Codewalk <a href="https://golang.org/doc/codewalk/sharemem/" target="_blank" rel="noopener">通过通信共享内存</a></p>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>translation</tag>
      </tags>
  </entry>
  <entry>
    <title>通俗设计模式（译）</title>
    <url>/2020/04/23/%E9%80%9A%E4%BF%97%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%AF%91%EF%BC%89/</url>
    <content><![CDATA[<p><a href="https://roadmap.sh/guides/design-patterns-for-humans" target="_blank" rel="noopener">原文：Design Patterns for Humans</a></p>
<p>设计模式是对反复出现的问题的解决方案；<em>解决某些问题的指南</em>。它们不是像魔法一样的类、包或者库。这个指南说的是在某些情况下如何解决某些问题。</p>
<a id="more"></a>
<blockquote>
<p>设计模式是对反复出现的问题的解决方案。如何解决某些问题的指南。</p>
</blockquote>
<p>维基百科的描述如下：</p>
<blockquote>
<p>在软件工程领域，软件设计模式是对软件设计中给定上下文中常见问题的通用可重用解决方案。它不是可以直接转换为源代码或机器码的最终设计。它是一种描述或模板，用于在许多不同情况下解决问题。</p>
</blockquote>
<h2 id="小心"><a href="#小心" class="headerlink" title="小心"></a>小心</h2><p>开发人员（大多是初学者）犯了过分思考和强加设计模式的错误，这可能会导致灾难。经验法则是使代码库尽可能简单，当你开发中能在代码库中看到重复模式时，再执行相关设计模式。</p>
<ul>
<li>设计模式不是银弹（译注：银弹指的是万能工具）。</li>
<li>不要强行使用，不然有好果子吃。</li>
<li>请记住，设计模式是<em>解决</em>问题的方法，而不是<em>发现</em>问题的方案，不要想太多。</li>
<li>用得对时被称为救星，不然就是代码混乱。</li>
</ul>
<blockquote>
<p>虽然代码示例用 PHP-7 编写，但丝毫不影响你理解概念。</p>
</blockquote>
<h2 id="设计模式的类型"><a href="#设计模式的类型" class="headerlink" title="设计模式的类型"></a>设计模式的类型</h2><p>本指南参考 Gang of Four (Gof) 的<a href="https://en.wikipedia.org/wiki/Design_Patterns" target="_blank" rel="noopener">《设计模式》</a>一书。书中将设计模式分成 3 类：</p>
<ul>
<li><a href="#创建型模式">Creational 创建型模式</a></li>
<li><a href="#结构型模式">Structural 结构型模式</a></li>
<li><a href="#行为型模式">Behavioral 行为型模式</a></li>
</ul>
<h2 id="创建型模式"><a href="#创建型模式" class="headerlink" title="创建型模式"></a>创建型模式</h2><p>简而言之</p>
<blockquote>
<p>创建型模式关注如何实例化一个对象或一组对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>软件工程领域，创建型模式是处理对象创建机制的设计模式，尝试以适合的方式创建对象。对象创建的基本形式可能会导致设计问题或者增加设计的复杂性。创建型模式通过某种方法控制对象的创建来解决此问题。</p>
</blockquote>
<p>这里列出 6 种创建型模式：</p>
<ul>
<li><a href="#🏠-简单工厂">Simple Factory 简单工厂</a> </li>
<li><a href="#🏭-工厂方法">Factory Method 工厂方法</a> </li>
<li><a href="#🔨-抽象工厂">Abstract Factory 抽象工厂</a> </li>
<li><a href="#👷-生成器">Builder 生成器</a> </li>
<li><a href="#🐑-原型">Prototype 原型</a> </li>
<li><a href="#💍-单例">Singleton 单例</a> </li>
</ul>
<h3 id="🏠-简单工厂"><a href="#🏠-简单工厂" class="headerlink" title="🏠 简单工厂"></a>🏠 简单工厂</h3><p>现实例子</p>
<blockquote>
<p>考虑一下，你在盖房子，需要门。你可以穿上木匠衣服，带上木头、胶水、钉子和所有必要的工具，然后开始在房子里造门。或者你只要打个电话给工厂，让他们把造好的门给你，这样你就不需要了解任何造门的额外知识了。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>简单工厂只需要为使用者生成一个实例，而不需要为使用者公开任何实例化的逻辑。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>面向对象编程（OOP）中，工厂是用于创建其他对象的对象 —— 正式说法是，工厂是一种函数或方法，它从某个方法（假定为 “new”）调用并返回不同原型或类的对象。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>首先是门的接口和其实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span><span class="params">()</span>: <span class="title">float</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span><span class="params">()</span>: <span class="title">float</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $width;</span><br><span class="line">    <span class="keyword">protected</span> $height;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $width, float $height)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;width = $width;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;height = $height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;width;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们有个门工厂来制造门并返回它：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoorFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">($width, $height)</span>: <span class="title">Door</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WoodenDoor($width, $height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以这样用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 给我造一扇 100*200 尺寸的门</span></span><br><span class="line">$door = DoorFactory::makeDoor(<span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Width: '</span> . $door-&gt;getWidth();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Height: '</span> . $door-&gt;getHeight();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给我造一扇 50*100 尺寸的门</span></span><br><span class="line">$door2 = DoorFactory::makeDoor(<span class="number">50</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p><strong>啥时候用呢？</strong></p>
<p>创建对象时，不仅要复制，还要执行一些逻辑操作，这些代码放到专门的“工厂”里相比四处复制粘贴相同代码是更有意义的。</p>
<h3 id="🏭-工厂方法"><a href="#🏭-工厂方法" class="headerlink" title="🏭 工厂方法"></a>🏭 工厂方法</h3><p>现实例子</p>
<blockquote>
<p>思考一个招聘经理的例子，一个人不可能对每个职位进行面试。根据职位空缺，她必须决定面试步骤然后将其委托给其他人。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>它提供了一种将实例化逻辑委托给子类的方法。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>基于类的编程中，工厂方法模式是一种创建型模式，该模式使用工厂方法来处理创建对象的问题，而不必指定将要创建对象的确切类。这是通过调用工厂方法创建对象来完成的。该方法在接口中指定并由子类实现，或者在基类中实现，并且可以选择由派生类覆盖，而不是通过调用构造函数来覆盖。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>以我们上文的招聘经理为例。首先，我们有一个面试官接口及其实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Interviewer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Developer</span> <span class="keyword">implements</span> <span class="title">Interviewer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Asking about design patterns!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommunityExecutive</span> <span class="keyword">implements</span> <span class="title">Interviewer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">askQuestions</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Asking about community building'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在定义招聘经理（HiringManager）：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HiringManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工厂方法</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">takeInterview</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $interviewer = <span class="keyword">$this</span>-&gt;makeInterviewer();</span><br><span class="line">        $interviewer-&gt;askQuestions();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，任何子类都可扩展它并提供所需要的面试官：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DevelopmentManager</span> <span class="keyword">extends</span> <span class="title">HiringManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Developer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MarketingManager</span> <span class="keyword">extends</span> <span class="title">HiringManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">makeInterviewer</span><span class="params">()</span>: <span class="title">Interviewer</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommunityExecutive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$devManager = <span class="keyword">new</span> DevelopmentManager();</span><br><span class="line">$devManager-&gt;takeInterview(); <span class="comment">// Output: Asking about design patterns</span></span><br><span class="line"></span><br><span class="line">$marketingManager = <span class="keyword">new</span> MarketingManager();</span><br><span class="line">$marketingManager-&gt;takeInterview(); <span class="comment">// Output: Asking about community building.</span></span><br></pre></td></tr></table></figure>
<p><strong>啥时候用呢？</strong></p>
<p>当类中有一些通用处理但所需的子类在运行时动态确定时很有用。或者换句话说，用户不知道它可能需要什么确切的子类。</p>
<h3 id="🔨-抽象工厂"><a href="#🔨-抽象工厂" class="headerlink" title="🔨 抽象工厂"></a>🔨 抽象工厂</h3><p>现实例子</p>
<blockquote>
<p>对简单工厂的例子扩展一下。根据你的需求， 你可能从一家木门店买到一扇门，或者在铁门店买到一扇铁门，或者相关的店买到 PVC 门。另外，你可能需要具有不同专业技能的人来安装不同的门，例如，木门的木匠，铁门的焊接工等。如你所见，他们与门之间存在依赖性，木门需要木匠，铁门需要焊接工等。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>工厂的工厂；一个将相关或从属的工厂分组在一起，但不指定其具体类别的工厂。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>抽象工厂模式提供了一种方法来封装一组具有共同主题的单个工厂，而无需指定其具体类。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>转换上面门的例子。首先是门的接口及其实现：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'I am a wooden door'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IronDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'I am an iron door'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们为每种门配备装配专家：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DoorFittingExpert</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welder</span> <span class="keyword">implements</span> <span class="title">DoorFittingExpert</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'I can only fit iron doors'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Carpenter</span> <span class="keyword">implements</span> <span class="title">DoorFittingExpert</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'I can only fit wooden doors'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在我们有了抽象工厂，它将使我们能够制造一系列对象，即木门工厂将创建木门和木门装配专家，铁门工厂将创建铁门和铁门装配专家。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">DoorFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 木门工厂返回木匠和木门</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WoodenDoorFactory</span> <span class="keyword">implements</span> <span class="title">DoorFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WoodenDoor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Carpenter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 铁门工厂返回铁门和相关的装配专家</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IronDoorFactory</span> <span class="keyword">implements</span> <span class="title">DoorFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeDoor</span><span class="params">()</span>: <span class="title">Door</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IronDoor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeFittingExpert</span><span class="params">()</span>: <span class="title">DoorFittingExpert</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Welder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着这么用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$woodenFactory = <span class="keyword">new</span> WoodenDoorFactory();</span><br><span class="line"></span><br><span class="line">$door = $woodenFactory-&gt;makeDoor();</span><br><span class="line">$expert = $woodenFactory-&gt;makeFittingExpert();</span><br><span class="line"></span><br><span class="line">$door-&gt;getDescription();  <span class="comment">// Output: I am a wooden door</span></span><br><span class="line">$expert-&gt;getDescription(); <span class="comment">// Output: I can only fit wooden doors</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Same for Iron Factory</span></span><br><span class="line">$ironFactory = <span class="keyword">new</span> IronDoorFactory();</span><br><span class="line"></span><br><span class="line">$door = $ironFactory-&gt;makeDoor();</span><br><span class="line">$expert = $ironFactory-&gt;makeFittingExpert();</span><br><span class="line"></span><br><span class="line">$door-&gt;getDescription();  <span class="comment">// Output: I am an iron door</span></span><br><span class="line">$expert-&gt;getDescription(); <span class="comment">// Output: I can only fit iron doors</span></span><br></pre></td></tr></table></figure>
<p>如你所见，木门工厂已经封装了木匠（carpenter）和木门（wooden door），铁门工厂已经封装了铁门（iron door）和焊接工（welder）。因此，它确保我们对于每个已创建的门不会匹配到错误的装配专家。</p>
<p><strong>啥时候用呢?</strong></p>
<p>当存在相互关联的依赖关系并且涉及到非简单的创建逻辑时。</p>
<h3 id="👷-生成器"><a href="#👷-生成器" class="headerlink" title="👷 生成器"></a>👷 生成器</h3><p>现实例子</p>
<blockquote>
<p>加入你在 Hardee 店里下了一笔订单，他们会毫无疑问的将货品交给你；这是简单工厂的例子。但是某些情况下，创建逻辑可能设计更多的步骤。例如，你想要定制赛百味的订单，在汉堡的制作方式上有多种选择，例如：你想要哪种面包？想要那种调味料？那种奶酪？等等。这种情况下，生成器模式应运而生。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>允许你创建对象的不同样式，同时避免构造函数污染。当一个对象有多种风格时很有用，亦或者创建对象涉及很多步骤时。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>生成器模式是一种对象创建软件设计模式，旨在为伸缩构造器反模式找到解决方案。</p>
</blockquote>
<p>解释一下什么是伸缩构造器反模式。有时我们见过以下构造函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($size, $cheese = true, $pepperoni = true, $tomato = false, $lettuce = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，构造函数参数的数量很快会失控，过多的参数看着会很头大。另外，如果你想添加更多选项，则此参数列表还继续增长。这就是伸缩构造函数反模式。</p>
<p><strong>程序示例</strong></p>
<p>明智的做法是使用构造器模式。首先，我们要做汉堡：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Burger</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $cheese = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> $pepperoni = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> $lettuce = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">protected</span> $tomato = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BurgerBuilder $builder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;size = $builder-&gt;size;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cheese = $builder-&gt;cheese;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pepperoni = $builder-&gt;pepperoni;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lettuce = $builder-&gt;lettuce;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tomato = $builder-&gt;tomato;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着是我们的生成器：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BurgerBuilder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cheese = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> $pepperoni = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> $lettuce = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">public</span> $tomato = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(int $size)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;size = $size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addPepperoni</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pepperoni = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addLettuce</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lettuce = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addCheese</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;cheese = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addTomato</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tomato = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">()</span>: <span class="title">Burger</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Burger(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$burger = (<span class="keyword">new</span> BurgerBuilder(<span class="number">14</span>))</span><br><span class="line">                    -&gt;addPepperoni()</span><br><span class="line">                    -&gt;addLettuce()</span><br><span class="line">                    -&gt;addTomato()</span><br><span class="line">                    -&gt;build();</span><br></pre></td></tr></table></figure>
<p><strong>啥时候用呢？</strong></p>
<p>当对象的配置项过多，为了避免伸缩构造函数时，这与工厂模式的主要区别在于：当创建是一步过程时，使用工厂模式，而创建是多步过程是，将使用生成器模式。</p>
<h3 id="🐑-原型"><a href="#🐑-原型" class="headerlink" title="🐑 原型"></a>🐑 原型</h3><p>现实例子</p>
<blockquote>
<p>记得多利吗？那只克隆羊！不谈细节，关键是克隆。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>通过克隆基于现有对象创建对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>原型模式是软件开发中的一种创建型模式。当要创建的对象由原型示例确定时使用，该实例被克隆以生成新对象。</p>
</blockquote>
<p>简而言之，它使你可以创建现有对象的副本并根据需要对其进行修改，而不必麻烦从头开始创建对象并设置。</p>
<p><strong>程序实例</strong></p>
<p>在 PHP 中，用 <code>clone</code> 很容易做到：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sheep</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">    <span class="keyword">protected</span> $category;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, string $category = <span class="string">'Mountain Sheep'</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;category = $category;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setName</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setCategory</span><span class="params">(string $category)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;category = $category;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCategory</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;category;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>克隆方式如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$original = <span class="keyword">new</span> Sheep(<span class="string">'Jolly'</span>);</span><br><span class="line"><span class="keyword">echo</span> $original-&gt;getName(); <span class="comment">// Jolly</span></span><br><span class="line"><span class="keyword">echo</span> $original-&gt;getCategory(); <span class="comment">// Mountain Sheep</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Clone and modify what is required</span></span><br><span class="line">$cloned = <span class="keyword">clone</span> $original;</span><br><span class="line">$cloned-&gt;setName(<span class="string">'Dolly'</span>);</span><br><span class="line"><span class="keyword">echo</span> $cloned-&gt;getName(); <span class="comment">// Dolly</span></span><br><span class="line"><span class="keyword">echo</span> $cloned-&gt;getCategory(); <span class="comment">// Mountain sheep</span></span><br></pre></td></tr></table></figure>
<p>你还可以使用魔法方法 <code>__clone</code> 方法修改克隆行为。</p>
<p><strong>啥时候用呢？</strong></p>
<p>当需要一个与现有对象相似的对象时，或者与克隆相比创建成本很高。</p>
<h3 id="💍-单例"><a href="#💍-单例" class="headerlink" title="💍 单例"></a>💍 单例</h3><p>现实例子</p>
<blockquote>
<p>一个国家一次只能有一位总统。每次接听值班电话的都是同一位总统。总统在这里就是单例。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>确保仅创建特定类的一个对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在软件工程中，单例模式时一种将类的实例化限制为一个对象的软件设计模式。当仅需要一个对象来协调整个系统中的动作时，这很有用。</p>
</blockquote>
<p>单例模式实际上被认为是反模式，应避免过度使用它。它不一定是坏的，并且可能有一些有效的使用场景但是应谨慎使用，因为它会在你的应用程序中引入全局状态，并且在同一个位置进行更改可能会影响其他区域，这让调试变得非常困难。关于它们的另一个不好的地方是，它会使你的代码高耦合，难以模拟单例。</p>
<p><strong>程序示例</strong></p>
<p>要创建单例，请将构造函数设为私有，禁用克隆，禁用扩展，并创建一个静态变量来容纳实例。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">President</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> $instance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Hide the constructor</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">()</span>: <span class="title">President</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>::$instance) &#123;</span><br><span class="line">            <span class="keyword">self</span>::$instance = <span class="keyword">new</span> <span class="keyword">self</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Disable cloning</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Disable unserialize</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着是使用：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$president1 = President::getInstance();</span><br><span class="line">$president2 = President::getInstance();</span><br><span class="line"></span><br><span class="line">var_dump($president1 === $president2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<h2 id="结构型模式"><a href="#结构型模式" class="headerlink" title="结构型模式"></a>结构型模式</h2><p>简而言之</p>
<blockquote>
<p>结构模式主要与对象组成有关，换句话说，实体如何互相利用。或者还有另一种解释，它们有助于回答“如何构建软件组件？”。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在软件工程中，结构型模式是通过识别实体间的简单方法来简化设计的设计模式。</p>
</blockquote>
<p>这有 7 种结构模式：</p>
<ul>
<li><a href="#🔌-适配器">Adapter 适配器</a></li>
<li><a href="#🚡-桥接">Bridge 桥接</a></li>
<li><a href="#🌿-组合">Composite 组合</a></li>
<li><a href="#☕-装饰器">Decorator 装饰器</a></li>
<li><a href="#📦-外观模式">Facade 外观</a></li>
<li><a href="#🍃-享元">Flyweight 享元</a></li>
<li><a href="#🎱-代理">Proxy 代理</a></li>
</ul>
<h3 id="🔌-适配器"><a href="#🔌-适配器" class="headerlink" title="🔌 适配器"></a>🔌 适配器</h3><p>现实例子</p>
<blockquote>
<p>在你的存储卡中有一些照片，需要将它们传输到计算机上。为了传输它们，你需要某种和计算机端口兼容的适配器，以便将存储卡连接到计算机。这种情况下，读卡器就是适配器。另一个例子是著名的电源适配器，三脚插头不能连接到两脚插座，需要使用电源适配器，使其与两脚插座兼容。还有个例子是翻译员将一个人说的话翻译给另一个人。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>适配器模式是你可以将其他不兼容的对象包装到适配器中，以使其与另一个类兼容。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>软件工程领域，适配器模式是一种软件设计模式，它允许将现有类的接口用作另一个接口。它通常用于将现有类和其他类一起使用而无需修改其源代码。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>思考一个猎人狩猎狮子的游戏。首先我们有一个 <code>Lion</code> 接口，所有类型的狮子都必须实现。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Lion</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AfricanLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsianLion</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>猎人使用 <code>Lion</code> 接口的任何实现都可以进行狩猎。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hunter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hunt</span><span class="params">(Lion $lion)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $lion-&gt;roar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在假设我们必须在游戏中添加 WildDog （野狗），以便猎人对其狩猎。但是我们不能直接这样做，因为狗具有不同的接口。为了使其与我们的猎人兼容，我们必须创建一个兼容的适配器。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 把它添加到游戏。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WildDog</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bark</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关于野狗的适配器，使其与我们的游戏兼容。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WildDogAdapter</span> <span class="keyword">implements</span> <span class="title">Lion</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $dog;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(WildDog $dog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dog = $dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;dog-&gt;bark();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在可以使用 WildDogAdapter 在我们的游戏中使用 WildDog 了。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$wildDog = <span class="keyword">new</span> WildDog();</span><br><span class="line">$wildDogAdapter = <span class="keyword">new</span> WildDogAdapter($wildDog);</span><br><span class="line"></span><br><span class="line">$hunter = <span class="keyword">new</span> Hunter();</span><br><span class="line">$hunter-&gt;hunt($wildDogAdapter);</span><br></pre></td></tr></table></figure>
<h3 id="🚡-桥接"><a href="#🚡-桥接" class="headerlink" title="🚡 桥接"></a>🚡 桥接</h3><p>现实例子</p>
<blockquote>
<p>考虑你有一个包含不同页面的网站，并且允许用户更改主题。你会怎么做？为每个主题创建每个页面的多个副本，还是只创建单独的主题，根据用户的喜好加载它们？桥接模式允许你执行第二种方案。</p>
</blockquote>
<p><img src="33b7aea0-f515-11e6-983f-98823c9845ee.png" alt="Without Bridge"></p>
<p>简而言之</p>
<blockquote>
<p>桥接模式是优先于继承而不是继承。将实现细节从层次结构推送到具有单独层次结构的另一个对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>桥接模式是软件工程中使用的一种设计模式，旨在“将抽象与其实现分离，从而使两者可以独立变化”。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>转换上面 WebPage 的例子。这是 WebPage 的层次结构。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WebPage</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">About</span> <span class="keyword">implements</span> <span class="title">WebPage</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $theme;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;theme = $theme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"About page in "</span> . <span class="keyword">$this</span>-&gt;theme-&gt;getColor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Careers</span> <span class="keyword">implements</span> <span class="title">WebPage</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $theme;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Theme $theme)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;theme = $theme;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Careers page in "</span> . <span class="keyword">$this</span>-&gt;theme-&gt;getColor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以及单独主题的层次结构</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Theme</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DarkTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Dark Black'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LightTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Off white'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AquaTheme</span> <span class="keyword">implements</span> <span class="title">Theme</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getColor</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Light blue'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个层次的用法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$darkTheme = <span class="keyword">new</span> DarkTheme();</span><br><span class="line"></span><br><span class="line">$about = <span class="keyword">new</span> About($darkTheme);</span><br><span class="line">$careers = <span class="keyword">new</span> Careers($darkTheme);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $about-&gt;getContent(); <span class="comment">// "About page in Dark Black";</span></span><br><span class="line"><span class="keyword">echo</span> $careers-&gt;getContent(); <span class="comment">// "Careers page in Dark Black";</span></span><br></pre></td></tr></table></figure>
<h3 id="🌿-组合"><a href="#🌿-组合" class="headerlink" title="🌿 组合"></a>🌿 组合</h3><p>现实例子</p>
<blockquote>
<p>每一个组织由雇员组成。每个受雇者有相同功能，比如，有一份薪水、一些职责、是否向某人报告、是否有下属等等。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>组合模式使客户能够以统一的方式对待各个对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在软件工程中，组合模式是一种分区设计模式。组合模式将一组对象当成一个对象的单个实例对待。组合的目的是将对象“组成”树状结构，以表示整个部分的层次结构。实现组合模式可以使客户统一对待单个对象和复合对象。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>以我们的雇员为例。这里有不同的员工类型。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Employee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Developer</span> <span class="keyword">implements</span> <span class="title">Employee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $salary;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">    <span class="keyword">protected</span> $roles;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;roles;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Designer</span> <span class="keyword">implements</span> <span class="title">Employee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $salary;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">    <span class="keyword">protected</span> $roles;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, float $salary)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setSalary</span><span class="params">(float $salary)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;salary = $salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSalary</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRoles</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;roles;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们有一个由几种不同类型雇员组成的组织。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Organization</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $employees;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addEmployee</span><span class="params">(Employee $employee)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;employees[] = $employee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNetSalaries</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $netSalary = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;employees <span class="keyword">as</span> $employee) &#123;</span><br><span class="line">            $netSalary += $employee-&gt;getSalary();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $netSalary;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着这么用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 准备员工</span></span><br><span class="line">$john = <span class="keyword">new</span> Developer(<span class="string">'John Doe'</span>, <span class="number">12000</span>);</span><br><span class="line">$jane = <span class="keyword">new</span> Designer(<span class="string">'Jane Doe'</span>, <span class="number">15000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把他们添加到组织</span></span><br><span class="line">$organization = <span class="keyword">new</span> Organization();</span><br><span class="line">$organization-&gt;addEmployee($john);</span><br><span class="line">$organization-&gt;addEmployee($jane);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Net salaries: "</span> . $organization-&gt;getNetSalaries(); <span class="comment">// Net Salaries: 27000</span></span><br></pre></td></tr></table></figure>
<h3 id="☕-装饰器"><a href="#☕-装饰器" class="headerlink" title="☕ 装饰器"></a>☕ 装饰器</h3><p>现实例子</p>
<blockquote>
<p>假设你经营一家提供多种服务的汽车维修店。现在，你要如何计算要收取的账单？选择一项服务，并动态地向其添加服务和的价格，知道获得最终花销。这里的每种服务都是装饰器。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>装饰器模式使你可以将对象包装在装饰器类的对象中，从而在运行时动态更改对象的行为。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>面向对象编程中，装饰器模式是一种设计模式，它允许将行为动态或静态地添加到单个对象中，而不影响同一类中其他对象地行为。装饰器模式通常可用于遵守“单一职责原则”，因为它允许在具有唯一关注区域的类之间划分功能。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>以咖啡为例，首先，我们有个简单的 offee 的接口及实现。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Coffee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Simple coffee'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们希望使代码可扩展，以便在需要时通过选项配置，我们为其添加装饰器。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MilkCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $coffee;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', milk'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhipCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $coffee;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', whip'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VanillaCoffee</span> <span class="keyword">implements</span> <span class="title">Coffee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $coffee;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Coffee $coffee)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coffee = $coffee;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCost</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getCost() + <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getDescription</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;coffee-&gt;getDescription() . <span class="string">', vanilla'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在来制作咖啡。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$someCoffee = <span class="keyword">new</span> SimpleCoffee();</span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 10</span></span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee</span></span><br><span class="line"></span><br><span class="line">$someCoffee = <span class="keyword">new</span> MilkCoffee($someCoffee);</span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 12</span></span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk</span></span><br><span class="line"></span><br><span class="line">$someCoffee = <span class="keyword">new</span> WhipCoffee($someCoffee);</span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 17</span></span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk, whip</span></span><br><span class="line"></span><br><span class="line">$someCoffee = <span class="keyword">new</span> VanillaCoffee($someCoffee);</span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getCost(); <span class="comment">// 20</span></span><br><span class="line"><span class="keyword">echo</span> $someCoffee-&gt;getDescription(); <span class="comment">// Simple Coffee, milk, whip, vanilla</span></span><br></pre></td></tr></table></figure>
<h3 id="📦-外观模式"><a href="#📦-外观模式" class="headerlink" title="📦 外观模式"></a>📦 外观模式</h3><p>现实例子</p>
<blockquote>
<p>你是怎么打开计算机的？“按下电源按钮”你会这么说，那仅仅是你所知道的，那是你使用的计算机在外部提供的简单接口，在内部，它还必须要做很多事情才能实现。与复杂子系统的这种简单接口就是一个外观。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>外观模式提供了到复杂子系统的简化接口。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>外观是为大型代码（例如类库）提供简化接口的对象。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>用上面计算机的例子，这里有个计算机类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getElectricShock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Ouch!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeSound</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Beep beep!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showLoadingScreen</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Loading.."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bam</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Ready to be used!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">closeEverything</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Bup bup bup buzzzz!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sooth</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Zzzzz"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pullCurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Haaah!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是外观。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputerFacade</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $computer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Computer $computer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer = $computer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;getElectricShock();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;makeSound();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;showLoadingScreen();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;bam();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;closeEverything();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;pullCurrent();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;computer-&gt;sooth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用外观。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$computer = <span class="keyword">new</span> ComputerFacade(<span class="keyword">new</span> Computer());</span><br><span class="line">$computer-&gt;turnOn(); <span class="comment">// Ouch! Beep beep! Loading.. Ready to be used!</span></span><br><span class="line">$computer-&gt;turnOff(); <span class="comment">// Bup bup buzzz! Haah! Zzzzz</span></span><br></pre></td></tr></table></figure>
<h3 id="🍃-享元"><a href="#🍃-享元" class="headerlink" title="🍃 享元"></a>🍃 享元</h3><p>现实例子</p>
<blockquote>
<p>你有没有在摊子上买过茶？他们通常会多做几杯，把多出来的留给其他顾客，这样可以节约资源，比如燃气。 享元设计模式主要就是这里，即共享。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>它用于通过与相似对象尽可能多地共享来最大程度减少内存使用或者计算开销。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在计算机编程中，享元 是一种软件设计模式。享元是通过与其他类似对象共享尽可能多的数据来最大程度减少内存使用的对象；当简单的重复代码占用了过多内存时，这是一种大量使用对象的方法。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>利用上面茶的例子。首先要有做茶师傅。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Anything that will be cached is flyweight.</span></span><br><span class="line"><span class="comment">// Types of tea here will be flyweights.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KarakTea</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Acts as a factory and saves the tea</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeaMaker</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $availableTea = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span><span class="params">($preference)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;availableTea[$preference])) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;availableTea[$preference] = <span class="keyword">new</span> KarakTea();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;availableTea[$preference];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着是提供服务的茶店（TeaShop）</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeaShop</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $orders;</span><br><span class="line">    <span class="keyword">protected</span> $teaMaker;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(TeaMaker $teaMaker)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;teaMaker = $teaMaker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">takeOrder</span><span class="params">(string $teaType, int $table)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;orders[$table] = <span class="keyword">$this</span>-&gt;teaMaker-&gt;make($teaType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serve</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;orders <span class="keyword">as</span> $table =&gt; $tea) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Serving tea to table# "</span> . $table;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$teaMaker = <span class="keyword">new</span> TeaMaker();</span><br><span class="line">$shop = <span class="keyword">new</span> TeaShop($teaMaker);</span><br><span class="line"></span><br><span class="line">$shop-&gt;takeOrder(<span class="string">'less sugar'</span>, <span class="number">1</span>);</span><br><span class="line">$shop-&gt;takeOrder(<span class="string">'more milk'</span>, <span class="number">2</span>);</span><br><span class="line">$shop-&gt;takeOrder(<span class="string">'without sugar'</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">$shop-&gt;serve();</span><br><span class="line"><span class="comment">// Serving tea to table# 1</span></span><br><span class="line"><span class="comment">// Serving tea to table# 2</span></span><br><span class="line"><span class="comment">// Serving tea to table# 5</span></span><br></pre></td></tr></table></figure>
<h3 id="🎱-代理"><a href="#🎱-代理" class="headerlink" title="🎱 代理"></a>🎱 代理</h3><p>实际例子</p>
<blockquote>
<p>用过门禁卡通过安全门吗？开门的方法很多，比如用门禁卡或者按下绕过安全性的按钮。门的主要功能是打开，但是其顶部添加了代理以添加一些功能。让我使用下面的代码示例解释它。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>使用代理模式，一个类表示另一个类的功能。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>一般来说，代理是一个类，充当其他类的接口。代理时客户端调用的包装器或者包装对象，用来访问后台的真实对象。使用代理可以简单地转发到真实对象，还可以提供其他逻辑。在代理中，还可以提供额外的功能，例如在对实际对象地操作占用大量资源时进行缓存，或者在调用对真是对象地操作之前检查先决条件。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>用上面安全门的例子。首先，实现门的接口。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LabDoor</span> <span class="keyword">implements</span> <span class="title">Door</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Opening lab door"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Closing the lab door"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们用一个代理使门更安全</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecuredDoor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $door;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Door $door)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;door = $door;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($password)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;authenticate($password)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;door-&gt;open();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Big no! It ain't possible."</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($password)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $password === <span class="string">'$ecr@t'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;door-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$door = <span class="keyword">new</span> SecuredDoor(<span class="keyword">new</span> LabDoor());</span><br><span class="line">$door-&gt;open(<span class="string">'invalid'</span>); <span class="comment">// Big no! It ain't possible.</span></span><br><span class="line"></span><br><span class="line">$door-&gt;open(<span class="string">'$ecr@t'</span>); <span class="comment">// Opening lab door</span></span><br><span class="line">$door-&gt;close(); <span class="comment">// Closing lab door</span></span><br></pre></td></tr></table></figure>
<p>另一个例子是某种数据映射器的实现。例如，我最近使用这种模式为 MongoDB 制作了 ODM (对象数据映射器)，在其中用到了魔法方法 <code>__call()</code> 围绕 mongo 类编写了一个代理。所有的方法调用都被代理到原始 mongo 类，并且原样返回检索结果，但是 <code>find</code> 或 <code>findOne</code> 的情况下，数据映射到所需的类对象，返回的是该对象而不是 <code>Cursor</code>。</p>
<h2 id="行为型模式"><a href="#行为型模式" class="headerlink" title="行为型模式"></a>行为型模式</h2><p>简而言之</p>
<blockquote>
<p>它与对象之间的职责分配有关。它们与结构模式的不同之处在于它们不仅指定结构，而且还概述了它们之间消息传递/通信的模式。换句话说，它们是为了解决如何在软件组件中运行一种行为的问题。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>软件工程中，行为型模式是识别对象之间常见的通信模式并实现这些模式的设计模式。这样做提高了执行此通信的灵活性。</p>
</blockquote>
<p>下面列出 10 种行为型模式：</p>
<ul>
<li><a href="#🔗-责任链">Chain of Responsibility 责任链</a></li>
<li><a href="#👮-命令">Command 命令</a></li>
<li><a href="#➿-迭代器">Iterator 迭代器</a></li>
<li><a href="#👽-调解员">Mediator 调解员</a></li>
<li><a href="#💾-备忘录">Memento 备忘录</a></li>
<li><a href="#😎-观察者">Observer 观察者</a></li>
<li><a href="#🏃-访问者">Visitor 访问者</a></li>
<li><a href="#💡-策略">Strategy 策略</a></li>
<li><a href="#💢-状态">State 状态</a></li>
<li><a href="#📒-模板方法">Template Method 模板方法</a></li>
</ul>
<h3 id="🔗-责任链"><a href="#🔗-责任链" class="headerlink" title="🔗 责任链"></a>🔗 责任链</h3><p>现实例子</p>
<blockquote>
<p>如果，你的账号有三种支付方式（A，B 和 C)；每个账号都有不同的存款。 A 有 100 元， B 有 300 元 和 C 有 1000 元，支付偏好的顺序依次为 A、B、C 。你将支付以捡 210 元的商品。用上责任链，首先会检查账户 A 够不够支付，如果可以，将进行购买，然后链条断裂。如果不够，则请求会进一步到账户 B ，检查是否够支付，如果可以，将进行购买，然后链条断裂。否则请求继续直到找到何时的处理程序为止。在这里，A、B 和 C 是链上的链接，整个现象就是责任链。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>它有助于构建对象链。请求从一端进入，并不断地从一个对象移到另一个对象，直到找到合适地处理程序为止。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>面向对象设计中，责任链模式是一种设计模式，由命令对象的源和一系列处理对象组成。每个处理对象都包含定义其可以处理的命令对象类型的逻辑；其余的将传递到链中的下一个处理对象。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>用上账户的例子。首先，我们有一个基本账户，该账户具有账户和某些账户链接在一起的逻辑。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $successor;</span><br><span class="line">    <span class="keyword">protected</span> $balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setNext</span><span class="params">(Account $account)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;successor = $account;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pay</span><span class="params">(float $amountToPay)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;canPay($amountToPay)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> sprintf(<span class="string">'Paid %s using %s'</span> . PHP_EOL, $amountToPay, get_called_class());</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;successor) &#123;</span><br><span class="line">            <span class="keyword">echo</span> sprintf(<span class="string">'Cannot pay using %s. Proceeding ..'</span> . PHP_EOL, get_called_class());</span><br><span class="line">            <span class="keyword">$this</span>-&gt;successor-&gt;pay($amountToPay);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'None of the accounts have enough balance'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">canPay</span><span class="params">($amount)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;balance &gt;= $amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bank</span> <span class="keyword">extends</span> <span class="title">Account</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Paypal</span> <span class="keyword">extends</span> <span class="title">Account</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bitcoin</span> <span class="keyword">extends</span> <span class="title">Account</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $balance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $balance)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;balance = $balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，使用上面定义的链接（即银行、PayPal、比特币）准备链。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 准备这样一条链</span></span><br><span class="line"><span class="comment">//      $bank-&gt;$paypal-&gt;$bitcoin</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 最开始是银行</span></span><br><span class="line"><span class="comment">//      如果银行不够就尝试 PayPal</span></span><br><span class="line"><span class="comment">//     如果 PayPal 不够再尝试 bit coin</span></span><br><span class="line"></span><br><span class="line">$bank = <span class="keyword">new</span> Bank(<span class="number">100</span>);          <span class="comment">// 银行余额 100</span></span><br><span class="line">$paypal = <span class="keyword">new</span> Paypal(<span class="number">200</span>);      <span class="comment">// Paypal 余额为 200</span></span><br><span class="line">$bitcoin = <span class="keyword">new</span> Bitcoin(<span class="number">300</span>);    <span class="comment">// Bitcoin 余额为 300</span></span><br><span class="line"></span><br><span class="line">$bank-&gt;setNext($paypal);</span><br><span class="line">$paypal-&gt;setNext($bitcoin);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Let's try to pay using the first priority i.e. bank</span></span><br><span class="line">$bank-&gt;pay(<span class="number">259</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output will be</span></span><br><span class="line"><span class="comment">// ==============</span></span><br><span class="line"><span class="comment">// Cannot pay using bank. Proceeding ..</span></span><br><span class="line"><span class="comment">// Cannot pay using paypal. Proceeding ..:</span></span><br><span class="line"><span class="comment">// Paid 259 using Bitcoin!</span></span><br></pre></td></tr></table></figure>
<h3 id="👮-命令"><a href="#👮-命令" class="headerlink" title="👮 命令"></a>👮 命令</h3><p>现实例子</p>
<blockquote>
<p>一个通用的例子是你在餐厅点餐。你（即客户）要求服务员（即调用者）带来一些食物（即命令），服务员只需将请求转发给负责烹饪的厨师（即接收者）。另一个例子是，你（即客户）使用遥控器（即调用者）打开（即命令）电视（即接收者）。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>允许你将动作封装在对象中。该模式的关键思想是提供使客户端和接收者解耦的方法。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>面向对象编程中，命令模式是一种行为型模式，其中的对象用于封装以后执行动作或触发事件所需的所有信息。该信息包括方法名称，拥有方法的对象和方法参数的值。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>首先实现接收者的所有动作</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Receiver</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bulb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Bulb has been lit"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">turnOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Darkness!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们将接口的每一个命令都实现</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Command</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurnOn</span> <span class="keyword">implements</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $bulb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bulb $bulb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb = $bulb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOff();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TurnOff</span> <span class="keyword">implements</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $bulb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Bulb $bulb)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb = $bulb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOff();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">undo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bulb-&gt;turnOn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们的调用者，客户端将与之交互以处理任何命令。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Invoker</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteControl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">submit</span><span class="params">(Command $command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $command-&gt;execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后看看客户端中如何使用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$bulb = <span class="keyword">new</span> Bulb();</span><br><span class="line"></span><br><span class="line">$turnOn = <span class="keyword">new</span> TurnOn($bulb);</span><br><span class="line">$turnOff = <span class="keyword">new</span> TurnOff($bulb);</span><br><span class="line"></span><br><span class="line">$remote = <span class="keyword">new</span> RemoteControl();</span><br><span class="line">$remote-&gt;submit($turnOn); <span class="comment">// Bulb has been lit!</span></span><br><span class="line">$remote-&gt;submit($turnOff); <span class="comment">// Darkness!</span></span><br></pre></td></tr></table></figure>
<p>命令模式可以用来实现基于事务的系统。一旦执行命令，便会继续保持命令的历史记录。如果最终的命令被成功执行，要么一切正常否则只需要便利历史记录并继续对所有已执行的命令执行撤销即可。</p>
<h3 id="➿-迭代器"><a href="#➿-迭代器" class="headerlink" title="➿ 迭代器"></a>➿ 迭代器</h3><p>现实例子</p>
<blockquote>
<p>旧收音机的例子挺不错，用户可以从某个频道开始，然后使用下一个或者上一个按钮浏览各个频道。又或者是 MP3 播放器或者电视机也可以通过前后按钮浏览内容，换句话说它们都提供了一个接口，以循环的方式访问相应的频道，歌曲或广播电台。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>它提供了一种在不暴露底层实现的情况下访问对象元素的方法。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>面向对象编程中，迭代器模式是一种设计模式，其中迭代器用于遍历容器并访问容器的元素。迭代器模式将算法与容器解耦；在某些情况下，算法必然特定于容器，因此无法解耦。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>在 PHP 中使用 SPL （标准库） 很容易实现。转换上面电台的例子，首先设计电台类。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RadioStation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $frequency;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(float $frequency)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;frequency = $frequency;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFrequency</span><span class="params">()</span>: <span class="title">float</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;frequency;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后实现迭代器</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Countable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Iterator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StationList</span> <span class="keyword">implements</span> <span class="title">Countable</span>, <span class="title">Iterator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> RadioStation[] $stations */</span></span><br><span class="line">    <span class="keyword">protected</span> $stations = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> int $counter */</span></span><br><span class="line">    <span class="keyword">protected</span> $counter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addStation</span><span class="params">(RadioStation $station)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;stations[] = $station;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">removeStation</span><span class="params">(RadioStation $toRemove)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $toRemoveFrequency = $toRemove-&gt;getFrequency();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;stations = array_filter(<span class="keyword">$this</span>-&gt;stations, <span class="function"><span class="keyword">function</span> <span class="params">(RadioStation $station)</span> <span class="title">use</span> <span class="params">($toRemoveFrequency)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $station-&gt;getFrequency() !== $toRemoveFrequency;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">()</span>: <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count(<span class="keyword">$this</span>-&gt;stations);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span>: <span class="title">RadioStation</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;stations[<span class="keyword">$this</span>-&gt;counter];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;counter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;counter++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;counter = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;stations[<span class="keyword">$this</span>-&gt;counter]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$stationList = <span class="keyword">new</span> StationList();</span><br><span class="line"></span><br><span class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">89</span>));</span><br><span class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">101</span>));</span><br><span class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">102</span>));</span><br><span class="line">$stationList-&gt;addStation(<span class="keyword">new</span> RadioStation(<span class="number">103.2</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>($stationList <span class="keyword">as</span> $station) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $station-&gt;getFrequency() . PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$stationList-&gt;removeStation(<span class="keyword">new</span> RadioStation(<span class="number">89</span>)); <span class="comment">// Will remove station 89</span></span><br></pre></td></tr></table></figure>
<h3 id="👽-调解员"><a href="#👽-调解员" class="headerlink" title="👽 调解员"></a>👽 调解员</h3><p>现实例子</p>
<blockquote>
<p>一个一般的例子，当你与其他人通过手机通话时，对话消息是通过网络提供商发送过去的。这里网络提供商就是调解员。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>调解员模式添加了第三方对象（称作调解员）用于控制两个对象（称作同事）之间的交互。它有助于减少彼此通信的类之间的耦合。因为他们不需要了解彼此的实现。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>软件工程中，调解员模式定义了一个对象，该对象封装了一组对象的交互方式。由于该模式可以更改程序运行行为，因此该模式被视为行为模式。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>这是一个简单的聊天室（即调解员）中的用户（即同事）互相发消息的例子。</p>
<p>首先，实现调解员接口，即聊天室。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ChatRoomMediator</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">(User $user, string $message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Mediator</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatRoom</span> <span class="keyword">implements</span> <span class="title">ChatRoomMediator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showMessage</span><span class="params">(User $user, string $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $time = date(<span class="string">'M d, y H:i'</span>);</span><br><span class="line">        $sender = $user-&gt;getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> $time . <span class="string">'['</span> . $sender . <span class="string">']:'</span> . $message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是用户，即同事</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">    <span class="keyword">protected</span> $chatMediator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name, ChatRoomMediator $chatMediator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;chatMediator = $chatMediator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;chatMediator-&gt;showMessage(<span class="keyword">$this</span>, $message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$mediator = <span class="keyword">new</span> ChatRoom();</span><br><span class="line"></span><br><span class="line">$john = <span class="keyword">new</span> User(<span class="string">'John Doe'</span>, $mediator);</span><br><span class="line">$jane = <span class="keyword">new</span> User(<span class="string">'Jane Doe'</span>, $mediator);</span><br><span class="line"></span><br><span class="line">$john-&gt;send(<span class="string">'Hi there!'</span>);</span><br><span class="line">$jane-&gt;send(<span class="string">'Hey!'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output will be</span></span><br><span class="line"><span class="comment">// Feb 14, 10:58 [John]: Hi there!</span></span><br><span class="line"><span class="comment">// Feb 14, 10:58 [Jane]: Hey!</span></span><br></pre></td></tr></table></figure>
<h3 id="💾-备忘录"><a href="#💾-备忘录" class="headerlink" title="💾 备忘录"></a>💾 备忘录</h3><p>现实例子</p>
<blockquote>
<p>举一个计算器的例子，计算器（即 originator ）在这里每执行一些运算，最后的结果都会保存在内存中（即备忘录），以便你返回它，还可以用某些操作按钮（即看守者）将其恢复。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>备忘录模式是关于捕获和存储对象的当前状态的方式，以便之后可以平滑地恢复它。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>备忘录模式是一种软件设计模式，它提供了将对象恢复到其先前状态（回滚撤销）的能力。</p>
</blockquote>
<p>通常在需要提供某种撤销功能时很有用。</p>
<p><strong>程序示例</strong></p>
<p>我们以文本编辑器为例，该编辑器不时保存状态，并可以根据需要进行恢复。</p>
<p>首先是保存编辑器状态的备忘录对象。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EditorMemento</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $content)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = $content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着我们的编辑器，即 originator ，将要使用这个备忘录对象。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Editor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $content = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">type</span><span class="params">(string $words)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="keyword">$this</span>-&gt;content . <span class="string">' '</span> . $words;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EditorMemento(<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">restore</span><span class="params">(EditorMemento $memento)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = $memento-&gt;getContent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着这么用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$editor = <span class="keyword">new</span> Editor();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Type some stuff</span></span><br><span class="line">$editor-&gt;type(<span class="string">'This is the first sentence.'</span>);</span><br><span class="line">$editor-&gt;type(<span class="string">'This is second.'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save the state to restore to : This is the first sentence. This is second.</span></span><br><span class="line">$saved = $editor-&gt;save();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Type some more</span></span><br><span class="line">$editor-&gt;type(<span class="string">'And this is third.'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output: Content before Saving</span></span><br><span class="line"><span class="keyword">echo</span> $editor-&gt;getContent(); <span class="comment">// This is the first sentence. This is second. And this is third.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Restoring to last saved state</span></span><br><span class="line">$editor-&gt;restore($saved);</span><br><span class="line"></span><br><span class="line">$editor-&gt;getContent(); <span class="comment">// This is the first sentence. This is second.</span></span><br></pre></td></tr></table></figure>
<h3 id="😎-观察者"><a href="#😎-观察者" class="headerlink" title="😎 观察者"></a>😎 观察者</h3><p>现实例子</p>
<blockquote>
<p>找工作的人在职位发布网站上订阅，获得匹配的工作机会时，他们可以收到消息。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>定义对象之间的依赖关系，以便每当对象改变状态时，都会通知其所有依赖对象。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>观察者模式是一种软件设计模式，其中对象（称为主题）维护其依赖项的列表（称为观察者），并通过调用其方法来自动将状态更改通知他们。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>实现上面的例子，首先，需要发布通知给求职者。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobPost</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $title)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;title = $title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTitle</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;title;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobSeeker</span> <span class="keyword">implements</span> <span class="title">Observer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onJobPosted</span><span class="params">(JobPost $job)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// Do something with the job posting</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hi '</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">'! New job posted: '</span>. $job-&gt;getTitle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后求职者将订阅职位消息</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmploymentAgency</span> <span class="keyword">implements</span> <span class="title">Observable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $observers = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">(JobPost $jobPosting)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;observers <span class="keyword">as</span> $observer) &#123;</span><br><span class="line">            $observer-&gt;onJobPosted($jobPosting);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attach</span><span class="params">(Observer $observer)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;observers[] = $observer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addJob</span><span class="params">(JobPost $jobPosting)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;notify($jobPosting);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Create subscribers</span></span><br><span class="line">$johnDoe = <span class="keyword">new</span> JobSeeker(<span class="string">'John Doe'</span>);</span><br><span class="line">$janeDoe = <span class="keyword">new</span> JobSeeker(<span class="string">'Jane Doe'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create publisher and attach subscribers</span></span><br><span class="line">$jobPostings = <span class="keyword">new</span> EmploymentAgency();</span><br><span class="line">$jobPostings-&gt;attach($johnDoe);</span><br><span class="line">$jobPostings-&gt;attach($janeDoe);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add a new job and see if subscribers get notified</span></span><br><span class="line">$jobPostings-&gt;addJob(<span class="keyword">new</span> JobPost(<span class="string">'Software Engineer'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output</span></span><br><span class="line"><span class="comment">// Hi John Doe! New job posted: Software Engineer</span></span><br><span class="line"><span class="comment">// Hi Jane Doe! New job posted: Software Engineer</span></span><br></pre></td></tr></table></figure>
<h3 id="🏃-访问者"><a href="#🏃-访问者" class="headerlink" title="🏃 访问者"></a>🏃 访问者</h3><p>实际例子</p>
<blockquote>
<p>加入有人要去迪拜旅游，他们需要一种进入迪拜的方式（即签证）。抵达之后，他们可以独自前往迪拜的任何地方，而不需要跑腿搞许可证；只要告诉他们地名，就可以去参观。访问者模式让你做到这一点，它可以帮助你添加游览的地点，以便他们可以尽可能多访问而不需要做任何繁琐的工作。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>访问者模式使你可以给对象添加进一步的操作，而无需修改它们。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在面向对象程序设计中，访问者设计模式时一种将算法和操作对象的结构分离的方法。这种分离的实际结果是能够在不修改这些对象结构的情况下向现有对象结构添加新操作。这是遵循开闭原则（Open Closed Principle）的一种方法。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>我们来模拟一所动物园，其中有几种不同的动物，我们必须赋予它们声音。下面用访问者模式来实现它。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Visitee</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Animal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Visitor</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AnimalOperation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现这些动物</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monkey</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">shout</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Ooh oo aa aa!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $operation-&gt;visitMonkey(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lion</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roar</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Roaaar!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $operation-&gt;visitLion(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dolphin</span> <span class="keyword">implements</span> <span class="title">Animal</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">speak</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Tuut tuttu tuutt!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">accept</span><span class="params">(AnimalOperation $operation)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $operation-&gt;visitDolphin(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现访问者</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Speak</span> <span class="keyword">implements</span> <span class="title">AnimalOperation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $monkey-&gt;shout();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $lion-&gt;roar();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $dolphin-&gt;speak();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$monkey = <span class="keyword">new</span> Monkey();</span><br><span class="line">$lion = <span class="keyword">new</span> Lion();</span><br><span class="line">$dolphin = <span class="keyword">new</span> Dolphin();</span><br><span class="line"></span><br><span class="line">$speak = <span class="keyword">new</span> Speak();</span><br><span class="line"></span><br><span class="line">$monkey-&gt;accept($speak);    <span class="comment">// Ooh oo aa aa!    </span></span><br><span class="line">$lion-&gt;accept($speak);      <span class="comment">// Roaaar!</span></span><br><span class="line">$dolphin-&gt;accept($speak);   <span class="comment">// Tuut tutt tuutt!</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过对动物具有继承层次结构来简单地做到这一点，但是每当我们必须向动物添加新动作时，就必须修改动物。但是现在我们不必更改它们。例如：假设我们被要求将跳跃行为添加到动物中，我们可以简单地通过创建一个新的访问者来添加它，即：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jump</span> <span class="keyword">implements</span> <span class="title">AnimalOperation</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitMonkey</span><span class="params">(Monkey $monkey)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Jumped 20 feet high! on to the tree!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitLion</span><span class="params">(Lion $lion)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Jumped 7 feet! Back on the ground!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">visitDolphin</span><span class="params">(Dolphin $dolphin)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Walked on water a little and disappeared'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$jump = <span class="keyword">new</span> Jump();</span><br><span class="line"></span><br><span class="line">$monkey-&gt;accept($speak);   <span class="comment">// Ooh oo aa aa!</span></span><br><span class="line">$monkey-&gt;accept($jump);    <span class="comment">// Jumped 20 feet high! on to the tree!</span></span><br><span class="line"></span><br><span class="line">$lion-&gt;accept($speak);     <span class="comment">// Roaaar!</span></span><br><span class="line">$lion-&gt;accept($jump);      <span class="comment">// Jumped 7 feet! Back on the ground!</span></span><br><span class="line"></span><br><span class="line">$dolphin-&gt;accept($speak);  <span class="comment">// Tuut tutt tuutt!</span></span><br><span class="line">$dolphin-&gt;accept($jump);   <span class="comment">// Walked on water a little and disappeared</span></span><br></pre></td></tr></table></figure>
<h3 id="💡-策略"><a href="#💡-策略" class="headerlink" title="💡 策略"></a>💡 策略</h3><p>现实例子</p>
<blockquote>
<p>考虑一个排序的例子，我们实现了冒泡排序，但是随着数据的增长，冒泡排序越来越慢。为了解决这个问题，我们实现了快排。但是现在，尽管快速排序算法对大型数据集表现更好，但是对于较小数据集却很慢。为了解决这个问题，我们实现了一种策略，对于小型数据集，使用冒泡排序，而对于较大的使用快排。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>策略模式可以根据情况切换算法或策略。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>在计算机编程中，策略（strategy）模式（也称为策略（policy）模式）是一种行为型模式，可以在运行时选择算法行为。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>首先对我们测策略接口做出不同实现。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SortStrategy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BubbleSortStrategy</span> <span class="keyword">implements</span> <span class="title">SortStrategy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Sorting using bubble sort"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do sorting</span></span><br><span class="line">        <span class="keyword">return</span> $dataset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuickSortStrategy</span> <span class="keyword">implements</span> <span class="title">SortStrategy</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Sorting using quick sort"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do sorting</span></span><br><span class="line">        <span class="keyword">return</span> $dataset;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后客户可以使用任意策略</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sorter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $sorter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(SortStrategy $sorter)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sorter = $sorter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sort</span><span class="params">(array $dataset)</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sorter-&gt;sort($dataset);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$dataset = [<span class="number">1</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">$sorter = <span class="keyword">new</span> Sorter(<span class="keyword">new</span> BubbleSortStrategy());</span><br><span class="line">$sorter-&gt;sort($dataset); <span class="comment">// Output : Sorting using bubble sort</span></span><br><span class="line"></span><br><span class="line">$sorter = <span class="keyword">new</span> Sorter(<span class="keyword">new</span> QuickSortStrategy());</span><br><span class="line">$sorter-&gt;sort($dataset); <span class="comment">// Output : Sorting using quick sort</span></span><br></pre></td></tr></table></figure>
<h3 id="💢-状态"><a href="#💢-状态" class="headerlink" title="💢 状态"></a>💢 状态</h3><p>实际例子</p>
<blockquote>
<p>假设你正在使用某些绘图程序，绘画时选择画笔。现在，画笔将根据所选颜色更改其行为，即如果选择红色，它将绘制为红色，选择蓝色，则将绘制为蓝色等。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>当状态改变时，它允许你改变类的行为。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>状态模式是一种行为软件设计模式，它以面向对象的方式实现状态机。使用状态模式，通过将每个单独的状态实现为状态模式接口的派生类，并通过调用模式的超类所定义的方法来实现状态转换。状态模式可以解释为策略模式，该模式能够通过调用模式接口中定义的方法来切换当前策略。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>再用文本编辑器的例子，它使你可以改变键入文本的状态，选择斜体，将以斜体显示；如果选择粗体，将以粗体显示。</p>
<p>首先是状态接口及其实现。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">WritingState</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpperCase</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> strtoupper($words);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LowerCase</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> strtolower($words);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultText</span> <span class="keyword">implements</span> <span class="title">WritingState</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $words)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $words;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着是编辑器</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextEditor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(WritingState $state)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;state = $state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setState</span><span class="params">(WritingState $state)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;state = $state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">type</span><span class="params">(string $words)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;state-&gt;write($words);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$editor = <span class="keyword">new</span> TextEditor(<span class="keyword">new</span> DefaultText());</span><br><span class="line"></span><br><span class="line">$editor-&gt;type(<span class="string">'First line'</span>);</span><br><span class="line"></span><br><span class="line">$editor-&gt;setState(<span class="keyword">new</span> UpperCase());</span><br><span class="line"></span><br><span class="line">$editor-&gt;type(<span class="string">'Second line'</span>);</span><br><span class="line">$editor-&gt;type(<span class="string">'Third line'</span>);</span><br><span class="line"></span><br><span class="line">$editor-&gt;setState(<span class="keyword">new</span> LowerCase());</span><br><span class="line"></span><br><span class="line">$editor-&gt;type(<span class="string">'Fourth line'</span>);</span><br><span class="line">$editor-&gt;type(<span class="string">'Fifth line'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// First line</span></span><br><span class="line"><span class="comment">// SECOND LINE</span></span><br><span class="line"><span class="comment">// THIRD LINE</span></span><br><span class="line"><span class="comment">// fourth line</span></span><br><span class="line"><span class="comment">// fifth line</span></span><br></pre></td></tr></table></figure>
<h3 id="📒-模板方法"><a href="#📒-模板方法" class="headerlink" title="📒 模板方法"></a>📒 模板方法</h3><p>实际例子</p>
<blockquote>
<p>假设我们要造房子，构建步骤可能如下：</p>
<ul>
<li>打地基</li>
<li>砌墙</li>
<li>加屋顶</li>
<li>添加其他楼层</li>
</ul>
<p>这些步骤的顺序是不会改变的，即你不可以在砌墙之前盖屋顶，但是每个步骤可以修改，例如墙壁可以由木头、聚酯或石头制成。</p>
</blockquote>
<p>简而言之</p>
<blockquote>
<p>模板方法定义了如何执行某种算法的框架，但是将这些步骤的实现交给字类。</p>
</blockquote>
<p>维基说</p>
<blockquote>
<p>软件工程领域，模板方法模式是一种行为型模式，用于定义操作中算法的程序框架，从而将某些步骤推迟到子类中。</p>
</blockquote>
<p><strong>程序示例</strong></p>
<p>设想我们有一个构建工具可以帮助我们测试、整理、构建，生成报告（即覆盖率报告，lint 报告等）并且将我们的程序部署在测试服务器上。</p>
<p>首先，搭建基类，它指定构建算法的框架。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// Template method</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;lint();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;assemble();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;deploy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现接口</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AndroidBuilder</span> <span class="keyword">extends</span> <span class="title">Builder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Running android tests'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Linting the android code'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Assembling the android build'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Deploying android build to server'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IosBuilder</span> <span class="keyword">extends</span> <span class="title">Builder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Running ios tests'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">lint</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Linting the ios code'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">assemble</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Assembling the ios build'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Deploying ios build to server'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用法</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$androidBuilder = <span class="keyword">new</span> AndroidBuilder();</span><br><span class="line">$androidBuilder-&gt;build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Running android tests</span></span><br><span class="line"><span class="comment">// Linting the android code</span></span><br><span class="line"><span class="comment">// Assembling the android build</span></span><br><span class="line"><span class="comment">// Deploying android build to server</span></span><br><span class="line"></span><br><span class="line">$iosBuilder = <span class="keyword">new</span> IosBuilder();</span><br><span class="line">$iosBuilder-&gt;build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">// Running ios tests</span></span><br><span class="line"><span class="comment">// Linting the ios code</span></span><br><span class="line"><span class="comment">// Assembling the ios build</span></span><br><span class="line"><span class="comment">// Deploying ios build to server</span></span><br></pre></td></tr></table></figure>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>到此为止。我将继续对此进行改进，你可以 watch/star 这个<a href="https://github.com/kamranahmedse/developer-roadmap/" target="_blank" rel="noopener">仓库</a>。之后计划编写有关架构模式的文章，敬请期待。</p>
]]></content>
      <tags>
        <tag>translation</tag>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>使用“试错法”解决问题（译）</title>
    <url>/2020/04/20/trial-and-error/</url>
    <content><![CDATA[<blockquote>
<p>在 leetcode 上看评论时，看到一篇写得很好的文章，学习一下思维方式，顺便翻译一下。</p>
</blockquote>
<p><a href="https://leetcode.com/explore/learn/card/binary-search/146/more-practices-ii/1041/discuss/109082/Approach-the-problem-using-the-%22trial-and-error%22-algorithm" target="_blank" rel="noopener">原文：Approach the problem using the “trial and error” algorithm</a></p>
<a id="more"></a>
<p><strong>更新</strong>：如果我们把输入的数组按升序排列，这个问题实际上可以改写成找到排序矩阵中的第 K 小的元素，在 <code>(i, j)</code> 位置的矩阵元素由 <code>matrix[i][j] = nums[j] - nums[i]</code> 得出，还有 <code>k = K + n*(n+1)/2</code> 和 <code>n = nums.length</code>。这个问题就可以用我<a href="https://leetcode.com/problems/k-th-smallest-prime-fraction/discuss/115819/Summary-of-solutions-for-problems-%22reducible%22-to-LeetCode-378" target="_blank" rel="noopener">之前发帖</a>中的多种算法（优先队列 PriorityQueue， 二分搜索 BinarySearch， 之字形搜索 ZigzagSearch）来解决。</p>
<hr>
<p>通常我们会避免使用天真的试错算法（<a href="https://en.wikipedia.org/wiki/Trial_and_error" target="_blank" rel="noopener">trial and error</a>）来解决问题，因为它通常会导致糟糕的时间复杂度。但是，有些情况下，这种天真的算法可能胜过其他更复杂的解决方案，而 LeetCode 确实有一些这样的问题（在本文的末尾列出 —— 具有讽刺意味的是，他们大多数都是“难”题）。因此，我觉得应该在此描述应用此算法的一般过程。</p>
<p>试错算法的基本思想实际上非常简单，总结如下：</p>
<ul>
<li><p>第一步：构建候选解决方案。</p>
</li>
<li><p>第二步：验证它是否符合我们的要求。</p>
</li>
<li><p>第三步：如果是，则接受解决方案；否则丢弃并重复第一步。</p>
</li>
</ul>
<p>但是，为了使此算法有效工作，需要满足以下两个条件：</p>
<ul>
<li><p>条件一：我们在<code>第二步</code>中一个有效的验证算法；</p>
</li>
<li><p>条件二：由所有候选解决方案形成的搜索空间很小，或者如果它很大，我们有有效的方法来遍历（或搜索）这个空间。</p>
</li>
</ul>
<p>第一个条件确保每个验证操作都可以快速完成，而第二个条件限制了需要完成的此类操作的总数。这两个组合将保证我们有一个有效的试错算法（这意味着如果不能满足其中一个，你甚至可能不会考虑这个算法）。</p>
<hr>
<p>现在我们来看看这个问题： <code>719. Find The K-th Smallest Pair Distance</code>，看看我们怎么应用试错算法。</p>
<p><strong>一、 构建候选解决方案</strong></p>
<p>为了构建候选解决方案，我们首先需要了解所需的解决方案。这个问题描述要求我们输出第 K 个最小的对距离（pair distance），这不过是一个非负整数（因为输入数组 nums 是一个整数数组，对距离的是绝对值）。因此，我们的候选解决方案应该也是非负整数。</p>
<p><strong>二、 搜索空间由所有的候选解决方案组成</strong></p>
<p>设 <code>min</code> 和 <code>max</code> 为输入数组 nums 中的最小和最大值，并且 <code>d = max - min</code>，然后任何 nums 中的对距离必须位于 <code>[0, d]</code> 的范围。因此，我们所需的解决方案一再此范围内，这意味着搜索空间将为<code>[0, d]</code> （超出此范围的任何数字都可以立即排除，无需进一步验证）。</p>
<p><strong>三、 验证给定的候选解决方案</strong></p>
<p>这是试错算法的关键部分。因此，给定一个候选整数，我们如何确定它是否是第 K 个最小的对距离呢？</p>
<p>首先，第 K 个最小的对距离究竟意味着什么？根据定义，如果我们计算所有对距离并按照升序排序，那么第 K 个最小的对距离将是索引 <code>K-1</code> 处的距离。这实际上是解决这个问题的天真方式（但是不出所料会因为 <code>MLE</code> 而被拒绝）。</p>
<p>显然，上述定义不能用于验证，因为它需要显示计算对距离数组。幸运的是，还有另一种方法来定义第 K 个最小的对距离：给定一个整数 <code>num</code>，用 <code>count(num)</code> 表示不大于 <code>num</code> 的对距离数，则第 K 个最小对距离将是满足 <code>count(num) &gt;= K</code> 的最小整数。</p>
<p>以下是替代定义。令 <code>num_k</code> 为具有索引 <code>K-1</code> 的有序对距离数组的第 K 个对距离，如第一定义中所指定的。由于索引 <code>K-1</code> 及其之前的所有对距离都不大于 <code>num_k</code> ，因此 <code>count(num_k) &gt;= K</code> 。现在假设 <code>num</code> 是满足 <code>count(num) &gt;= K</code> 最小的整数，我们认定 <code>num</code> 必须等于 <code>num_k</code> ，如下所示：</p>
<ol>
<li>如果 <code>num_k &lt; num</code> ，因为 <code>count(num) &gt;= K</code> ，那么 <code>num</code>  将不是满足 <code>count(num) &gt;= K</code> 的最小整数，这与我们假设相矛盾。</li>
<li>如果 <code>num_k &gt; num</code> ，因为 <code>count(num) &gt;= K</code> ，根据 <code>count</code> 的函数定义，至少有 K 个对距离不大于 <code>num</code> ，这意味着至少有 K 个对距离小于 <code>num_k</code> 。这意味着 <code>num_k</code> 不能是第 K 个对距离，这再次与我们的假设矛盾。</li>
</ol>
<p>利用第 K 个最小对距离的这种替代定义，我们可以将验证过程转换为一个计数过程，那么我们究竟如何计算呢？</p>
<p><strong>四、 计算不超过给定整数的对距离数</strong></p>
<p>正如我提到的，我们不能使用对距离数组，这意味着唯一的选择是输入数组本身。如果其元素之间没有顺序，除了逐个计算和测试每个对距离之外，我们没有更好的方法。这导致 <code>O(n^2)</code> 的验证算法，其与上述朴素解决方法一样差。所以我们需要对 nums 强加一些命令，默认是排序。</p>
<p>现在假设 <code>nums</code> 按升序排序，我们如何继续计算给定的 <code>num</code> ？注意，每个对距离 <code>d_ij</code> 的特征在于一对索引 <code>(i, j)</code> ，其中 <code>i &lt; j</code> ，即 <code>d_ij &lt;= nums[j] - nums[i]</code> 。如果我们保持第一个索引 <code>i</code> 固定，那么 <code>d_ij &lt;= num</code> 等价于 <code>nums[j] &lt;= nums[i] + num</code> 。这表明至少我们可以进行二分搜索以找到最小的索引 <code>j</code> ，使得每个索引 <code>i</code> 的 <code>nums[j] &gt; nums[i] + num</code> ，然后索引 <code>i</code> 的 count 将是 <code>j-i-1</code> ，并且总的来说，我们有一个 O(nlogn) 的验证算法。</p>
<p>事实证明，如果我们使用以下属性，则可以使用经典的双指针技术在线性时间内完成计数：假设有两个起始索引 <code>i1</code> 和 <code>i2</code> ， <code>i1 &lt; i2</code> ， 让 <code>j1</code> 和 <code>j2</code> 成为最小的索引，使得 <code>nums[j1] &gt; nums[i1] + num</code> he <code>nums[j2] &gt; nums[i2] + num</code> ，那么 <code>j2 &gt;= j1</code> 必定是真的。证明是直截了当的：假设 <code>j2 &lt; j1</code> ，因为 <code>j1</code> 是满足 <code>nums[j1] &gt; nums[i1] + num</code> 的最小的索引， 我们应该有 <code>nums[j2] &lt;= nums[i1] + num</code> 。另一方面， <code>nums[j2] &gt; nums[i2] + num &gt;= nums[i1] + num</code> 。这两个不等式相互矛盾，从而证实了我们上面的结论。</p>
<p><strong>五、 如何有效地遍历（或搜索）搜索空间</strong></p>
<p>到目前为止，我们知道搜索空间，知道如何构建候选解决方案以及如何通过计数来验证它，我们仍然需要最后一块拼图：如何遍历搜索空间。</p>
<p>当然，我们可以通过尝试从 <code>0</code> 到 <code>d</code> 的每个整数来进行天真的线性遍历，并选择第一个满足 <code>count(num) &gt;= K</code>  的整数 <code>num</code>  。时间复杂度将是 <code>O(nd)</code> 。然而，假设 <code>d</code> 可以比 <code>n</code> 大得多，则改算法可能比之前提出的朴素 <code>O(n^2)</code> 解更差。</p>
<p>这里关键是观察到候选解决方案是按升序自然排序的，因此可能使用二分搜索。另一个事实是 <code>count</code> 函数的非递减属性：给定两个整数 <code>num1</code> 和 <code>num2</code> 满足 <code>num1 &lt; num2</code> ，我们有 <code>count(num1) &lt;= count(num2)</code> （我将证明过程留给你）。所以二分搜索步骤如下：</p>
<ol>
<li>设 <code>[l,r]</code> 为当前搜索空间，初始化 <code>l = 0, r = d</code> 。</li>
<li>如果 <code>l &lt; r</code> ，计算中间点 <code>m = (l + r) / 2</code> 并评估 <code>count(m)</code> 。</li>
<li>如果 <code>count(m) &lt; K</code> ，我们丢弃当前搜索空间的左半边，令 <code>l = m + 1</code>；否则 <code>count(m) &gt;= K</code> 丢弃右半边，令 <code>r=m</code> 。</li>
</ol>
<p>你可能想知道为什么即使 <code>count(m) == K</code> ，我们也丢弃搜索空间的右半部分。注意第 K 小的对距离 <code>num_k</code> 是满足 <code>count(num_k) &gt;= K</code> 的最小整数。当 <code>count(m) == K</code> 时，我们知道 <code>num_k &lt;= K</code> （但不一定是 <code>num_k == m</code>，想想吧！）所以保持右半边没有意义。</p>
<p><strong>六、 把所有东西放到一起，又称解决方案</strong></p>
<p>不要被上述分析吓到。一旦理解，最终的解决方案就更容易编写。下面是 Java 版本的试错算法，时间复杂度 <code>O(nlogd + nlogn)</code> （别忘了排序），空间复杂度 <code>O(1)</code> 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">smallestDistancePair</span><span class="params">(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    Arrays.sort(nums);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> n = nums.length;</span><br><span class="line">    <span class="keyword">int</span> l = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> r = nums[n - <span class="number">1</span>] - nums[<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> cnt = <span class="number">0</span>; l &lt; r; cnt = <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> m = l + (r - l) / <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (j &lt; n &amp;&amp; nums[j] &lt;= nums[i] + m) j++;</span><br><span class="line">            cnt += j - i - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (cnt &lt; k) &#123;</span><br><span class="line">            l = m + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r = m;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>最后是 LeetCode 上可以用试错算法解决的问题列表（欢迎添加新的例子）：</p>
<ul>
<li><p><a href="https://leetcode.com/problems/k-th-smallest-prime-fraction/description/" target="_blank" rel="noopener">786. K-th Smallest Prime Fraction</a></p>
</li>
<li><p><a href="https://leetcode.com/problems/minimize-max-distance-to-gas-station/description/" target="_blank" rel="noopener">774    Minimize Max Distance to Gas Station</a></p>
</li>
<li><p><a href="https://leetcode.com/problems/find-k-th-smallest-pair-distance/description/" target="_blank" rel="noopener">719. Find K-th Smallest Pair Distance</a></p>
</li>
<li><p><a href="https://leetcode.com/problems/kth-smallest-number-in-multiplication-table/description/" target="_blank" rel="noopener">668. Kth Smallest Number in Multiplication Table</a></p>
</li>
<li><p><a href="https://leetcode.com/problems/maximum-average-subarray-ii/description/" target="_blank" rel="noopener">644. Maximum Average Subarray II</a></p>
</li>
<li><p><a href="https://leetcode.com/problems/kth-smallest-element-in-a-sorted-matrix/description/" target="_blank" rel="noopener">378. Kth Smallest Element in a Sorted Matrix</a></p>
</li>
</ul>
<p>无论如何，这篇文章只是提醒你，如果你所有其他常见解决方案严重受到不良时间或空间性能的影响，则试错算法值得尝试。此外，我们始终建议你在完全致力于此算法前，快速评估搜索空间大小和潜在的验证算法，以及估计算法复杂度。</p>
<p>希望有帮助，编码愉快！</p>
]]></content>
      <tags>
        <tag>translation</tag>
        <tag>algorithm</tag>
      </tags>
  </entry>
  <entry>
    <title>SOLID 原则 —— 理解现实中的问题（译）</title>
    <url>/2020/04/14/SOLID-%E5%8E%9F%E5%88%99/</url>
    <content><![CDATA[<p><a href="https://medium.com/@minhajukhan/solid-principles-and-how-we-write-code-57beb1668db3" target="_blank" rel="noopener">原文：SOLID Principles — Understanding with Real-Life Problems.</a></p>
<p>毕业至今进入软件公司工作，我们多次接受有关 SOLID 原则的讲座，其中包括其定义和抽象示例。<br>今天我们将以不同的方式去理解这个原则。</p>
<p>我们遵循 SOLID 原则从头开始构造一些东西。</p>
<p>如果你是初学者，不知道什么是 SOLID ，没关系，边看边学。</p>
<a id="more"></a>
<hr>
<p>最近我被要求实现一个服务，该服务在某些事件发生时发送文本消息。</p>
<p>这里是需求：</p>
<ol>
<li>在系统发生登录事件时，从分布式队列接收一条消息。</li>
<li>根据配置验证传入的消息，评估向哪些用户发送短信消息。</li>
<li>发送短信消息给评估通过的用户。</li>
</ol>
<p>简单，那么用我最喜欢的 Go 语言实现。</p>
<h2 id="1-单一职责原则-Single-Responsibility-Principle"><a href="#1-单一职责原则-Single-Responsibility-Principle" class="headerlink" title="1. 单一职责原则 (Single Responsibility Principle)"></a>1. 单一职责原则 (Single Responsibility Principle)</h2><blockquote>
<p>一个类或模块应该有且仅有一个被修改的原因。</p>
</blockquote>
<p>考虑到需求，我将应用拆成三个组件。</p>
<ol>
<li>消费者 （consumer） —— 从分布式队列读取消息</li>
<li>规则引擎 （rule engine） —— 根据传入消息验证用户</li>
<li>通知者（notifier） —— 发送消息给通过验证的用户</li>
</ol>
<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><p>消费者应该只做一件事：从队列中读取消息，传递给规则引擎。</p>
<p>我们服务中的这个消费者是一个简单的 Kafka 消费者，它可以读取消息。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> message := <span class="keyword">range</span> claim.Messages() &#123;</span><br><span class="line">    n.Engine.ProcessEvent(message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="规则引擎"><a href="#规则引擎" class="headerlink" title="规则引擎"></a>规则引擎</h3><p>当你把某物称为引擎时，意味着它很强大，它管理这系统中困难工作的核心。此处命名理由类似。</p>
<p>当我的规则引擎启动（实例化）时，它就等待 <code>ProcessEvent()</code> 接口被调用。在我们的例子中是，消费者去调用它。</p>
<p>因此，它主要负责一件事（至少对外是这样的）。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Engine <span class="keyword">interface</span> &#123;</span><br><span class="line">    ProcessEvent(message types.NotificationMessage) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>如果你真的以 SRP（单一职责原则） 的方式考虑架构组件，那么可以创建出相同行为的接口或类。</p>
<h2 id="2-开闭原则-（Open-Closed-Principle）"><a href="#2-开闭原则-（Open-Closed-Principle）" class="headerlink" title="2. 开闭原则 （Open Closed Principle）"></a>2. 开闭原则 （Open Closed Principle）</h2><blockquote>
<p>软件实体应该为拓展而开放，为修改而封闭。</p>
</blockquote>
<p>更进一步，我们来实现通知者组件。</p>
<h3 id="通知者，天真的实现"><a href="#通知者，天真的实现" class="headerlink" title="通知者，天真的实现"></a>通知者，天真的实现</h3><p>一种天真的方式将是简单，简洁且直接的：</p>
<ol>
<li>实现一个类。</li>
<li>在需要时传递类实例。</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> SMSNotifier <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SMSNotifier)</span> <span class="title">SendSMS</span><span class="params">(msg <span class="keyword">string</span>, recipient <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>对于不熟悉 Go 的程序员，第二句表示该类拥有名为 SendSMS 的方法。</p>
</blockquote>
<h3 id="通知者，一种更好的实现"><a href="#通知者，一种更好的实现" class="headerlink" title="通知者，一种更好的实现"></a>通知者，一种更好的实现</h3><ol>
<li>定义一个接口，具体类要实现这个接口。</li>
<li>传递实现了该接口的具体类的实例。</li>
</ol>
<p>接口：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Notifier <span class="keyword">interface</span> &#123;</span><br><span class="line">    Notify(msg <span class="keyword">string</span>, recipient <span class="keyword">string</span>) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> SMSNotifier <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SMSNotifier)</span> <span class="title">Notify</span><span class="params">(msg <span class="keyword">string</span>, recipient <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>问： 为什么后一种方法更好？</li>
<li><p>答： 考虑“天真”方式的实现，如果客户还要求我们通过电子邮件发送通知，我们就要“打开” SMSNotifier 类的实现，并在其中添加代码。这不可避免地违反了开闭原则。如果我们考虑了后者的实现，我们只需要实现另一个通知者。</p>
  <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> EmailNotifier <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *EmailNotifier)</span> <span class="title">Notify</span><span class="params">(msg <span class="keyword">string</span>, recipient <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>并非总是如此，但是在大多数情况下，都是在程序中传递接口而不是具体实现，因此当新的需求到来时，你只需实现接口的另一个实例。</p>
<h2 id="3-里氏替换原则-（Liskov-Substitution-Principle）"><a href="#3-里氏替换原则-（Liskov-Substitution-Principle）" class="headerlink" title="3. 里氏替换原则 （Liskov Substitution Principle）"></a>3. 里氏替换原则 （Liskov Substitution Principle）</h2><p>抱歉。</p>
<blockquote>
<p>译注： 原文中未用到该原则。</p>
</blockquote>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>不好意思。</p>
<h2 id="4-接口隔离-（Interface-Segregation-Principle）"><a href="#4-接口隔离-（Interface-Segregation-Principle）" class="headerlink" title="4. 接口隔离 （Interface Segregation Principle）"></a>4. 接口隔离 （Interface Segregation Principle）</h2><blockquote>
<p>不应强迫客户端依赖于不使用的接口。</p>
</blockquote>
<h3 id="规则引擎-1"><a href="#规则引擎-1" class="headerlink" title="规则引擎"></a>规则引擎</h3><p>回到我们的规则引擎，并实现其接口要求我们实现的唯一方法。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProcessEvent</span><span class="params">(message types.NotificationMessage)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p>规则引擎可以处理许多不同类型的传入消息。我倾向于称它为事件，因为我们正在根据系统中发生的事件来接收消息。</p>
<p>考虑以上描述，我们可以肯定地将一条消息转换为一个事件。为此，我们可以使用“<a href="https://en.wikipedia.org/wiki/Factory_method_pattern" target="_blank" rel="noopener">工厂设计模式</a>”，稍后介绍这个。</p>
<p>继续，创建一个事件接口，</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Event <span class="keyword">interface</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>概括需求，我们必须根据传入系统的事件向用户发送文本消息。</p>
<p>因为事件已经成为我们服务中的一个实体，我们应该在定义该实体边界时，围绕我们刚学习的“单一职责原则”进行思考。</p>
<ol>
<li>事件应该知道它要发送什么消息，以封装事件的所有细节。</li>
<li>事件不应该知道如何发送消息。</li>
</ol>
<p>由于要发送消息，就必须告知事件有关通知者的信息。因此，我们将其作为参数提供。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Event <span class="keyword">interface</span> &#123;</span><br><span class="line">    Send(n Notifier) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，这是我们规则引擎的消息提取方法的小而美的实现。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *engine)</span> <span class="title">ProcessMessage</span><span class="params">(message types.NotificationMessage)</span></span> &#123;</span><br><span class="line">    event, err := e.eventFactory(message)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> event.Notify(e.notifier)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息到事件的转换就是 EventFactory 的全部内容。</p>
<p>以下是工厂中的一段代码，以供熟悉：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> messageType &#123;</span><br><span class="line">    <span class="keyword">case</span> loginSuccessfulEvent:</span><br><span class="line">       <span class="keyword">return</span> NewLoginEvent()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>接口要求如下：</p>
<ul>
<li><p>Notifier</p>
<ol>
<li>Notifier 接口只想要客户端实现 Notify() 接口。</li>
<li>除了需要的之外， SMSNotifier 不会实现 Notifier 强迫它实现的任何方法。</li>
</ol>
</li>
<li><p>Event</p>
<ol>
<li>Event 接口只要客户端实现 Send() 接口。</li>
<li>除了需要的之外， LoginEvent （由工厂返回） 不会实现 Event 强迫它实现的任何方法。</li>
</ol>
</li>
</ul>
<p>要点： 保持接口尽可能短，最多一种方法就很不错。</p>
<h2 id="5-依赖倒置原则-（Dependency-Inversion-Principle）"><a href="#5-依赖倒置原则-（Dependency-Inversion-Principle）" class="headerlink" title="5. 依赖倒置原则 （Dependency Inversion Principle）"></a>5. 依赖倒置原则 （Dependency Inversion Principle）</h2><blockquote>
<p>高级模块不应该依赖低级模块，两者都应依赖抽象。</p>
</blockquote>
<p>我们系统中主要由两个组件（由于消费者除了读取队列中的消息并扔到规则引擎之外，没做多少事情，我们可以忽略它）。</p>
<p>规则引擎相比通知者是更高级的模块。</p>
<p>假如 Notifier 不是接口，但是具体实现是 SMSNotifier。<br>这种情况下，Engine（高级模块）依赖于 SMSNotifier （低级模块），它在引导时实例化引擎时注入。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------+   +-------------+</span><br><span class="line">| Engine +---&gt; SMSNotifier |</span><br><span class="line">+--------+   +-------------+</span><br></pre></td></tr></table></figure>
<p>在实例化依赖项是将其注入 Engine 中：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">fucn NewRuleEngine(config Config, notifier SMSNotifier) *Engine</span><br></pre></td></tr></table></figure>
<p>考虑到依赖关系树，以下是此服务的生命周期中可能发生的事件：</p>
<ul>
<li>12:00 AM —— 更改在 SMSNotifier 中完成。</li>
<li>12:01 AM —— SMSNotifier 重新编译，因为有更改。</li>
<li>12:02 AM —— 因为 SMSNotifier 是 Engine 的直接依赖，它被重新编译。</li>
<li>04:20 AM —— 违反依赖倒置原则。</li>
</ul>
<h3 id="引入抽象"><a href="#引入抽象" class="headerlink" title="引入抽象"></a>引入抽象</h3><p>通过引入我们的 Notifier 接口，我们可以反转来自 Engine 的 SMSNotifier 的依赖关系。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">      +----------+</span><br><span class="line">   +--&gt; Notifier +&lt;--+</span><br><span class="line">   |  +----------+   |</span><br><span class="line">   |                 |</span><br><span class="line">+--+-----+   +-------+-----+</span><br><span class="line">| Engine |   | SMSNotifier |</span><br><span class="line">+--------+   +-------------+</span><br></pre></td></tr></table></figure>
<p>回看之前的事件：</p>
<ul>
<li>12:00 AM —— 更改在 SMSNotifier 中完成。</li>
<li>12:01 AM —— SMSNotifier 重新编译。</li>
<li>12:02 AM —— 此时 SMSNotifier 不是 Engine 的直接依赖，它不会被重新编译。</li>
<li>12:01 同上 —— 依赖倒置原则完好。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>基于组件的方法架构适合以 SOLID 原则实施。</li>
<li>组件必须与合约以及配置通信，而不是与具体的实现。</li>
<li>保持合约越小越好，这样生活更轻松。</li>
<li>不要一满意就签入代码。上述解决方案不是初稿。花时间分析你写的内容。</li>
</ol>
]]></content>
      <tags>
        <tag>translation</tag>
        <tag>design pattern</tag>
      </tags>
  </entry>
  <entry>
    <title>Rust 学习笔记 3.1</title>
    <url>/2020/04/02/Rust-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-3-1/</url>
    <content><![CDATA[<p>阅读 <a href="https://doc.rust-lang.org/book" target="_blank" rel="noopener">《 Rust 程序设计》</a>的一些笔记。</p>
<p>第 4 章 - 理解所有权（ownership）</p>
<a id="more"></a>
<p>所有权是 Rust 最独特的功能，它使 Rust 不需要垃圾回收器也能保证内存安全。因此，了解所有权在 Rust 中的工作方式非常重要。在本章中，我们将讨论所有权以及几个相关功能：借用（borrowing），切片（slice）和 Rust 如何在内存中布置数据。</p>
<h2 id="什么是所有权？"><a href="#什么是所有权？" class="headerlink" title="什么是所有权？"></a>什么是所有权？</h2><p>Rust 的主要特色是所有权（ownership），尽管这个功能易于解释，但对其他语言具有深远的影响。<br>所有程序必须在运行时管理内存。有些语言有垃圾回收功能，在程序运行时会不断寻找不再使用的内存；另有一些语言，程序员必须显式分配和释放内存。 Rust 使用了第三种方法：内存是通过所有权管理的，该系统具有一组规则，编译器会在编译时检查这些规则。所有所有权功能都不会拖慢程序的运行速度。</p>
<p>由于所有权对许多程序员来说是一个新概念，需要一些时间来适应。好消息是，你对 Rust 和所有权系统规则的了解越丰富，自然就能开发出安全高效的代码。继续吧！</p>
<p>了解所有权以后，你将具有坚实的基础，可以了解 Rust 独树一帜的功能。在本章，你将通过研究一种非常常见的数据结构示例来学习所有权：字符串。</p>
<blockquote>
<p><em>栈（Stack）和堆（Heap）</em><br>在许多编程语言中，你都不需要太关注堆和栈。但是在像 Rust 这样的系统编程语言中，决定值分配在堆上还是栈上，对语言的行为方式以及决策理由的影响很大。这里是简要说明。<br>堆和栈都是内存的一部分，你的代码可在运行时使用，但它们的结构不同。堆栈按获取值的顺序存储值，并以相反的顺序删除值。这也被称为后进先出。设想有一堆（stack）盘子：当你添加盘子，就放在上面，当你需要盘子，从顶部取走，从中间或者底部增加或移除盘子都是不行的！添加数据就叫压入栈，删除数据就叫弹出栈。<br>栈中保存的所有数据必须具有已知的固定大小。编译时大小未知或者大小可能变化的数据必须存在堆中。堆的组织性较差：为了将数据放在堆上，你需要请求一定数量的空间。操作系统在堆上找到一个足够大的空间，将其标记为正在使用，然后返回一个指针，指向这个位置。这个过程称作在堆上分配，有时也简称为“分配（allocating）”。将值压入栈不被视为分配。因为指针是已知且固定大小的，你可以将指针存到栈里，但是你想拿到实际数据，就要跟随指针寻址。<br>考虑坐在餐馆里的场景。当您进入餐馆，说明你们一共多少人，然后工作人员会找到一个座位足够的餐桌，并带你过去。如果你们一行人中有人迟到了，他们可以询问你们的座位并找到你们。<br>压栈比在堆上分配要快，因为堆上你要寻址。如果现代处理器在内存中跳动次数越少，则速度越快。继续类推，考虑一家餐厅的服务器从多个桌子上接订单。最有效的做法是将所有的订单放在一张桌子上，然后转到下一张桌子。几个桌子上来来回回地收订单就很慢。同样地，如果处理器处理的数据与其他数据（如栈上数据）接近，而不是与其他数据（如堆上的数据）相距较远，则可以更好地完成工作。在堆上分配大量空间也耗时间。<br>当你的代码调用一个函数，传递给函数的值（可能包括指向堆中数据的指针）和函数的局部变量被压入栈。函数结束后，这些值从栈中弹出。<br>跟踪代码的哪些部分正在使用偶给堆中的哪些数据，从而最大程度地减少堆中的重复数据，并清理堆上未使用的数据，以确保你不会耗尽内存，这些都是所有权所解决的问题。了解所有权后，你就不需要经常考虑堆栈了，但是知道管理堆数据是所有权存在的原因，可以帮助你理解其工作原理。</p>
</blockquote>
<h2 id="所有权规则"><a href="#所有权规则" class="headerlink" title="所有权规则"></a>所有权规则</h2><p>首先，我们看一看所有权规则。在浏览示例时请记住以下规则：</p>
<ul>
<li>Rust 中的每个值都有一个变量，称为其所有者。</li>
<li>同一时刻只会又一个所有者。</li>
<li>当所有者超出作用域，该值将被删除。</li>
</ul>
<h2 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h2><p>在第 2 章中我们已经见过 Rust 程序的例子了。既然我们已经了解了基本语法，之后的例子就不包含 <code>fn main() {</code> 代码了，继续学习，你需要自己把代码加到 main 函数中去运行。这样，我们的例子就可以更简洁，专注于实际内容而不是样板代码。</p>
<p>所有权的第一个例子，我们将研究一些变量的作用域。作用域就是一个项目在程序中的有效范围。假设我们又一个这样的变量：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="string">"hello"</span>;</span><br></pre></td></tr></table></figure>
<p>变量 s 表示字符串文字，字符串的值被硬编码到我们程序源码中。变量从声明的那一刻起就一直有效直到作用域的结尾。清单 4-1 注释说明了变量 s 的作用域。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">&#123;   <span class="comment">// s 在这不可用，它还未被定义</span></span><br><span class="line">    <span class="keyword">let</span> s = <span class="string">"hello"</span>; <span class="comment">// 从这一点开始 s 是有效的</span></span><br><span class="line">    <span class="comment">// 用 s 做一些事情</span></span><br><span class="line">&#125;   <span class="comment">// 作用域结束了，s 不再有效</span></span><br></pre></td></tr></table></figure>
<p>清单 4-1: 变量及其作用域</p>
<p>换句话说，这里有两个重要的时间点：</p>
<ul>
<li>当 s 进入作用域时，它是有效的。</li>
<li>它保持有效，直到超出作用域范围。</li>
</ul>
<p>此时，作用域和变量有效的关系与其他编程语言类似。现在，以此为基础，我们将介绍 String 类型。</p>
<h2 id="String-类型"><a href="#String-类型" class="headerlink" title="String 类型"></a><code>String</code> 类型</h2><p>为了说明所有权规则，我们需要的数据类型比第 3 章“数据类型”一节中介绍的数据类型更复杂。先前涵盖的类型都存储在栈中，当它们的作用域结束时会从栈中弹出，但是我们想查看存储在堆中的数据，并探索 Rust 如何知道何时该清理这些数据。</p>
<p>这里我们用 String 举例并专注于 String 与所有权有关的部分。这些方面也适用于其他复杂数据类型，无论是标准库提供的还是你自造的。第 8  章中我们会更深入的讨论 String 。</p>
<p>我们已经看过字符串文字，其中字符硬编码在我们的程序中。字符串文字很方便，但是并不是在所有使用文字的场景都合适。其中一个原因是，它们是不可变的。另一个是在编写代码时，并非每个字符值都可以知道：例如，我们想获得用户输入并保存该输入该怎么办？对于这种情况， Rust 具有第二种字符串类型 <code>String</code> 。这种类型分配在堆上，因此可以存储在编译时未知的大量文本。你可以使用 <code>from</code> 函数从字符串文字创建字符串，如下所示：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br></pre></td></tr></table></figure>
<p>双冒号（::）是一种运算符，这种运算符使我们可以调用特定命名空间 String 类型下的 from 函数。而不是用类似 string_from 这样的名字。我们将在第 5 章的“方法语法”部分以及第 7 章的“模块树中引用项目的路径” 中更多讨论这种语法。</p>
<p>这种字符串可以被改变：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line">s.push_str(<span class="string">", world!"</span>); <span class="comment">// push_str() 添加文字到字符串</span></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, s); <span class="comment">// 这里将打印 `hello, world!`</span></span><br></pre></td></tr></table></figure>
<p>所以，这儿有什么区别呢？为什么 String 可以被改变而文字就不行？区别在这两种类型如何处理内存。</p>
<h2 id="内存和分配"><a href="#内存和分配" class="headerlink" title="内存和分配"></a>内存和分配</h2><p>对于字符串文字，我们在编译时就知道内容，因此文本直接背影编码到最终的可执行文件中。这就是字符文字高效快速的原因。但是这些属性仅来自字符串文字的不可变性。不幸的是，对于在编译时大小未知且运行程序时大小可能改变的文本，我们无法在二进制文件中添加大量的内存。</p>
<p>对于 String 类型，为了支持可变的，可增长的文本，我们需要在堆上分配一定数量的内存，在编译时为止，用以保存内容，这意味着：</p>
<ul>
<li>必须在运行时从操作系统请求内存。</li>
<li>在 String 操作完成后，我们需要一种方法将该内存返还给操作系统。</li>
</ul>
<p>第一部分有我们完成：当我们调用 String::from 时，其实现会请求所需要的内存。这在编程语言中几乎是通用的。</p>
<p>然而，第二部分就不同了，带有垃圾回收器（GC）的语言，GC 会跟踪并清理不再使用的内存，我们不需要考虑。没有 GC ，我们就要负责确定何时不再使用内存，并调用代码明确的释放内存，就像我们要求的那样。从历史上看，要正确执行此操作一直是编程难题。如果我们忘记了，就会浪费内存。如果过早的释放，我们就得到了不可用的变量。如果我们重复释放，也是有问题的。我们需要将一个 allocate（分配） 恰好与一个 free（释放） 对应。</p>
<p>Rust 采取了另一种路径：拥有它的变量超出范围后，内存自动回收。这是清单 4-1 中作用域实例的一个版本，其中 String 替代了字符串常量：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>); <span class="comment">// 从这一点开始 s 是有效的</span></span><br><span class="line">    <span class="comment">// 用 s 做一些事情</span></span><br><span class="line">&#125;   <span class="comment">// 作用域结束了，s 不再有效</span></span><br></pre></td></tr></table></figure>
<p>我们可以很自然地将 String 需要的内存返回给操作系统：当超出 s 的作用域。当变量超出作用域， Rust 调用一个特殊的函数，这个函数叫 <code>drop</code> ，这是 String 的作者可以在其中防止代码以返回内存的地方。 Rust 在右大括号出自动调用 drop 函数。</p>
<blockquote>
<p>注意：在 C++ 中，这种在项目生命周期结束时分配资源的模式有时称为“资源获取即初始化”（ Resource Acquisition Is Initialization, RAII），如果你使用过 RAII 模式，Rust 中的 drop 也就不会陌生。</p>
</blockquote>
<p>这种模式对 Rust 代码的编写方式有深远影响。现在看起来似乎很简单，但是在更复杂的情况下，当我们想让多个变量使用我们在堆上分配的数据时，代码的行为可能出乎意料。现在我们探讨其中的一些情况。</p>
<h3 id="变量与数据交互的方式：移动（Move）"><a href="#变量与数据交互的方式：移动（Move）" class="headerlink" title="变量与数据交互的方式：移动（Move）"></a>变量与数据交互的方式：移动（Move）</h3><p>多个变量可以在 Rust 中以不同方式与同一个数据交互。看清单 4-2 中的例子：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y = x;</span><br></pre></td></tr></table></figure>
<p>清单 4-2 ：将变量 x 赋值给 y</p>
<p>我们可能会猜它做了什么：“将 5 值绑定到 x ；然后在 x 中复制值并将其绑定到 y 。” 我们现在有两个变量 x 和 y ， 它们都等于 5 。这确实是正在发生的事情，因为整数是已知且固定大小的简单值，然后将这两个 5 值压入栈。</p>
<p>现在看一看 String 版本:</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1;</span><br></pre></td></tr></table></figure>
<p>这和前一段代码很相似，因此我们可以假设它的工作方式是相同的：那就是，第二行会得到 s1 的拷贝并绑定到 s2 。但是实际不是这样的。</p>
<p>看图 4-1 ,看看 String 幕后发生了什么。一个 String 分成三个部分，画在了左边：一个指向保存字符串内容的内存指针，一个长度，还有一个容量。这组数据保存在栈里。右边是保存在堆内存上的内容。</p>
<p><img src="trpl04-01.svg" alt="4-1"></p>
<p>图 4-1：内存中绑定到 s1 的值 “hello” 的字符串表示形式。</p>
<p>该长度（len）是 String 当前正在使用的内存量（以字节为单位）。此处容量（capacity）是 String 从操作系统接受的内存总量（以字节为单位）。长度和容量之间的差别很重要，但这种情况下并不重要，暂时可以忽略容量。</p>
<p>当我们把 s1 赋值给 s2 ， String 数据被复制，这意味着我们复制了栈上的指针，长度和容量。我们不会复制指针指向的堆上的数据，内存中的数据如图 4-2 所示。</p>
<p><img src="trpl04-02.svg" alt="4-2"></p>
<p>图 4-2：变量 <code>s2</code> 在内存中表示形式，该变量具有 <code>s1</code> 的指针，长度和容量的副本。</p>
<p>如果 Rust 复制了堆数据的话，就会像图 4-3 ，但不是这样的。如果堆上的数据很大， Rust 复制堆上的数据，就会使 <code>s2 = s1</code> 运行代价很高。</p>
<p><img src="trpl04-03.svg" alt="4-3"></p>
<p>图 4-3：如果 Rust 也复制堆数据，则 s2 = s1 可能这么做</p>
<p>先前我们说过，当变量超出作用域， Rust 自动调用 drop 函数并清理该变量的堆内存。但是图 4-2 显示了两个指向相同位置的数据指针。这是一个问题：当 s2 和 s1 都超出范围时，它们都会尝试释放相同一块的内存。这被称为 <em>双重释放错误</em> ,是我们前面提到的内存安全错误之一。释放内存两次可能导致内存损坏，从而可能导致安全漏洞。</p>
<p>为了确保内存安全，在 Rust 中，在这种情况下会发生的事情有很多细节。Rust 不会尝试复制分配的内存，而是认为 s1 不再有效，因此，当 s1 超出范围时， Rust 不需要释放任何内容。检查下创建 s2 之后尝试使用 s1 会发生什么；它不起作用：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1;</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"&#123;&#125;, world"</span>, s1);</span><br></pre></td></tr></table></figure>
<p>你会得到下面的错误，因为 Rust 阻止你使用无效的引用：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">error[E0382]: use of moved value: `s1`</span><br><span class="line"> --&gt; src/main.rs:5:28</span><br><span class="line">  |</span><br><span class="line">3 |     <span class="built_in">let</span> s2 = s1;</span><br><span class="line">  |         -- value moved here</span><br><span class="line">4 |</span><br><span class="line">5 |     println!(<span class="string">"&#123;&#125;, world!"</span>, s1);</span><br><span class="line">  |                            ^^ value used here after move</span><br><span class="line">  |</span><br><span class="line">  = note: move occurs because `s1` has <span class="built_in">type</span> `std::string::String`, <span class="built_in">which</span> does</span><br><span class="line">  not implement the `Copy` trait</span><br></pre></td></tr></table></figure>
<p>如果你在使用其他语言时听说过浅拷贝（shallow copy）和深拷贝（deep copy）这两个术语，那么复制指针、长度和容量而不复制数据的概念听起来就像是浅拷贝。但是由于 Rust 还使第一个变量无效，这不是浅拷贝，因此称为移动（move）。在此示例中，我们说 s1 已移入 s2。因此实际发生的情况如图 4-4 所示。</p>
<p><img src="trpl04-04.svg" alt="4-4"></p>
<p>图 4-4：s1 无效后再内存中的表示形式</p>
<p>那解决了我们的问题！只有 s2 有效，当它超出范围时，仅凭它就可以释放内存，完成了。</p>
<p>此外，这暗示了一种设计选择： Rust 永远不会自动创建数据的“深层”副本。因此，就运行效率而言，任何自动复制都被认为是廉价的。</p>
<h2 id="变量与数据交互的方式：克隆（Clone）"><a href="#变量与数据交互的方式：克隆（Clone）" class="headerlink" title="变量与数据交互的方式：克隆（Clone）"></a>变量与数据交互的方式：克隆（Clone）</h2><p>如果我们确实要深拷贝 String 的堆数据，而不仅仅是栈数据，则可以使用一种称为 <code>clone</code> 的通用方法。我们将在第 5 章讨论方法语法，但是由于方法是许多编程语言中的常用功能，因此你以前可能见过它们。</p>
<p>这是 <code>clone</code> 方法的实际例子：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"><span class="keyword">let</span> s2 = s1.clone();</span><br><span class="line"></span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"s1 = &#123;&#125;, s2 = &#123;&#125;"</span>, s1, s2);</span><br></pre></td></tr></table></figure>
<p>这代码可以运行，并且显示完成了图 4-3 的行为，它确实复制了堆数据。</p>
<p>当你看到克隆调用时，你因该知道正在执行的代码可能运行开销很大。这种视觉指示器表明发生了一些不同的情况。</p>
<h2 id="仅栈数据：拷贝（Copy）"><a href="#仅栈数据：拷贝（Copy）" class="headerlink" title="仅栈数据：拷贝（Copy）"></a>仅栈数据：拷贝（Copy）</h2><p>还有个问题没有讨论。这段使用了整数的代码是有效的，部分代码如清单 4-2 所示：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">let</span> y = x;</span><br><span class="line"><span class="built_in">println!</span>(<span class="string">"x = &#123;&#125;, y = &#123;&#125;"</span>, x, y);</span><br></pre></td></tr></table></figure>
<p>这段代码似乎与我们刚学到的矛盾：我们没有调用 clone 方法，但是 x 仍然可用且不是移入 y 。</p>
<p>原因是诸如在编译时已知大小的整数之类的类型，完全存储在栈中，因此可以快速产生实际值的副本。这意味着在创建变量 y 之后，我们不需要阻止 x 生效。换句话说，这里的深拷贝和浅拷贝没有区别，因此调用克隆与通常的浅拷贝没有不同，我们可以将其省略。</p>
<p>Rust 具有一个特殊的注释，称为 <code>Copy</code> 特征，我们可以将其放在存储在栈的类型上（第 10 章进一步讨论）。如果类型具有 <code>Copy</code> 特征，则分配后仍然可以使用旧的变量值。但如果该类型或其实现部分实现了 <code>Drop</code> 特性， Rust 将不允许我们使用 <code>Copy</code> 特征对该类型进行注释。如果在值超出范围时对该类型需要特殊处理，向该类型添加 <code>Copy</code> 注释，则会出现编译错误。要了解如何将 <code>Copy</code> 特征添加到你的类型中，参考附录 C 的“可导出特征”。</p>
<p>那么什么类型被拷贝？你可以查看给定的文档，一般规则是，任何一组简单的标量值都可以拷贝，而不需要分配或是某种形式的资源都不是拷贝。一下是一些 Copy 类型：</p>
<ul>
<li>所有整数类型，例如 u32 。</li>
<li>布尔类型， <code>bool</code>。</li>
<li>所有浮点类型，例如 f64 。</li>
<li>字符类型， <code>char</code>。</li>
<li>元组，如果它们仅包含复制类型，例如， (i32, i32) 。而 (i32, String) 就不是。</li>
</ul>
<h2 id="所有权和职能"><a href="#所有权和职能" class="headerlink" title="所有权和职能"></a>所有权和职能</h2><p>用于将值传递给函数的语义类似于用于将值分配给变量的语义。就像赋值一样，将变量传递给函数将移动或拷贝。清单 4-3 给出了一个示例，启动带有注释，显示变量进入和退出范围的位置。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);  <span class="comment">// s 进入作用域</span></span><br><span class="line"></span><br><span class="line">    takes_ownership(s);             <span class="comment">// s 的值移入函数</span></span><br><span class="line">                                    <span class="comment">// ... s 从这开始无效了</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;                      <span class="comment">// x 进入作用域</span></span><br><span class="line"></span><br><span class="line">    makes_copy(x);                  <span class="comment">// x 移入函数中</span></span><br><span class="line">                                    <span class="comment">// 但是 i32 是拷贝类型，所以 x 仍然有效</span></span><br><span class="line">                                    <span class="comment">// 继续使用 x 变量。</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// 这里x 超出作用域，接着是 s 。但是因为 s 的值被移动了，没什么特别情况。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">takes_ownership</span></span>(some_string: <span class="built_in">String</span>) &#123; <span class="comment">// some_string 进入作用域</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, some_string);</span><br><span class="line">&#125; <span class="comment">// 这里， some_string 超出作用域，调用 drop ，释放内存。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">makes_copy</span></span>(some_integer: <span class="built_in">i32</span>) &#123; <span class="comment">// some_integer 进入作用域</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, some_integer);</span><br><span class="line">&#125; <span class="comment">// 这里，some_integer 超出作用域，没什么特别的。</span></span><br></pre></td></tr></table></figure>
<p>清单 4-3：函数的所有权和作用域注释</p>
<p>如果我们在调用 <code>takes_ownership</code> 之后使用 s , Rust 将抛出编译一场，这些静态检查防止我们犯错误。尝试将代码添加到使用 s 和 x 的 main 函数中，以查看可以在哪里使用它们以及所有权规则在哪里阻止你这么做。</p>
<h2 id="返回值和作用域"><a href="#返回值和作用域" class="headerlink" title="返回值和作用域"></a>返回值和作用域</h2><p>返回值也可以转移所有权。清单 4-4 带有与清单 4-3 类似的注释。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = gives_ownership();         <span class="comment">// gives_ownership 将其返回值移入 s</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s2 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);     <span class="comment">// s2 进入作用域</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> s3 = takes_and_gives_back(s2);  <span class="comment">// s2 被移入 takes_and_gives_back， 该</span></span><br><span class="line">                                        <span class="comment">//  函数也将返回值移入 s3</span></span><br><span class="line">&#125; <span class="comment">// 这里, s3 超出作用域而被 drop. s2 超出作用域但是由于被移动，所以无事发生. </span></span><br><span class="line">  <span class="comment">//  s1 超出作用域被 drop 。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">gives_ownership</span></span>() -&gt; <span class="built_in">String</span> &#123;             <span class="comment">// gives_ownership 将返回值移动给</span></span><br><span class="line">                                             <span class="comment">// 调用方。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> some_string = <span class="built_in">String</span>::from(<span class="string">"hello"</span>); <span class="comment">// some_string 进入作用域</span></span><br><span class="line"></span><br><span class="line">    some_string                              <span class="comment">// some_string 被返回并移动到函数</span></span><br><span class="line">                                             <span class="comment">// 调用方。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// takes_and_gives_back will take a String and return one</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">takes_and_gives_back</span></span>(a_string: <span class="built_in">String</span>) -&gt; <span class="built_in">String</span> &#123; <span class="comment">// a_string 进入作用域</span></span><br><span class="line"></span><br><span class="line">    a_string  <span class="comment">// a_string 别返回且移动到函数调用方</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清单 4-4：返回值转移所有权</p>
<p>变量的所有权每次都遵循相同的模式：将值分配给它移动的另一个变量。当包含堆上数据的变量超出范围，只有该数据移至另一个变量，才 drop 这个值。</p>
<p>拥有所有权，然后返回每个函数的所有权，有点乏味。如果我们要让函数使用值但不取得所有权怎么办？令人烦恼的是，除了我们可能想返回的函数主体的任何数据之外，如果我们想再次使用它们，还需要将其传递回去。</p>
<p>可以使用元组返回多个值，如清单 4-5 。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s1 = <span class="built_in">String</span>::from(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> (s2, len) = calculate_length(s1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The length of '&#123;&#125;' is &#123;&#125;."</span>, s2, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">calculate_length</span></span>(s: <span class="built_in">String</span>) -&gt; (<span class="built_in">String</span>, <span class="built_in">usize</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> length = s.len(); <span class="comment">// len() returns the length of a String</span></span><br><span class="line"></span><br><span class="line">    (s, length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>清单 4-5：返回参数所有权</p>
<p>但对于一个应该是通用的概念来说，这有太多的仪式和大量的工作。幸运的是， Rust 有此概念的功能，称为参考（references） 。</p>
]]></content>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Rust 学习笔记 2</title>
    <url>/2020/03/30/Rust-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-2/</url>
    <content><![CDATA[<p>阅读 <a href="https://doc.rust-lang.org/book" target="_blank" rel="noopener">《 Rust 程序设计》</a>的一些笔记。</p>
<p>第 3 章 - 通用编程概念</p>
<a id="more"></a>
<h2 id="变量和可变性"><a href="#变量和可变性" class="headerlink" title="变量和可变性"></a>变量和可变性</h2><p>Rust 中的变量默认为不可变的。</p>
<p>只要变量定义未加上 <code>mut</code> ，它在程序中就不用担心它被改变。</p>
<p>对于大数据结构，加上 <code>mut</code> ，可以直接操作实例，比复制并返回新实例肯定要快。</p>
<p>但是对于小数据结构，创建新的实例或者更多函数式编程风格更容易被理解，所以略低的性能在提高程序可读性时是值得的。</p>
<h3 id="变量（variables）和常量（constants）的区别"><a href="#变量（variables）和常量（constants）的区别" class="headerlink" title="变量（variables）和常量（constants）的区别"></a>变量（variables）和常量（constants）的区别</h3><p>常量是绑定到名称且不允许更改的值。但是常量和不可变量还是有一些区别。</p>
<p>首先，不允许将 <code>mut</code> 和常量一起使用，默认情况下，常量不仅不可变，它们始终不可变。</p>
<p>使用 <code>const</code> 关键字定义常量而不是 <code>let</code> 关键字，并且必须注释值得类型。</p>
<p>常量可以在任何范围（scope）中声明，包括全局范围。</p>
<p>最后一个不同，常量只能设置未常量表达式，不能设置未函数调用结果或者只能在运行时计算的任何其他值。</p>
<p>例如：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_POINTS: <span class="built_in">u32</span> = <span class="number">100_000</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在数字文本中插入下划线，可以提高可读性。</p>
</blockquote>
<h3 id="隐藏（Shadowing）"><a href="#隐藏（Shadowing）" class="headerlink" title="隐藏（Shadowing）"></a>隐藏（Shadowing）</h3><p>我们可以通过使用相同变量的名称并重复使用 <code>let</code> 关键字来隐藏变量。</p>
<p>隐藏和将变量标记为 <code>mut</code> 不同，因为一旦忘记使用 <code>let</code> 重新分配变量，就会在编译时报错。通过使用 <code>let</code> ，我们可以对一个值执行一些转换，但是在转换完成后，变量是不可变的。</p>
<p><code>mut</code> 和 shadowing 的另一个不同是，使用 <code>let</code> 关键字实际是创建了一个新的变量，但是可以重用名称。</p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="标量类型（scalar-types）"><a href="#标量类型（scalar-types）" class="headerlink" title="标量类型（scalar types）"></a>标量类型（scalar types）</h3><p>标量类型表示单个值， Rust 中有 4 种主要标量类型：整数、浮点数、布尔值 和 字符。</p>
<h4 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h4><p>整数类型有：<br><code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code>, <code>i128</code>, <code>isize</code>,<br><code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>u128</code>, <code>usize</code>。</p>
<p>Rust 的默认整数类型是 <code>i32</code> ，即使在 64 位系统上，这种类型通常也是最快的。</p>
<p>使用 <code>isize</code> 或 <code>usize</code> 的主要用在对某种集合进行索引的场景。</p>
<blockquote>
<p>整数溢出，在 debug 模式编译的程序遇到整数溢出问题会 panic， release 模式编译则不 panic ，而是进行两个补码换行，例如 <code>u8</code> 类型保存 256 会变成 0， 保存 257 会变成 1 ，以此类推。依赖整数移除的 wrapping 行为被视为错误，如果要显式 wrap ，则可以使用标准库类型 <code>Wrapping</code> 。</p>
</blockquote>
<h4 id="浮点类型"><a href="#浮点类型" class="headerlink" title="浮点类型"></a>浮点类型</h4><p>浮点类型有： <code>f32</code>, <code>f64</code>。</p>
<p>默认类型为 <code>f64</code> ，因为在现代 CPU 上，它的速度与 <code>f32</code> 大致相同，但精度更高。</p>
<h4 id="数字运算"><a href="#数字运算" class="headerlink" title="数字运算"></a>数字运算</h4><p>Rust 支持四则运算和求余运算。</p>
<p>附录 B 中列出了更多运算符。</p>
<h4 id="布尔类型"><a href="#布尔类型" class="headerlink" title="布尔类型"></a>布尔类型</h4><p>布尔值只要用于条件表达式，比如 <code>if</code> 表达式。</p>
<h4 id="字符类型"><a href="#字符类型" class="headerlink" title="字符类型"></a>字符类型</h4><p><code>char</code> 类型是 Rust 中最基本的字母类型，使用单引号指定。（相对的字符串文字，使用双引号。）</p>
<p>Rust 中 <code>char</code> 类型，大小为 4 字节，代表 Unicode 标量。Unicode 标量值范围从 <code>U+0000</code> 至 <code>U+D7FF</code> 和 <code>U+E000</code> 至 <code>U+10FFFF</code> 。但是 “字符” 并不是 Unicode 中真正的概念，因此你对 “字符” 的直觉可能与 Rust 中不一致。我们在第 8 章中讨论。</p>
<h3 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h3><p>复合类型可以组合多个值到一个类型中， Rust 有两个基本复合类型： 元组（tuples）和数组（arrays）</p>
<h4 id="元组类型"><a href="#元组类型" class="headerlink" title="元组类型"></a>元组类型</h4><p>元组是一种将多种类型的值组合为一个复合类型的一般方法。元组的长度是固定的：声明之后它们的长度就无法增长或缩小。</p>
<p>我们在括号内编写逗号分隔的值列表来创建元组。元组中每个位置都有一个类型，并且元组中不通知的类型不必相同，此例中，我们添加了可选的类型注释：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> tup: (<span class="built_in">i32</span>, <span class="built_in">f64</span>, <span class="built_in">u8</span>) = (<span class="number">1</span>, <span class="number">1.1</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>元组可以通过和 <code>let</code> 的一种模式解构（destructuring）。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> tup = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.1</span>);</span><br><span class="line">    <span class="keyword">let</span> (_, y, _) = tup;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of y is &#123;&#125;"</span>, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>除了通过模式匹配进行解构，我们还是可以通过点号（.）加索引的方式访问元组元素。例如：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = (<span class="number">1</span>, <span class="number">2.1</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"&#123;&#125; &#123;&#125; &#123;&#125;"</span>, x.<span class="number">0</span>, x.<span class="number">1</span>, x.<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h4><p>数组中的元素类型必须相同， Rust 中的数组具有固定长度。</p>
<p>放入数组的值被写成用方括号括起来的都好分隔的列表。</p>
<p>当你想把数据分配在栈上而不是堆上时，数组很有用。（第 4 章中讨论堆栈）</p>
<p>数组不如向量类型（vector type）灵活。虽然，向量是标准库提供的类似集合类型，允许大小缩放。如果不确定使用数组还是向量，则可能就该使用向量。第 8 章细谈向量。</p>
<p>一个使用数组而不是向量的例子：程序中需要知道每个月份的名称，这样的程序不太可能增加或删除月份，这样你可以使用数组，因为你知道它始终包含 12 个元素。</p>
<p>初始化给数组赋值的方式：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="comment">// [类型; 长度] </span></span><br><span class="line"><span class="keyword">let</span> a: [<span class="built_in">i32</span>; <span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// [初始值; 长度]</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">3</span>; <span class="number">5</span>]; </span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure>
<h5 id="访问数组元素"><a href="#访问数组元素" class="headerlink" title="访问数组元素"></a>访问数组元素</h5><p>数组是栈上分配的单一内存块。你可以通过索引访问数组元素，如下：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">let</span> first = a[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> second = a[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="无效的数组元素访问"><a href="#无效的数组元素访问" class="headerlink" title="无效的数组元素访问"></a>无效的数组元素访问</h5><p>如果你尝试访问超出数组末尾的数组元素会如何？下面的程序可以通过编译，但是运行会报 panic ：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> element = a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第 9 章讨论错误处理。</p>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>Rust 使用 snake case 作为函数和变量名的常规样式，即所有字母小写并用下划线分隔单词。</p>
<p>Rust 中函数可以写在源码中的任何位置，不用关注声明顺序。</p>
<h3 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h3><p>定义函数时可以拥有形参（parameters），这些特殊变量是函数签名的一部分。<br>传递给函数的具体值称为实参（arguments）。在日常交谈中，人们倾向于将形参和实参交替用于函数定义中的变量和调用函数时传递的具体值。</p>
<p>函数签名中，必须声明每个参数的类型。这是 Rust 的刻意设计：函数定义中指明类型就意味着编译器不需要在其他地方推断你的意图。</p>
<p>如果函数需要多个参数，定义时用逗号分隔。</p>
<h3 id="函数体包含语句（Statements）和表达式（Expressions）"><a href="#函数体包含语句（Statements）和表达式（Expressions）" class="headerlink" title="函数体包含语句（Statements）和表达式（Expressions）"></a>函数体包含语句（Statements）和表达式（Expressions）</h3><p>函数体由一系列可选的表达式结尾的语句组成。至此，我们仅介绍了没有结尾表达式的函数，但是你已经将表达式视为语句的一部分了。<br>因为 Rust 时基于表达式的语言，所以这里要理解它们重要的区别。其他语言中没有类似的区别，下面我们看看语句和表达式的差异如何影响函数体。</p>
<p>我们实际上已经使用过语句和表达式。语句是执行某些操作但没有返回值的指令。表达式的计算结果是结果值。举个例子。</p>
<p>创建一个变量并使用 <code>let</code> 关键字为其赋值就是一条语句。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> y = <span class="number">6</span>; <span class="comment">// 这是一条语句</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数定义也是语句；前面整个实例就是一个语句。</p>
<p>语句没有返回值。所以，你无法用 <code>let</code> 语句为另一个变量赋值。下面的例子是错误的：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = (<span class="keyword">let</span> y = <span class="number">6</span>); <span class="comment">// 这是错误的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>let y = 6</code> 语句不会有返回值，因此 <code>x</code> 不会绑定任何内容。不想其他语言，例如 C 和 Ruby ，赋值会在赋值的位置返回，其他语言中你可以写 <code>x = y = 6</code> 来为 x 和 y 共同赋值。</p>
<p>表达式求值，将出现在你之后编写的大部分 Rust 代码中。<br>表达式可以是语句的一部分：下个例子中，6 就是语句 <code>let y = 6</code> 中的表达式。调用函数是一个表达式。调用宏一个表达式。创建新作用域的代码块也是一个表达式，例如：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> y = &#123;</span><br><span class="line">        <span class="keyword">let</span> x = <span class="number">3</span>;</span><br><span class="line">        x + <span class="number">1</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of y is: &#123;&#125;"</span>, y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意 <code>x + 1</code> 这一行没有分号。表达式就不包含结尾的分号。如果你在结尾加了分号，就把它变成了语句，即不会有返回值。<br>在接下来探索返回值和表达式时，请记住这一点。</p>
<h3 id="函数返回值"><a href="#函数返回值" class="headerlink" title="函数返回值"></a>函数返回值</h3><p>函数可以把值返回给代码调用方。我们没有命名返回值，但是要在 <code>-&gt;</code> 后声明它们的类型。 Rust 中，函数的返回值与函数体中的最终表达式的值同义。你可以用 <code>return</code> 关键字提前返回，但是大多数函数都隐式返回最后一个表达式。这是一个带返回值的函数的实例：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">five</span></span>() -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = five();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of x is :&#123;&#125;"</span>, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 <code>five</code> 函数在 Rust 中是合法的。</p>
<p>另一个例子：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> x = plus_one(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of x is: &#123;&#125;"</span>, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是个错误的函数</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">plus_one</span></span>(x: <span class="built_in">i32</span>) -&gt; <span class="built_in">i32</span> &#123;</span><br><span class="line">    x + <span class="number">1</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译错误如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"> --&gt; src/main.rs:7:24</span><br><span class="line">  |</span><br><span class="line">7 | fn plus_one(x: i32) -&gt; i32 &#123;</span><br><span class="line">  |    --------            ^^^ expected `i32`, found `()`</span><br><span class="line">  |    |</span><br><span class="line">  |    implicitly returns `()` as its body has no tail or `<span class="built_in">return</span>` expression</span><br><span class="line">8 |     x + 1; </span><br><span class="line">  |          - <span class="built_in">help</span>: consider removing this semicolon</span><br></pre></td></tr></table></figure>
<p>主要报错信息 “类型不匹配” 揭示了这段代码的核心问题。由于 <code>x + 1;</code> 是语句不会有返回值，则末尾表达式就变成了 <code>()</code>， 一个空的元组。什么都不返回，这与函数的定义相矛盾导致错误。并且在此输出中， Rust 提供了一条建议，可能纠正这个错误：删除分号，可解决错误。</p>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>Rust 中的注释必须以双斜线开头，对于超过一行的注释，你需要在每一行开头都加上 <code>//</code> 。</p>
<p>Rust 拥有另一种注释 —— 文档注释，我们在第 14 章关于如何发布 crate 到 crate.io 中讲述。 </p>
<h2 id="控制流"><a href="#控制流" class="headerlink" title="控制流"></a>控制流</h2><p>在大多数编程语言中，根据条件是否为真来决定是否运行某块代码，而在条件为真时来决定重复运行一些代码是基本的构建块。让你控制 Rust 代码执行流程的最常见构造是 <code>if</code> 表达式和循环。</p>
<h3 id="if-表达式"><a href="#if-表达式" class="headerlink" title="if 表达式"></a><code>if</code> 表达式</h3><p>与 <code>if</code> 表达式中的条件相关联的代码块有时称为手臂（arms），就像之前猜数字游戏中讨论的 <code>match</code> 表达式中的 arm 一样。</p>
<p>可选的，我们可以使用 <code>else</code> 表达式给程序在条件为假时执行一个替代的代码块。</p>
<p>值得注意的时，条件必须是 <code>bool</code> 类型。不像 Ruby 或者 JavaScript， Rust 不会自动将非布尔类型转换为布尔类型。</p>
<h4 id="使用-else-if-处理多条件"><a href="#使用-else-if-处理多条件" class="headerlink" title="使用 else if 处理多条件"></a>使用 <code>else if</code> 处理多条件</h4><p>过多的 <code>else if</code> 表达式使代码混乱，因此如果超过一个，就要考虑重构你的代码。第六章描述 Rust 中强大的分支选择结构，称为 <code>match</code> 。</p>
<h4 id="let-语句中使用-if"><a href="#let-语句中使用-if" class="headerlink" title="let 语句中使用 if"></a><code>let</code> 语句中使用 <code>if</code></h4><p>例子：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">mail</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> condition = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="keyword">if</span> condition &#123;</span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="number">6</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of number is: &#123;&#125;"</span>, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变量 <code>number</code> 将会被 <code>if</code> 表达式的输出值绑定。 </p>
<p>请记住，代码块的计算结果为它们中的最后一个表达式，数字本身也是表达式。所以在这个例子中，整个 <code>if</code> 表达式的值取决于要执行的代码块。这意味着来自 <code>if</code> 的每个分支的值必须使同一类型。如果类型不匹配，就会报错：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> condition = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> number = <span class="keyword">if</span> condition &#123; </span><br><span class="line">        <span class="number">5</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="string">"six"</span> <span class="comment">// 类型不匹配</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The value of number is: &#123;&#125;"</span>, number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时就会报错。如果仅在运行时确定数字类型， Rust 将无法做到这一点；如果编译器必须跟踪任何变量的多个假设类型，那么编译器会过于复杂且对代码缺少保证。</p>
<h3 id="循环重复"><a href="#循环重复" class="headerlink" title="循环重复"></a>循环重复</h3><p>Rust 中有三种循环： <code>loop</code>, <code>while</code> 和 <code>for</code>。</p>
<h4 id="用-loop-重复代码"><a href="#用-loop-重复代码" class="headerlink" title="用 loop 重复代码"></a>用 <code>loop</code> 重复代码</h4><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"again!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行这段代码会重复输出 <code>again!</code> 直到通过 ctrl+c 中断程序。</p>
<p>使用 <code>break</code> 关键字可以跳出 loop 循环。</p>
<h4 id="loop-循环中返回值"><a href="#loop-循环中返回值" class="headerlink" title="loop 循环中返回值"></a>loop 循环中返回值</h4><p><code>loop</code> 的用途之一是重试你知道可能会失败的操作，例如检查线程是否完成了工作。然而，你也许需要把结果传递给其余代码，要做到这一点，你可以在 <code>break</code> 表达式之后协商你要返回的值。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="keyword">loop</span> &#123;</span><br><span class="line">        counter += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> counter == <span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">break</span> counter * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"The result is: &#123;&#125;"</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="while-条件循环"><a href="#while-条件循环" class="headerlink" title="while 条件循环"></a><code>while</code> 条件循环</h4><figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> number = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> number != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;!"</span>, number);</span><br><span class="line"></span><br><span class="line">        number -= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"LIFTOFF!!!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>while</code> 循环，可以消除许多 <code>loop</code> <code>if</code> <code>else</code> <code>break</code> 结构产生的嵌套，使代码更清晰。</p>
<h4 id="用-for-循环遍历一个集合"><a href="#用-for-循环遍历一个集合" class="headerlink" title="用 for 循环遍历一个集合"></a>用 <code>for</code> 循环遍历一个集合</h4><p>用 <code>while</code> 循环遍历集合是这样的：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> index &lt; <span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"the value is: &#123;&#125;"</span>, a[index]);</span><br><span class="line"></span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>for</code> 循环，就更加简洁：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> a = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">40</span>, <span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> a.iter() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"the value is: &#123;&#125;"</span>, element);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>while</code> 循环遍历集合时，如果 <code>a</code> 集合少了元素，而 <code>while</code> 循环的条件没有修改，代码会 <code>panic</code> ，当你使用 for 循环时，不需要担心这个问题。</p>
<p><code>for</code> 循环的安全性和简洁性使其称为 Rust 中最常用的循环构造。即使在你想要多次运行某段代码的情况下，多数 Rust 程序员也选择用 <code>for</code> 循环。为了做到这一点要使用 <code>Range</code> ，它是标准库提供的一种类型，产生一个数字序列。</p>
<p>这是一个使用 <code>for</code> 循环的倒计数程序，它还包含我们未提到过得方法，用于反转范围（range）：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">for</span> number <span class="keyword">in</span> (<span class="number">1</span>..<span class="number">4</span>).rev() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">"&#123;&#125;!"</span>, number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"LIFTOFF!!!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码更好些，对吧？</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本章你学到了：变量、标量以及符合类型，函数，注释，<code>if</code>表达式，还有循环。通过以下习题巩固本章讨论的概念：</p>
<ul>
<li>转换温度华氏度和摄氏度。</li>
<li>产生第 n 个 Fibonacci 数。</li>
<li>利用歌曲中的重复内容，将歌词打印到圣诞节颂歌“圣诞节的十二天”中。</li>
</ul>
<p>当你准备好继续前进时，我们将讨论 Rust 中其他编程语言不常见的概念：所有权（ownership）。</p>
]]></content>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Rust 学习笔记 1</title>
    <url>/2020/03/30/Rust-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-1/</url>
    <content><![CDATA[<p>阅读 <a href="https://doc.rust-lang.org/book" target="_blank" rel="noopener">《 Rust 程序设计》</a>的一些笔记。</p>
<p>第 2 章 - 从一个猜数字游戏了解语言特性</p>
<a id="more"></a>
<blockquote>
<p>参考<a href="https://doc.rust-lang.org/book/ch02-00-guessing-game-tutorial.html" target="_blank" rel="noopener">原文</a></p>
</blockquote>
<h2 id="保存值到变量"><a href="#保存值到变量" class="headerlink" title="保存值到变量"></a>保存值到变量</h2><p>Rust 中，变量默认是不可变的（immutable）。</p>
<p><code>String::new</code> 函数返回的 <code>String.String</code> 是标准库提供的字符串类型，它是可增长的（grawable），UTF-8 编码的文本。</p>
<p><code>::new</code> 中的 <code>::</code> 语法表明 <code>new</code> 是 <code>String</code> 类型的关联函数（associated function），关联函数都是再类型上实现的，而不是再某一类型的特定实例上实现。</p>
<p><code>&amp;</code> 表明这个参数是一个引用（reference），即直接访问某块内存中的数据而不需要拷贝。引用是一项复杂的功能， Rust 的主要优势之一是使用引用的安全性和便捷性（第 4 章会有详细介绍）。而目前需要知道的是，像变量一样，引用也默认是不可变的，因此 <code>read_line()</code> 函数中需要传递 <code>&amp;mut guess</code> 参数，而不是 <code>&amp;guess</code> 。</p>
<h2 id="使用结果（Result）类型处理潜在的故障"><a href="#使用结果（Result）类型处理潜在的故障" class="headerlink" title="使用结果（Result）类型处理潜在的故障"></a>使用结果（Result）类型处理潜在的故障</h2><p><code>read_line</code> 接收用户输入，返回一个值，本例中它是 <code>io::Result</code>， Rust 在其标准库中有大量名为 <code>Result</code> 的类型：通用 <code>Result</code> 和特定版本的子模块，例如 <code>io::Result</code> 。</p>
<p><code>Result</code> 类型是枚举类型（enumerations），通常被成为 <code>enums</code>，枚举类型是一种有固定值集合的类型，这些值成为枚举变量，第 6 章会详细介绍枚举类型。</p>
<p><code>Result</code> 类型的目的是对错误处理（error-handling）信息进行编码。<code>io::Result</code> 的实例拥有 <code>expect</code> 方法。如果 <code>io::Result</code> 实例是一个 <code>Err</code> 值， <code>expect</code> 将导致程序崩溃，并显示你传递给 <code>expect</code> 的参数。如果 <code>read_line</code> 方法返回一个 <code>Err</code> ，可能是来自底层操作系统的错误导致的。如果 <code>io::Result</code> 实例是 <code>Ok</code> 值，<code>expect</code> 将获得 <code>Ok</code> 持有的返回值，并只将该值返回给你，以便你使用它。这种情况下，该值是用户输入到标准输入的字节数。</p>
<p>如果你不调用 <code>expect</code> ，程序可以通过编译，但是你会获得警告：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">warning: unused `std::result::Result` that must be used</span><br><span class="line"> --&gt; src/main.rs:8:5</span><br><span class="line">  |</span><br><span class="line">8 | /     io::stdin()</span><br><span class="line">9 | |         .read_line(&amp;mut guess);</span><br><span class="line">  | |_______________________________^</span><br><span class="line">  |</span><br><span class="line">  = note: `<span class="comment">#[warn(unused_must_use)]` on by default</span></span><br><span class="line">  = note: this `Result` may be an `Err` variant, <span class="built_in">which</span> should be handled</span><br></pre></td></tr></table></figure>
<p>抑制警告的正确做法是编写实际的错误处理，但是你仅仅希望问题发生时程序崩溃，你可以使用 <code>expect</code> 。第 9 章可以学到如何从错误中恢复。</p>
<h2 id="使用-println-占位符"><a href="#使用-println-占位符" class="headerlink" title="使用 println! 占位符"></a>使用 <code>println!</code> 占位符</h2><p>闭合的大括号 <code>{}</code> 就是一个占位符：<code>{}</code> 像螃蟹的小钳子抓住一个值。</p>
<h2 id="产生秘密数字"><a href="#产生秘密数字" class="headerlink" title="产生秘密数字"></a>产生秘密数字</h2><p>我们使用 1 至 100 之间的随机数，虽然 Rust 当前的标准库中没有随机数函数，但是 Rust 团队提供了 <code>rand</code> 板条箱（crate）。</p>
<h2 id="使用板条箱获得更多功能"><a href="#使用板条箱获得更多功能" class="headerlink" title="使用板条箱获得更多功能"></a>使用板条箱获得更多功能</h2><p>一个 crate 是 Rust 源码文件的集合。我们正在构建的项目是一个可执行的二进制板条箱（binary crate）。<code>rand</code> 是一个库板条箱（library crate）包含可以被其他程序使用的代码。</p>
<p>在 <code>Cargo.toml</code> 文件中，依赖项部分添加一行：</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rand</span> = <span class="string">"0.5.5"</span></span><br></pre></td></tr></table></figure>
<p>我们指定 <code>rand</code> 板条箱的语义版本说明符（semantic version specifier）为 <code>0.5.5</code> ， Cargo 理解语义版本（有时称为 <code>SemVer</code>），这是一种书写版本号的标准。<code>0.5.5</code> 是 <code>^0.5.5</code> 的简写，它表示“具有兼容 0.5.5 版本公共 API 的任意版本”。</p>
<p>执行 <code>cargo build</code> 获取依赖。</p>
<h2 id="使用-Cargo-lock-文件确保可复制的构建"><a href="#使用-Cargo-lock-文件确保可复制的构建" class="headerlink" title="使用 Cargo.lock 文件确保可复制的构建"></a>使用 Cargo.lock 文件确保可复制的构建</h2><p>Cargo 具有一种机制，可以确保你或其他任何人每次构建代码时都可以重建相同的工件：除非另有说明，否则 Cargo 将仅使用你指定的依赖项版本。</p>
<h2 id="更新-Crate-获取新版本"><a href="#更新-Crate-获取新版本" class="headerlink" title="更新 Crate 获取新版本"></a>更新 Crate 获取新版本</h2><p><code>update</code> 命令将忽略 Cargo.lock 文件并找到所有最新版本依赖，并写入 Cargo.lock 文件。</p>
<p>默认情况下，Cargo 将仅查找介于 <code>0.5.5</code> 和 <code>0.6.0</code> 的版本。</p>
<p>通过修改 Cargo.toml 来指定 rand 0.6.x 版本，再次执行 <code>cargo build</code>， Cargo 将更新可用的注册表，并根据你指定的新版本重新评估你的 <code>rand</code> 需求。</p>
<h2 id="产生随机数"><a href="#产生随机数" class="headerlink" title="产生随机数"></a>产生随机数</h2><p>首先添加 <code>use</code> 行： <code>use rand::Rng</code> 。 <code>Rng</code> 特征（trait）定义了产生随机数的实现方法，并且该特性必须要在我们可以使用这些方法的范围内。第 10 章详细介绍 trait 。</p>
<p>接着添加两行， <code>rand::thread_rng</code> 函数将为我们提供将要使用的特定随机数生成器：它有当前线程执行并且操作系统提供随机种子。</p>
<h2 id="查看使用说明文档"><a href="#查看使用说明文档" class="headerlink" title="查看使用说明文档"></a>查看使用说明文档</h2><p>你不可能一开始就知道要使用哪些 traits 或者要调用哪些函数，crate 的使用说明在其文档中，使用 <code>cargo doc --open</code> 可以构建所有本地依赖的文档。</p>
<p>使用说明文档生成在 <code>./target/doc/guessing_game/index.html</code> 目录中，我们起一个简单的 web 服务方便查看文档（需要 python3 支持，你也可以直接打开目标文件）。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">python3 -m http.server -d ./target/doc/</span><br></pre></td></tr></table></figure>
<p>浏览器打开 <a href="http://localhost:8000/guessing_game" target="_blank" rel="noopener">http://localhost:8000/guessing_game</a> 。</p>
<h2 id="比较-Guess-和-Secret-Number"><a href="#比较-Guess-和-Secret-Number" class="headerlink" title="比较 Guess 和 Secret Number"></a>比较 Guess 和 Secret Number</h2><p>我们用到了 match 表达式，一个 <code>match</code> 表达式由手臂（arms）构成，手臂由模式（pattern）和执行代码构成，如果 <code>match</code> 表达式开头的值符合该模式，就会执行这段代码。<code>match</code> 结构和模式是 Rust 中的强大功能，可以当你表达代码可能遇到的各种情况，并确保对所有情况进行处理。这些功能分别在第 6 章和第 18 章中详细介绍。</p>
<p>Rust 具有强大的静态类型系统。然而，它也有类型推断（type inference）。当我们写下 <code>let mut guesss = String::new()</code> ， Rust 就能够推断出 <code>guess</code> 应该是 <code>String</code> 类型。</p>
<p>由于 <code>guess</code> 和 <code>secret_number</code> 类型不匹配，cmp 方法调用失败，则我们需要类型转换。我们再创建一个变量 <code>guess</code> ，虽然它和之前的变量重名，但是 Rust 允许我们用一个新的值来掩盖（shadow）以前的 <code>guess</code> 值，次功能通常用于值类型转换的情况。掩盖使我们可以重用变量名称，而不是强迫我们创建两个唯一变量，例如 <code>guess_str</code> 和 <code>guess</code> 。（第 3 章详细描述 shadowing ）</p>
<p><code>trim</code> 方法用于消除（eliminates）按下回车键时被读取到的 <code>\n</code> 字符。</p>
<p><code>parse</code> 方法作用于字符串可以将字符串解析为数字。但是这个方法可以解析出多种类型，我们要明确指定 <code>guess</code> 的类型：<code>let guess: u32</code> 。</p>
<p>例程中的 <code>u32</code> 注解，影响到与 <code>secret_number</code> 比较时，将其也推断成 <code>u32</code> 类型。</p>
]]></content>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Rust 学习笔记 0</title>
    <url>/2020/03/30/Rust-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-0/</url>
    <content><![CDATA[<p>阅读 <a href="https://doc.rust-lang.org/book" target="_blank" rel="noopener">《 Rust 程序设计》</a>的一些笔记。</p>
<p>第 1 章 - 第一个 Rust 项目</p>
<a id="more"></a>
<h2 id="安装-Rust"><a href="#安装-Rust" class="headerlink" title="安装 Rust"></a>安装 Rust</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl https://sh.rustup.rs -sSf | sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$HOME</span>/.cargo/bin:<span class="variable">$PATH</span>"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>default 模式安装，会修改 ~/.profile 文件，需要手动修改你的环境变量。</p>
</blockquote>
<h2 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 由于数字开头的 crate 名称不合法，所以使用 --name 指定 crate 名称</span></span><br><span class="line">cargo new 002_helloworld --name hello_cargo</span><br><span class="line"><span class="built_in">cd</span> 002_hello_cargo</span><br></pre></td></tr></table></figure>
<h2 id="编译运行"><a href="#编译运行" class="headerlink" title="编译运行"></a>编译运行</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cargo build</span><br><span class="line">./target/debug/hello_cargo</span><br></pre></td></tr></table></figure>
<p>也可以</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cargo run</span><br></pre></td></tr></table></figure>
<blockquote>
<p>代码没做改动的情况下，不会重新编译，而是直接运行可执行文件。</p>
</blockquote>
<h2 id="代码检查"><a href="#代码检查" class="headerlink" title="代码检查"></a>代码检查</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cargo check</span><br></pre></td></tr></table></figure>
<blockquote>
<p>因为不需要生成执行文件，所以 <code>check</code> 非常快。</p>
</blockquote>
<h2 id="构建发布"><a href="#构建发布" class="headerlink" title="构建发布"></a>构建发布</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cargo build --release</span><br></pre></td></tr></table></figure>
<blockquote>
<p>加上 <code>--release</code> 会优化编译（编译速度较慢），可执行文件生成至 <code>target/release</code> 目录。</p>
</blockquote>
<blockquote>
<p>如果你需要 benchmark ，那么就要指定 <code>--release</code> 。</p>
</blockquote>
<blockquote>
<p>复杂项目的构建使用 <code>cargo</code> 将能体现它的价值。</p>
</blockquote>
]]></content>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>Go 谚语</title>
    <url>/2020/01/10/Go-Proverbs/</url>
    <content><![CDATA[<blockquote>
<p>Go 语言之父 Rob Pike 总结的几条 Go 谚语。</p>
</blockquote>
<p> <a href="https://www.youtube.com/watch?v=PAAkCSZUG1c" target="_blank" rel="noopener">来源： Go Proverbs - Rob Pike - Gopherfest - November 18, 2015</a></p>
 <a id="more"></a>
<ol>
<li>Don’t communicate by sharing memory, share memory by communicating.</li>
<li>Concurrency is not parallism.</li>
<li>Channels orchestrate; mutexes serialize.</li>
<li>The bigger the interface, the weaker the abstraction.</li>
<li>Make the zero value useful. (e.g. bytes.Buffer or sync.Mutex)</li>
<li>interface{} says nothing.</li>
<li>Gofmt’s style is no one’s favorite, yet gofmt is everyone’s favorite.</li>
<li>A little copying is better than a little dependency.</li>
<li>Syscall must always be guarded with build tags.</li>
<li>Cgo must always be guarded with build tags.</li>
<li>Cgo is not Go.</li>
<li>With the unsafe package, there are no guarantees.</li>
<li>Clear is better than clever.</li>
<li>Reflection is never clear.</li>
<li>Errors are values.</li>
<li>Don’t just check errors, handle them gracefully.</li>
<li>Design the architecture, name the components, document the details.</li>
<li>Documentation is for users.</li>
<li>Don’t panic.</li>
</ol>
<h2 id="解读"><a href="#解读" class="headerlink" title="解读"></a>解读</h2><ol>
<li>不要通过共享内存来通信，而应该通过通信的方式共享内存。<blockquote>
<p>Go 官方博客的<a href="https://blog.golang.org/share-memory-by-communicating" target="_blank" rel="noopener">解读</a></p>
</blockquote>
</li>
<li>并发不是并行。</li>
<li>Channels 编排；互斥量的串行化。<blockquote>
<p>使用 chan 串行处理互斥量。</p>
</blockquote>
</li>
<li>接口越大，抽象能力越弱。<blockquote>
<p>好的接口定义一般不超过两种方法.</p>
</blockquote>
</li>
<li>让零值有用（比如 bytes.Buffer 或 sync.Mutex）。</li>
<li>interface{} 没有信息。<blockquote>
<p>因为接口类型无法做到静态检查。</p>
</blockquote>
</li>
<li>Gofmt 的风格没有人喜欢，但 Gofmt 却是每个人的最爱。</li>
<li>做一点复制比一点依赖更好。</li>
<li>系统调用必须由构建标签保证。</li>
<li>Cgo 必须由构建标签保证。</li>
<li>Cgo 不是 Go 。<blockquote>
<p>他说自己几乎不使用 cgo 。<br>Dave 博客的<a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go" target="_blank" rel="noopener">解读</a>。</p>
</blockquote>
</li>
<li>unsafe 包中的内容，没有保证。</li>
<li>清晰比聪明更重要。<blockquote>
<p>书写逻辑清晰的代码，不要耍小聪明。</p>
</blockquote>
</li>
<li>反射永远是不清晰的。</li>
<li>错误也是值。<blockquote>
<p>Go 官方博客的<a href="https://blog.golang.org/errors-are-values" target="_blank" rel="noopener">解读</a>。</p>
</blockquote>
</li>
<li>不要仅仅检查报错，要优雅的处理它们。<blockquote>
<p>Dave 博客的<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" target="_blank" rel="noopener">解读</a>。</p>
</blockquote>
</li>
<li>设计架构，命名组件，记录细节。<blockquote>
<p>取一个好名字解释起来也省事。</p>
</blockquote>
</li>
<li>文档是给用户看的。<blockquote>
<p>文档应该记录用户需要知道的内容。</p>
</blockquote>
</li>
<li>不要恐慌。<blockquote>
<p>程序 panic 不是正常的错误，要找到问题并解决。正常错误用 error 处理。</p>
</blockquote>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://go-proverbs.github.io/" target="_blank" rel="noopener">Go Proverbs</a></li>
<li><a href="https://studygolang.com/articles/12327" target="_blank" rel="noopener">Go 语言中文网 - Go 谚语</a></li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Go 私网开发服务搭建记录</title>
    <url>/2019/10/29/Go-%E7%A7%81%E7%BD%91%E5%BC%80%E5%8F%91%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>本文记录了私网 Go 开发所需的所有相关服务，包括版本管理，模块代理，持续集成。</p>
<p>涉及服务如下：</p>
<ul>
<li>Gogs</li>
<li>goproxy</li>
<li>Jenkins</li>
</ul>
<a id="more"></a>
<p>系统配置：</p>
<ul>
<li>CentOS 7</li>
</ul>
<h2 id="版本管理"><a href="#版本管理" class="headerlink" title="版本管理"></a>版本管理</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>搭建版本管理系统（VCS）的目的：一方面是为私有项目提供版本管理，一方面是托管修改过的开源项目。</p>
<h3 id="选型"><a href="#选型" class="headerlink" title="选型"></a>选型</h3><p>私网环境开发，项目源码可以托管于任何版本管理系统，但是 Go 对 Git 的支持更好，优先考虑搭建 Git 服务作为版本管理。</p>
<p>Go 要求版本管理系统实现 <code>go-get</code> 接口。我们选择了 <a href="https://gogs.io/" target="_blank" rel="noopener">Gogs</a> 。它是由 Go 语言编写的开源 Git 服务，搭建十分便捷 。</p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>详见 <a href="https://gogs.io/docs/installation" target="_blank" rel="noopener">官方搭建指南</a> ，以下仅作记录。</p>
<blockquote>
<p>如果使用 MySQL ，要求版本不低于 5.7 。参考这篇 <a href="/2019/10/28/Install-MySQL-8-0-on-CentOS-7/">安装 MySQL 8.0</a></p>
</blockquote>
<h4 id="新建数据库"><a href="#新建数据库" class="headerlink" title="新建数据库"></a>新建数据库</h4><p>名称： gogs</p>
<p>编码： utf8mb4</p>
<p>数据库中通过以下脚本新建数据库：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> gogs <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>
<h4 id="下载最新二进制程序包"><a href="#下载最新二进制程序包" class="headerlink" title="下载最新二进制程序包"></a>下载最新二进制程序包</h4><p>下载<a href="https://gogs.io/docs/installation/install_from_binary.html" target="_blank" rel="noopener">官网</a>提供的二进制文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://cdn.gogs.io/0.11.91/gogs_0.11.91_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="解压运行"><a href="#解压运行" class="headerlink" title="解压运行"></a>解压运行</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tar xf gogs_0.11.91_linux_amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gogs</span><br><span class="line">./gogs web</span><br></pre></td></tr></table></figure>
<h4 id="按照提示进行配置"><a href="#按照提示进行配置" class="headerlink" title="按照提示进行配置"></a>按照提示进行配置</h4><blockquote>
<p>配置前确保 Git 已安装</p>
</blockquote>
<details><br><summary>安装 Git</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum -y install git</span><br></pre></td></tr></table></figure><br><br></details>

<p>浏览器访问当前主机的 3000 端口，开始配置。</p>
<p>有几个配置项需要注意：</p>
<ul>
<li><p>域名：建议填域名，不然引用地址会很奇怪，即使没有真实域名也可以再客户端上做个 host 映射。例如：<code>go.findshank.com</code>。</p>
</li>
<li><p>HTTP 端口号：可以使用任意未占用的端口号，之后通过 nginx 映射到 80 端口。</p>
</li>
<li><p>应用 URL：必须启用 HTTPS，例如：<code>https://go.findshank.com</code> 。之后反向代理配置好 HTTPS 即可。</p>
</li>
<li><p>禁止用户注册：建议勾选，之后统一由管理员分配账号。</p>
</li>
</ul>
<h4 id="配置守护进程"><a href="#配置守护进程" class="headerlink" title="配置守护进程"></a>配置守护进程</h4><p>修改 <code>./scripts/systemd/gogs.service</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Gogs</span><br><span class="line"><span class="attr">After</span>=syslog.target</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"><span class="attr">After</span>=mysqld.service</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">LimitMEMLOCK</span>=infinity</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65535</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/home/shank/gogs</span><br><span class="line"><span class="attr">ExecStart</span>=/home/shank/gogs/gogs web</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">Environment</span>=USER=shank HOME=/home/shank</span><br><span class="line"></span><br><span class="line"><span class="attr">ProtectSystem</span>=full</span><br><span class="line"><span class="attr">PrivateDevices</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">NoNewPrivileges</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意修改为实际的用户目录</p>
</blockquote>
<p>复制到系统目录</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo cp ./scripts/systemd/gogs.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>
<h4 id="启用守护进程"><a href="#启用守护进程" class="headerlink" title="启用守护进程"></a>启用守护进程</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> gogs</span><br><span class="line">sudo systemctl start gogs</span><br></pre></td></tr></table></figure>
<h2 id="模块代理"><a href="#模块代理" class="headerlink" title="模块代理"></a>模块代理</h2><h3 id="目的-1"><a href="#目的-1" class="headerlink" title="目的"></a>目的</h3><p>Go 1.11 之后推荐使用 <code>go mod</code> 作为依赖管理，使用 <code>go mod</code> 可以通过配置模块代理服务加快依赖包的下载。这类代理服务通过环境变量 <code>GOPROXY</code> 进行指定，只要实现了模块代理协议（Module proxy protocol）的服务都称为模块代理服务。</p>
<p>因为公有网络的不确定性（比如开源作者删除了代码仓库或者网络被防火墙劫持），可以考虑自己维护一个代理服务，方便私网内构建时拉取常用第三方代码依赖。</p>
<h3 id="选型-1"><a href="#选型-1" class="headerlink" title="选型"></a>选型</h3><p>目前有许多开源项目实现了 goproxy 服务，我们选择了社区活跃且版本稳定的 <a href="https://github.com/goproxyio/goproxy" target="_blank" rel="noopener">goproxyio/goproxy</a>。</p>
<h3 id="源码构建及部署"><a href="#源码构建及部署" class="headerlink" title="源码构建及部署"></a>源码构建及部署</h3><blockquote>
<p>Go 版本不低于 1.11</p>
</blockquote>
<details><br><summary>配置 Go 1.13.3 编译环境</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://dl.google.com/go/go1.13.3.linux-amd64.tar.gz</span><br><span class="line">sudo tar -C /usr/<span class="built_in">local</span> -xzf go1.13.3.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=$PATH:/usr/local/go/bin'</span> &gt;&gt; <span class="variable">$HOME</span>/.profile</span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.profile</span><br></pre></td></tr></table></figure><br><br></details>

<details><br><summary>安装 make</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum -y install make</span><br></pre></td></tr></table></figure><br><br></details>

<h4 id="下载一份稳定版版本的源码"><a href="#下载一份稳定版版本的源码" class="headerlink" title="下载一份稳定版版本的源码"></a>下载一份稳定版版本的源码</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/goproxyio/goproxy/archive/v2.0.1.tar.gz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>v2.0.0 版本有 BUG 。<br>我遇到如下问题 <code>go get golang.org/x/tools/cmd/present: no matching versions for query &quot;upgrade&quot;</code> 。<br>故此处已更新。</p>
</blockquote>
<h4 id="解压-amp-编译"><a href="#解压-amp-编译" class="headerlink" title="解压 &amp; 编译"></a>解压 &amp; 编译</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tar xf v2.0.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> goproxy-2.0.1</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果你使用的是 go 1.13 以下版本， make 可能因网络问题耗时严重，你需要设置环境变量 GOPROXY 加速构建，例如： <code>export GOPROXY=https://goproxy.io</code>。因为 go 1.13 指定了默认的 GOPROXY 可以不需要另外配置。</p>
</blockquote>
<h4 id="添加二进制文件到系统目录"><a href="#添加二进制文件到系统目录" class="headerlink" title="添加二进制文件到系统目录"></a>添加二进制文件到系统目录</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo cp ./bin/goproxy /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<h4 id="配置守护进程-1"><a href="#配置守护进程-1" class="headerlink" title="配置守护进程"></a>配置守护进程</h4><p>修改 <code>./scripts/goproxy.service</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=goproxy service</span><br><span class="line"><span class="attr">Documentation</span>=https://goproxy.io</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"><span class="attr">Environment</span>=PATH=/usr/bin:/usr/local/go/bin</span><br><span class="line"><span class="attr">Environmnet</span>=GO111MODULE=<span class="literal">on</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/goproxy -listen=<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">8081</span> -proxy=https://goproxy.io -exclude=go.findshank.com</span><br><span class="line"><span class="attr">KillMode</span>=control-group</span><br><span class="line"><span class="attr">SuccessExitStatus</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attr">Alias</span>=goproxy.service</span><br></pre></td></tr></table></figure>
<p>参数说明</p>
<ul>
<li><code>-listen</code>：服务监听地址。</li>
<li><code>-proxy</code>：上游代理模块，不配置则直接请求目的地址。</li>
<li><code>-exclude</code>：不走代理的域名，私网域名公网无法访问应直接请求。</li>
</ul>
<p>复制到系统目录</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo cp ./scripts/goproxy.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>
<h4 id="启用守护进程-1"><a href="#启用守护进程-1" class="headerlink" title="启用守护进程"></a>启用守护进程</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> goproxy</span><br><span class="line">sudo systemctl start goproxy</span><br></pre></td></tr></table></figure>
<h2 id="持续集成（可选）"><a href="#持续集成（可选）" class="headerlink" title="持续集成（可选）"></a>持续集成（可选）</h2><h3 id="目的-2"><a href="#目的-2" class="headerlink" title="目的"></a>目的</h3><p>开发者将代码提交到版本管理系统，之后的编译构建，自动化测试，打包，发布，部署等都是固定流程，应该由持续集成系统去完成。</p>
<p>使用持续集成，可以降低重复繁琐操作的出错率。</p>
<h3 id="选型-2"><a href="#选型-2" class="headerlink" title="选型"></a>选型</h3><p>有许多在线的持续集成服务，由于我们是私网部署，我们选择了 <a href="https://jenkins.io" target="_blank" rel="noopener">Jenkins</a> ,它是由 Java 语言编写的开源 CI&amp;CD 服务，搭建十分便捷 。</p>
<h3 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h3><p>详见 <a href="https://jenkins.io/zh/doc/book/installing/" target="_blank" rel="noopener">官方搭建指南</a> ，以下仅作记录。</p>
<h4 id="安装-Java-1-8-运行环境"><a href="#安装-Java-1-8-运行环境" class="headerlink" title="安装 Java 1.8 运行环境"></a>安装 Java 1.8 运行环境</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum -y install java-1.8.0-openjdk-devel</span><br></pre></td></tr></table></figure>
<h4 id="启用-Jenkins-存储库"><a href="#启用-Jenkins-存储库" class="headerlink" title="启用 Jenkins 存储库"></a>启用 Jenkins 存储库</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl --silent --location http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo | sudo tee /etc/yum.repos.d/jenkins.repo</span><br><span class="line">sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key</span><br></pre></td></tr></table></figure>
<h4 id="安装-Jenkins"><a href="#安装-Jenkins" class="headerlink" title="安装 Jenkins"></a>安装 Jenkins</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum -y install jenkins</span><br></pre></td></tr></table></figure>
<h4 id="启用守护程序"><a href="#启用守护程序" class="headerlink" title="启用守护程序"></a>启用守护程序</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl start jenkins</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> jenkins</span><br></pre></td></tr></table></figure>
<h4 id="按照提示进行配置-1"><a href="#按照提示进行配置-1" class="headerlink" title="按照提示进行配置"></a>按照提示进行配置</h4><p>浏览器访问当前主机的 8080 端口，开始配置。</p>
<p>安装建议的插件，按需求以后添加插件。</p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><p>这里我们选用使用最广泛的 NGINX 作为反向代理服务。</p>
<blockquote>
<p>鉴于篇幅，仅介绍对于 Gogs 的反向代理。</p>
</blockquote>
<h3 id="安装-NGINX"><a href="#安装-NGINX" class="headerlink" title="安装 NGINX"></a>安装 NGINX</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum install -y nginx</span><br></pre></td></tr></table></figure>
<h3 id="HTTPS-证书"><a href="#HTTPS-证书" class="headerlink" title="HTTPS 证书"></a>HTTPS 证书</h3><p>获取证书的途径有很多，可以购买商业证书，或者申请免费证书，私网环境为了简单，我就选择自签证书。</p>
<p>使用 openssl 自签证书可以 <a href="/2019/06/26/enable-https-for-private-network/">参考这篇</a></p>
<p>也可以用 Gogs 可执行程序提供的子命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./gogs cert -ca=<span class="literal">true</span> -duration=8760h0m0s -host=go.findshank.com</span><br></pre></td></tr></table></figure>
<p>会在执行目录下得到两个文件： <code>cert.pem</code> 和 <code>key.pem</code> 。</p>
<h3 id="Gogs-配置"><a href="#Gogs-配置" class="headerlink" title="Gogs 配置"></a>Gogs 配置</h3><p>找到 Gogs 的配置文件 <code>gogs/custom/conf/app.ini</code> ，确保 <code>ROOT_URL</code> 为 https 协议，比如： <code>https://go.findshank.com</code> 。其他的配置都不用改。</p>
<h3 id="NGINX-配置"><a href="#NGINX-配置" class="headerlink" title="NGINX 配置"></a>NGINX 配置</h3><p>先把 <code>/etc/nginx/nginx.conf</code> 中的默认 <code>server</code> 配置删除，你也可以把它注释掉，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#server &#123;</span><br><span class="line">#    listen       80 default_server;</span><br><span class="line">#    listen       [::]:80 default_server;</span><br><span class="line">#    server_name  _;</span><br><span class="line">#    root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">#    # Load configuration files for the default server block.</span><br><span class="line">#    include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">#    location / &#123;</span><br><span class="line">#    &#125;</span><br><span class="line"></span><br><span class="line">#    error_page 404 /404.html;</span><br><span class="line">#        location = /40x.html &#123;</span><br><span class="line">#    &#125;</span><br><span class="line"></span><br><span class="line">#    error_page 500 502 503 504 /50x.html;</span><br><span class="line">#        location = /50x.html &#123;</span><br><span class="line">#    &#125;</span><br><span class="line">#&#125;</span><br></pre></td></tr></table></figure>
<p>新建配置文件 <code>/etc/nginx/conf.d/default.conf</code>，填入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        listen [::]:443 ssl;</span><br><span class="line">        server_name go.findshank.com;</span><br><span class="line">        ssl_certificate &quot;/home/shank/gogs/keys/cert.pem&quot;;</span><br><span class="line">        ssl_certificate_key &quot;/home/shank/gogs/keys/key.pem&quot;;        </span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_set_header X-Real-IP $remote_addr;      </span><br><span class="line">                proxy_pass http://127.0.0.1:3000$request_uri; </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        listen [::]:80 default_server;</span><br><span class="line">        server_name go.findshank.com;</span><br><span class="line">        return 301 https://$host$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>验证配置</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>
<h3 id="启用守护程序-1"><a href="#启用守护程序-1" class="headerlink" title="启用守护程序"></a>启用守护程序</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl start nginx</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>
<h2 id="可能遇到的问题"><a href="#可能遇到的问题" class="headerlink" title="可能遇到的问题"></a>可能遇到的问题</h2><ul>
<li>无法外部访问服务：检查 CentOS 的防火墙策略，放行特定端口。安全性要求不高甚至可以关闭防火墙。</li>
<li>私网仓库通过模块代理 go get 失败：<ul>
<li><code>...exec: &quot;git&quot;: executable file not found in $PATH...</code>： 确保 <code>git</code> 已安装。</li>
<li><code>... reading https://sum.golang.org/lookup/... 410 Gone</code>： 本地添加环境变量 <code>GOSUMDB=off</code></li>
</ul>
</li>
<li>NGINX 启动失败：<ul>
<li><code>...SSL: error:0200100D:system library:fopen:Permission denied...</code>： 对证书文件无访问权限，这是 SELinux 的强制模式导致的。解决办法就是 <code>restorecon -v -R /path/to/keys</code>。</li>
<li><code>...[emerg] bind() to 0.0.0.0:XXXX failed...</code>： 也可能表现为 NGINX 反代的端口返回 502 错误，这也是 SELinux 的坑。使用 semanage 添加 HTTP 端口即可，详见参考资料。</li>
</ul>
</li>
<li>各种 ssl 验证出错的问题： 使用自签证书，要在所有客户端的系统上都信任自签的证书。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.liquidweb.com/kb/how-to-stop-and-disable-firewalld-on-centos-7/" target="_blank" rel="noopener">How to Stop and Disable Firewalld on CentOS 7</a></li>
<li><a href="https://www.findshank.com/2019/06/26/setup-private-goproxy-server/">部署 goproxy 服务</a></li>
<li><a href="https://linuxize.com/post/how-to-install-jenkins-on-centos-7/" target="_blank" rel="noopener">How To Install Jenkins on CentOS 7</a></li>
<li><a href="https://github.com/Unknwon/wuwen.org/issues/12" target="_blank" rel="noopener">使用 HTTPS 部署 Gogs</a></li>
<li><a href="https://serverfault.com/questions/540537/nginx-permission-denied-to-certificate-files-for-ssl-configuration" target="_blank" rel="noopener">nginx permission denied to certificate files for ssl configuration
</a></li>
<li><a href="https://blog.csdn.net/RunSnail2018/article/details/81185653" target="_blank" rel="noopener">CentOS7 中 semanage 命令的安装</a></li>
<li><a href="https://blog.csdn.net/RunSnail2018/article/details/81185138" target="_blank" rel="noopener">Nginx 启动报 [emerg] bind() to 0.0.0.0:XXXX failed (13: Permission denied)错误处理</a></li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>Gogs</tag>
        <tag>goproxy</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7 安装 MySQL 8.0</title>
    <url>/2019/10/28/Install-MySQL-8-0-on-CentOS-7/</url>
    <content><![CDATA[<p>记录下在 CentOS 7 上安装 MySQL 8.0 ，并启用兼容性的密码验证。</p>
<a id="more"></a>
<h2 id="安装记录"><a href="#安装记录" class="headerlink" title="安装记录"></a>安装记录</h2><p>查看当前 linux 版本，执行 <code>uname -a</code>，结果如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Linux localhost.localdomain 3.10.0-1062.el7.x86_64 #1 SMP Wed Aug 7 18:08:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
<p>访问官网获取 linux 7 版本的仓库安装包。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>MD5 校验</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">md5sum mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>对照输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">893b55d5d885df5c4d4cf7c4f2f6c153  mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>添加官方仓库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo rpm -ivh mysql80-community-release-el7-3.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>替换阿里云镜像加速下载（可选）</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure>
<p>安装 MySQL </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum -y install mysql-server</span><br></pre></td></tr></table></figure>
<p>添加并启动守护进程</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line">sudo systemctl start mysqld</span><br></pre></td></tr></table></figure>
<p>检查运行状态</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>
<p>查找临时 root 密码</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br></pre></td></tr></table></figure>
<p>密码在行末</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2019-10-29T06:28:08.128300Z 5 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: Z-_%r1L3PRuJ</span><br></pre></td></tr></table></figure>
<p>配置 MySQL</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure>
<p>按提示，输入刚才找到的密码，然后变更为新密码（要求足够复杂，包含大小写字母数字及特殊字符）。</p>
<p>登录数据库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>
<p>新建用户</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">CREATE USER <span class="string">'appuser'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'P@ssw0rd'</span>;</span><br><span class="line">FLUSH PRIVILEGES; </span><br><span class="line">ALTER USER <span class="string">'appuser'</span>@<span class="string">'%'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'P@ssw0rd'</span>;</span><br></pre></td></tr></table></figure>
<p>启用密码验证插件与旧版兼容</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 末尾添加一行</span></span><br><span class="line">default-authentication-plugin=mysql_native_password</span><br></pre></td></tr></table></figure>
<p>重启 MySQL</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<p>防火墙设置（可选）</p>
<p>CentOS 默认启用防火墙进程（firewalld）</p>
<p>为 MySQL 开放全 IP 端口</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo firewall-cmd --zone=public --add-service=mysql --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-centos-7" target="_blank" rel="noopener">How To Install MySQL on CentOS 7</a></li>
<li><a href="https://wiki.mikejung.biz/Firewalld" target="_blank" rel="noopener">How to Allow MySQL Traffic using firewalld on CentOS 7</a></li>
</ul>
]]></content>
      <tags>
        <tag>CentOS</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>私网 git 仓库 go mod 实践</title>
    <url>/2019/08/07/%E7%A7%81%E7%BD%91-git-%E4%BB%93%E5%BA%93-go-mod-%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<p>使用 gogs 搭建私网 git 服务器，搭建十分便捷，参考<a href="https://gogs.io/docs/installation" target="_blank" rel="noopener">官方文档</a></p>
<p>本文旨在探究私网 git 服务对 <code>go get</code> 支持的问题。</p>
<a id="more"></a>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>使用 go mod 获取依赖，实际也是调用 go get，但是 go mod 中获取依赖必须要 vcs 服务开启 https，如何启用 https 见<a href="https://www.findshank.com/2019/06/26/enable-https-for-private-network/">之前的文章</a>，本文简单起见使用 go get 的方式获取依赖。</p>
<p>结论：</p>
<p>gogs 中要配置好 <code>DOMAIN</code> 及 <code>ROOT_URL</code> 。</p>
<h2 id="初次尝试"><a href="#初次尝试" class="headerlink" title="初次尝试"></a><del>初次尝试</del></h2><details><br><br><summary>展开</summary><br><br>### 准备实验环境<br><br>本地机器 host 里添加一条记录。<br><br>&gt; git 服务的实际局域网 IP 为 <code>192.168.20.44</code>。<br><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.20.44 vcs.private.org</span><br></pre></td></tr></table></figure><br><br>配置 git 服务的域名，在 gogs 配置文件中修改如下行：<br><br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">DOMAIN</span> = vcs.private.org</span><br></pre></td></tr></table></figure><br><br>重启 gogs 服务。<br><br>使用 <code>sko00o</code> 用户新建一个仓库，名叫 <code>demo</code> 。<br><br>上传一个由 go mod 管理的项目。<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir demo &amp;&amp; <span class="built_in">cd</span> demo</span><br><span class="line">go mod init vcs.private.org/sko00o/demo</span><br><span class="line">touch main.go</span><br><span class="line"><span class="built_in">echo</span> package main &gt; main.go</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"initial commit"</span></span><br><span class="line">git remote add origin gogs@vcs.private.org:sko00o/demo.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><br><br>### clone 测试<br><br>直接使用 git clone vcs.private.org/sko00o/demo 仓库拉取成功。<br><br>### go get 测试<br><br>尝试 go get 拉取 sko00o/demo 仓库。<br><br>&gt; 服务未配置 https ，故添上 <code>-insecure</code> 参数。<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go get -v -insecure vcs.private.org/sko00o/demo</span><br></pre></td></tr></table></figure><br><br>拉取失败，错误提示：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Parsing meta tags from https://vcs.private.org?go-get=1 (status code 502)</span><br><span class="line">go get vcs.private.org/sko00o/demo: unrecognized import path <span class="string">"vcs.private.org/sko00o/demo"</span> (parse https://vcs.private.org/sko00o/demo?go-get=1: no go-import meta tags</span><br></pre></td></tr></table></figure><br><br>再次尝试：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go get -v -insecure vcs.private.org/sko00o/demo.git</span><br></pre></td></tr></table></figure><br><br>拉取失败，错误提示：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go: vcs.private.org/sko00o/demo.git@v0.0.0-20190624043337-f2473e290d4d: parsing go.mod: unexpected module path <span class="string">"vcs.private.org/sko00o/demo"</span></span><br></pre></td></tr></table></figure><br><br>将 demo 仓库中的 go.mod 改为 <code>module vcs.private.org/sko00o/demo.git</code><br><br>再次尝试：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go get -v -insecure vcs.private.org/sko00o/demo.git</span><br></pre></td></tr></table></figure><br><br>成功。<br><br></details>

<h2 id="更合理的办法"><a href="#更合理的办法" class="headerlink" title="更合理的办法"></a>更合理的办法</h2><p>因为要修改 module 名字，以上处理方式显然不合理。</p>
<p>参考官方文档后， 得知 go 要求版本管理系统的服务端实现 go-get=1 的请求，恰好 gogs 是支持这个请求的。</p>
<p>尝试直接访问这个 API。</p>
<p><code>curl &quot;http://vcs.private.org/sko00o/demo?go-get=1&quot;</code></p>
<p>返回内容如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"go-import"</span> <span class="attr">content</span>=<span class="string">"192.168.20.44/sko00o/demo git http://192.168.20.44/sko00o/demo.git"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"go-source"</span> <span class="attr">content</span>=<span class="string">"192.168.20.44/sko00o/demo _ http://192.168.20.44/sko00o/demo/src/master&#123;/dir&#125; http://192.168.20.44/sko00o/demo/src/master&#123;/dir&#125;/&#123;file&#125;#L&#123;line&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">                go get --insecure 192.168.20.44/sko00o/demo</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>问题应该出在这里，说明 gogs 服务端的配置还存在问题，接着修改：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">ROOT_URL</span> = http://vcs.private.org</span><br></pre></td></tr></table></figure>
<p>重启 gogs 。 <code>service gogos restart</code></p>
<p>再次请求，返回内容符合要求</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"go-import"</span> <span class="attr">content</span>=<span class="string">"vcs.private.org/sko00o/demo git http://vcs.private.org/sko00o/demo.git"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"go-source"</span> <span class="attr">content</span>=<span class="string">"vcs.private.org/sko00o/demo _ http://vcs.private.org/sko00o/demo/src/master&#123;/dir&#125; http://vcs.private.org/sko00o/demo/src/master&#123;/dir&#125;/&#123;file&#125;#L&#123;line&#125;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">                go get --insecure vcs.private.org/sko00o/demo</span><br><span class="line">        <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>仓库回滚到没有修改 go.mod module 的版本，并强制提交。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git reset --hard &lt;SHA1&gt; <span class="comment"># must replace SHA1</span></span><br><span class="line">git push --force</span><br></pre></td></tr></table></figure>
<p>再次 <code>go get -v -insecure vcs.private.org/sko00o/demo</code></p>
<p>成功。</p>
<h2 id="还可能遇到的问题"><a href="#还可能遇到的问题" class="headerlink" title="还可能遇到的问题"></a>还可能遇到的问题</h2><p>如果你设置了环境变量 <code>http_proxy</code>， 你可能遇到下面的问题。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Fetching https://vcs.private.org/sko00o/demo?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org/sko00o/demo?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org/sko00o/demo?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org/sko00o/demo?go-get=1 (status code 500)</span><br><span class="line">Fetching https://vcs.private.org/lowan?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org/lowan?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org/lowan?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org/lowan?go-get=1 (status code 500)</span><br><span class="line">Fetching https://vcs.private.org?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org?go-get=1 (status code 500)</span><br><span class="line">go get vcs.private.org/sko00o/demo: unrecognized import path <span class="string">"vcs.private.org/sko00o/demo"</span> (parse http://vcs.private.org/sko00o/demo?go-get=1: no go-import meta tags ())</span><br></pre></td></tr></table></figure>
<p>解决办法：取消代理配置 <code>export http_proxy=</code> 。</p>
<p>如果你设置了 git 代理，你可能遇到下面的问题。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Fetching https://vcs.private.org/sko00o/demo?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org/sko00o/demo?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org/sko00o/demo?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org/sko00o/demo?go-get=1 (status code 200)</span><br><span class="line">get <span class="string">"vcs.private.org/sko00o/demo"</span>: found meta tag get.metaImport&#123;Prefix:<span class="string">"vcs.private.org/sko00o/demo"</span>, VCS:<span class="string">"git"</span>, RepoRoot:<span class="string">"http://vcs.private.org/sko00o/demo.git"</span>&#125; at http://vcs.private.org/sko00o/demo?go-get=1</span><br><span class="line">Fetching https://vcs.private.org/lowan?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org/lowan?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org/lowan?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org/lowan?go-get=1 (status code 200)</span><br><span class="line">Fetching https://vcs.private.org?go-get=1</span><br><span class="line">https fetch failed: Get https://vcs.private.org?go-get=1: EOF</span><br><span class="line">Fetching http://vcs.private.org?go-get=1</span><br><span class="line">Parsing meta tags from http://vcs.private.org?go-get=1 (status code 404)</span><br><span class="line">go get vcs.private.org/sko00o/demo: git ls-remote -q http://vcs.private.org/sko00o/demo.git <span class="keyword">in</span> /mnt/d/GoDev/pkg/mod/cache/vcs/3172f8a70a0665ea75a1e7fb868f761ef269470c22b6a85cbe78b19c5608fbee: <span class="built_in">exit</span> status 128:</span><br><span class="line">        fatal: unable to access <span class="string">'http://vcs.private.org/sko00o/demo.git/'</span>: The requested URL returned error: 500</span><br></pre></td></tr></table></figure>
<p>解决办法：取消 git 中的 http 代理 <code>git config --global --unset http.proxy</code> 。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://golang.org/cmd/go/#hdr-Download_and_install_packages_and_dependencies" target="_blank" rel="noopener">Download and install packages and dependencies</a></p>
</li>
<li><p><a href="https://golang.org/cmd/go/#hdr-Remote_import_paths" target="_blank" rel="noopener">Remote import paths</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>git</tag>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 git 管理 svn</title>
    <url>/2019/07/31/%E4%BD%BF%E7%94%A8-git-%E7%AE%A1%E7%90%86-svn/</url>
    <content><![CDATA[<p>习惯于使用 git 的你，可能会受不了 svn 残缺的功能。</p>
<p>还好 git 拥有一个十分好用的命令 <code>git svn</code>。</p>
<p>本文仅记录普通场景的使用，详细内容见<a href="https://git-scm.com/docs/git-svn" target="_blank" rel="noopener">官方文档</a>。</p>
<a id="more"></a>
<h2 id="新建-svn-仓库"><a href="#新建-svn-仓库" class="headerlink" title="新建 svn 仓库"></a>新建 svn 仓库</h2><p>主干代码放在 trunk 目录下，即 git 中的 master 分支。</p>
<p>分支代码按分支命名的目录放在 branches 目录下，假如有个分支是 bra1 那么它将在 branches/bra1 下。</p>
<p>标签代码分支代码目录结构一致，排布在 tags 目录下，子目录为标签名称，一般为版本号，类似于 tags/v1.0.0 。</p>
<p>所以一般 svn 仓库的标准目录结构如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">project</span><br><span class="line">├── branches</span><br><span class="line">│   ├── bra1</span><br><span class="line">│   └── bra2</span><br><span class="line">├── tags</span><br><span class="line">│   ├── v1.0.0</span><br><span class="line">│   └── v1.1.0</span><br><span class="line">└── trunk</span><br></pre></td></tr></table></figure>
<h2 id="拉取-svn-仓库"><a href="#拉取-svn-仓库" class="headerlink" title="拉取 svn 仓库"></a>拉取 svn 仓库</h2><p>第一步，也是最重要的一步，拉取代码。</p>
<p>咱们使用 <code>git svn</code> 命令管理 svn 仓库就需要区分一下目录结构及目录层级。</p>
<h3 id="项目在根目录"><a href="#项目在根目录" class="headerlink" title="项目在根目录"></a>项目在根目录</h3><p>这种情况，体验相对最舒适，以下命令即可完成：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn <span class="built_in">clone</span> -s svn://host/project</span><br></pre></td></tr></table></figure>
<p><code>-s</code> 让工具知道这是一个标准目录结构。</p>
<details><br><summary>可能遇到的问题</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Can<span class="string">'t locate Term/ReadKey.pm in @INC (you may need to install the Term::ReadKey module)</span></span><br></pre></td></tr></table></figure><br><br>该问题是缺少 perl 模块，无法读取 svn 密码<br><br>解决办法：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo cpan Term::ReadKey</span><br></pre></td></tr></table></figure><br><br></details>

<details><br><summary>如果不是标准目录命名</summary><br><br>假如目录结构是这样的：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">project</span><br><span class="line">├── branches1</span><br><span class="line">├── tags2</span><br><span class="line">└── trunk0</span><br></pre></td></tr></table></figure><br><br>就自己指定下各类目录的实际名称：<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn <span class="built_in">clone</span> svn://host/project -T trunk0 -b branches1 -t tags2</span><br></pre></td></tr></table></figure><br><br>- <code>-T</code> 主干目录<br>- <code>-b</code> 分支目录<br>- <code>-t</code> 标签目录<br><br></details>

<h3 id="项目不在根目录"><a href="#项目不在根目录" class="headerlink" title="项目不在根目录"></a>项目不在根目录</h3><blockquote>
<p>但现实可能没这么美好。</p>
</blockquote>
<p>此时我们的实际项目可能在： <code>svn://host/s001/p002/project</code></p>
<p>咱们不能直接 <code>git svn clone</code>，因为会出问题。咱们要把这个命令拆成几步来完成。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir project &amp;&amp; <span class="built_in">cd</span> project</span><br><span class="line">git svn -s init svn://host/s001/p002/project</span><br></pre></td></tr></table></figure>
<p>接着你会看到：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Initialized empty Git repository <span class="keyword">in</span> ~/project/.git/</span><br><span class="line">Using higher level of URL: svn://host/s001/p002/project =&gt; svn://host/s001</span><br></pre></td></tr></table></figure>
<p>它默认去使用了根目录，如果我们有根目录的修改权限，这样也能用，但是我们一般只有 project 那层的权限，所以咱们要修改下当前目录的 git 配置文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config -e</span><br></pre></td></tr></table></figure>
<p>配置文件大概是这样的：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[core]</span></span><br><span class="line">    <span class="comment"># 省略</span></span><br><span class="line"><span class="section">[svn-remote "svn"]</span></span><br><span class="line">    url = svn://host/s001</span><br><span class="line">    fetch = p002/project/trunk:refs/remotes/origin/trunk</span><br><span class="line">    branches = p002/project/branches/*:refs/remotes/origin/*</span><br><span class="line">    tags = p002/project/tags/*:refs/remotes/origin/tags/*</span><br></pre></td></tr></table></figure>
<p>修改如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[core]</span></span><br><span class="line">    <span class="comment"># 省略</span></span><br><span class="line"><span class="section">[svn-remote "svn"]</span></span><br><span class="line">    url = svn://host/s001/p002/project</span><br><span class="line">    fetch = trunk:refs/remotes/origin/trunk</span><br><span class="line">    branches = branches/*:refs/remotes/origin/*</span><br><span class="line">    tags = tags/*:refs/remotes/origin/tags/*</span><br></pre></td></tr></table></figure>
<details><br><summary>如果不是标准目录命名</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn init svn://host/s001/p002/project -T trunk0 -b branches1 -t tags2</span><br><span class="line">git config -e</span><br></pre></td></tr></table></figure><br><br><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[svn-remote "svn"]</span></span><br><span class="line">    url = svn://host/s001/p002/project</span><br><span class="line">    fetch = trunk0:refs/remotes/origin/trunk</span><br><span class="line">    branches = branches1/*:refs/remotes/origin/*</span><br><span class="line">    tags = tags2/*:refs/remotes/origin/tags/*</span><br></pre></td></tr></table></figure><br><br></details>

<p>配置文件保存后，拉取代码：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn fetch</span><br></pre></td></tr></table></figure>
<h2 id="递交版本"><a href="#递交版本" class="headerlink" title="递交版本"></a>递交版本</h2><p>一般流程如下：</p>
<p><strong>步骤一:</strong></p>
<p>正常的 git 的方式提交本地记录</p>
<p>当需要将本地记录推送到 svn 服务的时候，使用以下命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn dcommit</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个命令强制要求，版本管理中的文件的更改都已提交到本地记录。</p>
</blockquote>
<p><strong>步骤二:</strong></p>
<p>当遇到远程仓库已经存在别的提交时，会提交失败，咱们需要先拉取最新版本，但不是用 <code>git pull</code>，而是用以下命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn rebase</span><br></pre></td></tr></table></figure>
<p><strong>步骤三:</strong></p>
<p>如果有冲突，手动解决冲突，再进行<code>步骤一</code>。</p>
<h2 id="新建分支"><a href="#新建分支" class="headerlink" title="新建分支"></a>新建分支</h2><p>假如要新建一个分支叫 bra6</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn branch -m <span class="string">"new branch bra6"</span> bra6</span><br></pre></td></tr></table></figure>
<p>检查所有分支</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git branch -a</span><br></pre></td></tr></table></figure>
<p>你能发现有个新的远程分支叫 <code>remotes/origin/bra6</code> 。</p>
<blockquote>
<p>但是当前的活动分支还是指向 <code>remotes/origin/trunk</code> 。</p>
</blockquote>
<h2 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h2><p>新建一个本地分支映射远程分支，再切换到新的本地分支：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git branch bra6 remotes/origin/bra6</span><br><span class="line">git checkout bra6</span><br></pre></td></tr></table></figure>
<p>模拟提交一次，确认当前活动分支推送到对应的 svn 分支目录：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git svn dcommit --dry-run</span><br><span class="line"><span class="comment"># Committing to svn://host/s001/p002/project/branches/bra6 ...</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>你还可以通过 <code>git svn info</code> 查看详情</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://git-scm.com/docs/git-svn" target="_blank" rel="noopener">Reference/External Systems/svn</a></li>
<li><a href="https://git-scm.com/book/zh/v2/Git-%E4%B8%8E%E5%85%B6%E4%BB%96%E7%B3%BB%E7%BB%9F-%E4%BD%9C%E4%B8%BA%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84-Git" target="_blank" rel="noopener">Git 与其他系统 - 作为客户端的 Git</a></li>
<li><a href="https://stackoverflow.com/questions/728931/how-to-switch-svn-branches-using-git-svn" target="_blank" rel="noopener">How to switch svn branches using git-svn?</a></li>
</ul>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>git</tag>
        <tag>svn</tag>
      </tags>
  </entry>
  <entry>
    <title>LoRaWAN Backend Interfaces v1.0 学习 (p3)</title>
    <url>/2019/07/16/LoRaWAN-Backend-Interfaces-v1-0-%E5%AD%A6%E4%B9%A0-p3/</url>
    <content><![CDATA[<p>接上一篇。</p>
<p><a href="https://lora-alliance.org/resource-hub/lorawantm-back-end-interfaces-v10" target="_blank" rel="noopener">原文档链接</a></p>
<p>本部分主要介绍漫游过程。</p>
<a id="more"></a>
<h2 id="11-漫游过程"><a href="#11-漫游过程" class="headerlink" title="11. 漫游过程"></a>11. 漫游过程</h2><h3 id="11-1-漫游类型"><a href="#11-1-漫游类型" class="headerlink" title="11.1 漫游类型"></a>11.1 漫游类型</h3><p>有两种 LoRa 漫游类型，名为被动漫游（Passive Roaming）和切换漫游（Handover Roaming）。被动漫游使终端设备能够受益于 NS 的 LoRaWAN 网络服务，处于两个网络的终端设备即使在重叠 RF 功能受限（即信道）范围内在另一个 NS 的控制下使用网关（Gateways）时也能工作。LoRa 会话和终端设备的 MAC 层控制由前 NS 维护，称为 sNS ，而往返于空中接口的帧由后 NS 处理，后者称为 fNS （转发 NS ）。对于给定的 LoRa 会话，只能有一个 sNS，而同一个会话可能涉及零个或多个 fNS 。</p>
<p>有两种类型的 fNS ：有状态和无状态。有状态 fNS 在终端设备的被动漫游开始时创建上下文（context），并利用该上下文来处理相同终端设备的任何后续上行链路/下行链路分组（subsequent）。无状态 fNS 不会创建任何上下文，因此最终必须彼此独立地处理任何上行链路/下行链路分组。假设某个超范围机制漫游伙伴知道给定的 fNS 是无状态还是有状态的。</p>
<p>即使在终端设备执行从一个 NS 到另一个 NS 的切换漫游之后， hNS 仍然使用 JS 和 AS 维护控制平面（control-plane）和数据平面（data-plane）。对于给定 LoRa 会话， hNS 保持不变，直到终端设备执行下一个入网过程。与 fNS 不同， sNS 具有控制终端设备 RF 设置的能力，这允许更灵活的漫游场景。</p>
<p><img src="f6.png" alt="Figure 6 Use of Handover and Passive Roaming"></p>
<p>f6. 使用切换漫游和被动漫游</p>
<p>图 f6 所示，其中切换漫游和被动漫游同时用于 LoRa 会话。这个例子中，终端设备通过 NS1 激活， NS1 充当 hNS。随后，当 NS2 成为 sNS 时，漫游设备执行了从 NS1 到 NS2 的切换漫游，并且当 NS3 成为终端设备的 fNS 时，还从 NS2 到 NS3 进行被动漫游。</p>
<p>漫游激活是终端设备在 vNS 的覆盖范围内激活的能力。</p>
<p>本规范描述了下列漫游情况的过程：</p>
<ul>
<li>正在进行的 LoRa 会话期间的被动漫游</li>
<li>正在进行的 LoRa 会话期间的切换漫游</li>
<li>基于 hNS 和 vNS 之间的切换漫游，漫游激活新的 LoRa 会话</li>
<li>基于 hNS 和 vNS 之间的被动漫游，漫游激活新的 LoRa 会话</li>
</ul>
<p>当 hNS 和 vNS 没有任何漫游协议时激活新的 LoRa 会话超出了本规范的范围。这包含两种 NS 可能与第三个 NS 签订漫游协议的情况（例如， hNS 和第三个 NS 具有切换漫游协议，第三个 NS 和 vNS 具有被动漫游协议）。</p>
<h3 id="11-2-漫游策略"><a href="#11-2-漫游策略" class="headerlink" title="11.2 漫游策略"></a>11.2 漫游策略</h3><p>每个网络运营商（network operator）都应该（SHALL）配置漫游策略，该漫游可以单独允许/禁止被动漫游、切换漫游、基于被动漫游的激活、基于其 NetID 识别的其他网络运营商的基于切换漫游的激活。对于被动漫游，策略还应该（SHALL）包括上行链路 MIC 检查是否由 fNS 完成。</p>
<p>每个网络运营商（network operator）都应该（SHALL）配置漫游策略，该漫游可以允许/禁止被动漫游、切换漫游、基于被动漫游的激活、基于其 DevEUI 识别的单独终端设备的基于切换漫游的激活。</p>
<h3 id="11-3-被动漫游"><a href="#11-3-被动漫游" class="headerlink" title="11.3 被动漫游"></a>11.3 被动漫游</h3><p>此过程适用于 R1.0 [LW10, LW102] 和 R1.1 [LW11] 终端设备和网络。</p>
<h4 id="11-3-1-被动漫游开始"><a href="#11-3-1-被动漫游开始" class="headerlink" title="11.3.1 被动漫游开始"></a>11.3.1 被动漫游开始</h4><p>图 f7 所示针对终端设备的正在进行的 LoRa 会话的两个 NS 之间的被动漫游过程的消息流。有关基于被动漫游的新 LoRa 会话的激活，请参阅第 12.2 节。</p>
<p><img src="f7.png" alt="Figure 7 Passive Roaming start"></p>
<p>f7. 被动漫游开始</p>
<p>步骤 0：</p>
<p>终端设备已通过 NS1 激活。</p>
<p>步骤 1：</p>
<p>当终端设备发送一个数据包，它由 NS2 接收， NS2 与终端设备没有任何上下文关联。</p>
<p>步骤 2：</p>
<p>如果 NS2 被其他网络运营商启用了被动漫游，那么 NS2 应该（SHALL）将接收数据包中的 NwkID 映射到具有被动漫游协议的运营商 NetID。如果未查到， NS2 应该（SHALL）忽略这个数据包，程序终止于此。</p>
<p>步骤 3：</p>
<p>如果查到了一个或多个 NetID ，然后如果 NS2 没有通过 out-of-band 机制配置 NS 的 IP 地址/主机名， 它就应该（SHALL）使用 DNS 去查找（见第 19 章）每一个匹配上 NetID 的 NS 的 IP 地址（比如，NS1 处于这种情形）。如果有不止一个匹配项，那么对每一个匹配的 NS 执行步骤 4-6 。</p>
<p>步骤 4：</p>
<p>NS2 应该发送 PRStartReq 消息到 NS1 ，携带收到数据包的 PHYPayload 以及关联的 ULMetadata 。元数据（metadata）的详情见第 16 章。</p>
<p>步骤 5：</p>
<p>NS1 应该（SHALL）检查它是否与收到的 NetID 标识的网络运营商签有被动漫游协议。如果未找到协议，要决定返回携带 Result=NoRoamingAgreement 的 PRStartAns 。</p>
<p>NS1 应该（SHALL）从 PHYPayload 中提取终端设备的 DevAddr ，识别相应的网络会话完整性密钥（R1.1 中为 FNwkSIntKey，在 R1.0/R1.0.2 中为 NwkSKey），并验证 PHYPayload 中的 MIC 。如果未找到密钥或 MIC 验证失败，则 NS1 应决定返回携带 Result=MICFailed 的 PRStartAns 。</p>
<p>步骤 6：</p>
<p>如果识别出的终端设备配置为使用被动漫游并且 NS1 决定通过 NS2 启用被动漫游，则 NS1 应（SHALL）向 NS2 发送携带 Result=Success 以及与被动漫游相关联的生命周期的 PRStartAns。如果 NS2 要作为有状态 fNS 运行，则 NS1 还应（SHALL）包括 DevEUI 和 ServiceProfile 。如果是 NS1-NS2 的被动漫游协议要求 NS2 对上行数据包进行 MIC 检查，则 PRStartAns 消息中还要有的 FCntUp 和 FNwkSIntKey （R1.1 的情况下） 或 NwkSKey （在 R1.0/1.02 的情况下）。</p>
<p>如果 NS1 此时不希望通过 NS2 启用被动漫游，那么它应该（SHALL）将携带 Result=Deferred 和 Lifetime 的 PRStartAns 发送到 NS2 。在收到此消息时， NS2 在生命周期内不应（SHALL not）再向同一终端设备的 NS1 发送 PRStartReq 。</p>
<p>如果步骤 5 失败了，接着 NS1 应该（SHALL）发送带有标识结果的 PRStartAns 给 NS2 。</p>
<p>NS1 可以同时从多个 NS 接收 PRStartReq ，并决定使用零个或多个 NS 来启用被动漫游。</p>
<p>在相关生命周期到期之后， NS1 和 NS2 应自行终止被动漫游（即，不涉及彼此的额外信令），除非在到期之前使用新一轮 PRStartReq/PRStartAns 扩展被动漫游。对于无状态 fNS 操作， NS1 应（SHALL）将与被动漫游关联的 Lifetime 设置为零。</p>
<p>步骤 7：</p>
<p>一旦收到成功的 PRStartAns ，NS2 就会成为该终端设备 LoRa 会话中的一个 fNS 。NS1 继续作为 sNS 服务。</p>
<p>在此之后， NS2 应该（SHALL）将从终端设备接收的数据包转发给 NS1 ， NS1 应（SHALL）接收来自 NS2 的此类数据包。此外， NS1 应（SHALL）记录 NS2 作为用于将数据包发送到终端设备的候选 fNS 。 NS2 应（SHALL）接受 NS1 发送的数据包，通过其中一个网关转发到终端设备。</p>
<h4 id="11-3-2-分组传输（Packet-Transmission）"><a href="#11-3-2-分组传输（Packet-Transmission）" class="headerlink" title="11.3.2 分组传输（Packet Transmission）"></a>11.3.2 分组传输（Packet Transmission）</h4><p>图 f8 展示了终端在被动漫游时收发数据包的消息流。虽然流程图中一个上行包紧跟着一个下行包，其实上下行链路部分可以以终端设备的类型所允许的任何顺序独立执行。</p>
<p>在无状态 fNS 过程的情况下，每个上行链路分组应该（SHALL）根据第 11.3.1 节进行处理（不是根据本节中的步骤 1-4 ，它假定了 fNS 是有状态的）。然而，本节中的步骤 5-11 适用于下行链路跟组处理，即使对无状态的 fNS 过程也是如此。</p>
<p>本节中的所有步骤都适用于有状态 fNS 过程下的上下行链路的分组处理。</p>
<p><img src="f8.png" alt="Figure 8 Packet transmission using Passive Roaming"></p>
<p>f8. 使用被动漫游的分组传输</p>
<p>步骤 0：</p>
<p>在 fNS 和终端设备的 sNS 之间启用有状态被动漫游。</p>
<p>步骤 1：</p>
<p>终端设备发送由 fNS 接收的分组。</p>
<p>步骤 2：</p>
<p>如果 fNS 需要根据 sNS-fNS 被动路由协议对上行数据包进行 MIC 检查，则 fNS 应（SHALL）从数据包中提取终端设备的 DevAddr 并识别 FNwkSIntKey/NwkSKey ，再验证数据包中的 MIC 。若无法找到 FNwkSIntKey/NwkSKey 或者 MIC 验证失败，那么 fNS 应该（SHALL）忽略这个分组。</p>
<p>步骤 3：</p>
<p>如果识别出终端设备，则 fNS 应该（SHALL）向所识别的终端设备的 sNS 发送 XmitDataReq 消息，该 sNS 承载所接收的分组的 PHYPayload 和相关联的 ULMetadata 。</p>
<p>步骤 4：</p>
<p>在收到 XmitDataReq 后， sNS 应该（SHALL）发回一条携带结果的 XmitDataAns 消息给 fNS 。</p>
<p>当 sNS 具有要发送到终端设备的分组时，执行后续步骤，该分组可以或可以不遵循前面的步骤。</p>
<p>步骤 5：</p>
<p>sNS 有分组要发送给终端设备。</p>
<p>步骤 6：</p>
<p>sNS 应该（SHALL）确定是通过其控制下的 GW 之一还是通过 fNS 控制下的 GW 发送数据包。</p>
<p>步骤 7：</p>
<p>如果是 sNS 确定通过 fNS 发送分组，这个 sNS 应该（SHALL）发送 XmitDataReq 消息给 fNS ，消息携带所接收的分组的 PHYPayload 和相关联的 ULMetadata 。</p>
<p>步骤 8：</p>
<p>如果接收到 XmitDataReq 包含错误， fNS 应该（SHALL）发送携带失败值的 XmitDataAns 消息给 sNS，不应该（SHALL NOT）尝试发送这个分组。否则， fNS 将尝试基于其从 sNS 接收的元数据信息将分组发送到终端设备。如果元数据包括 GWInfo.ULToken ，则 fNS 可以使用该元数据来选择下行链路传输的 GW 。由于时序约束（timing constraints）和网络条件， fNS 可能无法发送分组。在这种情况下， fNS 应该（SHALL）不会重试传输。</p>
<p>步骤 9：</p>
<p>在尝试发送数据包之后， fNS 应（SHALL）向携带 DLFreq1 或 DLFreq2 的 sNS 发送 XmitDataAns 消息（取决于数据包是在 RX1 还是 RX2 或两者上发送），Result=Success 表示传输成功，否则结果是 Result=XmitFailed 。</p>
<h3 id="11-3-3-被动漫游停止"><a href="#11-3-3-被动漫游停止" class="headerlink" title="11.3.3 被动漫游停止"></a>11.3.3 被动漫游停止</h3><p>图 f9 和 f10 展示了终止被动漫游的流程。这个过程仅适用于有状态的 fNS 。</p>
<p><img src="f9.png" alt="Figure 9 sNS-initiated Passive Roaming termination"></p>
<p>f9. sNS-发起的 被动漫游的终止</p>
<p>步骤 0：</p>
<p>在 fNS 和终端设备的 sNS 之间启用被动漫游。</p>
<p>步骤 1：</p>
<p>当 sNS 决定在被动漫游生命周期超时前终止与终端设备的被动漫游时， sNS 应该（SHALL）发送一条 PRStopReq 消息给 fNS ，消息携带终端设备的 DevAddr 和 DevEUI，以及可选的生命周期（Lifetime） 。如果 fNS 是有状态的并且 sNS 不希望在规定的时间跨度内从终端设备的 fNS 接收另一个 PRStartReq ，则 sNS 应该（SHALL）应该包含生命周期（Lifetime）。</p>
<p>步骤 2：</p>
<p>fNS 应该（SHALL）校验具有 DevEUI 的终端设备是否已经处于被动漫游并且与 sNS 相关联。如果这两个条件都满足，然后 fNS 应该（SHALL）发送携带 Result=Success 的 PRStopAns 消息给 sNS 。否则， fNS 应该（SHALL）携带 Result=UnknownDevEUI 的 PRStopAns 消息给 sNS 。如果收到的 PRStopReq 消息包含生命周期 ，则 fNS 在生命周期内应该（SHALL）不会向终端设备的 sNS 发送另一个 PRStartReq 。</p>
<p>如果终端设备的被动漫游先前已使用 PRStopReq 消息终止或者被 PRStartAns/Result=Deferred 拒绝，则新来的生命周期为 0 的 PRStopReq 消息使 NS2 能够再次向终端设备发送 PRStartReq 从该终端设备接收数据包。这仅适用于有状态的 fNS 。</p>
<p><img src="f10.png" alt="Figure 10 fNS-initiated Passive Roaming termination"></p>
<p>f10. fNS-发起的 被动漫游的终止</p>
<p>步骤 0：</p>
<p>在 fNS 和终端设备的 sNS 之间启用被动漫游。</p>
<p>步骤 1：</p>
<p>当 fNS 决定在被动漫游生命周期超时前终止与终端设备的被动漫游时， fNS 应该（SHALL）发送一条 PRStopReq 消息给 sNS，该消息携带终端设备的 DevEUI 。</p>
<p>步骤 2：</p>
<p>sNS 应该（SHALL）校验具有 DevEUI 的终端设备是否由自己提供服务并且已经处于与 fNS 的被动漫游。如果两个条件都满足，然后 sNS 应该（SHALL）发送携带 Result=Success 的 PRStopAns 消息给 fNS。否则， sNS 应该（SHALL）发送携带 Result=UnknownDevEUI 的 PRStopAns 消息给 fNS 。</p>
<p>在被动漫游终止后， sNS 和 fNS 之间应该（SHALL）停止为指定的终端设备向彼此转发数据包。</p>
<h3 id="11-4-切换漫游"><a href="#11-4-切换漫游" class="headerlink" title="11.4 切换漫游"></a>11.4 切换漫游</h3><p>这个过程仅适用于 R1.1 [LW11] 终端设备和网络。</p>
<h4 id="11-4-1-切换漫游开始"><a href="#11-4-1-切换漫游开始" class="headerlink" title="11.4.1 切换漫游开始"></a>11.4.1 切换漫游开始</h4><p>图 f11 说明了终端设备正在进行的 LoRa 会话的切换漫游过程的消息流。基于新 LoRa 会话的切换漫游激活参阅第 12.1 节。</p>
<p><img src="f11.png" alt="Figure 11 Handover Roaming start"></p>
<p>f11. 切换漫游开始</p>
<p>步骤 0：</p>
<p>考虑终端设备已在 NS1 上激活的情况。因此， NS1 作为终端设备的 fNS 、 sNS 以及 hNS 。</p>
<p>步骤 1：</p>
<p>终端设备响应收到的 ForceRejoinReq MAC 指令（未示出）或者在没有外部触发的情况下自动地发送 Rejoin-request Type 0 消息。</p>
<p>步骤 2：</p>
<p>如果 NS2 充当由接收到 DevEUI 标识的终端设备的 sNS ，并且 NS2 没有通过发送 ForceRejoinReq 请求 Rejoin-request Type 0 ，那么 NS2 应该（SHOULD）默默地丢弃消息并且流程终止于此。</p>
<p>如果 NS2 不止终端设备的 sNS，那么 NS2 应该（SHALL）在 Rejoin 请求中使用 NetID 标识的操作符查找其漫游策略。如果 NS2 没有被操作者配置成允许切换漫游，那么 NS2 应该（SHALL）忽略 Rejoin-request 并且终止该程序。否则，如果 NS2 没有通过 out-of-band 机制配置 NS1 的 IP 地址/主机名 ，它应该（SHALL）使用 DNS 发现 NS1 的 IP 地址（参见第 19 节）。</p>
<p>步骤 3：</p>
<p>如果 NS2 没有缓存终端设备的设备配置文件（Device Profile），它应该（SHALL）发送一条携带 DevEUI 的 ProfileReq 消息给 NS1 。如果没有发送 ProfileReq 就跳过步骤 4 和 5 。</p>
<p>步骤 4：</p>
<p>NS1 应该（SHALL）通过 NetID 标识的操作符查找其漫游策略。</p>
<p>步骤 5：</p>
<p>如果 NS1 被配置为允许向 NS2 和 终端设备提供切换漫游，NS1 应该（SHALL）发送带有 Result=Success 、 设备配置文件（Device Profile） 以及 Profile Timestamp（设备配置文件最近一次修改的时间戳）的 ProfileAns 消息给 NS2 。如果没有启用切换漫游， ProfileAns 消息中携带 Result=(NoRoamingAgreement 或者 DevRoamingDisallowed) 以及生命周期（Lifetime），然后程序终止。Lifetime 允许 NS1 在生命周期结束前请求 NS2 而不用向终端设备发送额外的 ProfileReq 。</p>
<p>步骤 6：</p>
<p>NS2 应（SHALL）向 NS1 发送携带 PHYPayload 的 HRStartReq 消息， PHYPayload 中包含 Rejoin-request 消息 、 MACVersion 、 ULMetadata 、 设备配置时间戳 （Device Profile Timestamp），以及由 NS2 标识的参数 DevAddr 、 DLSettigns 、 RxDelay 和可选的 CFList 以分配给终端设备。 NS2 应该（SHALL）将 MACVersion 的值设置为终端设备和 NS2 之间的最高通用版本。</p>
<p>步骤 7：</p>
<p>如果 NS2 或终端设备不允许切换漫游，再或者消息的 MIC 校验失败，则 NS1 应该（SHALL）继续执行步骤 9 。切换漫游拒绝可能时由于每个 NS 或每个设备的漫游策略，或者在终端设备已经被另一个 sNS 服务时可能不需要切换漫游。</p>
<p>如果 NS1 确定自从收到的设备配置文件时间戳指示的时间以来设备配置文件已更改，则 NS1 断定 NS2 具有过时的（stale）设备配置文件信息。在这种情况下， NS1 应该（SHELL）继续执行步骤 9 。</p>
<p>否则， NS1 应该（SHALL）转发 RejoinReq 消息给 JS ，消息携带从 NS2 接收的 PHYPayload ，其中包含 Rejoin-request 消息、 MACVersion 、 DevEUI 、 DevAddr 、 DLSettings 、 RxDelay 以及可选的 CFList 。</p>
<p>步骤 8：</p>
<p>如果 JS 接受了 Rejoin-request ，它应该（SHALL）按照 MACVersion 继续执行 Rejoin-request ，即发送 RejoinAns 消息给 NS1， 消息携带 Result=Success 、 PHYPayload (包含 Join-accept 信息、 SNwkSIntKey 、 FNwkSIntKey 、 NwkSEncKey 、 Lifetime)。 否则 JS 应该（SHALL）发送一条 RejoinAns 消息给 NS1， 消息带有 Result=(UnknownDevEUI 或者 MICFailed) 。</p>
<p>NS1 应该（SHALL）将接收的 Lifetime 值视为它分配给 LoRa 会话的会话生存期（session lifetime）的上限（upper-bound）。</p>
<p>步骤 9：</p>
<p>如果 NS1 在步骤 7 中决定不允许切换漫游，那么 NS1 应该（SHALL）发送一条 HRStartAns 消息给 NS2 ，消息带有设置错误值的 Resule （参见表 t24）以及 Lifetime 。Lifetime 允许 NS1 在生命周期结束前请求 NS2 而不用向终端设备发送额外的 HRStartReq 。</p>
<p>如果 NS1 断定 NS2 已知的设备配置文件是过时的，则 NS1 应（SHALL）将 HRStartAns 消息发给 NS2 ，消息携带 Result=StaleDeviceProfile 、最新设备配置文件以及它的设备配置文件时间戳。 NS2 应该（SHALL）跳回步骤 6 去使用刚刚收到的新设备配置文件。</p>
<p>否则， NS1 应该（SHALL）通过还包含 DLMetadata 和服务配置文件（Service Profile）将 HRStartAns 消息的有效载荷发送给 NS2 。 NS1 也应该（SHALL）缓存收到的 SNwkSIntKey ，这样它就可以在决定将它们转发给 JS 之前验证后续 Rejoin-Type 0 消息的 MIC 。</p>
<p>步骤 10：</p>
<p>如果 HRStartAns 指示了成功，NS2 应该（SHALL）转发收到的带有 Join-accept 消息的 PHYPayload 给终端设备。否则 NS2 应该（SHALL）不发送任何会应该终端设备。</p>
<p>如果重新入网过程（Rejoin Procedure）成功，接着 NS2 应该（SHALL）开始转发从终端设备收到的数据包给 NS1 ， NS1 应该（SHALL）接受这种数据包。另外， NS1 应该（SHALL）开始转发从 AS 收到数据包给 NS2 ，并且 NS2 应该（SHALL）接收这种数据包。</p>
<p>步骤 11：</p>
<p>终端设备发送第一次上行链路数据包。NS2 应该（SHALL）发送这个数据包给 NS1 。</p>
<p>步骤 12：</p>
<p>当 NS2 接收到终端设备的第一次上行链路数据包时， NS2 开始充当 sNS， 而 NS1 停止充当 sNS 。同时， NS1 继续作为 hNS 服务于终端设备。</p>
<h4 id="11-4-2-数据包传输"><a href="#11-4-2-数据包传输" class="headerlink" title="11.4.2 数据包传输"></a>11.4.2 数据包传输</h4><p>切换漫游的案例中，hNS 和 sNS 应该（SHALL）使用和被动漫游（参见 11.3.2 节）相同方式的 XmitDataReq/Ans 消息。唯一的不同就是， hNS-sNS 接口携带的是 FRMPayload 而不是 PHYPayload，ULMetadata/DLMetadata 包含不同的对象集合在第 16 节描述。</p>
<h4 id="11-4-3-切换漫游停止"><a href="#11-4-3-切换漫游停止" class="headerlink" title="11.4.3 切换漫游停止"></a>11.4.3 切换漫游停止</h4><p>图 f12 阐明在终端设备执行切换漫游到新的 sNS 之后，hNS 与之前提供服务的 sNS 终止了切换漫游。</p>
<p><img src="f12.png" alt="Figure 12 Termination of sNS"></p>
<p>步骤 0：</p>
<p>终端设备在 NS1 和 NS2 之间执行切换漫游。</p>
<p>步骤 1：</p>
<p>终端设备在 NS1 和 NS3 之间执行切换漫游。</p>
<p>步骤 2：</p>
<p>终端设备的第一次上行数据包通过新的 sNS （NS3） 被 NS1 接收到。</p>
<p>步骤 3：</p>
<p>当 NS1 通过新的 sNS （NS3）收到终端设备的第一条上行包时， NS1 应该（SHALL）发送一条带有 DevEUI 的 HRStopReq 消息到之前的 sNS （NS2）。</p>
<p>HRStopReq 消息带有可选的 Lifetime ，表示 NS1 不希望在规定时间内收到 NS2 的另一条 HRStartReq 消息。</p>
<p>步骤 4：</p>
<p>如果 NS2 为收到 DevEUI 标识的终端设备和相关联的 NS1 激活了切换漫游， 则先前提供服务的 sNS （NS2）应该终止切换漫游并且发送携带 Result=Success 的 HRStopAns 消息给 NS1 。 如果 NS2 没有为中断设别和相关联的 NS1 激活切换漫游，则 NS2 应该（SHALL）发送携带 Result=UnknownDevEUI 的 HRStopAns 消息给 NS1 。</p>
<p>步骤 5：</p>
<p>NS2 停止作为 sNS 为终端设备的 LoRa 会话提供服务。如果 NS2 为终端设备的 LoRa 会话启用了和其他 NS 的被动漫游，则 NS2 应该（SHALL） 也终止和那个 NS 的被动漫游。</p>
<p>如果先前用 HRStopReq 命令终止了对终端设备的切换漫游，则新的 HRStopReq 命令 Lifetime 值为 0 ，使 NS2 能够在收到新的类型为 0 的 Rejoin-request 请求后再次向该终端设备发送 HRStart 请求。</p>
<p>另一种情况是当 sNS 决定终止漫游时终止切换漫游。sNS 可以通过发送 ForceRejoinReq 命令给终端设备来执行终止流程。然后， sNS 应该（SHALL）发送带有 DevEUI 的 HRStopReq 给 hNS 。如果 hNS 已经激活了 DevEUI 标识的终端设别和相关联 sNS 的切换漫游， hNS 应该（SHALL）终止切换漫游并且发送一条带有 Result=Success 的 HRStopAns 给 sNS 。如果 hNS 没有和相关联的终端设备激活切换漫游，那么 hNS 应该（SHALL）发送携带 Result=UnknownDevEUI 的 HRStopAns 消息给 sNS 。即使 sNS 从 hNS 收到了错误结果，仍然可以终止切换漫游。</p>
<h4 id="11-4-4-hNS-重获控制权"><a href="#11-4-4-hNS-重获控制权" class="headerlink" title="11.4.4 hNS 重获控制权"></a>11.4.4 hNS 重获控制权</h4><p>图 f13 阐释了 hNS 通过接管当前服务的 sNS 而变成 sNS 的消息流程。</p>
<p><img src="f13.png" alt="Figure 13 hNS regaining sNS control"></p>
<p>步骤 0：</p>
<p>终端设备在 NS1 和 NS2 之间执行切换漫游。</p>
<p>步骤 1：</p>
<p>NS1 决定变成 sNS 。</p>
<p>步骤 2：</p>
<p>NS1 应该（SHALL）发送一条带有 DevEUI 的 HRStartReq 消息给 NS2 触发切换漫游。 </p>
<blockquote>
<p>原文有误，稍作修改。原文：<code>The NS1 SHALL send an HRStartReq message to the NS1 carrying DevEUI to trigger the Handover Roaming.</code></p>
</blockquote>
<p>步骤 3：</p>
<p>如果 NS2 通过收到的 DevEUI 标识和相关联的 NS1 为终端设备激活了切换漫游，那 NS2 就应该（SHALL）发送携带 Result=Success 的 HRStartAns 给 NS1 ，否则携带 Result=UnknownDevEUI 。 </p>
<p>步骤 4：</p>
<p>NS2 应该（SHALL）初始化网络触发（network-triggered）的切换漫游，如 11.4.1 节所描述。它假设这个流程初始化的时候终端设备在 NS1 的无线电覆盖范围内， NS1 拒绝了来自其他 NS 的切换漫游尝试，包括 NS2 ，而变成了 sNS 。</p>
<p>步骤 5：</p>
<p>NS1 直接从终端设备获取到第一次上行数据包。</p>
<p>步骤 6：</p>
<p>NS1 应该（SHALL）与 NS2 执行切换漫游的停止流程，如 11.4.3 节所示。</p>
<p>步骤 7：</p>
<p>NS2 停止作为 sNS 服务于终端设备的 LoRa 会话。如果 NS2 已经和其他 NS 为终端设备的 LoRa 会话启用了被动漫游，那么 NS2 也应该（SHALL）终止和那个 NS 的被动漫游。</p>
<p>或者，NS1 可以等到终端设备自己决定要初始化切换漫游，有效的跳过步骤 2 和 3，继续步骤 4 至 7 。</p>
]]></content>
      <categories>
        <category>LoRaWAN</category>
      </categories>
      <tags>
        <tag>LoRaWAN</tag>
      </tags>
  </entry>
  <entry>
    <title>LoRaWAN Backend Interfaces v1.0 学习 (p2)</title>
    <url>/2019/07/11/LoRaWAN-Backend-Interfaces-v1-0-%E5%AD%A6%E4%B9%A0-p2/</url>
    <content><![CDATA[<p>接上一篇。</p>
<p><a href="https://lora-alliance.org/resource-hub/lorawantm-back-end-interfaces-v10" target="_blank" rel="noopener">原文档链接</a></p>
<p>本部分主要介绍终端状态、激活流程以及停用流程。</p>
<a id="more"></a>
<h2 id="4-终端类型和状态"><a href="#4-终端类型和状态" class="headerlink" title="4. 终端类型和状态"></a>4. 终端类型和状态</h2><p>LoRaWAN 终端设备有两种类型：ABP（Activation-by-Personalization，个性化激活） 激活终端设备，以及 OTA (Over-the-Air，空中激活) 激活终端设备。ABP 终端通过跳过入网过程直接绑定到特定网络，OTA 终端执行入网过程以在选定网络上激活。</p>
<p>图 f3 展示了两种类型终端以及与 OTA 终端设备关联的各种终端设备状态。</p>
<p><img src="f3.png" alt="Figure 3 End-Device types and states"></p>
<p>f3. 终端类型和状态</p>
<p>一台 ABP 终端设备离开制造商或之后配置时应该（SHALL）具有以下信息： DevAddr 、 AppSKey 、 网络会话密钥（network session keys）。网络会话密钥在 R1.1 (LoRaWAN1.1) 中是 SNwkSIntKey 、 FNwkSIntKey 、 NwkSEncKey ，在 R1.0/1.0.2 （LoRaWAN1.0/1.0.2）中是 NwkSKey。为了使终端设备能够轻松使用网络，其 hNS （Home NS）应该（SHALL）具有 DevAddr 、 网络会话密钥 、 终端设备的 AS 信息；并且 AS 应该（SHALL）具有终端设备的 DevAddr 、 AppSKey 。</p>
<p>一台 OTA 终端设备离开制造商或之后配置时应该（SHALL）具有以下信息： DevEUI 、 NwkKey (仅限 R1.1) 、 AppKey 、 JoinEUI 。此时，它被称为通用终端设备。关联的 JS (Join Server) 应该（SHALL）具有终端设备的 DevEUI 、 AppKey 、 NwkKey （仅限 R1.1）。在被委托（commissioned）之前，NS 或 AS 可能没有关于通用终端设备的任何信息。</p>
<p>在其生命周期中重新配置终端设备。配置和重新配置过程详细内容超出本文档范围。</p>
<p>委托过程将终端设备关联到其 hNS 和特定 AS 。已委托的 OTA 终端设备的 JS 应该（SHALL）具有终端设备的 hNS 信息。与终端设备关联的 AS 应该（SHALL）具有终端设备的 DevEUI 。hNS 应该（SHALL）具有与终端设备及其订阅相关的各种配置文件信息。用于为 AS 、 JS 和 NS 提供所需信息的机制超出本文档范围。</p>
<p>当一个被委托的 OTA 终端设备成功执行了入网（激活）过程，它能知道 DevAddr 、 网络会话密钥和 AppSKey 。JS 能知道 DevEUI 、 DevAddr 、 网络会话密钥 、AppSKey 和 DevNonce 。JS 将 DevEUI 和 AppSKey 交付给 AS 。JS 将网络会话密钥和可选的加密 AppSKey 传递给 NS 。</p>
<h2 id="5-调试程序（Commissioning-Procedure）"><a href="#5-调试程序（Commissioning-Procedure）" class="headerlink" title="5. 调试程序（Commissioning Procedure）"></a>5. 调试程序（Commissioning Procedure）</h2><p>调试程序有 AS 、 JS（仅适用于 OTA) 和给定终端设备的 NS 执行。它涉及 JS 将终端设备与 hNS (仅适用于 OTA) 相关联， hNS 和 AS 接收与终端设备及其服务订阅相关的配置文件信息。用于提供关于前述网络元件的所需信息的机制超出本文档范围。</p>
<p>退役程序（Decommissioning Procedure）会破坏终端设备与 hNS 和 AS 之间的关联。此过程涉及在调试时重置在 AS 和 NS 上创建的状态，解除 JS 上的终端设备和 hNS 的绑定（仅适用于 OTA）。</p>
<p>调试和退役程序的细节超出了本规范的范围。</p>
<h2 id="6-激活-ABP-终端设备"><a href="#6-激活-ABP-终端设备" class="headerlink" title="6. 激活 ABP 终端设备"></a>6. 激活 ABP 终端设备</h2><p>图 f4 展示了具有 NS 的 ABP 终端设备激活。此过程适用于 R1.0 和 R1.1 终端设备和网络。</p>
<p>！<a href="f4.png">Figure 4 Activation of ABP End-Device</a><br>f4. 激活 ABP 终端设备</p>
<p>步骤 0：</p>
<p>终端设备、 NS 和 AS 配置了所需的信息，因此终端设备可以在上电之后立即发送数据包。</p>
<p>步骤 1：</p>
<p>当终端设备具有要发送的应用有效负载（Payload）时，它可以在不执行与网络的的任何设置信令的情况下这样做。数据包包含用 AppSKey 加密的应用有效负载，以及使用网络会话完整性密钥（R1.1 中是 SNwkSIntKey 和 FNwkSIntKey ，否则是 NwkSKey）生成的 MIC 。</p>
<p>当 NS 收到数据包是，它应该（SHALL）根据收到的数据包的 DevAddr 执行网络会话完整性密钥查找。 NS 应该（SHALL）使用检索到的密钥验证 MIC 。如果为找到密钥，或者 MIC 校验失败，则 NS 应该丢弃该数据包。</p>
<p>步骤 2：</p>
<p>NS 应将接收的数据包的加密有效负载发送到与终端设备相关联的 AS 。应用程序有效负载可以伴随元数据，例如 DevAddr 、 FPort 、 时间戳（timestamp）等。 NS 应该（SHALL）考虑从终端设备接收第一个数据包时激活终端设备的 LoRa 会话。</p>
<h2 id="7-激活-OTA-终端设备"><a href="#7-激活-OTA-终端设备" class="headerlink" title="7. 激活 OTA 终端设备"></a>7. 激活 OTA 终端设备</h2><p>终端设备使用 OTA 激活过程，以便与网络相互认证，并获得授权发送上行链路和接收下行链路数据包。对于终端设备， NS 分成两种。一类是 hNS ，包含终端设备的终端设备信息、服务以及路由配置文件，并在激活后提供面向 AS 和 JS 的接口。提供 hNS 所需配置文件信息的机制超出本文档范围。另一类是 vNS （Visited NS），它与 hNS 之间制定了业务及技术协议以便能够为终端设备提供服务。</p>
<p>激活程序有两种变体，即固定激活（Activation at Home）和漫游激活（Roaming Activation）。</p>
<p>固定激活：终端设备在 hNS 的无线电覆盖范围内执行激活过程。在程序结束时， hNS 时唯一为终端服务的 NS ,用于联系 AS 和 JS 。</p>
<p>漫游激活：终端设备在 hNS 的无线电覆盖范围之外但是在 vNS 的覆盖范围之内执行激活过程。在此过程中， vNS 在 JS 的帮助下取得 hNS 的身份标识，并从 hNS 获得所需的终端设备和服务配置文件。在程序结束时，终端设备由 vNS 和 hNS 提供服务，以便联系 AS 和 JS 。</p>
<p>当终端设备成功执行入网和重新入网的过程时，终端设备被称为与后端进行了 LoRa 会话。每次 LoRa 会话都与终端设备上管理的上下文参数以及 NS 、 JS 和 AS 相关联。（例如，会话密钥、 DevAddr 、 NS 的 ID 等）。当终端设备执行停用（退出）过程或其他成功的入网/重新入网过程时，LoRa 会话终止。</p>
<h2 id="8-固定激活（OTA-Activation-at-Home-Procedure）"><a href="#8-固定激活（OTA-Activation-at-Home-Procedure）" class="headerlink" title="8. 固定激活（OTA Activation at Home Procedure）"></a>8. 固定激活（OTA Activation at Home Procedure）</h2><p>图 f5 说明了固定激活流程中的消息流。此过程适用于 R1.0 [LW10,LW102] 和 R1.1 [LW11] 终端设备和网络。</p>
<p><img src="f5.png" alt="Figure 5 Message flow for OTA Activation at Home Procedure."></p>
<p>f5. 固定激活流程中的消息流</p>
<p>步骤 1：</p>
<p>终端设备应该（SHALL）发射入网请求（Join-request）消息。</p>
<p>步骤 2：</p>
<p>当 NS 收到入网请求消息， NS 应该（SHALL）按照终端设备的 DevEUI 判断自己是不是 hNS 。在这个流程中假设这个 NS 就是当前终端设备的 hNS 。有关 NS 不是终端设备的 hNS 的情况，请参阅第 12 节，但 NS 配置为使用 JS 进行漫游激活过程。如果 NS 既不是 hNS 也没有配置为使用 JS ，那么这个 NS 应该默默地忽略这条入网请求，程序终止于此。</p>
<p>如果 NS 尚未通过 out-of-band 机制配置 JS 的 IP 地址/主机名， NS 应该（SHALL）使用 DNS 根据收到地 Join-request 消息中的 JoinEUI 来查找 JS 地 IP 地址（参见第 19 节）。如果 DNS 查询失败，那么 NS 应该（SHALL）在此处终止程序。</p>
<p>对于配置了未标识 JS 的 AppEUI 的 R1.0 [LW10] 终端设备， NS 应该（SHOULD）通过 out-of-band 机制配置 JS 的 IP 地址/主机名。</p>
<p>步骤 3：</p>
<p>NS 向 JS 发送 JoinReq 消息，该消息携带 Join-request 消息的 PHYPayload 、 MACVersion 、 DevEUI 、 DevAddr 、 DLSettings 、 RxDelay 和可选的 CFList 。NS 应该（SHALL）将 MACVersion 的值设置为终端设备和 NS 之间的最高通用版本。</p>
<p>步骤 4：</p>
<p>JS 应该（SHALL）根据 MACVersion 处理 Join-request 消息，并将 JoinAns 发送到携带 Result=Success 的 NS ，带有 Join-accept 消息的 PHYPayload、网络会话密钥（在 R1.1 情况下为 SNwkSIntKey 、 FNwkSIntKey 和 NwkSEncKey ，以及在 R1.0/R1.0.2 终端设备的情况下为 NwkSKey）、加密的 AppSKey 或 SessionKeyID 或两者以及成功时的 Lifetime，还有在失败的情况下 Result=UnknownDevEUI 或 MICFailed（例如，如果 JS 无法识别设备，或者 Join-request 的 MIC 未通过校验）。</p>
<p>JS 可以创建与生成的会话密钥相关联的 SessionKeyID 。</p>
<p>为 R1.1 终端设备生成的 SNwkSIntKey ， FNwkSIntKey ， NwkSEncKey 以及 AppSKey 遵循 LoRaWAN1.1 规范 [LW11]。为 R1.0/R1.0.2 终端设备生成的 NwkSKey 遵循 LoRaWAN1.0 规范 [LW10]。当从 JS 传送到 NS 时，使用 JS 和 AS 之间共享的密钥对 AppSKey 进行加密。</p>
<p>对于 R1.0 [LW10] 终端设备，当 AppEUI 未识别 JS 时， JS 也应（SHALL）处理 Join-request 消息。</p>
<p>步骤 5：</p>
<p>如果收到 JoinAns 消息提示成功，则 NS 应该（SHALL）将接收到的具有 Join-accept 消息的 PHYPayload 转发给终端设备。终端设备在接收到 Join-accept 消息时应（SHALL）生成基于 LoRaWAN 规范 [LW10, LW102, LW11] 的网络会话密钥和 AppSKey 。</p>
<p>步骤 6：</p>
<p>当 NS 收到终端设备上行链路的数据包时， NS 应该（SHALL）发送具有加密的 AppSKey 或 SessionKeyID 或两者的应用有效负载给 AS 。</p>
<p>步骤 7：</p>
<p>当 AS 收到加密的 AppSKey 以及应用程序有效负载时， AS 应（SHALL）使用 JS 和 AS 之间共享的密钥解密 AppSKey ，并使用 AppSKey 解密收到的有效负载。如果 NS 未提供加密的 AppSKey ，则 AS 应（SHALL）继续下一步。</p>
<p>步骤 8：</p>
<p>如果 AS 想要直接从 JS 接收 AppSKey ,则执行此步骤。</p>
<p>AS 应该（SHALL）请求由终端设备的 DevEUI 标识的 AppSKey 和来自 JS 的 SessionKeyID 。使用 JS 和 AS 之间共享的密钥加密 AppSKey 。JS 将加密的 AppSKey 、 DevEUI 和 SessionKeyID 发送给 AS 。然后 AS 应该（SHALL）使用 JS 和 AS 之间共享的密钥解密 AppSKey 。然后， AS 开始使用 AppSKey 来加密和解密应用程序有效负载。</p>
<p>无论 NS 和 JS 属于统一管理域还是它们属于两个单独的管理域时，都可以对委托的终端设备进行 OTA 激活。</p>
<h2 id="9-OTA-终端设备的停用（退出）"><a href="#9-OTA-终端设备的停用（退出）" class="headerlink" title="9. OTA 终端设备的停用（退出）"></a>9. OTA 终端设备的停用（退出）</h2><p>OTA 激活的终端设备的 LoRa 会话也可能因各种原因而终止。例如用户合同到期、恶意终端设备行为等。用于停止会话的过程时退出程序（Exit Procedure)，它是入网程序的对立部分（counter-part）。</p>
<p>没有用于执行退出过程的明确且专用的 LoRaWAN 信令。假设终端设备和后端依赖于应用层信令来执行该过程。触发器和应用层信令的实现细节超出本文档范围。</p>
<p>当 AS 通知了 hNS 执行退出过程时还存在单独的 sNS 时， hNS 应（SHALL）执行切换漫游停止过程（Handover Roaming Stop Procedure)以将 LoRaWAN 会话的终止传达给 sNS 。</p>
<p>成功执行新的入网/重新入网过程的终端设备也终止当前的 LoRaWAN 会话，并且在某种程度上，它可以被视为停用（Deactivation）关联该会话。</p>
<h2 id="10-安全关联"><a href="#10-安全关联" class="headerlink" title="10. 安全关联"></a>10. 安全关联</h2><p>表 t1 显示 LoRaWAN 部署使用的完全关联。一些必须的安全关联将在 LoRaWAN 规范中详细说明，有些则留给部署。</p>
<table>
<thead>
<tr>
<th>终点（End-points）</th>
<th>类型</th>
<th>是否属于 LoRa 规范</th>
<th>用途</th>
<th>生成于（若动态）</th>
<th>密钥名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>ED-JS</td>
<td>静态</td>
<td>范围内</td>
<td>保护 Join/Rejoin</td>
<td>-</td>
<td>AppKey, NwkKey</td>
</tr>
<tr>
<td>ED-NS</td>
<td>动态</td>
<td>范围内</td>
<td>保护 OTA 帧递交</td>
<td>Join 过程</td>
<td>SNwkSIntKey, FNwkSIntKey, NwkSEncKey, NwkSKey</td>
</tr>
<tr>
<td>ED-AS</td>
<td>动态</td>
<td>范围内</td>
<td>保护端对端帧负载的递交</td>
<td>Join 过程</td>
<td>AppSKey</td>
</tr>
<tr>
<td>JS-NS</td>
<td>静态</td>
<td>超范围</td>
<td>保护 Join/Rejoin 以及会话密钥传递</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>AS-JS</td>
<td>静态</td>
<td>范围内</td>
<td>保护 AppSkey 传递</td>
<td>-</td>
<td>ASJSKey</td>
</tr>
<tr>
<td>AS-JS</td>
<td>静态</td>
<td>超范围</td>
<td>委托/退役</td>
<td>-</td>
<td>ASJSKey</td>
</tr>
<tr>
<td>JS-Manufacturer</td>
<td>静态</td>
<td>超范围</td>
<td>保护 AppKey/NwkKey 传递</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>NS-NS</td>
<td>静态</td>
<td>超范围</td>
<td>保护 Join/Rejoin 以及 NS 间帧传递</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>t1. LoRaWAN 安全关联</p>
]]></content>
      <categories>
        <category>LoRaWAN</category>
      </categories>
      <tags>
        <tag>LoRaWAN</tag>
      </tags>
  </entry>
  <entry>
    <title>LoRaWAN Backend Interfaces v1.0 学习 (p1)</title>
    <url>/2019/07/10/LoRaWAN-Backend-Interfaces-v1-0-%E5%AD%A6%E4%B9%A0-p1/</url>
    <content><![CDATA[<p>本文为学习 LoRaWAN 后端接口 v1.0 文档时，顺便翻译所得。文档较长，预计分为多篇。</p>
<p><a href="https://lora-alliance.org/resource-hub/lorawantm-back-end-interfaces-v10" target="_blank" rel="noopener">原文档链接</a></p>
<p>本部分主要介绍网络参考模型。</p>
<a id="more"></a>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>这份文档描述了以下服务间的标准接口和数据流：</p>
<ol>
<li>网络服务器（Network Sever）和入网服务器（Join Server）</li>
<li>入网服务器（Join Server）和应用服务器（Application Server）</li>
<li>漫游流量路由的两个网络服务器（Network Servers)</li>
</ol>
<p>Network Server 和 Application Server 之间的接口超出本文档范围。<br>重点关注本文档中描述的 OTAA（Over-the-Air Activation）及单终端漫游时，网络中多实体间信息流。</p>
<h2 id="2-公约"><a href="#2-公约" class="headerlink" title="2. 公约"></a>2. 公约</h2><p>本文中的关键词（”MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, 以及 “OPTIONAL”）的解释如 <a href="https://tools.ietf.org/html/rfc2119" target="_blank" rel="noopener">RFC 2119</a> 协议描述。</p>
<h2 id="3-网络参考模型（Network-Reference-Model）"><a href="#3-网络参考模型（Network-Reference-Model）" class="headerlink" title="3. 网络参考模型（Network Reference Model）"></a>3. 网络参考模型（Network Reference Model）</h2><p>LoRaWAN 架构网络参考模型如图 f0, f1 所示：</p>
<p><img src="f0.png" alt="Figure 1 LoRaWAN Network Reference Model (NRM), End-Device at home"></p>
<p>f0. 固定终端（End-Device at home）</p>
<p><img src="f1.png" alt="Figure 2 LoRaWAN Network Reference Model (NRM), roaming End-Device"></p>
<p>f1. 漫游终端（roaming End-Device）</p>
<p><strong>终端（End-Device）：</strong></p>
<p>终端是传感器或执行器。它是无线方式通过无线网关连入一个 LoRaWAN 网络的。终端的应用层连接到云端特定的 Application Server（简称：AS）。这个终端的所有应用层载荷（payloads）都会路由到响应的 AS。</p>
<p><strong>无线网关（Radio-Gateway）：</strong></p>
<p>无线网关传递所有接收到的 LoRaWAN 无线数据报到 Network Server（简称：NS）,连接使用 IP 端口。无线网关完全工作在物理层。它的职责是简单解码上行无线数据报并将数据报定向到 NS。相对地，下行时，无线网关简单处理（不解析）传递 NS 的请求报文。</p>
<p><strong>网络服务器（Network Server）：</strong></p>
<p>NS 是终端设备连接的网络，终止于 LoRaWAN MAC 层。它是星型拓扑的中心。</p>
<p>NS 的一般特征：</p>
<ul>
<li>终端地址检查</li>
<li>帧验证和帧计数检查</li>
<li>确认（Acknowledgments）</li>
<li>数据速率适应</li>
<li>响应终端设备的所有 MAC 层请求</li>
<li>传递上行应用数据到合适的 AS</li>
<li>将任何 AS 的下行消息排队到连接上网络的任何终端</li>
<li>在终端和 Join Servers 之间传递 Join-request（入网请求） 和 Join-accept（入网确认）</li>
</ul>
<p>在漫游架构中，一个 NS 可能扮演三个不同的角色，这取决于终端是否处于漫游场景以及涉及的漫游类型。</p>
<p>Serving NS（简称：sNS）控制终端的 MAC 层。</p>
<p>Home NS （简称：hNS）是设备配置（Device Profile)、服务配置（Service Profile）、路由配置（Routing Profile）存储的位置。hNS 将用于入网过程中直接关联 Join Server。它连接到 AS。如果 hNS 和 sNS 分离，他们遵循漫游协议。上下行数据报在 sNS 和 hNS 间传递。</p>
<p>Forwarding NS（简称：fNS）管理着无线网关。当 sNS 和 fNS 分离，他们遵循漫游协议。将有一个或多个 fNS 服务于终端设备。上下行数据报在 fNS 和 sNS 间传递。</p>
<p><strong>入网服务器（Join Server）：</strong></p>
<p>Join Server（简称：JS）处理终端设备的 OTA（Over-the-Air）激活流程。可能有许多 JS 连接到一个 NS，且一个 JS 可能连接多个 NS。</p>
<p>终端设备通过 Join-request 消息中的 JoinEUI 字段发信号通知 JS。每个 JS 被唯一 JoinEUI 值标识。（注意：AppEUI 存在于 LoRaWAN1.0/1.0.2（LW10，LW102） 的 Join-request 中，被重命名未 LoRaWAN1.1（LW11） 中的 JoinEUI 。术语 JoinEUI 被用于指代该规范中 LW10/LW102 终端设备上下文中的 AppEUI 。</p>
<p>JS 知道终端设备的 hNS 标识符，并在漫游过程中将所需信息提供给其他 NS。<br>JS 包含所需信息处理上行入网请求帧并且生成下行入网确认帧。它也执行网络和应用程序会话密钥（session key）的派生。它将终端设备的网络密钥传送到 NS ，将应用会话密钥传送给相应的应用服务器。</p>
<p>为此，JS 应该（SHALL）包含其控制下的每个终端设备的如下信息：</p>
<ul>
<li>DevEUI</li>
<li>AppKey</li>
<li>NwkKey（仅适用于 LW11 终端设备）</li>
<li>hNS 标识</li>
<li>AS 标识</li>
<li>一种首选网络的方法，以防多个网络可以为终端提供服务</li>
<li>终端设备 LoRaWAN 版本（LoRaWAN 1.0，1.0.2 或 1.1）</li>
</ul>
<p>根密钥（root key） NwkKey 和 AppKey 仅可用于 JS 和终端设备，他们不会被发送到 NS 或 AS 。</p>
<p>安全配置（secure provisioning），存储和使用根密钥 NwkKey 和 AppKey 在终端设备和后端是解决方案整体安全性的内在要素。这些留待实施且超出本文档的范畴。然而，该解决方案可包括 SE （Secure Elements 安全要素） 和 HSM （Hardware Security Modules 硬件安全模块）。</p>
<p>这些信息实际如何编程到 JS 中超出本文档范围，可能因 JS 而异。这可以通过例如门户网站或者一组 API 来实现。</p>
<p>JS 和 NS 应该（SHALL）应该能够建立安全通信，提供端点身份验证（end-point authentication），完整性（integrity）和重放保护（replay protection）以及机密性（confidentiality）。JS 还应该（SHALL）能够安全地传递应用会话密钥（AppSKey）给 AS 。</p>
<p>JS 可以连接到多个 AS，一个 AS 可以连接到多个 JS 。</p>
<p>JS 和 AS 应该（SHALL）能建立安全通信，提供端点身份验证（end-point authentication），完整性（integrity）和重放保护（replay protection）以及机密性（confidentiality）。</p>
<p><strong>应用服务器（Application Server）：</strong></p>
<p>AS 处理相关终端设备地所有应用层有效负载（payload），并为最终用户提供应用级服务。它还为连接的终端设备生成所有应用层下行链路有效载荷。</p>
<p>可以有多个 AS 连接到一个 NS ，也可以一个 AS 连接到许多 NS（例如通过多层网络操作终端）。一个 AS 也可以连接多个 JS 。</p>
<p>hNS 基于 DevEUI 路由上行链路到合适的 AS 。</p>
<p>除了前述的网络元素外，LoRaWAN 架构还在这些实体间定义了以下网络接口：</p>
<p>hNS-JS：此接口用于支持 JS 和 NS 之间的入网（激活）过程。</p>
<p>vNS-JS：此接口用于漫游激活过程。它用于检索于终端设备关联的 hNS 和 NetID 。</p>
<p>ED-NS：此接口用于支持终端设备和 NS 之间的 LoRaWAN MAC 层信令和有效载荷传送。</p>
<p>AS-hNS：此接口用于支持应用程序有效载荷的传送以及在 AS 和 NS 之间关联元数据（meta-data）。</p>
<p>hNS-sNS：此接口用于支持 hNS 和 sNS 之间的漫游信令和有效载荷传递。</p>
<p>sNS-fNS：此接口用于支持 sNS 和 fNS 之间的漫游信令和有效载荷传递。</p>
<p>AS-JS：此接口用于将应用会话密钥（AppSKey）从 JS 传送到 AS 。</p>
]]></content>
      <categories>
        <category>LoRaWAN</category>
      </categories>
      <tags>
        <tag>LoRaWAN</tag>
      </tags>
  </entry>
  <entry>
    <title>部署 goproxy 服务</title>
    <url>/2019/06/26/setup-private-goproxy-server/</url>
    <content><![CDATA[<p>上一篇已经实践了在私网环境中配置自签名的证书，并开启 https。</p>
<p>这一切都是为了能在私网中搭建一个方便可用的 Go 集成环境。</p>
<p>Go 在 1.11 版本添加了 Go Module 特性，成为官方推荐的包管理方式。<br><a href="https://github.com/golang/go/wiki/Modules" target="_blank" rel="noopener">详情见官方 wiki</a></p>
<p>与 go mod 同时到来的还有 goproxy ，允许使用代理的方式拉取依赖包。</p>
<a id="more"></a>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>goproxy 解决了几个长期存在的问题：</p>
<ol>
<li>国内网络环境下从 github 拉去依赖包速度很慢</li>
<li>如果开源作者删除了仓库，对应依赖包就无法找到</li>
</ol>
<p>goproxy 代理服务会缓存依赖包版本，不需要重复下载，也不需要担心原库被删除。</p>
<p>有许多开放的代理服务，比如我常用的是 <a href="https://goproxy.io" target="_blank" rel="noopener">https://goproxy.io</a></p>
<p>只需要设置环境变量 <code>GOPROXY=https://goproxy.io</code> 就能享受代理的快捷。</p>
<p>但是公开的 goproxy 服务仅可以访问公开的仓库，对于私有项目或者<br>私网环境，咱们还得自己建。</p>
<h2 id="选型"><a href="#选型" class="headerlink" title="选型"></a>选型</h2><p>有几款不错的 goproxy 项目</p>
<ul>
<li><p><a href="https://github.com/gomods/athens" target="_blank" rel="noopener">gomods/athens</a></p>
</li>
<li><p><a href="https://github.com/goproxyio/goproxy" target="_blank" rel="noopener">goproxyio/goproxy</a></p>
</li>
<li><p><a href="https://github.com/goproxy/goproxy.cn" target="_blank" rel="noopener">goproxy/goproxy.cn</a></p>
</li>
</ul>
<p>虽然 <code>athens</code> star 数最多，配置文件很灵活可配项很多，但是我觉得它很长一段时间都会是 beta 状态，我自己部署也不需要太多定制化。</p>
<p>我最后选择了 <code>goproxyio</code> 的项目，代码不多，也很稳定。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>goproxyio 发布了 docker 镜像，可以很方便地使用 docker 部署 goproxy。</p>
<p>这里我们讲一下源码编译。其实也是相当简单，按照 README 文档，一条命令搞定。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当然你先要装好 <code>go</code> 和 <code>make</code></p>
</blockquote>
<p>linux 下编译完成后就出现了 goproxy 执行文件。</p>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><blockquote>
<p>新版 <code>goproxy</code> 需要调用 <code>go mod</code> 命令，所以部署环境要安装 <code>go 1.12</code> （1.12 版本以后支持在任意目录调用 <code>go mod download</code> 命令）。</p>
</blockquote>
<p>上传 goproxy 执行文件到 linux 主机上，放在任意目录下。</p>
<p>直接 <code>./goproxy</code> 运行，会在 <code>8081</code> 端口上开启代理服务，然后本地开发环境，配置 GOPROXY 环境变量。</p>
<blockquote>
<p>假设内网 linux 主机 ip 地址是 10.0.0.1，请自行替换 ip 地址。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GOPROXY=http://10.0.0.1:8081</span><br></pre></td></tr></table></figure>
<p>再任意 go mod 管理地项目下执行 go get ，你就能看到 goproxy 服务代你请求了目标地址。</p>
<p>如果你配置了 GOPATH 环境变量， goproxy 服务就会缓存到 <code>$GOPATH/pkg/mod</code> 下。</p>
<p>如果你不愿意设置 GOPATH 环境变量，也可以使用 <code>-cacheDir</code> 参数指定缓存目录。</p>
<p>如果你不想使用 <code>8081</code> 端口，可以使用 <code>-listen</code> 参数指定新的端口。</p>
<p>本地网络不好希望加一个公共 goproxy 作代理转发，那么设置 <code>-proxy</code>。</p>
<p>假设私有仓库地址 <code>cvs.private.com</code> 不希望走代理，那么设置 <code>-exclude</code>，配置域名或者完整仓库路径。</p>
<p>更多使用说明见 <code>./goproxy -h</code>。</p>
<h2 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h2><p>仅仅 nohup 的方式启动 goproxy 服务太 low 了，咱们使用 systemd 管理。</p>
<blockquote>
<p>路由模式依赖 <code>go mod -m</code> 命令需要执行目录是 <code>go mod</code> 目录，所以无法使用 systemd 管理。</p>
</blockquote>
<p><del>编写一个 <code>goproxy.service</code> 文件</del><br>项目源码目录下 scripts 下有 service 配置文件，可以直接使用。</p>
<blockquote>
<p>一定要配置 <code>Environment</code> 。</p>
</blockquote>
<details><br><summary>放到 <code>/etc/systemd/system/</code> 目录下</summary><br><br>&gt; 假设程序在 <code>/root/goproxy/goproxy</code>， 请自行替换启动文件路径。<br><br><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=goproxy service</span><br><span class="line"><span class="attr">Documentation</span>=https://goproxy.io</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Environment</span>=PATH=/usr/local/go/bin</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">65536</span></span><br><span class="line"><span class="attr">ExecStart</span>=/root/goproxy/goproxy -cacheDir=/root/go -proxy=https://goproxy.io -exclude=<span class="string">"*.private.com"</span></span><br><span class="line"><span class="attr">KillMode</span>=control-group</span><br><span class="line"><span class="attr">SuccessExitStatus</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attr">Alias</span>=goproxy.service</span><br></pre></td></tr></table></figure><br><br></details>

<p>关于如何编写 service 文件，我推荐一篇不错地<a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" target="_blank" rel="noopener">教程</a></p>
<p>最后启动服务</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">sudo systemctl start goproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># （可选）开启自启</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> goproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">sudo systemctl status goproxy</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://github.com/goproxyio/goproxy" target="_blank" rel="noopener">goproxy.io</a></p>
</li>
<li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-systemctl-to-manage-systemd-services-and-units" target="_blank" rel="noopener">How To Use Systemctl to Manage Systemd Services and Units</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>GOPROXY</tag>
      </tags>
  </entry>
  <entry>
    <title>私网环境启用 https</title>
    <url>/2019/06/26/enable-https-for-private-network/</url>
    <content><![CDATA[<p>本文是搭建私网环境下的 go 自动集成环境的一部分。</p>
<p>go 项目使用 go mod 作依赖包管理，遇到一些问题。<br>对于依赖库是保存在内网仓库的情况，拉取代码会失败，原因是 go mod 获取<br>依赖包版本需要使用 https 请求，而自建的 git 服务没有启用 https 。</p>
<p>如果是传统的 gopath 依赖项目， 只需要 go get -insecure 即可绕过 https 限制，<br>但是这里我们选择用 go mod ，一方面这是 go 官方推荐的方式，也是未来的发展趋势，<br>另一方面是不希望依赖包放在 vendor 目录下一起提交到版本库造成源码目录过于庞大。</p>
<p>接下来讲一讲如何在私网中启用 https， 服务端系统以 CentOS7 为例。</p>
<a id="more"></a>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>为了达到实验目的，先修改本地机器的 host 文件。</p>
<p>web 服务运行在 192.168.20.44 的局域网 IP 的主机上<br>添加一条虚拟的域名映射到这个 IP 。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">192.168.20.44 vcs.private.org</span><br></pre></td></tr></table></figure>
<h2 id="创建-SSL-证书"><a href="#创建-SSL-证书" class="headerlink" title="创建 SSL 证书"></a>创建 SSL 证书</h2><h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建目录用于保存公共证书</span></span><br><span class="line">sudo mkdir /etc/ssl/certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录用于保存私钥文件</span></span><br><span class="line">sudo mkdir /etc/ssl/private</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关键目录，设置访问权限</span></span><br><span class="line">sudo chmod 700 /etc/ssl/private</span><br></pre></td></tr></table></figure>
<h3 id="创建自签名密钥证书对"><a href="#创建自签名密钥证书对" class="headerlink" title="创建自签名密钥证书对"></a>创建自签名密钥证书对</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo openssl req -x509 -nodes -days 365 \</span><br><span class="line">    -newkey rsa:2048 -keyout /etc/ssl/private/selfsigned.key \</span><br><span class="line">    -out /etc/ssl/certs/selfsigned.crt</span><br></pre></td></tr></table></figure>
<h3 id="命令参数解释"><a href="#命令参数解释" class="headerlink" title="命令参数解释"></a>命令参数解释</h3><p><code>openssl</code> 用于创建和管理OpenSSL证书，密钥和其他文件的基本命令行工具。</p>
<p><code>req -x509</code> 表示我们想要使用 X.509 证书签名请求（CSR，certificate signing request）生成签名证书。</p>
<p><code>-nodes</code> 跳过用密码保护证书的选项。</p>
<p><code>-days 365</code> 有效期 365 天。</p>
<p><code>-newkey rsa:2048</code> 同时生成新证书和新密钥，生成 2048 位的 RSA 密钥。</p>
<p><code>-keyout</code> 密钥输出目录。</p>
<p><code>-out</code> 证书输出目录。</p>
<p>接下来会被要求填写一些证书的基本信息，需要注意的一点是<br><code>CommonName</code> 要填写服务相关的域名或者公共 IP 地址。<br>此处咱们填写 <code>vcs.private.org</code></p>
<details><br><br><summary>还可以一条命令完成</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo openssl req -x509 -nodes -days 365 \</span><br><span class="line">    -subj <span class="string">"/C=CN/ST=ZJ/L=HZ/O=private.org/CN=vcs.private.org"</span> \</span><br><span class="line">    -newkey rsa:2048 -keyout /etc/ssl/private/selfsigned.key \</span><br><span class="line">    -out /etc/ssl/certs/selfsigned.crt</span><br></pre></td></tr></table></figure><br><br></details>

<h3 id="创建-Diffie-Hellman-组"><a href="#创建-Diffie-Hellman-组" class="headerlink" title="创建 Diffie-Hellman 组"></a>创建 Diffie-Hellman 组</h3><p>据说用于与客户端协商 PFS (<a href="https://en.wikipedia.org/wiki/Forward_secrecy" target="_blank" rel="noopener">Perfect Forward Secrecy</a>)，能在私钥受损的情况下保证会话密钥不受损害。</p>
<p>创建要几十秒，需要稍微等一下。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这个 DH 组到底有多强大呢，等我学习后再总结下…… Orz</p>
</blockquote>
<h2 id="配置-Nginx-使用-SSL"><a href="#配置-Nginx-使用-SSL" class="headerlink" title="配置 Nginx 使用 SSL"></a>配置 Nginx 使用 SSL</h2><h3 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用 EPEL 库</span></span><br><span class="line">sudo yum install epel-release</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo yum install nginx</span><br><span class="line"><span class="comment"># 开启</span></span><br><span class="line">sudo systemctl start nginx</span><br><span class="line"><span class="comment"># 检查状态</span></span><br><span class="line">systemctl status nginx</span><br></pre></td></tr></table></figure>
<h3 id="防火墙配置（如果未开启了防火墙，可跳过）"><a href="#防火墙配置（如果未开启了防火墙，可跳过）" class="headerlink" title="防火墙配置（如果未开启了防火墙，可跳过）"></a>防火墙配置（如果未开启了防火墙，可跳过）</h3><ul>
<li>firewalld 相关</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo firewall-cmd --add-service=http</span><br><span class="line">sudo firewall-cmd --add-service=https</span><br><span class="line">sudo firewall-cmd --runtime-to-permanent</span><br></pre></td></tr></table></figure>
<ul>
<li>iptables 相关</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo iptables -I INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span><br><span class="line">sudo iptables -I INPUT -p tcp -m tcp --dport 443 -j ACCEPT</span><br></pre></td></tr></table></figure>
<h3 id="添加-TLS-SSL-服务配置块"><a href="#添加-TLS-SSL-服务配置块" class="headerlink" title="添加 TLS/SSL 服务配置块"></a>添加 TLS/SSL 服务配置块</h3><p><code>sudo vim /etc/nginx/conf.d/ssl.conf</code></p>
<p>内容如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 http2 ssl;</span><br><span class="line">    listen [::]:443 http2 ssl;</span><br><span class="line"></span><br><span class="line">    server_name vcs.private.org;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/ssl/certs/selfsigned.crt;</span><br><span class="line">    ssl_certificate_key /etc/ssl/private/selfsigned.key;</span><br><span class="line">    ssl_dhparam /etc/ssl/certs/dhparam.pem;</span><br><span class="line"></span><br><span class="line">    root /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">    location = /404.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考<a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html" target="_blank" rel="noopener">这篇文章</a>添加更多安全性配置</p>
</blockquote>
<h2 id="启用新配置"><a href="#启用新配置" class="headerlink" title="启用新配置"></a>启用新配置</h2><p>先检查配置文件是否有错误</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure>
<p>重载新配置</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo service nginx reload</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl https://vcs.private.org</span><br></pre></td></tr></table></figure>
<p>你会看到报错</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl: (60) Peer<span class="string">'s certificate issuer has been marked as not trusted by the user.</span></span><br><span class="line"><span class="string">More details here: http://curl.haxx.se/docs/sslcerts.html</span></span><br><span class="line"><span class="string">.....</span></span><br></pre></td></tr></table></figure>
<h2 id="更新客户端信任证书"><a href="#更新客户端信任证书" class="headerlink" title="更新客户端信任证书"></a>更新客户端信任证书</h2><p>服务端启用了 https，接下来让客户端接受这个自签署的证书。</p>
<ul>
<li>ArchLinux</li>
</ul>
<p>签署好的 <code>selfsigned.crt</code> 文件复制到 <code>/etc/ca-certificates/trust-source/anchors</code> 目录下<br>运行 <code>sudo update-ca-trust</code>， 没有任何输出即更新成功。</p>
<ul>
<li>CentOS7</li>
</ul>
<p>签署好的 <code>selfsigned.crt</code> 文件复制到 <code>/etc/pki/ca-trust/source/anchors</code> 目录下<br>运行 <code>sudo update-ca-trust extract</code>， 没有任何输出即更新成功。</p>
<ul>
<li>Windows10</li>
</ul>
<p>添加比较麻烦参考<a href="https://reactpaths.com/how-to-get-https-working-in-localhost-development-environment-f17de34af046" target="_blank" rel="noopener">这篇文章</a>。<br>虽然添加完成后 chrome 依旧是不接受这个证书的（应该是浏览器策略的问题），但是<br>cmd 里 curl 验证可以通过。</p>
<p>客户端信任了证书之后，再次 curl 请求就能成功了。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7" target="_blank" rel="noopener">How To Create a Self-Signed SSL Certificate for Nginx on CentOS 7</a></p>
</li>
<li><p><a href="https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html" target="_blank" rel="noopener">Strong SSL Security on nginx</a></p>
</li>
<li><p><a href="https://jlk.fjfi.cvut.cz/arch/manpages/man/update-ca-trust.8" target="_blank" rel="noopener">update-ca-trust</a></p>
</li>
<li><p><a href="https://manuals.gfi.com/en/kerio/connect/content/server-configuration/ssl-certificates/adding-trusted-root-certificates-to-the-server-1605.html" target="_blank" rel="noopener">Adding trusted root certificates to the server</a></p>
</li>
<li><p><a href="https://reactpaths.com/how-to-get-https-working-in-localhost-development-environment-f17de34af046" target="_blank" rel="noopener">How to get HTTPS working in localhost development environment</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>https</tag>
        <tag>TLS</tag>
        <tag>CA</tag>
      </tags>
  </entry>
  <entry>
    <title>Go 调度器如何工作（译）</title>
    <url>/2019/05/15/Go-Scheduler/</url>
    <content><![CDATA[<blockquote>
<p>本文翻译自 Go 核心开发者 Ian Lance Taylor, 在 Quora 上的<a href="https://qr.ae/pNrVMG" target="_blank" rel="noopener">回答</a>。</p>
</blockquote>
<a id="more"></a>
<p>我将概述从 Go 版本 1.7 开始使用的调度程序。</p>
<p>有三个基础数据结构，被称作 G、M 和 P 。G 是 goroutine， M 是操作系统线程， P 是（逻辑）处理单元。</p>
<p>调度器拥有确切的 GOMAXPROCS 数量的 P （GOMAXPROCS 是一个环境变量，并且运行时函数用它来设置程序中的并发度）。为了让一个 M 执行一个 G ，它需要先获取一个 P 。然后运行 G 直到停止。 G 通过诸如 I/O 操作的系统调用、通过阻塞一个 channel 操作、通过调用一个 C 函数、通过被预抢占（pre-empted），或者一些少数情况来停止。一个 G 只能在安全的地方被预抢占，当前实现中只能在代码发生函数调用时发生。</p>
<p>当一个 G 被 channel 操作之类的东西所阻塞时，它会被放进队列中，此时 M 将会寻找另一个可运行的 G 。如果没有可运行的 G ，这个 M 就会释放 P 然后进入休眠。</p>
<p>当一个 G 被系统调用之类的东西所阻塞时，它会释放 P 且继续在 M 上运行。有一个系统监视器线程，每隔一段时间（20us 到 10ms 之间）就会唤醒一次。如果系统监视器线程发现有可运行的 G 和可用的 P ，它就会唤醒一个正在休眠的 M ，或者没有休眠的 M 就启动一个新的。那个 M 将获得 P 并捡起一个可运行的 G 。</p>
<p>当一个 G 完成一次系统调用时，它必须重新获取 P 。如果没有可用的 P ，它将被标记为可运行接着 M 就会休眠。</p>
<p>当一个 channel 操作成功时，它将唤醒另一个 goroutine ，把它标记为可运行，并且如果有可用的 P ，唤醒一个 M 去运行它。</p>
<p>虽然垃圾回收器多数情况下时并发的，但还是有部分情况需要短暂停止所有线程才能安全地转移到回收地下一个阶段。它通过将所有正在运行的 goroutine 标记为预抢占来实现此目的。当它们到达安全地点时， G 和 M 将会休眠。当垃圾回收器时唯一剩下的正在运行的 G 时，它将进入下一阶段，接着唤醒 GOMAXPROCS <a href="#note1"><sup>1</sup></a> 数量的 M ，它们将各自找到可运行的 G 并继续下去。</p>
<p>runtime.Gosched 函数促使 M 将当前的 G 放到可运行 goroutine 列表中，并从那个列表中选取一个新的 G 开始运行。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.quora.com/How-does-the-golang-scheduler-work/answer/Ian-Lance-Taylor" target="_blank" rel="noopener">How does the golang scheduler work?</a></li>
<li><a href="https://studygolang.com/articles/12326" target="_blank" rel="noopener">Go 调度工作机制</a></li>
</ul>
<h2 id="注"><a href="#注" class="headerlink" title="注"></a>注</h2><div id="note1"></div>

<ul>
<li>[1] 原回答中应该是少了个 <code>S</code> 。</li>
</ul>
]]></content>
      <tags>
        <tag>Go</tag>
        <tag>scheduler</tag>
        <tag>translation</tag>
      </tags>
  </entry>
  <entry>
    <title>Try faceswap with Arch Linux</title>
    <url>/2019/04/01/try-faceswap-on-archlinux/</url>
    <content><![CDATA[<h2 id="What-is-faceswap"><a href="#What-is-faceswap" class="headerlink" title="What is faceswap"></a>What is faceswap</h2><p>See <a href="https://github.com/deepfakes/faceswap" target="_blank" rel="noopener">deepfakes/faceswap</a></p>
<p>Seems a little bit difficult to use it.</p>
<p>But worth to give it a try.</p>
<a id="more"></a>
<h2 id="Make-it-work"><a href="#Make-it-work" class="headerlink" title="Make it work"></a>Make it work</h2><h3 id="Install-anaconda"><a href="#Install-anaconda" class="headerlink" title="Install anaconda"></a>Install anaconda</h3><blockquote>
<p>If you don’t have <code>yay</code>, check <a href="http://www.findshank.com/2018/06/18/Install-yaourt-on-Arch-Linux/">this</a> post.</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yay -S anaconda</span><br></pre></td></tr></table></figure>
<h3 id="Create-a-conda-virtual-environment"><a href="#Create-a-conda-virtual-environment" class="headerlink" title="Create a conda virtual environment"></a>Create a conda virtual environment</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">conda create -n faceswap python=3.6</span><br></pre></td></tr></table></figure>
<blockquote>
<p>python3.6 is recommended here.</p>
</blockquote>
<h3 id="Install-Nvidia-driver-and-cuda-support"><a href="#Install-Nvidia-driver-and-cuda-support" class="headerlink" title="Install Nvidia driver and cuda support"></a>Install Nvidia driver and cuda support</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yay -S nvidia nvidia-utils cuda</span><br></pre></td></tr></table></figure>
<blockquote>
<p>We need cuda-10.0 here! If not match this version. try <code>downgrade</code></p>
</blockquote>
<details><br><br><summary>How to downgrade?</summary><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yay -S downgrade</span><br><span class="line">downgrade cudnn</span><br></pre></td></tr></table></figure><br><br></details>

<h3 id="Add-cudnn-to-cuda"><a href="#Add-cudnn-to-cuda" class="headerlink" title="Add cudnn to cuda"></a>Add cudnn to cuda</h3><p>Download cuDNN-7.5 for cuda-10.0 on <a href="https://developer.nvidia.com/cudnn" target="_blank" rel="noopener">official site</a>.</p>
<blockquote>
<p>You neet to register and login first.</p>
</blockquote>
<p>Then unzip the <code>cudnn-10.0-linux-x64-v7.5.0.56.tgz</code> file to <code>/opt/cuda</code>.</p>
<h3 id="Get-faceswap-source-code-and-install-it"><a href="#Get-faceswap-source-code-and-install-it" class="headerlink" title="Get faceswap source code and install it"></a>Get faceswap source code and install it</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/deepfakes/faceswap.git</span><br><span class="line"><span class="built_in">cd</span> faceswap</span><br><span class="line"></span><br><span class="line"><span class="comment"># active conda virtual environment</span></span><br><span class="line"><span class="built_in">source</span> activate faceswap</span><br><span class="line"></span><br><span class="line"><span class="comment"># install</span></span><br><span class="line">python setup.py</span><br></pre></td></tr></table></figure>
<details><br><br><summary>dlib problem?</summary><br><br>You may got <code>dlib</code> problem when you run faceswap.<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># replace blas with openblas</span></span><br><span class="line">sudo pacman -S openblas</span><br><span class="line"></span><br><span class="line"><span class="comment"># get dlib source code</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/davisking/dlib.git</span><br><span class="line"><span class="built_in">cd</span> dlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># active conda virtual environment</span></span><br><span class="line"><span class="built_in">source</span> activate faceswap</span><br><span class="line"></span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><br><br></details>

<h3 id="play-with-faceswap"><a href="#play-with-faceswap" class="headerlink" title="play with faceswap"></a>play with faceswap</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># try gui</span></span><br><span class="line">python faceswap.py gui</span><br></pre></td></tr></table></figure>
<p><img src="Screenshot.png" alt="screenshot"></p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a href="https://github.com/deepfakes/faceswap/blob/master/INSTALL.md" target="_blank" rel="noopener">INSTALL.md</a></li>
<li><a href="https://uoa-eresearch.github.io/eresearch-cookbook/recipe/2014/11/20/conda/" target="_blank" rel="noopener">Create virtual environments for python with conda</a></li>
<li><a href="https://medium.com/@mimoralea/getting-started-with-nvidia-gpu-anaconda-tensorflow-and-keras-on-arch-linux-8f5f2868a455" target="_blank" rel="noopener">Getting Started With NVIDIA GPU, Anaconda, TensorFlow and Keras on Arch Linux</a></li>
<li><a href="https://www.ostechnix.com/downgrade-package-arch-linux/" target="_blank" rel="noopener">How To Downgrade A Package In Arch Linux</a></li>
</ul>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
        <tag>faceswap</tag>
      </tags>
  </entry>
  <entry>
    <title>Install Arch Linux again</title>
    <url>/2019/03/31/Install-Arch-Linux-again/</url>
    <content><![CDATA[<h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>Got a new 256G nvme ssd hard drive.</p>
<p>Install Arch Linux again.</p>
<a id="more"></a>
<h1 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h1><p>Download latest ISO file <a href="https://www.archlinux.org/download/" target="_blank" rel="noopener">here</a>.</p>
<p>Check md5 with tools. e.g. <code>md5sum</code>  on linux.</p>
<p>Write ISO file in your usb driver.</p>
<blockquote>
<p>select <code>GPT</code> for EFI only</p>
</blockquote>
<p>Plug in you usb drive and reboot into it.</p>
<h1 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># list all disks and partitions</span></span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># my new ssd is `nvme0n1`</span></span><br><span class="line"><span class="comment"># make partition table with `cfdisk`</span></span><br><span class="line">cfisk /dev/nvme0n1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 512M EFI file system --&gt; nvme0n1p1</span></span><br><span class="line"><span class="comment"># 218G Linux file system --&gt; nvme0n1p2</span></span><br><span class="line"><span class="comment"># 20G swap space --&gt; nvme0n1p3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># write then quit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># format new partitions</span></span><br><span class="line">mkfs.fat -F32 /dev/nvme0n1p1</span><br><span class="line">mkfs.ext4 /dev/nvme0n1p2</span><br><span class="line">mkswap /dev/nvme0n1p3</span><br><span class="line">swapon /dev/nvme0n1p3</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount to /mnt</span></span><br><span class="line">mount /dev/nvme0n1p2 /mnt</span><br><span class="line">mkdir -p /mnt/boot</span><br><span class="line">mount /dev/nvme0n1p1 /mnt/boot</span><br></pre></td></tr></table></figure>
<h1 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h1><p>If your network special as China, I recommended you change pacman mirror first.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/pacman.d</span><br><span class="line">mv ./mirrorlist ./mirrorlist.bak</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Server = http://mirrors.163.com/archlinux/$repo/os/$arch'</span> &gt; ./mirrorlist</span><br></pre></td></tr></table></figure>
<p>Then follow the pase.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Update you pacman database</span></span><br><span class="line">pacman -Syy</span><br><span class="line"><span class="comment"># Install base and dev-base</span></span><br><span class="line">pacstrap -i /mnt base base-devel</span><br><span class="line"><span class="comment"># Type enter enter enter ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate fstab</span></span><br><span class="line">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># Change root</span></span><br><span class="line">arch-chroot /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment"># set timezone, I live in China, so I use this timezone.</span></span><br><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"></span><br><span class="line"><span class="comment"># set localtime instead of UTC time, I want my windows have same time set.</span></span><br><span class="line">hwclock --systohc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install vim first</span></span><br><span class="line">pacman -S vim</span><br><span class="line"></span><br><span class="line"><span class="comment"># Localization</span></span><br><span class="line">vim /etc/locale.gen</span><br><span class="line"><span class="comment"># uncommit follow lines and save</span></span><br><span class="line"><span class="comment">#en_US.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.GBK GBK</span></span><br><span class="line"><span class="comment">#zh_CN.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.GB2312</span></span><br><span class="line">locale-gen</span><br><span class="line"><span class="comment"># set default locale</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'LANG=en_US.UTF-8'</span> &gt; /etc/locale.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Network</span></span><br><span class="line"><span class="built_in">echo</span> HOSTNAME &gt; /etc/hostname</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'127.0.0.1 localhost'</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'::1       localhost'</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'127.0.1.1 HOSTNAME.localdomain    HOSTNAME'</span>  &gt;&gt;/etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># dhcpcd enable</span></span><br><span class="line">systemctl <span class="built_in">enable</span> dhcpcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initramfs</span></span><br><span class="line">mkinitcpio -p linux</span><br><span class="line"></span><br><span class="line"><span class="comment"># set root password</span></span><br><span class="line">passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Boot loader install intel mocro-code</span></span><br><span class="line">pacman -S intel-ucode</span><br><span class="line"></span><br><span class="line"><span class="comment"># use grub for boot manage</span></span><br><span class="line">pacman -S grub efibootmgr os-prober</span><br><span class="line">grub-install --efi-directory=/boot --bootloader-id=ArchLinux --recheck</span><br><span class="line"></span><br><span class="line"><span class="comment"># If your windows boot loader in other EFI partition, you can mount the partition,</span></span><br><span class="line"><span class="comment"># and copy `Boot` and `Microsoft` to your /boot/EFI/, otherwise, grub can not</span></span><br><span class="line"><span class="comment"># find your windows boot loader.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set default boot on last saved one</span></span><br><span class="line">vim /etc/default/grub</span><br><span class="line"><span class="comment"># GRUB_DEFAULT=saved</span></span><br><span class="line"><span class="comment"># GRUB_SAVEDEFAULT="true"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate grub.cfg</span></span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># install more apps</span></span><br><span class="line">pacman -S iw wpa_supplicant dialog <span class="comment"># wifi support</span></span><br><span class="line">pacman -S ttf-dejavu wqy-microhei wqy-zenhei <span class="comment"># font support</span></span><br><span class="line">pacman -S alsa-utils <span class="comment"># sound</span></span><br><span class="line">pacman -S dosfstools <span class="comment"># support NTFS usb driver</span></span><br><span class="line">pacman -S zsh openssh</span><br><span class="line"></span><br><span class="line"><span class="comment"># exit, unmount and reboot</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">umount -R /mnt</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h1 id="After-Install"><a href="#After-Install" class="headerlink" title="After Install"></a>After Install</h1><h2 id="check-network"><a href="#check-network" class="headerlink" title="check network"></a>check network</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># check if your network interfaces</span></span><br><span class="line">ip link</span><br><span class="line"><span class="comment"># if state is DOWN, maybe you dhcpcd not run</span></span><br><span class="line">systemctl start dhcpcd &amp;&amp; systemctl <span class="built_in">enable</span> dhcpcd</span><br></pre></td></tr></table></figure>
<h2 id="new-sudo-user"><a href="#new-sudo-user" class="headerlink" title="new sudo user"></a>new sudo user</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># then add a new user, my username is shank</span></span><br><span class="line">useradd -m -g users -s /bin/zsh shank</span><br><span class="line"><span class="comment"># new passord for new user</span></span><br><span class="line">passwd shank</span><br><span class="line"><span class="comment"># set new user in sudo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'shank ALL=(ALL) ALL'</span> &gt; /etc/sudoers.d/shank</span><br></pre></td></tr></table></figure>
<h2 id="dual-video-card-driver"><a href="#dual-video-card-driver" class="headerlink" title="dual video card driver"></a>dual video card driver</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># check you video card</span></span><br><span class="line">lspci | grep VGA</span><br><span class="line"><span class="comment"># found my NVIDIA GTX 1060 here</span></span><br><span class="line"><span class="comment"># install driver for video card</span></span><br><span class="line">pacman -S mesa vulkan-intel</span><br><span class="line"><span class="comment"># pacman -S xf86-video-intel # often not recommended</span></span><br><span class="line">pacman -S nvidia</span><br><span class="line">pacman -S nvidia-libgl</span><br><span class="line">pacman -S xorg-xrandr</span><br><span class="line">nvidia-xconfig</span><br></pre></td></tr></table></figure>
<h2 id="desktop-environment"><a href="#desktop-environment" class="headerlink" title="desktop environment"></a>desktop environment</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Install an desktop manager</span></span><br><span class="line">sudo pacman -S sddm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install an desktop environment</span></span><br><span class="line">sudo pacman -S gnome</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable the desktop manager</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> sddm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install NetworkManager</span></span><br><span class="line">sudo pacman -S networkmanager</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable the NetworkManager</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> NetworkManager</span><br><span class="line"></span><br><span class="line"><span class="comment"># then reboot</span></span><br><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>
<h2 id="install-yay"><a href="#install-yay" class="headerlink" title="install yay"></a>install yay</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S git</span><br><span class="line">git <span class="built_in">clone</span> https://aur.archlinux.org/yay.git</span><br><span class="line"><span class="built_in">cd</span> yay</span><br><span class="line">makepkg -si</span><br></pre></td></tr></table></figure>
<h2 id="more-apps"><a href="#more-apps" class="headerlink" title="more apps"></a>more apps</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S \</span><br><span class="line">ibus ibus-qt ibus-rime \</span><br><span class="line">ttf-inconsolata noto-fonts-cjk \</span><br><span class="line">powerline-fonts ttf-font-awesome \</span><br><span class="line">net-tools dnsutils inetutils iproute2 \</span><br><span class="line">zsh terminator thunar \</span><br><span class="line">vlc alsa-utils deadbeef cmus telegram-desktop \</span><br><span class="line">goldendict mplayer \</span><br><span class="line">go git wget openssh unzip unrar \</span><br><span class="line">ntfs-3g deluge shadowsocks shadowsocks-qt5 \</span><br><span class="line">gnome gnome-tweaks \</span><br><span class="line">numix-gtk-theme</span><br><span class="line"></span><br><span class="line">yay -S numix-circle-icon-theme-git \</span><br><span class="line">capitaine-cursors \</span><br><span class="line">google-chrome \</span><br><span class="line">visual-studio-code-bin \</span><br><span class="line">foxitreader \</span><br><span class="line">anaconda</span><br></pre></td></tr></table></figure>
<h2 id="more-operations"><a href="#more-operations" class="headerlink" title="more operations"></a>more operations</h2><h3 id="set-oh-my-zsh"><a href="#set-oh-my-zsh" class="headerlink" title="set oh-my-zsh"></a>set oh-my-zsh</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="set-anaconda"><a href="#set-anaconda" class="headerlink" title="set anaconda"></a>set anaconda</h3><p>Don’t set anaconda in your path, will occur many problems!<br>So we just set <code>alias</code> to make it easy for activate conda environment.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ~/.zshrc</span></span><br><span class="line"><span class="built_in">alias</span> activate-env=<span class="string">"source /opt/anaconda/bin/activate"</span></span><br><span class="line"><span class="built_in">alias</span> deactivate-env=<span class="string">"source /opt/anaconda/bin/deactivate"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ease access to conda</span></span><br><span class="line">sudo ln /opt/anaconda/bin/conda /usr/bin/conda</span><br></pre></td></tr></table></figure>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ul>
<li><a href="https://wiki.archlinux.org/index.php/EFI_system_partition" target="_blank" rel="noopener">Installation guide</a></li>
</ul>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title>Install PostgreSQL on CentOS7</title>
    <url>/2019/03/14/install-postgresql-on-centos7/</url>
    <content><![CDATA[<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><blockquote>
<p>if you want install latest version check <a href="https://www.postgresql.org/download/" target="_blank" rel="noopener">official site</a></p>
</blockquote>
<p>I will install postgres9.6 for CentOS7.</p>
<blockquote>
<p>default version of postgres in CentOS7 rpm is not recommanded, I need some new features in postgres9.5+.</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yum install https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-7-x86_64/pgdg-redhat96-9.6-3.noarch.rpm</span><br><span class="line">sudo yum install postgresql96-server postgresql96-contrib</span><br><span class="line"></span><br><span class="line"><span class="comment"># initialize the database</span></span><br><span class="line">sudo postgresql96-setup initdb</span><br></pre></td></tr></table></figure>
<h1 id="Config-for-remote-access"><a href="#Config-for-remote-access" class="headerlink" title="Config for remote access"></a>Config for remote access</h1><p>Set listen port to wildcard</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># sudo vim /var/lib/pgsql/9.6/data/postgresql.conf</span><br><span class="line">listen_addresses = &apos;*&apos;</span><br></pre></td></tr></table></figure>
<p>Change HBA (host-based authentication) configuration</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># sudo vim /var/lib/pgsql/9.6/data/pg_hba.conf</span><br><span class="line">host    all             all             0.0.0.0/0            md5</span><br></pre></td></tr></table></figure>
<h1 id="Start-server"><a href="#Start-server" class="headerlink" title="Start server"></a>Start server</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> postgresql-9.6</span><br><span class="line">sudo systemctl start postgresql-9.6</span><br><span class="line"></span><br><span class="line"><span class="comment"># check listen port</span></span><br><span class="line">ss -ant | grep 5432</span><br></pre></td></tr></table></figure>
<h1 id="Login-default-role"><a href="#Login-default-role" class="headerlink" title="Login default role"></a>Login default role</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo -i -u postgres</span><br><span class="line"><span class="comment"># to access PostgreSQL prompt</span></span><br><span class="line">psql</span><br><span class="line"><span class="comment"># for quit PostgreSQL prompt</span></span><br><span class="line">\q</span><br></pre></td></tr></table></figure>
<h1 id="Create-a-new-role"><a href="#Create-a-new-role" class="headerlink" title="Create a new role"></a>Create a new role</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">createuser --interactive</span><br></pre></td></tr></table></figure>
<blockquote>
<p>My new role is <code>rwuser</code></p>
</blockquote>
<h1 id="Create-a-new-database"><a href="#Create-a-new-database" class="headerlink" title="Create a new database"></a>Create a new database</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">createdb test1</span><br></pre></td></tr></table></figure>
<h1 id="Login-new-role"><a href="#Login-new-role" class="headerlink" title="Login new role"></a>Login new role</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># access PostgreSQL prompt with new role</span></span><br><span class="line">sudo su -c <span class="string">"psql -d test1"</span> - rwuser</span><br><span class="line"><span class="comment"># type following command in  PostgreSQL prompt</span></span><br><span class="line">\password</span><br><span class="line"><span class="comment"># then set your new password</span></span><br></pre></td></tr></table></figure>
<p>You can use navicat to connect pgsql later.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7#create-a-new-role" target="_blank" rel="noopener">How To Install and Use PostgreSQL on CentOS 7</a></li>
<li><a href="https://www.liquidweb.com/kb/change-a-password-for-postgresql-on-linux-via-command-line/" target="_blank" rel="noopener">Change a Password for PostgreSQL on Linux via Command Line</a></li>
<li><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">Official install guide</a></li>
</ul>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>CentOS7</tag>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>For-Select loop in Go</title>
    <url>/2019/03/14/for-select-in-go/</url>
    <content><![CDATA[<p>Simple <code>break</code> in for-select loop, will not break out of <code>for</code> loop. You should use <code>break label</code>.</p>
<a id="more"></a>
<h1 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h1><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    one := time.After(time.Second * <span class="number">2</span>)</span><br><span class="line">    two := time.After(time.Second * <span class="number">4</span>)</span><br><span class="line">    three := time.After(time.Second * <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="comment">//fmt.Println("out of for") // anything here will invoke error</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"head"</span>)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-one:</span><br><span class="line">            fmt.Println(<span class="string">"one"</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> &lt;-two:</span><br><span class="line">            fmt.Println(<span class="string">"two"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> &lt;-three:</span><br><span class="line">            fmt.Println(<span class="string">"three"</span>)</span><br><span class="line">            <span class="keyword">break</span> out</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">"tail"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//out: // break label must define before for loop</span></span><br><span class="line">    fmt.Println(<span class="string">"in the end"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://play.golang.org/p/vz_uQb4nhPz" target="_blank" rel="noopener">Playground</a></p>
<h1 id="more"><a href="#more" class="headerlink" title="more"></a>more</h1><p><a href="https://golang.org/ref/spec#Break_statements" target="_blank" rel="noopener">Break statement</a></p>
]]></content>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Solve ridiculous problem in Golang</title>
    <url>/2018/10/30/Solve-ridiculous-problem-in-Golang/</url>
    <content><![CDATA[<h1 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">panic: runtime error: invalid memory address or nil pointer dereference</span><br><span class="line">[signal SIGSEGV: segmentation violation code=0x1 addr=0x10 pc=0x6e2bea]</span><br><span class="line"></span><br><span class="line">goroutine 10233 [running]:</span><br><span class="line">.../backend.(*ActionBackend).ReceiveTXPacket(0xc42968f940)</span><br><span class="line">        /.../backend/actionbackend.go:102 +0x2a</span><br><span class="line">.../backend.NewActionBackend.func1(0xc42968f940)</span><br><span class="line">        /.../backend/actionbackend.go:45 +0x2b</span><br><span class="line">created by .../backend.NewActionBackend</span><br><span class="line">        /.../backend/actionbackend.go:44 +0x89</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="solve"><a href="#solve" class="headerlink" title="solve"></a>solve</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -n 65536</span><br></pre></td></tr></table></figure>
<h1 id="why"><a href="#why" class="headerlink" title="why"></a>why</h1><p>First, I try to find some logic problem in panic lines. But nothing should be modified.</p>
<p>Then I reconigized my program need to create 3000 connection. (It’s a stress test program.)</p>
<p>While I type this <code>ulimit -n</code>, it shows the file-size writing limit is <code>1024</code>. So … boooom!</p>
]]></content>
      <tags>
        <tag>Linux</tag>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title>Install mysql on wsl</title>
    <url>/2018/09/15/Install-mysql-on-wsl/</url>
    <content><![CDATA[<h1 id="How"><a href="#How" class="headerlink" title="How"></a>How</h1><ol>
<li><p>Install a distro in windows store.</p>
<blockquote>
<p>I got ubuntu18.04LTS here.</p>
</blockquote>
</li>
<li><p>Change sources.list</p>
<p> backup first.</p>
 <a id="more"></a>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class="line">sudo vi /etc/apt/sources.list</span><br></pre></td></tr></table></figure>
<p> run these commands in vi to replace url.</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">:%s/archive.ubuntu.com/mirrors.163.com</span><br><span class="line">:%s/security.ubuntu.com/mirrors.163.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>Install mysql</p>
<blockquote>
<p>meet some problem when install mariadb, so I change to mysql.</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt install mysql-server</span><br><span class="line">sudo service mysql start</span><br><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>Adjusting User Authentication and Privileges</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mysql</span><br><span class="line"><span class="comment"># after enter mysql, check which authentication method each of your MySQL user accounts use with the following command</span></span><br><span class="line"><span class="comment"># SELECT user,authentication_string,plugin,host FROM mysql.user;</span></span><br><span class="line">ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'YourPassword'</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-mysql-on-ubuntu-18-04" target="_blank" rel="noopener">How To Install MySQL on Ubuntu 18.04</a></p>
]]></content>
      <categories>
        <category>WSL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>WSL</tag>
      </tags>
  </entry>
  <entry>
    <title>How to revert Singly Linked List</title>
    <url>/2018/08/17/How-to-revert-Linked-List/</url>
    <content><![CDATA[<p>Here is the struct of Singly Linked List and Print method:</p>
<a id="more"></a>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Link</span> &#123;</span></span><br><span class="line">  Link* next;</span><br><span class="line">  DType data;</span><br><span class="line">  Link(DType data) &#123; <span class="keyword">this</span>-&gt;data = data; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Print</span><span class="params">(Link* head)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (head != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; head-&gt;data &lt;&lt; <span class="string">' '</span>;</span><br><span class="line">    head = head-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Two ways to revert the Singly Linked List.</p>
<ul>
<li>Non-Recursion version</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Link* <span class="title">Reverse</span><span class="params">(Link* head)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  Link *r, *p, *q;</span><br><span class="line">  p = head;</span><br><span class="line">  q = head-&gt;next;</span><br><span class="line">  head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">while</span> (q != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    r = q-&gt;next;</span><br><span class="line">    q-&gt;next = p;</span><br><span class="line">    p = q;</span><br><span class="line">    q = r;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Recursion version</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Link* <span class="title">Reverse2</span><span class="params">(Link* head, Link*&amp; nhead)</span> </span>&#123;</span><br><span class="line">  nhead = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">if</span> (head-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    nhead = head;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">  &#125;</span><br><span class="line">  Link* tail = Reverse2(head-&gt;next, nhead);</span><br><span class="line">  tail-&gt;next = head;</span><br><span class="line">  head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main function &amp; result:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Link *root, *p;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">      root = p = <span class="keyword">new</span> Link(i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p-&gt;next = <span class="keyword">new</span> Link(i);</span><br><span class="line">      p = p-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Print(root);</span><br><span class="line">  <span class="comment">// 0 1 2 3 4 5 6 7 8 9</span></span><br><span class="line"></span><br><span class="line">  root = Reverse(root);</span><br><span class="line">  Print(root);</span><br><span class="line">  <span class="comment">// 9 8 7 6 5 4 3 2 1 0</span></span><br><span class="line"></span><br><span class="line">  Link* nroot;</span><br><span class="line">  Reverse2(root, nroot);</span><br><span class="line">  Print(nroot);</span><br><span class="line">  <span class="comment">// 0 1 2 3 4 5 6 7 8 9</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>algorithm</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>LinkdList</tag>
      </tags>
  </entry>
  <entry>
    <title>Use VirtualBox to access OS on hard drive</title>
    <url>/2018/08/15/Use-VirtualBox-to-access-OS-on-hard-drive/</url>
    <content><![CDATA[<h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>虽然已经主要在用Arch了，但是最近有朋友让我帮他改改cpp代码。<del>代码拿过来一看，好家伙，浓浓的windows气息，没办法人家公司就是做windows桌面应用的。</del></p>
<p>那么问题来了，我不想重启电脑切换系统，还要用windows给他调代码，怎么办？</p>
<p>用虚拟机吧，传统流程：新建一个虚拟机-&gt;装系统-&gt;搭开发环境-&gt;调代码(-&gt;删除虚拟机)。<strong>麻烦</strong></p>
<a id="more"></a>
<h1 id="How"><a href="#How" class="headerlink" title="How"></a>How</h1><p>既然虚拟机也要用虚拟硬盘文件装系统，何不挂载装有系统的硬盘直接用呢？ Google一下，这是可以的。</p>
<blockquote>
<p>注意：运行虚拟机的硬盘最好与虚拟机挂载系统的硬盘分开，防止未知错误；重要数据最好备份下。</p>
</blockquote>
<p>下面主要按照我的实际情况讲，我电脑里双系统分在两块硬盘上，win 在 /dev/sda，linux 在 /dev/sdb，这是最理想的，互不干扰。</p>
<ol>
<li><p>root 权限下运行 VirtualBox</p>
</li>
<li><p>新建一个windows虚拟机，添加虚拟硬盘时选择<code>Do not add a virtual hard drive</code>(不添加虚拟硬盘)，其他配置照常，然后保存。</p>
</li>
<li><p>输入以下命令创建映射真实硬盘的虚拟硬盘文件：</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo VBoxManage internalcommands createrawvmdk -filename <span class="string">"&lt;/path/to/file&gt;.vmdk"</span> -rawdisk /dev/sda</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>&lt;/path/to/file&gt;.vmdk</code>换成你要保存虚拟硬盘的文件位置，例如 <code>~/vbox/win.vmdk</code>。<br><code>/dev/sda</code>是我win的安装盘，你可以用<code>sudo fdisk -l</code>查看你的系统所在位置。<br>以上命令是可以指定只映射某几个分区的，具体命令自己Google。</p>
</blockquote>
</li>
<li><p>设置windows虚拟机的存储设备（Settings-&gt;Storage-&gt;Add Hard Disk-&gt;Choose existing disk），找到上一步生成的vmdk文件添加即可。</p>
</li>
<li><p>因为我的windows启动方式是EFI，所以在Settings-&gt;System中勾上<code>Enable EFI(special OSes only)</code>。</p>
</li>
</ol>
<p>至此，可以启动了。</p>
<p><img src="result.gif" alt="result"></p>
<blockquote>
<p>顺便使用下Linux下的gif制作器 <code>peek</code></p>
</blockquote>
<h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1><p>[Using a Physical Hard Drive with a VirtualBox VM]<a href="https://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html" target="_blank" rel="noopener">https://www.serverwatch.com/server-tutorials/using-a-physical-hard-drive-with-a-virtualbox-vm.html</a></p>
]]></content>
      <tags>
        <tag>VirtualBox</tag>
      </tags>
  </entry>
  <entry>
    <title>Downgrade vscode to 1.25.1-3</title>
    <url>/2018/08/15/Downgrade-vscode-to-1-25-1-3/</url>
    <content><![CDATA[<h1 id="Sunny-day"><a href="#Sunny-day" class="headerlink" title="Sunny day"></a>Sunny day</h1><p>Happy to update vscode to 1.26.0-2 this morning.</p>
<a id="more"></a>
<blockquote>
<p>How to update?</p>
</blockquote>
<p>Just type</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S visual-studio-code-bin</span><br></pre></td></tr></table></figure>
<h1 id="Awful-user-experience"><a href="#Awful-user-experience" class="headerlink" title="Awful user experience"></a>Awful user experience</h1><p>This new <a href="https://code.visualstudio.com/updates/v1_26#_custom-title-bar-and-menus-for-windowslinux" target="_blank" rel="noopener">feature</a> driven me upgrade to this version.</p>
<p>But I would say it’s a bad idea.</p>
<ol>
<li>Title bar is more wide on linux. (ugly)</li>
<li>Title text not align center on top. (too ugly)</li>
</ol>
<p>The feature on UI I can choose to ignore it. Because it’s disabled in default settings.</p>
<p><strong>BUT</strong> I can’t tolerate the new bug. If I try to <code>Open Folder...[Ctrl+K Ctrl+O]</code>, the editor will crash.(OS: Arch Linux x86_64, Kernel: 4.17.14-arch1-1-ARCH, WM: i3)</p>
<p>so I need to downgrade.</p>
<h1 id="How-to-downgrade"><a href="#How-to-downgrade" class="headerlink" title="How to downgrade"></a>How to downgrade</h1><p>I installed vscode via <code>yaourt</code>, but it’s not support downgrade option. So I google this problem.</p>
<p>Someone said <code>Old packages are normally kept in: /var/cache/pacman/pkg/</code></p>
<p>So check the directoy by <code>ls -l /var/cache/pacman/pkg/visual-studio-code-*</code>, I got this</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">-rw-r--r-- 1 root root 47360116 Jul 13 18:20 /var/cache/pacman/pkg/visual-studio-code-bin-1.25.1-1-x86_64.pkg.tar.xz</span><br><span class="line">-rw-r--r-- 1 root root 47352676 Aug  5 02:39 /var/cache/pacman/pkg/visual-studio-code-bin-1.25.1-3-x86_64.pkg.tar.xz</span><br><span class="line">-rw-r--r-- 1 root root 56026160 Aug 14 18:36 /var/cache/pacman/pkg/visual-studio-code-bin-1.26.0-2-x86_64.pkg.tar.xz</span><br></pre></td></tr></table></figure>
<p>Soooo lucky!</p>
<p>Just use pacman to reinstall the pkg</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -U /var/cache/pacman/pkg/visual-studio-code-bin-1.25.1-3-x86_64.pkg.tar.xz</span><br></pre></td></tr></table></figure>
<p><em>Awsome <code>pacman</code>, save my life!</em></p>
<h1 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h1><p><a href="https://bbs.archlinux.org/viewtopic.php?id=95959" target="_blank" rel="noopener">how to downgrade via yaourt</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>VS Code</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>screen: Cannot open your terminal &#39;/dev/pts/1&#39;</title>
    <url>/2018/07/25/screen-Cannot-open-your-terminal-dev-pts-1/</url>
    <content><![CDATA[<h1 id="What-happened"><a href="#What-happened" class="headerlink" title="What happened"></a>What happened</h1><p>I bought a Tencent Cloud CVM to hold my DST server few days ago.</p>
<a id="more"></a>
<p>Use screen to run <code>server.sh</code> is perfect. I login <code>UserA</code> to run screen session. Then, use another device to login <code>UserB</code>. When I use <code>UserB</code> to login <code>UserA</code> and run <code>screen -r</code> to continue my screen session, following error occur:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Cannot open your terminal <span class="string">'/dev/pts/1'</span> - please check.</span><br></pre></td></tr></table></figure>
<h1 id="How-to-Fix"><a href="#How-to-Fix" class="headerlink" title="How to Fix"></a>How to Fix</h1><p>After login in <code>UserB</code>, run this to get a new <code>tty</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">script /dev/null</span><br></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://blog.sina.com.cn/s/blog_704836f401010osn.html" target="_blank" rel="noopener">polygun2000’s blog</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Screen</tag>
      </tags>
  </entry>
  <entry>
    <title>Failed to delete using Trash in vscode</title>
    <url>/2018/06/18/Failed-to-delete-using-Trash-in-vscode/</url>
    <content><![CDATA[<h1 id="Update-on-2018-07-25"><a href="#Update-on-2018-07-25" class="headerlink" title="Update on 2018-07-25"></a>Update on 2018-07-25</h1><h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><p>OS: Arch linux<br>Desktop: i3 4.15.0.1<br>VScode version: 1.25.1</p>
<a id="more"></a>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>VScode base on electron, electron will call <code>gvfs-trash</code> to move file to trash.</p>
<p>If you type <code>gvfs-trash</code> in commandline , you may got this problem:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">This tool has been deprecated, use <span class="string">'gio trash'</span> instead.</span><br><span class="line">See <span class="string">'gio help trash'</span> <span class="keyword">for</span> more info.</span><br></pre></td></tr></table></figure>
<h2 id="Solve"><a href="#Solve" class="headerlink" title="Solve"></a>Solve</h2><p>add this to you environment:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> ELECTRON_TRASH=gio</span><br></pre></td></tr></table></figure>
<h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><p><a href="https://github.com/Microsoft/vscode/issues/13189" target="_blank" rel="noopener">Linux: Unable to move file to trash upon delete (#13189)</a></p>
<hr>
<h1 id="Old-record"><a href="#Old-record" class="headerlink" title="Old record"></a>Old record</h1><blockquote>
<p>Following method not work in i3</p>
</blockquote>
<h2 id="Environment-1"><a href="#Environment-1" class="headerlink" title="Environment"></a>Environment</h2><p>Desktop :Gnome 3.28.2<br>VScode version: 1.24.1</p>
<h2 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem"></a>Problem</h2><p>When I want to delete file from explorer in vscode, following Error occurs:</p>
<p><code>Failed to delete using the Trash. Do you want to permanently delete instead?</code></p>
<h2 id="Solve-1"><a href="#Solve-1" class="headerlink" title="Solve"></a>Solve</h2><p>Maybe <code>gvfs-trash</code> not work properly. It has been deprecated in this gnome version.<br>So open shell, install another tool for help.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">## need python installed</span></span><br><span class="line">sudo easy_install trash-cli</span><br></pre></td></tr></table></figure>
<h2 id="Refs-1"><a href="#Refs-1" class="headerlink" title="Refs"></a>Refs</h2><p><a href="https://github.com/Microsoft/vscode/issues/49675" target="_blank" rel="noopener">Failed to delete using Trash in Ubuntu 18.04 (#49675)</a><br><a href="https://github.com/Microsoft/vscode/issues/22820#issuecomment-288239512" target="_blank" rel="noopener">Moving files to trash always fails in Kubuntu 16.04 (#22820)</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>VS Code</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Install vscode on Arch Linux</title>
    <url>/2018/06/17/Install-vscode-on-Arch-Linux/</url>
    <content><![CDATA[<h1 id="Method-1-official-binary-version-recommend"><a href="#Method-1-official-binary-version-recommend" class="headerlink" title="Method 1: official binary version (recommend)"></a>Method 1: official binary version (recommend)</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yaourt -S visual-studio-code-bin</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="Method-2-open-source-build"><a href="#Method-2-open-source-build" class="headerlink" title="Method 2: open source build"></a>Method 2: open source build</h1><p>first should modify open file limit on your device.</p>
<p>edit <code>/etc/security/limits.conf</code></p>
<p>Add following lines to the end of file</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">*         hard    nofile      500000</span><br><span class="line">*         soft    nofile      500000</span><br><span class="line">root      hard    nofile      500000</span><br><span class="line">root      soft    nofile      500000</span><br></pre></td></tr></table></figure>
<p>Reboot (or log out and back in)</p>
<p>switch to root user <code>sudo su</code></p>
<p>use <code>limit -n</code> to ensure the value is 500000</p>
<p>Then switch back to your user</p>
<p>Just like <code>su - shank</code></p>
<p>Then run</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo yaourt vscode</span><br></pre></td></tr></table></figure>
<p>Then Type <code>4</code> to choose this one</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">4 aur/code 1.24.1-1 (143) (16.35)</span><br><span class="line">    Microsoft Code -- The Open Source build of Visual Studio Code (vscode)</span><br></pre></td></tr></table></figure>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a href="https://easyengine.io/tutorials/linux/increase-open-files-limit/" target="_blank" rel="noopener">Increase “Open Files Limit”</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>VS Code</tag>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title>Install yay (or yaourt) on Arch Linux</title>
    <url>/2018/06/17/Install-yaourt-on-Arch-Linux/</url>
    <content><![CDATA[<h1 id="How-to-install-yay-another-great-AUR-helper"><a href="#How-to-install-yay-another-great-AUR-helper" class="headerlink" title="How to install yay (another great AUR helper)"></a>How to install <a href="https://github.com/Jguer/yay" target="_blank" rel="noopener">yay</a> (another great AUR helper)</h1><blockquote>
<p>Update on 2018/10/16</p>
</blockquote>
<h2 id="Recommended-Use-yay-to-replace-yaourt"><a href="#Recommended-Use-yay-to-replace-yaourt" class="headerlink" title="[Recommended] Use yay to replace yaourt"></a><strong>[Recommended]</strong> Use <code>yay</code> to replace <code>yaourt</code></h2><p>If you already got <code>yaourt</code> just type:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yaourt -S yay</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>Otherwise, you can also install by <code>makepkg</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://aur.archlinux.org/yay.git</span><br><span class="line"><span class="built_in">cd</span> yay</span><br><span class="line">makepkg -si</span><br></pre></td></tr></table></figure>
<h2 id="Deprecated-Install-yaourt"><a href="#Deprecated-Install-yaourt" class="headerlink" title="[Deprecated]Install yaourt"></a><strong>[Deprecated]</strong><del>Install <code>yaourt</code></del></h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/pacman.conf</span><br></pre></td></tr></table></figure>
<p>Then, add following lines to the end.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[archlinuxcn]</span><br><span class="line">Server = http://repo.archlinuxcn.org/<span class="variable">$arch</span></span><br></pre></td></tr></table></figure>
<p>Install the GPG key.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S archlinuxcn-keyring</span><br></pre></td></tr></table></figure>
<p>Finally, update and install yaourt.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -Sy yaourt</span><br></pre></td></tr></table></figure>
<p>Done!</p>
<p><a href="https://www.archlinuxcn.org/archlinux-cn-repo-and-mirror/" target="_blank" rel="noopener">reference</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title>Rime默认简体中文配置</title>
    <url>/2018/06/09/Rime%E9%BB%98%E8%AE%A4%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p><a href="https://rime.im/" target="_blank" rel="noopener">Rime</a>这个输入法是很强大。</p>
<p>但是我对输入法的要求不高: 能输入中文；界面简洁；词汇联想别太”睿智”。</p>
<a id="more"></a>
<p>恰好这些需求Rime都很轻松的满足了，但是唯一不爽的是每次切换到Rime都默认输入繁中，再F4切换简中就很不方便。</p>
<p>虽然这是作者的喜好，但是我不习惯，还好文档提供了默认使用简中的配置方案。</p>
<p>解决方案：<code>vim ~/.config/ibus/rime/luna_pinyin.custom.yaml</code></p>
<blockquote>
<p>这是linux中的用户配置位置，其他系统查看<a href="https://github.com/rime/home/wiki/RimeWithSchemata#rime-%E4%B8%AD%E7%9A%84%E6%95%B8%E6%93%9A%E6%96%87%E4%BB%B6%E5%88%86%E4%BD%88%E5%8F%8A%E4%BD%9C%E7%94%A8" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># luna_pinyin.custom.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">patch:</span></span><br><span class="line">  <span class="attr">switches:</span>                   <span class="comment"># 注意缩进</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ascii_mode</span></span><br><span class="line">      <span class="attr">reset:</span> <span class="number">0</span>                <span class="comment"># reset 0 的作用是当从其他输入法切换到本输入法重设为指定状态</span></span><br><span class="line">      <span class="attr">states:</span> <span class="string">[</span> <span class="string">中文,</span> <span class="string">西文</span> <span class="string">]</span>   <span class="comment"># 选择输入方案后通常需要立即输入中文，故重设 ascii_mode = 0</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">full_shape</span></span><br><span class="line">      <span class="attr">states:</span> <span class="string">[</span> <span class="string">半角,</span> <span class="string">全角</span> <span class="string">]</span>   <span class="comment"># 而全／半角则可沿用之前方案的用法。</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">simplification</span></span><br><span class="line">      <span class="attr">reset:</span> <span class="number">1</span>                <span class="comment"># 增加这一行：默认启用「繁→簡」转换。</span></span><br><span class="line">      <span class="attr">states:</span> <span class="string">[</span> <span class="string">漢字,</span> <span class="string">汉字</span> <span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/rime/home/wiki/CustomizationG" target="_blank" rel="noopener">Rime 定制指南</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Rime</tag>
      </tags>
  </entry>
  <entry>
    <title>ArchLinux安装记录</title>
    <url>/2018/06/03/ArchLinux%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<blockquote>
<p>本教程在EFI启动的Windows10台式机上完成。</p>
</blockquote>
<ol>
<li>Arch Linux 2018.06.01 iso，<a href="https://www.archlinux.org/download/" target="_blank" rel="noopener">官网下载</a></li>
<li>USB Driver &gt; 1G</li>
<li>Etcher <a href="https://etcher.io/" target="_blank" rel="noopener">官网下载</a></li>
</ol>
<a id="more"></a>
<h2 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h2><h3 id="预留空间"><a href="#预留空间" class="headerlink" title="预留空间"></a>预留空间</h3><p>使用 Windows 的磁盘管理工具压缩分区卷，不要格式化。(我预留的空间为60G。)</p>
<h3 id="U盘启动"><a href="#U盘启动" class="headerlink" title="U盘启动"></a>U盘启动</h3><ol>
<li>使用Etcher将Arch安装盘写入U盘</li>
<li>重启电脑启动到U盘系统</li>
<li>你将看到 <code>root@archiso ~ #</code></li>
</ol>
<h3 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h3><p>查看分区表。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">fdisk -l</span><br></pre></td></tr></table></figure>
<p>记录以下分区标识。</p>
<ol>
<li><code>EFI System</code> 分区，此处以 <code>/dev/sda1</code> 为例。</li>
<li>将要安装 Arch Linux 的硬盘，此处以 <code>/dev/sdb</code> 为例。</li>
<li>找到之前预留的空间，此处以 <code>/dev/sdb2</code> 为例。</li>
</ol>
<p>使用新手分区工具 <code>cfdisk</code>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cfdisk /dev/sdb</span><br></pre></td></tr></table></figure>
<p>上下移动选择到 <code>Free Space</code>，左右移动选择到 <code>New</code>，分配与内存等大小的Swap分区，此处输入 <code>8G</code>，然后回车确认。再选择 <code>Type</code>，分区类型求改为 <code>Linux swap</code>。（当然也可以不分交换分区）</p>
<p>再次选择剩余的 <code>Free Space</code>，分出 <code>/</code>和<code>/home</code>。（因人而异，为了方便，我剩下的只分一个区，类型为 <code>Linux filesystem</code>）</p>
<p>最后选择 <code>Write</code>，输入 <code>yes</code>，再选择 <code>Quit</code>，退出分区工具。</p>
<p>再次 <code>fdisk -l</code> 查看新的分区表，记录新创建的分区标识。</p>
<p>此处以 8G的 <code>/dev/sdb2</code> 和 52G的 <code>/dev/sdb4</code> 为例。</p>
<p>也可以使用下面命令将新分区格式化。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkfs.ext4 /dev/sdb4</span><br><span class="line">mkswap /dev/sdb2</span><br></pre></td></tr></table></figure>
<h2 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h2><h3 id="挂载分区"><a href="#挂载分区" class="headerlink" title="挂载分区"></a>挂载分区</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Linux filesystem</span></span><br><span class="line">mount /dev/sdb4 /mnt</span><br><span class="line"><span class="comment"># EFI system</span></span><br><span class="line">mkdir -p /mnt/boot/efi</span><br><span class="line">mount /dev/sda1 /mnt/boot/efi</span><br><span class="line"><span class="comment"># Linux swap</span></span><br><span class="line">swapon /dev/sdb2</span><br></pre></td></tr></table></figure>
<h3 id="配置镜像源"><a href="#配置镜像源" class="headerlink" title="配置镜像源"></a>配置镜像源</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/pacman.d</span><br><span class="line">mv ./mirrorlist ./mirrorlist.bak</span><br><span class="line">touch mirrorlist</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Server = http://mirrors.163.com/archlinux/$repo/os/$arch'</span> &gt; ./mirrorlist</span><br></pre></td></tr></table></figure>
<h3 id="联网"><a href="#联网" class="headerlink" title="联网"></a>联网</h3><p>有线连接可跳过这步，无线连接使用以下命令找到Ｗi-Fi，找到并输入密码即可。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wifi-menu</span><br></pre></td></tr></table></figure>
<h3 id="开始安装配置"><a href="#开始安装配置" class="headerlink" title="开始安装配置"></a>开始安装配置</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置系统时间</span></span><br><span class="line">timedatectl <span class="built_in">set</span>-ntp <span class="literal">true</span></span><br><span class="line"><span class="comment"># 刷新本地数据库</span></span><br><span class="line">pacman -Syy</span><br><span class="line"><span class="comment"># 安装基础系统</span></span><br><span class="line">pacstrap -i /mnt base base-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回车两次然后输入y之后等一会……</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 fstab 文件</span></span><br><span class="line">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab</span><br><span class="line"><span class="comment"># 切换到已安装的ArchLinux</span></span><br><span class="line">arch-chroot /mnt</span><br><span class="line"><span class="comment"># 设置时区</span></span><br><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"><span class="comment"># 时钟设置 使用UTC会导致双系统时间不同 此处用可以用localtime</span></span><br><span class="line">hwclock --systohc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络</span></span><br><span class="line">pacman -S iw wpa_supplicant dialog</span><br><span class="line"><span class="comment"># 字体</span></span><br><span class="line">pacman -S ttf-dejavu wqy-microhei wqy-zenhei</span><br><span class="line"><span class="comment"># 音频</span></span><br><span class="line">pacman -S alsa-utils</span><br><span class="line"><span class="comment"># vim &amp; ssh</span></span><br><span class="line">pacman -S vim openssh</span><br><span class="line"><span class="comment"># 引导工具</span></span><br><span class="line">pacman -S dosfstools grub efibootmgr os-prober</span><br><span class="line">grub-install --efi-directory=/boot/efi --bootloader-id=ArchLinux --recheck</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br><span class="line"><span class="comment"># P.S忽略执行 grub-mkconfig 下方的错误，前几行包含 Found XXX.img 就行</span></span><br></pre></td></tr></table></figure>
<h3 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vim /etc/locale.gen</span><br></pre></td></tr></table></figure>
<p>删除下面四句前面的<code>#</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#en_US.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.GBK GBK</span></span><br><span class="line"><span class="comment">#zh_CN.UTF-8 UTF-8</span></span><br><span class="line"><span class="comment">#zh_CN.GB2312</span></span><br></pre></td></tr></table></figure>
<p>然后生成更新</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">locale-gen</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'LANG=en_US.UTF-8'</span> &gt; /etc/locale.conf</span><br></pre></td></tr></table></figure>
<h3 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h3><blockquote>
<p>自行替换下面的 <code>HOSTNAME</code></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> HOSTNAME &gt; /etc/hostname</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'127.0.0.1   localhost.localdomain   localhost'</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'::1         localhost.localdomain   localhost'</span> &gt;&gt; /etc/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'127.0.1.1   HOSTNAME.localdomain    HOSTNAME'</span>  &gt;&gt;/etc/hosts</span><br></pre></td></tr></table></figure>
<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br><span class="line">umount -R /mnt</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="用户设置"><a href="#用户设置" class="headerlink" title="用户设置"></a>用户设置</h3><p>重启进入ArchLinux，输入<code>root</code>，回车即可登录。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 为root设置密码</span></span><br><span class="line">passwd root</span><br><span class="line"><span class="comment"># 添加普通用户,以shank为例。</span></span><br><span class="line">useradd -m -g users -s /bin/bash shank</span><br><span class="line"><span class="comment"># 设置新用户密码</span></span><br><span class="line">passwd shank</span><br><span class="line"><span class="comment"># 设置sudo权限</span></span><br><span class="line">vim /etc/sudoers</span><br><span class="line"><span class="comment"># 在root ALL=(ALL) ALL 下一行添加 shank ALL=(ALL) ALL</span></span><br><span class="line"><span class="comment"># 去掉 #%wheel ALL=(ALL) ALL 前面的‘#’号</span></span><br></pre></td></tr></table></figure>
<h2 id="桌面环境"><a href="#桌面环境" class="headerlink" title="桌面环境"></a>桌面环境</h2><h3 id="安装显卡驱动"><a href="#安装显卡驱动" class="headerlink" title="安装显卡驱动"></a>安装显卡驱动</h3><p>运行下面的命令，先确定显卡型号，记下 <code>BusID</code>，类似 <code>00:02.0 VGA ...</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">lspci | grep VGA</span><br></pre></td></tr></table></figure>
<p>双显卡会有些麻烦，参考官方文档<a href="https://wiki.archlinux.org/index.php/NVIDIA_Optimus" target="_blank" rel="noopener">NVIDIA_Optimus</a></p>
<p>依次运行以下命令。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果没有联网，你需要先联网</span></span><br><span class="line">wifi-menu</span><br><span class="line"><span class="comment"># intel显卡</span></span><br><span class="line">pacman -S xf86-video-intel</span><br><span class="line"><span class="comment"># nvidia显卡</span></span><br><span class="line">pacman -S nvidia nvidia-libgl</span><br><span class="line"><span class="comment"># 显示输出</span></span><br><span class="line">pacman -S xorg-xrandr</span><br><span class="line"><span class="comment"># 生成配置，将位于 /etc/X11/xorg.conf</span></span><br><span class="line">nvidia-xconfig</span><br></pre></td></tr></table></figure>
<h3 id="双显卡的配置"><a href="#双显卡的配置" class="headerlink" title="双显卡的配置"></a>双显卡的配置</h3><p>先配置xorg.conf</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vim /etc/X11/xorg.conf</span><br></pre></td></tr></table></figure>
<p>参照下面内容配置N卡，<code>BusID</code>那里N卡一般是<code>PCI:1:0:0</code>,之前查到的BusID为<code>00:02.0</code>则这里填<code>PCI:0:2:0</code>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Section &quot;Module&quot;</span><br><span class="line">    Load &quot;modesetting&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Device&quot;</span><br><span class="line">    Identifier &quot;nvidia&quot;</span><br><span class="line">    Driver &quot;nvidia&quot;</span><br><span class="line">    BusID &quot;PCI:1:0:0&quot;</span><br><span class="line">    Option &quot;AllowEmptyInitialConfiguration&quot;</span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure>
<p>保存后，在编辑Intel.conf</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vim /etc/X11/xorg.conf.d/20-intel.conf</span><br></pre></td></tr></table></figure>
<p>找下面内容修改，注意BusID按实际填写。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Section <span class="string">"Device"</span></span><br><span class="line">    Identifier <span class="string">"intel"</span></span><br><span class="line">    Driver <span class="string">"modesetting"</span></span><br><span class="line">    BusID <span class="string">"PCI:0:2:0"</span></span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure>
<h3 id="安装KDE桌面环境"><a href="#安装KDE桌面环境" class="headerlink" title="安装KDE桌面环境"></a>安装KDE桌面环境</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pacman -S plasma kdebase kde-l10n-zh_cn</span><br><span class="line">pacman -S xf86-input-synaptics</span><br></pre></td></tr></table></figure>
<p>修改 <a href="https://wiki.archlinux.org/index.php/NVIDIA_Optimus#Display_Managers" target="_blank" rel="noopener">Display Manager</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'xrandr --setprovideroutputsource modesetting NVIDIA-0'</span> &gt;&gt; /usr/share/sddm/scripts/Xsetup</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'xrandr --auto'</span> &gt;&gt; /usr/share/sddm/scripts/Xsetup</span><br></pre></td></tr></table></figure>
<p>测试是否可以进入桌面</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl start sddm</span><br></pre></td></tr></table></figure>
<h3 id="桌面正常启动后"><a href="#桌面正常启动后" class="headerlink" title="桌面正常启动后"></a>桌面正常启动后</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置桌面自启动</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> sddm</span><br><span class="line"><span class="comment"># 开启桌面ＷiFi配置</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> NetworkManager</span><br><span class="line"><span class="comment"># 启动菜单添加缺失的windows启动项（可选）</span></span><br><span class="line">sudo grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>
<h2 id="配置梯子"><a href="#配置梯子" class="headerlink" title="配置梯子"></a>配置梯子</h2><h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S shadowsocks privoxy</span><br></pre></td></tr></table></figure>
<h3 id="ss配置文件"><a href="#ss配置文件" class="headerlink" title="ss配置文件"></a>ss配置文件</h3><p>编辑配置文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vim ~/ss-local.json</span><br></pre></td></tr></table></figure>
<p>格式如下:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"server"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">    <span class="attr">"server_port"</span>: <span class="number">0000</span>,</span><br><span class="line">    <span class="attr">"password"</span>: <span class="string">"0000"</span>,</span><br><span class="line">    <span class="attr">"method"</span>: <span class="string">"aes-256-cfb"</span>,</span><br><span class="line">    <span class="attr">"local_address"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="attr">"local_port"</span>: <span class="number">1080</span>,</span><br><span class="line">    <span class="attr">"fast_open"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"workers"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>移动到 <code>/etc</code>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mv ~/ss-local.json /etc/ss-local.json</span><br></pre></td></tr></table></figure>
<h3 id="测试ss连接"><a href="#测试ss连接" class="headerlink" title="测试ss连接"></a>测试ss连接</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动sslocal</span></span><br><span class="line">sudo su</span><br><span class="line">nohup sslocal -c /etc/ss-local.json &lt; /dev/null &amp;&gt;&gt; /var/<span class="built_in">log</span>/ss-local.log &amp;</span><br><span class="line"><span class="comment"># 设置临时全局代理</span></span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">"socks5://127.0.0.1:1080"</span>;<span class="built_in">export</span> https_proxy=<span class="variable">$http_proxy</span></span><br><span class="line"><span class="comment"># 然后访问下Google，有返回html就成了。</span></span><br><span class="line">curl -skL www.google.com</span><br></pre></td></tr></table></figure>
<h3 id="使用gfwlist选择代理"><a href="#使用gfwlist选择代理" class="headerlink" title="使用gfwlist选择代理"></a>使用gfwlist选择代理</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取 gfwlist2privoxy 脚本</span></span><br><span class="line">curl -skL https://raw.github.com/zfl9/gfwlist2privoxy/master/gfwlist2privoxy -o gfwlist2privoxy</span><br><span class="line"><span class="comment"># 生成 gfwlist.action 文件</span></span><br><span class="line">bash gfwlist2privoxy <span class="string">'127.0.0.1:1080'</span></span><br><span class="line"><span class="comment"># 拷贝至 privoxy 配置目录</span></span><br><span class="line">cp -af gfwlist.action /etc/privoxy/</span><br><span class="line"><span class="comment"># 加载 gfwlist.action 文件</span></span><br><span class="line">sudo su</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'actionsfile gfwlist.action'</span> &gt;&gt; /etc/privoxy/config</span><br><span class="line"><span class="comment"># 启动 privoxy.service 服务</span></span><br><span class="line">systemctl start privoxy.service</span><br></pre></td></tr></table></figure>
<h3 id="验证代理切换"><a href="#验证代理切换" class="headerlink" title="验证代理切换"></a>验证代理切换</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">unset</span> http_proxy https_proxy no_proxy</span><br><span class="line"><span class="comment"># 设置临时变量，privoxy 默认监听端口为 8118</span></span><br><span class="line"><span class="built_in">export</span> proxy=http://127.0.0.1:8118; <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span> https_proxy=<span class="variable">$proxy</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br><span class="line"><span class="comment"># 可以看到返回值，说明代理成功</span></span><br><span class="line">curl -skL www.google.com</span><br><span class="line"><span class="comment"># 查看当前IP，若是墙内IP说明gfwlist配置成功</span></span><br><span class="line">curl -4skL http://ip.chinaz.com/getip.aspx</span><br></pre></td></tr></table></figure>
<h3 id="shell脚本的方式"><a href="#shell脚本的方式" class="headerlink" title="shell脚本的方式"></a>shell脚本的方式</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新建文件</span></span><br><span class="line">touch ss-privoxy</span><br><span class="line"><span class="comment"># 赋予执行权限</span></span><br><span class="line">sudo chmod +x ss-privoxy</span><br><span class="line"><span class="comment"># 移到PATH路径</span></span><br><span class="line">mv -af ss-privoxy /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"><span class="comment"># 编辑</span></span><br><span class="line">sudo vim /usr/<span class="built_in">local</span>/bin/ss-privoxy</span><br></pre></td></tr></table></figure>
<p>脚本内容如下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">    nohup sslocal -c /etc/ss-local.json &lt; /dev/null &amp;&gt;&gt; /var/<span class="built_in">log</span>/ss-local.log &amp;</span><br><span class="line">    systemctl start privoxy</span><br><span class="line">    proxy=<span class="string">"http://127.0.0.1:8118"</span></span><br><span class="line">    <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span></span><br><span class="line">    <span class="built_in">export</span> https_proxy=<span class="variable">$proxy</span></span><br><span class="line">    <span class="built_in">export</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br><span class="line">    ;;</span><br><span class="line">stop)</span><br><span class="line">    <span class="built_in">unset</span> http_proxy https_proxy no_proxy</span><br><span class="line">    systemctl stop privoxy</span><br><span class="line">    pkill sslocal</span><br><span class="line">    ;;</span><br><span class="line">reload)</span><br><span class="line">    pkill sslocal</span><br><span class="line">    nohup sslocal -c /etc/ss-local.json &lt; /dev/null &amp;&gt;&gt; /var/<span class="built_in">log</span>/ss-local.log &amp;</span><br><span class="line">    ;;</span><br><span class="line"><span class="built_in">set</span>)</span><br><span class="line">    proxy=<span class="string">"http://127.0.0.1:8118"</span></span><br><span class="line">    <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span></span><br><span class="line">    <span class="built_in">export</span> https_proxy=<span class="variable">$proxy</span></span><br><span class="line">    <span class="built_in">export</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br><span class="line">    ;;</span><br><span class="line"><span class="built_in">unset</span>)</span><br><span class="line">    <span class="built_in">unset</span> http_proxy https_proxy no_proxy</span><br><span class="line">    ;;</span><br><span class="line">*)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"usage: source <span class="variable">$0</span> start|stop|reload|set|unset"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<p>配置命令别名： <code>sudo vim /etc/profile.d/ss-privoxy.sh</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">alias</span> ss.start=<span class="string">'. ss-privoxy start'</span></span><br><span class="line"><span class="built_in">alias</span> ss.stop=<span class="string">'. ss-privoxy stop'</span></span><br><span class="line"><span class="built_in">alias</span> ss.reload=<span class="string">'. ss-privoxy reload'</span></span><br><span class="line"><span class="built_in">alias</span> ss.set=<span class="string">'. ss-privoxy set'</span></span><br><span class="line"><span class="built_in">alias</span> ss.unset=<span class="string">'. ss-privoxy unset'</span></span><br></pre></td></tr></table></figure>
<p>使用说明：</p>
<ul>
<li>ss.start：启动 ss-local+privoxy 代理</li>
<li>ss.stop：停用 ss-local+privoxy 代理</li>
<li>ss.reload：重载 ss-local.json 配置文件</li>
<li>ss.set：设置 shell_proxy 环境变量</li>
<li>ss.unset：删除 shell_proxy 环境变量</li>
</ul>
<h2 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h2><h3 id="分发仓库里可以找到的"><a href="#分发仓库里可以找到的" class="headerlink" title="分发仓库里可以找到的"></a>分发仓库里可以找到的</h3><p>安装前先查找软件包是否存在，以<code>ibus</code>为例：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查找与ibus相关的包</span></span><br><span class="line">pacman -Ss ibus</span><br><span class="line"><span class="comment"># 这里支持正则匹配的，还可以这么写，更多查看 man pacman</span></span><br><span class="line">pacman -Ss <span class="string">'^ibus-*'</span></span><br></pre></td></tr></table></figure>
<p>这里我选择安装ibus-rime输入法</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo pacman -S ibus-rime</span><br></pre></td></tr></table></figure>
<h3 id="AUR中可以找到的"><a href="#AUR中可以找到的" class="headerlink" title="AUR中可以找到的"></a><a href="https://aur.archlinux.org/" target="_blank" rel="noopener">AUR</a>中可以找到的</h3><p>以安装VScode为例，该package描述页在<a href="https://aur.archlinux.org/packages/visual-studio-code-bin/" target="_blank" rel="noopener">这里</a></p>
<p>你可以复制<code>Git Clone URL</code>，然后按下面步骤安装。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先安装Git</span></span><br><span class="line">sudo pacman -S git</span><br><span class="line"><span class="comment"># 将仓库clone下来</span></span><br><span class="line">git <span class="built_in">clone</span> https://aur.archlinux.org/visual-studio-code-bin.git</span><br><span class="line"><span class="comment"># 进入git目录</span></span><br><span class="line"><span class="built_in">cd</span> visual-studio-code-bin</span><br><span class="line"><span class="comment"># 编译压缩成安装包</span></span><br><span class="line">makepkg -si</span><br><span class="line"><span class="comment"># pacman安装 (P.S XXXXXX 为版本号)</span></span><br><span class="line">sudo pacman -U visual-studio-code-bin-XXXXXX.pkg.tar.xz</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://wiki.archlinux.org/index.php/Installation_guide" target="_blank" rel="noopener">Installation guide</a></li>
<li><a href="https://blog.csdn.net/maxsky/article/details/56839855" target="_blank" rel="noopener">笔记本双显卡 EFI 启动安装 ArchLinux</a></li>
<li><a href="https://www.zfl9.com/ss-local.html" target="_blank" rel="noopener">ss-local + privoxy 代理</a></li>
<li><a href="https://wiki.archlinux.org/index.php/IBus" target="_blank" rel="noopener">IBus</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Arch</tag>
      </tags>
  </entry>
  <entry>
    <title>DST Server on Ubuntu16.04 (饥荒服务搭建指南)</title>
    <url>/2018/05/29/DST-Server-on-Ubuntu16-04/</url>
    <content><![CDATA[<p>与朋友玩DST(饥荒)，开个5人局，卡到没法玩，所以想办法搭私服。</p>
<p>首先感谢<a href="https://www.bilibili.com/video/av12666273/" target="_blank" rel="noopener">路叔的视频</a>以及<a href="https://tieba.baidu.com/p/4159392559" target="_blank" rel="noopener">这个帖子</a></p>
<ul>
<li>复制粘贴以下脚本保存为 <code>install.sh</code></li>
</ul>
<blockquote>
<p>update <code>install.sh</code> at 2018-12-15</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">dividing=<span class="string">"================================================================================"</span></span><br><span class="line">commandPath=<span class="string">"steamcmd"</span></span><br><span class="line">commandFile=<span class="string">"./steamcmd.sh"</span></span><br><span class="line"></span><br><span class="line">gamesPath=<span class="string">"Steam/steamapps/common/Don't Starve Together Dedicated Server/bin"</span></span><br><span class="line">gamesFile=<span class="string">"./dontstarve_dedicated_server_nullrenderer"</span></span><br><span class="line"></span><br><span class="line">dataPath=$(<span class="built_in">pwd</span>)/.klei</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> FilesDelete()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose File To Delete [1-5]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_filedelete</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$dataPath</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="variable">$dataPath</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveServer_<span class="variable">$input_filedelete</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            rm -r DoNotStarveServer_<span class="variable">$input_filedelete</span>/save</span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveServer_<span class="variable">$input_filedelete</span> Is Deleted\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveCaves_<span class="variable">$input_filedelete</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            rm -r DoNotStarveCaves_<span class="variable">$input_filedelete</span>/save</span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveCaves_<span class="variable">$input_filedelete</span> Is Deleted\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="string">"../"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> FilesBackup()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose File To Backup [1-5]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_filebackup</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$dataPath</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="variable">$dataPath</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveServer_<span class="variable">$input_filebackup</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            tar -zcf DoNotStarveServer_<span class="variable">$input_filebackup</span>.tar.gz DoNotStarveServer_<span class="variable">$input_filebackup</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveServer_<span class="variable">$input_filebackup</span> Is Backuped\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveCaves_<span class="variable">$input_filebackup</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">            tar -zcf DoNotStarveCaves_<span class="variable">$input_filebackup</span>.tar.gz DoNotStarveCaves_<span class="variable">$input_filebackup</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveCaves_<span class="variable">$input_filebackup</span> Is Backuped\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="string">"../"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> FilesRecovery()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose File To Recovery [1-5]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_filerecovery</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -d <span class="variable">$dataPath</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="variable">$dataPath</span></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">"DoNotStarveServer_<span class="variable">$input_filerecovery</span>.tar.gz"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveServer_<span class="variable">$input_filerecovery</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                rm -r DoNotStarveServer_<span class="variable">$input_filerecovery</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            tar -zxf DoNotStarveServer_<span class="variable">$input_filerecovery</span>.tar.gz DoNotStarveServer_<span class="variable">$input_filerecovery</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveServer_<span class="variable">$input_filerecovery</span> Is Recovered\033[0m"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Backup File For DoNotStarveServer_<span class="variable">$input_filerecovery</span> Not Found\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ -f <span class="string">"DoNotStarveCaves_<span class="variable">$input_filerecovery</span>.tar.gz"</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> [ -d <span class="string">"DoNotStarveCaves_<span class="variable">$input_filerecovery</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                rm -r DoNotStarveCaves_<span class="variable">$input_filerecovery</span></span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">            tar -zxf DoNotStarveCaves_<span class="variable">$input_filerecovery</span>.tar.gz DoNotStarveCaves_<span class="variable">$input_filerecovery</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] File DoNotStarveCaves_<span class="variable">$input_filerecovery</span> Is Recovered\033[0m"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Backup File For DoNotStarveCaves_<span class="variable">$input_filerecovery</span> Not Found\033[0m"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="string">"../"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Main Archive Folder Not Found\033[0m"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> SystemPrepsDetail()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] System Library Install\033[0m"</span></span><br><span class="line">    sudo apt-get update</span><br><span class="line">    sudo apt-get install screen</span><br><span class="line">    sudo apt-get install lib32gcc1</span><br><span class="line">    sudo apt-get install lib32stdc++6</span><br><span class="line">    sudo apt-get install libcurl4-gnutls-dev:i386</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] System Library Install Finished\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> SystemPreps()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] System Library Preparing\033[0m"</span></span><br><span class="line">    sudo apt-get update                                                         1&gt;/dev/null</span><br><span class="line">    sudo apt-get install screen                                                 1&gt;/dev/null</span><br><span class="line">    sudo apt-get install lib32gcc1                                              1&gt;/dev/null</span><br><span class="line">    sudo apt-get install lib32stdc++6                                           1&gt;/dev/null</span><br><span class="line">    sudo apt-get install libcurl4-gnutls-dev:i386                               1&gt;/dev/null</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] System Library Prepare Finished\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> CommandPreps()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] Steam Command Line Files Preparing\033[0m"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$commandPath</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        mkdir <span class="string">"<span class="variable">$commandPath</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">"<span class="variable">$commandPath</span>"</span></span><br><span class="line"></span><br><span class="line">    wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz 1&gt;/dev/null</span><br><span class="line">    tar -xvzf steamcmd_linux.tar.gz                                             1&gt;/dev/null</span><br><span class="line">    rm -f steamcmd_linux.tar.gz                                                 1&gt;/dev/null</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] Steam Command Line Files Prepare Finished\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> ServerStart()</span><br><span class="line">&#123;  </span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose Game Mode [1.noraml] [2.caves]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_mode</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose Save File [1-5]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_save</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">"<span class="variable">$gamesPath</span>"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$input_mode</span> <span class="keyword">in</span></span><br><span class="line">        1)</span><br><span class="line">            screen -dm -S <span class="string">"DST Server"</span> <span class="string">"<span class="variable">$gamesFile</span>"</span> -conf_dir DoNotStarveServer_<span class="string">"<span class="variable">$input_save</span>"</span>;;</span><br><span class="line">        2)</span><br><span class="line">            screen -dm -S <span class="string">"DST Server"</span> <span class="string">"<span class="variable">$gamesFile</span>"</span> -conf_dir DoNotStarveCaves_<span class="string">"<span class="variable">$input_save</span>"</span>;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Illegal Command,Please Check\033[0m"</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    screen -r <span class="string">"DST Server"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> ServerPreps()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] Preparing Server Files\033[0m"</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$commandPath</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Steam Command Line Not Found\033[0m"</span></span><br><span class="line">        CommandPreps</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] Steam Command Line Found\033[0m"</span></span><br><span class="line">        <span class="built_in">cd</span> <span class="string">"<span class="variable">$commandPath</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Choose Game Update Mode [1.noraml] [2.caves]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_game</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$input_game</span> <span class="keyword">in</span></span><br><span class="line">        1)</span><br><span class="line">            <span class="string">"<span class="variable">$commandFile</span>"</span> +login anonymous +app_update 343050 validate +quit;;</span><br><span class="line">        2)</span><br><span class="line">            <span class="string">"<span class="variable">$commandFile</span>"</span> +login anonymous +app_update 343050 -beta cavesbeta validate +quit;;</span><br><span class="line">        *)</span><br><span class="line">            <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Illegal Command,Please Check\033[0m"</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">"../"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">    ServerStart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">clear</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$gamesPath</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[31m[warn] Server Files Not Found\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">    SystemPrepsDetail</span><br><span class="line">    ServerPreps</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Server Files Found\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$dividing</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[33m[info] Choose An Action To Perform\033[0m"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] System Library Files [0.Prepare]\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Game Server [1.start]  [2.update]  [3.process kill]\033[0m"</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"\033[32m[info] Save Files  [7.backup] [8.recovery][9.delete]\033[0m"</span></span><br><span class="line">    <span class="built_in">read</span> input_update</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$input_update</span> <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">            SystemPreps</span><br><span class="line">            ;;</span><br><span class="line">        1)</span><br><span class="line">            ServerStart</span><br><span class="line">            ;;</span><br><span class="line">        2)</span><br><span class="line">            ServerPreps</span><br><span class="line">            ;;</span><br><span class="line">        3)</span><br><span class="line">            screen -X -S <span class="string">"DST Server"</span> quit</span><br><span class="line">            ;;</span><br><span class="line">        7)</span><br><span class="line">            FilesBackup</span><br><span class="line">            ;;</span><br><span class="line">        8)</span><br><span class="line">            FilesRecovery</span><br><span class="line">            ;;</span><br><span class="line">        9)</span><br><span class="line">            FilesDelete</span><br><span class="line">            ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<ul>
<li>添加运行权限</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo chmod u+x install.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>运行脚本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sh install.sh</span><br><span class="line"><span class="comment"># 按下面的输入数字选择：</span></span><br><span class="line"><span class="comment"># Game Mode: 1</span></span><br><span class="line"><span class="comment"># Save File: 1</span></span><br><span class="line"><span class="comment"># Ctrl+c 中断进程</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获得 <code>Token</code></li>
</ul>
<p>如何获得参考<a href="http://blog.ttionya.com/article-1235.html" target="_blank" rel="noopener">这里</a>：</p>
<p>游戏主界面右下角 <code>Account</code> -&gt; <code>Generate Server Token</code> -&gt; 复制粘贴保存到 <code>cluster_token.txt</code>。</p>
<ul>
<li>本地打开DST，创建一个在线世界，Mod 什么都设置好，点击开始进游戏，然后关闭保存游戏。</li>
</ul>
<p>找到存档 Linux存档位置：<code>~/.klei/DoNotStarveTogether</code> Windows存档位置：<code>%HOMEPATH%\Klei\DoNotStarveTogether\</code>。</p>
<p>将对应的 <code>Cluster_X</code> 目录覆盖到云主机的下面目录：<code>~/.klei/DoNotStarveserver_1/</code>。</p>
<blockquote>
<p>这里我的存档为 <code>Cluster_1</code>。</p>
</blockquote>
<p><del>将上一步获得的 <code>cluster_token.txt</code> 放到 <code>Cluster_X</code> 目录下</del> 存档目录下已存在该文件可以不用替换。</p>
<ul>
<li>记录Mod编号</li>
</ul>
<p>打开存档目录下的 <code>Master/modoverrides.lua</code> 文件，记录所有的 <code>workshop-XXXXXXXXX</code> 中的数字编号。</p>
<p>打开 <code>~/Steam/steamapps/common/Don&#39;t Starve Together Dedicated Server/mods/dedocated_server_mods_setup.lua</code> 将Mod按 <code>ServerModSetup(&quot;XXXXXXXXX&quot;)</code> 的格式一行一行写进去并保存。</p>
<ul>
<li>再次运行 <code>install.sh</code>，选择 <code>1.start</code>。</li>
</ul>
<p>几分钟后即可在 DST 的 online 列表中搜到你的服务器。</p>
<blockquote>
<p>我上面写的教程没开 Cave，你可以通过看视频把 Cave 服务打开，过程类似。</p>
</blockquote>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>DST</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04上Docker免sudo使用的解决方式</title>
    <url>/2018/04/15/Ubuntu16-04%E4%B8%8ADocker%E5%85%8Dsudo%E4%BD%BF%E7%94%A8%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在Ubuntu16.04上安装Docker-ce后，发现<code>docker run</code>不需要在<code>sudo</code>下运行，这就导致了一个问题VScode和PyCharm都连不上Docker，都是因为去访问权限的问题，因为不建议用root权限，所以就要找解决办法。</p>
<a id="more"></a>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><ol>
<li><p>修改服务文件</p>
<p> 修改 <code>/lib/systemd/system/docker.service</code></p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo vim /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>
<p> 找到这一行<code>ExecStart=/usr/bin/dockerd fd://</code>，替换为</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 大概是开启了docker的tcp访问和unix访问</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock</span><br></pre></td></tr></table></figure>
<p> 接着修改 <code>/etc/init.d/docker</code></p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/init.d/docker</span><br></pre></td></tr></table></figure>
<p> 找到这一行 <code>DOCKER_OPTS=</code>，做类似的修改</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DOCKER_OPTS=<span class="string">"-H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加用户到docker组</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后重启你的系统</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo reboot</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://forums.docker.com/t/cannot-connect-to-the-docker-daemon-is-the-docker-daemon-running-on-this-host/8925/15" target="_blank" rel="noopener">cannot-connect-to-the-docker-daemon-is-the-docker-daemon-running-on-this-host</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下使用SS本地代理</title>
    <url>/2018/04/15/Linux%E4%B8%8B%E4%BD%BF%E7%94%A8SS%E6%9C%AC%E5%9C%B0%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>凡是要Coding，免不了上Google，不得不说SS的Windows版体验更好。</p>
<p>Linux版我总是挂全局代理，国外IP不能看B站正版番就很难受。</p>
<p>因为懒一直没折腾，这次为了更好的体验，我决定花点时间。</p>
<a id="more"></a>
<h1 id="安装-ss-客户端"><a href="#安装-ss-客户端" class="headerlink" title="安装 ss 客户端"></a>安装 ss 客户端</h1><p>本来 python 版的 shadowsocks 带有 sslocal 可以做本地代理的，但是我用图形界面，觉得 qt 版体验要好些。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ArchLinux</span></span><br><span class="line">sudo pacman -S shadowsocks-qt5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">sudo add-apt-repository ppa:hzwhuang/ss-qt5</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install shadowsocks-qt5</span><br></pre></td></tr></table></figure>
<p>安装完成后，打开配置好你的 ss 服务，本地地址：<code>127.0.0.1</code>，端口：<code>1080</code>，本地服务器类型：<code>HTTP(S)</code>。</p>
<h2 id="验证本地代理"><a href="#验证本地代理" class="headerlink" title="验证本地代理"></a>验证本地代理</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置临时全局代理</span></span><br><span class="line"><span class="built_in">export</span> proxy=http://127.0.0.1:1080; <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span> https_proxy=<span class="variable">$proxy</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br><span class="line"><span class="comment"># 然后访问下Google，有返回html就成了。</span></span><br><span class="line">curl -skL www.google.com</span><br></pre></td></tr></table></figure>
<h1 id="安装-privoxy"><a href="#安装-privoxy" class="headerlink" title="安装 privoxy"></a>安装 privoxy</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ArchLinux</span></span><br><span class="line">sudo pacman -S privoxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line">sudo apt install privoxy</span><br></pre></td></tr></table></figure>
<h2 id="配置-gfwlist"><a href="#配置-gfwlist" class="headerlink" title="配置 gfwlist"></a>配置 gfwlist</h2><p>全局代理体验不佳，这里要利用 gfwlist ，配置 privoxy</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先获取一段格式转换脚本</span></span><br><span class="line">curl -skL https://raw.github.com/zfl9/gfwlist2privoxy/master/gfwlist2privoxy -o gfwlist2privoxy</span><br><span class="line"><span class="comment"># 生成 gfwlist.action 文件</span></span><br><span class="line">bash gfwlist2privoxy <span class="string">'127.0.0.1:1080'</span></span><br><span class="line"><span class="comment"># 拷贝至 privoxy 配置目录</span></span><br><span class="line">sudo cp -af gfwlist.action /etc/privoxy/</span><br><span class="line"><span class="comment"># 加载 gfwlist.action 文件</span></span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">'actionsfile gfwlist.action'</span> &gt;&gt; /etc/privoxy/config</span><br><span class="line"><span class="comment"># 启动 privoxy.service 服务</span></span><br><span class="line">sudo systemctl start privoxy.service</span><br></pre></td></tr></table></figure>
<h2 id="验证代理切换"><a href="#验证代理切换" class="headerlink" title="验证代理切换"></a>验证代理切换</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置临时变量，privoxy 默认监听端口为 8118</span></span><br><span class="line"><span class="built_in">export</span> proxy=http://127.0.0.1:8118; <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span> https_proxy=<span class="variable">$proxy</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br><span class="line"><span class="comment"># 可以看到返回值，说明代理成功</span></span><br><span class="line">curl -skL www.google.com</span><br><span class="line"><span class="comment"># 查看当前IP，若是墙内IP说明gfwlist配置成功</span></span><br><span class="line">curl -4skL http://ip.chinaz.com/getip.aspx</span><br></pre></td></tr></table></figure>
<h1 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h1><p>可以将环境变量加入 <code>.profile</code> 或 <code>.bashrc</code> 或其他配置文件中</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim ~/.profile 或者 sudo vim /etc/profile</span></span><br><span class="line"><span class="comment"># 设置临时变量，privoxy 默认监听端口为 8118</span></span><br><span class="line">proxy=http://127.0.0.1:8118</span><br><span class="line"><span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=<span class="variable">$proxy</span></span><br><span class="line"><span class="built_in">export</span> no_proxy=<span class="string">"localhost, 127.0.0.1, ::1"</span></span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.zfl9.com/ss-local.html" target="_blank" rel="noopener">ss-local + privoxy 代理</a><br><a href="https://www.privoxy.org/user-manual/actions-file.html" target="_blank" rel="noopener">Proivoxy用户手册</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Shadowsocks</tag>
        <tag>Privoxy</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04安装Node.js&amp;npm</title>
    <url>/2018/04/15/Ubuntu16-04%E5%AE%89%E8%A3%85Node-js-npm/</url>
    <content><![CDATA[<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><p>Ubuntu16.04 官方仓库提供的Node.js版本是4.x，不推荐使用apt安装。</p>
<p>我们需要从<a href="https://nodejs.org/zh-cn/" target="_blank" rel="noopener">官网</a>获得更新的版本。</p>
<a id="more"></a>
<p>这里直接wget获得</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget http://nodejs.org/dist/v8.1.1/node-v8.1.1-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>找到下载的压缩文件，解压系统应用目录</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo tar -C /usr/<span class="built_in">local</span> --strip-components 1 -xzf node-v8.1.1-linux-x64.tar.gz</span><br></pre></td></tr></table></figure>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p>查看是否安装到了正确的目录</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ls -l /usr/<span class="built_in">local</span>/bin/node</span><br><span class="line">ls -l /usr/<span class="built_in">local</span>/bin/npm</span><br><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://stackoverflow.com/questions/33033538/installing-a-tar-gz-on-linux?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa" target="_blank" rel="noopener">Installing a tar.gz on linux</a></p>
<p><a href="http://www.findshank.com/2017/08/06/%E4%B8%80%E4%BA%9B%E8%8A%82%E7%BA%A6%E7%94%9F%E5%91%BD%E7%9A%84%E6%93%8D%E4%BD%9C/#more">我的另一篇文章，有关npm加速</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Ubuntu</tag>
        <tag>Nodejs</tag>
        <tag>npm</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下zip安装MySQL总结</title>
    <url>/2018/04/01/Windows%E4%B8%8Bzip%E5%AE%89%E8%A3%85MySQL%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>安装MySQL不想用官方安装工具，因为它会添加开机计划任务，自动启动不说还会时不时更新，就很烦。我希望随用随启动，所以要选择zip安装，这样方便可控。<br>由于记性不好，每次这么装都要查资料，看到网上各种拙劣的教程就很无语，所以决定抽空自己总结下。</p>
<a id="more"></a>
<h1 id="下载-amp-解压"><a href="#下载-amp-解压" class="headerlink" title="下载&amp;解压"></a>下载&amp;解压</h1><ul>
<li><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">官网</a>下载zip安装包，我选择的是MySQL Community Server。<blockquote>
<p>zip安装包在<code>Other Downloads</code>中，我下载的是mysql-5.7.18-win32.zip</p>
</blockquote>
</li>
<li>解压到任意目录<blockquote>
<p>以下以解压到<code>D:\mysql-5.7.18-win32</code>为例。</p>
</blockquote>
</li>
</ul>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><ul>
<li>添加系统变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">变量名： MYSQL_HOME</span><br><span class="line">变量值： D:\mysql-5.7.18-win32</span><br></pre></td></tr></table></figure>
<ul>
<li>Path中添加 <code>%MYSQL_HOME%\bin</code></li>
</ul>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>MySQL目录下添加<code>my.ini</code>文件，内容如下：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="comment"># 默认编码</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 默认编码</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="comment"># 设置mysql的安装目录</span></span><br><span class="line"><span class="attr">basedir</span>=D:\mysql-<span class="number">5.7</span>.<span class="number">18</span>-win32</span><br><span class="line"><span class="comment"># 设置mysql数据库的数据的存放目录</span></span><br><span class="line"><span class="attr">datadir</span>=D:\mysql-<span class="number">5.7</span>.<span class="number">18</span>-win32\data</span><br><span class="line"><span class="comment"># 默认存储引擎</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=InnoDB</span><br></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol>
<li>若MySQL目录下有data目录，先清空该目录。</li>
<li>管理员模式启动cmd，切换到MySQL目录下的bin目录中。</li>
<li><p>运行初始化命令</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysqld --initialize-insecure</span><br></pre></td></tr></table></figure>
<p> 稍等一会，没有输出就成功了。</p>
<blockquote>
<p>若遇到缺少MSVCP120.dll的问题，前往<a href="https://www.microsoft.com/en-us/download/details.aspx?id=40784" target="_blank" rel="noopener">这里</a>下载安装VC++支持</p>
</blockquote>
</li>
<li><p>运行安装命令</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysqld --install</span><br></pre></td></tr></table></figure>
<p> 输出<code>service successfully installed</code>表明安装成功。</p>
</li>
<li><p>开启服务</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">net start mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录MySQL</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure>
<blockquote>
<p>首次登录没有密码，直接按回车</p>
</blockquote>
</li>
<li><p>更改root密码</p>
 <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">SET PASSWORD FOR <span class="string">'root'</span>@<span class="string">'localhost'</span> = PASSWORD(<span class="string">'newpass'</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>newpass</code>为新的密码</p>
</blockquote>
</li>
</ol>
<h1 id="验证编码"><a href="#验证编码" class="headerlink" title="验证编码"></a>验证编码</h1><p>root登录MySQL，然后输入以下查询语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'character%'</span>;</span><br></pre></td></tr></table></figure>
<p>你会的到以下结果：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">+<span class="comment">--------------------------+-------------------------------------------+</span></span><br><span class="line">| Variable_name            | Value                                     |</span><br><span class="line">+<span class="comment">--------------------------+-------------------------------------------+</span></span><br><span class="line">| character_set_client     | utf8                                      |</span><br><span class="line">| character_set_connection | utf8                                      |</span><br><span class="line">| character_set_database   | utf8                                      |</span><br><span class="line">| character_set_filesystem | binary                                    |</span><br><span class="line">| character_set_results    | utf8                                      |</span><br><span class="line">| character_set_server     | utf8                                      |</span><br><span class="line">| character_set_system     | utf8                                      |</span><br><span class="line">| character_sets_dir       | D:\mysql-5.7.18-win32\share\charsets\     |</span><br><span class="line">+<span class="comment">--------------------------+-------------------------------------------+</span></span><br></pre></td></tr></table></figure>
<p>至此，安装完成。</p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 停止MySQL服务</span></span><br><span class="line">net stop mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除MySQL服务</span></span><br><span class="line">sc delete mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解除安装</span></span><br><span class="line">mysqld remove</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Database</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Windows</tag>
      </tags>
  </entry>
  <entry>
    <title>如何在Windows上使用GLUT</title>
    <url>/2018/03/09/%E5%A6%82%E4%BD%95%E5%9C%A8Windows%E4%B8%8A%E4%BD%BF%E7%94%A8GLUT/</url>
    <content><![CDATA[<p>最近在看计算机图形学<br>书里的代码要用到OpenGL，然而在Windows上少了GLUT，需要自己手动配置。</p>
<a id="more"></a>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>Microsoft Visual Studio 2017 Community （勾选安装<code>使用C++的桌面开发</code>那项，确保安装MSVC）</li>
<li><a href="https://www.opengl.org/resources/libraries/glut/glut37.zip" target="_blank" rel="noopener">GLUT for Windows</a></li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ol>
<li>打开 glut37.zip。</li>
<li><code>glut.dll</code>,<code>glut32.dll</code> 解压到 Windows目录。<blockquote>
<p>我放到了<code>C:\Windows</code>目录下，当然你也可以把它们分别放到<code>C:\Windows\SysWOW64</code>和<code>C:\Windows\System32</code>下。</p>
</blockquote>
</li>
<li>找到MSVC的目录。<blockquote>
<p>例如 <code>C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.??.??????</code>。 (根据版本文件夹的名称的<code>?</code>会有不同)</p>
</blockquote>
</li>
<li>在<code>include</code>目录下新建<code>GL</code>文件夹，将<code>glut.h</code>复制进去。<blockquote>
<p>例如 <code>C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.13.26128\include\GL</code>。</p>
</blockquote>
</li>
<li>在<code>lib</code>目录下，将<code>glut.lib</code>,<code>glut32.lib</code>复制进去。</li>
</ol>
<h2 id="编写一个简单的opengl程序"><a href="#编写一个简单的opengl程序" class="headerlink" title="编写一个简单的opengl程序"></a>编写一个简单的opengl程序</h2><ol>
<li><p>打开VS2017，依次点击 <code>新建</code> - <code>项目</code> - <code>Visual C++</code> - <code>Windows 控制台应用程序</code> - <code>确定</code>。</p>
</li>
<li><p>右键点击解决方案管理器中的项目名称(ConsoleApplication?) - 属性 - 链接器</p>
<blockquote>
<p>注意：配置平台是Win32。</p>
<ul>
<li>常规 - 附加库目录 - &lt;编辑…&gt; - 粘贴你lib的路径<br>例如 <code>C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.13.26128\lib</code>。</li>
<li>输入 - 附加依赖项 - &lt;编辑…&gt; - 粘贴glut的lib<br>例如 <code>glut32.lib</code>。</li>
</ul>
</blockquote>
</li>
<li><p><code>ConsoleApplication1?.cpp</code>中写入以下代码：</p>
 <figure class="highlight cxx"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;gl/glut.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    glClearColor(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">    glMatrixMode(GL_PROJECTION);</span><br><span class="line">    gluOrtho2D(<span class="number">0.0</span>, <span class="number">200.0</span>, <span class="number">0.0</span>, <span class="number">250.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lineSegment</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    glClear(GL_COLOR_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">    glColor3f(<span class="number">0.0</span>, <span class="number">0.4</span>, <span class="number">0.2</span>);</span><br><span class="line">    glBegin(GL_LINES);</span><br><span class="line">    glVertex2i(<span class="number">180</span>, <span class="number">15</span>);</span><br><span class="line">    glVertex2i(<span class="number">10</span>, <span class="number">145</span>);</span><br><span class="line">    glEnd();</span><br><span class="line">    glFlush();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    glutInit(&amp;argc, argv);</span><br><span class="line">    glutInitDisplayMode(GLUT_SINGLE | GLUT_RGB);</span><br><span class="line">    glutInitWindowPosition(<span class="number">50</span>, <span class="number">100</span>);</span><br><span class="line">    glutInitWindowSize(<span class="number">400</span>, <span class="number">300</span>);</span><br><span class="line">    glutCreateWindow(<span class="string">"An Example OpenGL Program"</span>);</span><br><span class="line"></span><br><span class="line">    init();</span><br><span class="line">    glutDisplayFunc(lineSegment);</span><br><span class="line">    glutMainLoop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>F5调试，你可以看到图像是一条斜线。</p>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://www.cs.csustan.edu/~rsc/SDSU/GLUTinstall.html" target="_blank" rel="noopener">https://www.cs.csustan.edu/~rsc/SDSU/GLUTinstall.html</a></p>
</li>
<li><p><a href="http://blog.csdn.net/qq_19982213/article/details/69970977" target="_blank" rel="noopener">http://blog.csdn.net/qq_19982213/article/details/69970977</a></p>
</li>
</ul>
]]></content>
      <categories>
        <category>图形学</category>
      </categories>
      <tags>
        <tag>Windows</tag>
        <tag>GLUT</tag>
      </tags>
  </entry>
  <entry>
    <title>Protocal Buffer 学习 (语言指南)</title>
    <url>/2018/02/23/Protocal%20Buffer%20%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="官方指南"><a href="#官方指南" class="headerlink" title="官方指南"></a>官方指南</h2><p><a href="https://developers.google.com/protocol-buffers/docs/proto3#simple" target="_blank" rel="noopener">Language Guide (proto3)</a></p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>该文章为阅读官方指南顺便翻译的。</p>
<a id="more"></a>
<h2 id="定义消息类型"><a href="#定义消息类型" class="headerlink" title="定义消息类型"></a>定义消息类型</h2><p>看一个简单的例子。假如你想定义一个搜索请求信息格式，搜索请求有个询问字符串。你感兴趣的特定页面的结果，以及每个结果页面的条目数。下面是 <code>.proto</code> 文件。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchRequest</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> query = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">int32</span> result_per_page = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第一行指定了你使用 proto3 语法：如果你不这样做，protocal buffer 编译器将默认假设你使用 proto2 。这句必须在文件的第一非空无注释行。</li>
<li><code>SearchRequest</code>信息定义指定了三个字段(名/值 对)，一个用于你希望包含在此类消息中的每条数据。每个字段有一个名称和一个类型。</li>
</ul>
<h3 id="指定字段类型"><a href="#指定字段类型" class="headerlink" title="指定字段类型"></a>指定字段类型</h3><p>在上面的例子中，所有的字段都是 scalar (标量)类型：两个整数(<code>page_number</code>和<code>result_per_page</code>)和一个字符串(<code>query</code>)。当然，你也可以为你的字段指定 composite (复合)类型。</p>
<h3 id="分配标签"><a href="#分配标签" class="headerlink" title="分配标签"></a>分配标签</h3><p>如你所见，信息定义中的每个字段有一个独特的数字标签。这些标签被用来在二进制信息格式中识别你的字段，并且一旦你的信息类型在使用就不该修改这些字段。请注意，值为1到15的变量需要1字节编码，包括标签号和字段类型(你可以在 Protocal Buffer Encoding 中了解更多信息)。标签在16到2047之间需要2字节。所以你应该为频繁出现的消息元素保留标签1至15。请留意为将来可能添加的频繁出现的元素留出一些空间。<br>最小标签号码你可以指定为1，最大的为$2^{29}-1$，或536,870,911。你还不能使用数组19000至19999(<code>FieldDescriptor::kFirstReservedNumber</code>至<code>FieldDescriptor::kLastReservedNumber</code>)。因为它们是为 Protocal Bufffers 接口实现保留的，如果你在<code>.proto</code>文件中使用这些保留数字，protocal buffer 编译器会发出警告。同样的，你不能使用任何以前保留的标签。</p>
<h3 id="指定字段规则"><a href="#指定字段规则" class="headerlink" title="指定字段规则"></a>指定字段规则</h3><p>信息字段可以是下列中一种：</p>
<ul>
<li><code>singular</code> ：一种格式正确的消息可以有0或1个这个字段(但不超过1个)。</li>
<li><code>repeated</code> ：这个字段可以在格式正确的消息中被重复任意次。重复值的顺序会被保留。</li>
</ul>
<p>在 proto3 中， <code>repeated</code> 的 scalar 数字类型默认使用 <code>packed</code> 编码。<br>你可以在 Protocal Buffer Encoding 中了解有关 <code>packed</code> 的信息。</p>
<h3 id="添加更多信息类型"><a href="#添加更多信息类型" class="headerlink" title="添加更多信息类型"></a>添加更多信息类型</h3><p>单个<code>.proto</code>文件中可以定义多种信息类型。这便于你定义多种相关的信息。因此，举个例子，如果你想的定义回复信息格式来相应你的<code>SearchResponse</code>信息类型，你可以添加它到同一<code>.proto</code>文件：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> result_per_page = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchResponse</span> </span>&#123;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加注释"><a href="#添加注释" class="headerlink" title="添加注释"></a>添加注释</h3><p>欲添加注释到你的<code>.proto</code>文件，使用C/C++样式的<code>//</code>和<code>/* ... */</code>语法。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">/* SearchRequest represents a search query, with pagination options to</span><br><span class="line"> * indicate which results to include in the response. */</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> page_number = <span class="number">2</span>;  <span class="comment">// Which page number do we want?</span></span><br><span class="line">  <span class="built_in">int32</span> result_per_page = <span class="number">3</span>;  <span class="comment">// Number of results to return per page.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="保留字段"><a href="#保留字段" class="headerlink" title="保留字段"></a>保留字段</h3><p>如果你通过删除整个字段或者将它注释掉来更新一种消息类型，未来的用户可以在更新类型时重用该标签号码。如果他们稍后加载同样的<code>.proto</code>旧版本，可能会导致严重的问题，包括数据损坏，隐私错误，诸如此类。确保这种情况不会发生的一种方法是指定已删除字段的字段标记(和/或者名称)被保留(这可能会导致JSON序列化问题)。如果将来的任何用户试图使用这些标识符，protocal buffer 编译器将报错。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  reserved <span class="number">2</span>, <span class="number">15</span>, <span class="number">9</span> to <span class="number">11</span>;</span><br><span class="line">  reserved <span class="string">"foo"</span>, <span class="string">"bar"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意，你不能在同一<code>reserved</code>语句中混合字段名称和标签号码。</p>
<h3 id="你的-proto可以生成什么？"><a href="#你的-proto可以生成什么？" class="headerlink" title="你的.proto可以生成什么？"></a>你的<code>.proto</code>可以生成什么？</h3><p>当你在protocal buffer 编译器中运行一个<code>.proto</code>，编译器会生成你需要的语言的代码，包括getting和setting字段的值，序列化你的信息到输出流，从输入流解析你的信息。</p>
<ul>
<li>对于<strong>C++</strong>，编译器为每个<code>.proto</code>生成一个<code>.h</code>和<code>.cc</code>文件，每个信息类型用一个类定义。</li>
<li>对于<strong>Java</strong>，编译器会为每个消息来行生成一个带有类的<code>.java</code>文件，以及用于创建消息类实力的特殊<code>Builder</code>类。</li>
<li><strong>Python</strong>有一些不同——Python编译器会在<code>.proto</code>中为每个消息类型生成一个静态描述符，然后与<code>metaclass</code>一起使用，以在运行时创建必要的Python数据访问类。</li>
<li>对于<strong>Go</strong>，编译器为每种消息类型生成一个<code>.pb.go</code>文件。</li>
<li>对于<strong>Ruby</strong>，编译器使用包含消息类型的Ruby模块生成一个<code>.rb</code>文件。</li>
<li>对于<strong>JavaNano</strong>，编译器输出与Java相似，但没有<code>Builder</code>类。</li>
<li>对于<strong>Object-C</strong>，编译器会从每个<code>.proto</code>生成一个<code>pbobjc.h</code>和<code>pbobjc.m</code>文件，并为你的文件中描述的每种消息类型生成一个类。</li>
<li>对于<strong>C#</strong>，编译器会从每个<code>.proto</code>生成一个<code>.cs</code>文件，并为你的文件中描述的每种消息类型生成一个类。</li>
</ul>
<p>你可以按照所选语言的教程(即将推出proto3版本)了解更多关于使用每种语言的API的信息。有关更多API的详细信息，请参阅相关<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">API参考</a>(即将推出proto3版本)。</p>
<h2 id="Scalar-值类型"><a href="#Scalar-值类型" class="headerlink" title="Scalar 值类型"></a>Scalar 值类型</h2><p>标量消息字段可以具有以下类型之一——该表显示.proto文件中指定的类型以及自动生成的类中的相应类型：</p>
<table>
<thead>
<tr>
<th>.proto Type</th>
<th>Notes</th>
<th>C++ Type</th>
<th>Java Type</th>
<th>Python Type<sup>[2]</sup></th>
<th>Go Type</th>
<th>Ruby Type</th>
<th>C# Type</th>
<th>PHP Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>double</td>
<td></td>
<td>double</td>
<td>double</td>
<td>float</td>
<td>float64</td>
<td>Float</td>
<td>double</td>
<td>float</td>
</tr>
<tr>
<td>float</td>
<td></td>
<td>float</td>
<td>float</td>
<td>float</td>
<td>float32</td>
<td>Float</td>
<td>float</td>
<td>float</td>
</tr>
<tr>
<td>int32</td>
<td>使用可变长度编码。负数是无效编码——如果你的字段可能含有负数，请改用sint32</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>Fixnum or Bignum (as required)</td>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>int64</td>
<td>使用可变长度编码。负数是无效编码——如果你的字段可能具有负值，请改用sint64。</td>
<td>int64</td>
<td>long</td>
<td>int/long<sup>[3]</sup></td>
<td>int64</td>
<td>Bignum</td>
<td>long</td>
<td>integer/string<sup>[5]</sup></td>
</tr>
<tr>
<td>uint32</td>
<td>使用可变长度编码。</td>
<td>uint32</td>
<td>int<sup>[1]</sup></td>
<td>int/long<sup>[3]</sup></td>
<td>uint32</td>
<td>Fixnum or Bignum (as required)</td>
<td>uint</td>
<td>integer</td>
</tr>
<tr>
<td>uint64</td>
<td>使用可变长度编码。</td>
<td>uint64</td>
<td>long<sup>[1]</sup></td>
<td>int/long<sup>[3]</sup></td>
<td>uint64</td>
<td>Bignum</td>
<td>ulong</td>
<td>integer/string<sup>[5]</sup></td>
</tr>
<tr>
<td>sint32</td>
<td>使用可变长度编码。带符号的int值。这些比常规的int32更有效地编码负数。</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>Fixnum or Bignum (as required)</td>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>sint64</td>
<td>使用可变长度编码。带符号的int值。这些比常规的int64更有效地编码负数。</td>
<td>int64</td>
<td>long</td>
<td>int/long<sup>[3]</sup></td>
<td>int64</td>
<td>Bignum</td>
<td>long</td>
<td>integer/string<sup>[5]</sup></td>
</tr>
<tr>
<td>fixed32</td>
<td>总是四个字节。如果值通常大于$2^{28}$，则比uint32效率更高。</td>
<td>uint32</td>
<td>int<sup>[1]</sup></td>
<td>int</td>
<td>uint32</td>
<td>Fixnum or Bignum (as required)</td>
<td>uint</td>
<td>integer</td>
</tr>
<tr>
<td>fixed64</td>
<td>总是八个字节。如果值通常大于$2^{56}$，则会比uint64更高效。</td>
<td>uint64</td>
<td>long<sup>[1]</sup></td>
<td>int/long<sup>[3]</sup></td>
<td>uint64</td>
<td>Bignum</td>
<td>ulong</td>
<td>integer/string<sup>[5]</sup></td>
</tr>
<tr>
<td>sfixed32</td>
<td>总是四个字节。</td>
<td>int32</td>
<td>int</td>
<td>int</td>
<td>int32</td>
<td>Fixnum or Bignum (as required)</td>
<td>int</td>
<td>integer</td>
</tr>
<tr>
<td>sfixed64</td>
<td>总是八个字节。</td>
<td>int64</td>
<td>long</td>
<td>int/long<sup>[3]</sup></td>
<td>int64</td>
<td>Bignum</td>
<td>long</td>
<td>integer/string<sup>[5]</sup></td>
</tr>
<tr>
<td>bool</td>
<td></td>
<td>bool</td>
<td>boolean</td>
<td>bool</td>
<td>bool</td>
<td>TrueClass/FalseClass</td>
<td>bool</td>
<td>boolean</td>
</tr>
<tr>
<td>string</td>
<td>字符串必须始终包含UTF-8编码或7位ASCII文本。</td>
<td>string</td>
<td>String</td>
<td>str/unicode<sup>[4]</sup></td>
<td>string</td>
<td>String (UTF-8)</td>
<td>string</td>
<td>string</td>
</tr>
<tr>
<td>bytes</td>
<td>可能包含任何字节序列。</td>
<td>string</td>
<td>ByteString</td>
<td>str</td>
<td>[]byte</td>
<td>String (ASCII-8BIT)</td>
<td>ByteString</td>
<td>string</td>
</tr>
</tbody>
</table>
<p>你可以在 Protocal Buffer Encoding 中了解有关这些类型序列化消息如何编码的更多信息。</p>
<p><sup>[1]</sup> 在Java中，无符号的32位和64位整数使用其签名对应表示，最高位仅存储在符号位中。</p>
<p><sup>[2]</sup> 在所有情况下，将值设置为字段将执行类型检查以确保其有效。</p>
<p><sup>[3]</sup> 64位或无符号32位整数在解码时总是表示为long，但如果在设置字段时给定整型，则可以是int。在所有情况下，该值必须符合设置时表示的类型。见<sup>[2]</sup>。</p>
<p><sup>[4]</sup> Python字符串在解码时表示为unicode，但如果给出ASCII字符串(可能会更改)，则可以为str。</p>
<p><sup>[5]</sup> Integer用于64位机器，字符串用于32位机器。</p>
<h2 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h2><p>当一条消息被解析，如果编码的信息不包含特定的 singular 元素，则解析对象中的对应字段将设置为该字段的默认值。这些默认值是特定于类型的：</p>
<ul>
<li>对于 string 类型，默认值为空字符串。</li>
<li>对于 byte 类型，默认值是空字节。</li>
<li>对于 bool 类型，默认值是 false 。</li>
<li>对于 numeric(数字) 类型，默认值是0。</li>
<li>对于 enums 类型，默认值是第一个定义的枚举值，一定为0。</li>
<li>对于消息字段，该字段未设置。它的确切值是语言相关的。详情请参阅生成的代码指南。</li>
</ul>
<p>重复(repeated)字段的默认值为空(通常是相应语言的空列表)。</p>
<p>请注意，对于标量(scalar)消息字段，一旦解析了消息，就无法判断字段是否被显式设置为默认值(例如布尔值是否设置为<code>false</code>)或者根本没有设置：在定义消息类型时应该记住这一点。举个例子，如果你不希望该行为在默认情况下发生，请将其设置为<code>false</code>时切换某些行为的布尔值。另请注意，如果标量(scalar)消息字段被设置为其默认值，则该值不会在连线上序列化。有关如何在生成的代码中使用默认值的更多详细信息，请参阅所选语言的<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">生成代码指南</a>。</p>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>当你定义一个消息类型时，你可能希望它的一个字段只有一个预定义的值。例如，假设你想为每个<code>SearchRequest</code>添加一个<code>corpus</code>(语料库)字段，其中语料库可以是<code>UNIVERSAL</code>,<code>WEB</code>,<code>IMAGES</code>,<code>LOCAL</code>,<code>NEWS</code>,<code>PRRDUCTS</code>或<code>VIDEO</code>。你可以非常简单地通过为每个可能值添加一个常量来为消息定义添加枚举。<br>下面的示例中，我们添加一个名为<code>Corpus</code>的枚举，其中包含所有可能的值以及一个类型为<code>Corpus</code>的字段：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> query = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> page_number = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">int32</span> result_per_page = <span class="number">3</span>;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">Corpus</span> </span>&#123;</span><br><span class="line">    UNIVERSAL = <span class="number">0</span>;</span><br><span class="line">    WEB = <span class="number">1</span>;</span><br><span class="line">    IMAGES = <span class="number">2</span>;</span><br><span class="line">    LOCAL = <span class="number">3</span>;</span><br><span class="line">    NEWS = <span class="number">4</span>;</span><br><span class="line">    PRODUCTS = <span class="number">5</span>;</span><br><span class="line">    VIDEO = <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Corpus corpus = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，<code>Corpus</code>枚举的第一个常量映射为0：每个枚举定义都必须包含一个映射为0的常量作为第一个元素。这是因为：</p>
<ul>
<li>必须有一个零值，以便我们可以使用0作为数字的默认值。</li>
<li>零值需要是第一个元素，与第一个枚举值始终是默认值的proto2语义兼容。</li>
</ul>
<p>你可以通过将相同的值分配给不同的枚举常量来定义别名。为此，你需要将<code>allow_alias</code>选项设置为<code>true</code>，否则当找到别名时，协议编译器将生成错误消息。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EnumAllowingAlias</span> </span>&#123;</span><br><span class="line">  <span class="keyword">option</span> allow_alias = <span class="literal">true</span>;</span><br><span class="line">  UNKNOWN = <span class="number">0</span>;</span><br><span class="line">  STARTED = <span class="number">1</span>;</span><br><span class="line">  RUNNING = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">EnumNotAllowingAlias</span> </span>&#123;</span><br><span class="line">  UNKNOWN = <span class="number">0</span>;</span><br><span class="line">  STARTED = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// RUNNING = 1;  // Uncommenting this line will cause a compile error inside Google and a warning message outside.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>枚举器常量必须在32位整数的范围内。由于枚举值在线路上使用<code>varint</code>编码，所以负值效率不高，因此不推荐使用。你可以在消息定义中(如上例)或外部定义枚举——这些枚举可以在<code>.proto</code>文件中的任何消息定义中重用。你还可以使用语法<code>MessageType.EnumType</code>将一个消息中声明的枚举类型用作不同消息中字段的类型。</p>
<p>当你在使用<code>enum</code>的<code>.proto</code>文件上运行protocol buffer编译器，生成的代码将为Java或C++提供相应的枚举值，这是一种特殊的<code>EnumDescriptor</code>类，用于在运行时生成的类中创建一组具有整数值的符号常量。</p>
<p>在反序列化过程中，无法识别的枚举值将保留在消息中，但是当消息被反序列化时如何表示是依赖于语言的。在支持指定符号范围之外的值的开放枚举类型的语言(如C++和Go)中，未知枚举值仅作为其基础整数表示形式存储。在具有封闭枚举类型的语言(如Java)中，枚举中的一个用于表示无法识别的值，并且可以使用特殊访问器访问基础整数。在任何一种情况下，如果消息被序列化，则无法识别的值仍将与消息一起序列化。有关如何在应用程序中使用消息枚举的更多信息，请参阅所选语言的<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">生成代码指南</a>。</p>
<h3 id="保留值"><a href="#保留值" class="headerlink" title="保留值"></a>保留值</h3><p>如果你通过完全删除枚举条目或将其注释掉来更新枚举类型，未来的用户可以在对该类型进行自己的更新时重新使用数值。如果稍后加载相同的<code>.proto</code>的旧版本，包括数据损坏，隐私错误等，则可能会导致严重问题。确保这种情况不会发生的一种方法指定已删除条目的数字值(和/或名称)被保留(这也可能会导致JSON序列化的问题)。如果将来的任何用户试图使用这些标识符，protocol buffer 编译器将会报错。你可以使用<code>max</code>关键字指定保留的数值范围上升到最大可能值。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  reserved <span class="number">2</span>, <span class="number">15</span>, <span class="number">9</span> to <span class="number">11</span>, <span class="number">40</span> to max;</span><br><span class="line">  reserved <span class="string">"FOO"</span>, <span class="string">"BAR"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>请注意，你不能在同一<code>reserved</code>语句中混合字段名称和数字值。</p>
<h3 id="使用其他消息类型"><a href="#使用其他消息类型" class="headerlink" title="使用其他消息类型"></a>使用其他消息类型</h3><p>你可以使用其他消息类型作为字段类型。例如，假设你想在每个<code>SearchResponse</code>消息中包含<code>Result</code>消息——为此，你可以在同一个<code>.proto</code>中定义一个<code>Result</code>消息类型，然后在<code>SearchResponse</code>中指定<code>Result</code>类型的字段：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchResponse</span> </span>&#123;</span><br><span class="line">  <span class="keyword">repeated</span> Result results = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Result</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> url = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">string</span> title = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">string</span> snippets = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="导入定义"><a href="#导入定义" class="headerlink" title="导入定义"></a>导入定义</h3><p>在之前的例子中，<code>Result</code>消息类型与<code>SearchResponse</code>定义在同一文件中——如果你要使用的消息类型已经在其他<code>.proto</code>文件中定义了呢？<br>你可以通过导入来使用其他<code>.proto</code>文件中的定义。要导入另一个<code>.proto</code>的定义，可以在文件顶部添加一条导入语句：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"myproject/other_protos.proto"</span>;</span><br></pre></td></tr></table></figure>
<p>默认情况下，你只能使用直接导入的<code>.proto</code>文件中的定义。但是，有时你可能需要将<code>.proto</code>文件移至新位置。不是直接移动<code>.proto</code>文件，而是在一次更改中更新所有调用站点，现在你可以在旧位置放置一个虚拟<code>.proto</code>文件，以使用<code>import public</code>概念将所有导入转移到新位置。<code>import public</code>依赖可以被过渡到任何包含<code>import public</code>语句的proto中。例如：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// new.proto</span></span><br><span class="line"><span class="comment">// All definitions are moved here</span></span><br></pre></td></tr></table></figure>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old.proto</span></span><br><span class="line"><span class="comment">// This is the proto that all clients are importing.</span></span><br><span class="line"><span class="keyword">import</span> public <span class="string">"new.proto"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"other.proto"</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// client.proto</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"old.proto"</span>;</span><br><span class="line"><span class="comment">// You use definitions from old.proto and new.proto, but not other.proto</span></span><br></pre></td></tr></table></figure>
<p>协议编译器使用<code>-I / --proto_path</code>标志在协议编译器命令行中指定一组目录中搜索导入的文件。<br>如果没有给标志，它将在调用编译器的目录中查找。通常，你应该将<code>--proto_path</code>标志设置为根目录，并为所有导入使用完整名称。</p>
<h3 id="使用proto2消息类型"><a href="#使用proto2消息类型" class="headerlink" title="使用proto2消息类型"></a>使用proto2消息类型</h3><p>可以导入proto2消息类型并在proto3消息中使用它们，反之亦然。然而，proto2枚举不能直接用在proto3语法中(如果导入的proto2消息使用它们，这是可以的)。</p>
<h2 id="嵌套类型"><a href="#嵌套类型" class="headerlink" title="嵌套类型"></a>嵌套类型</h2><p>你可以在其他消息类型中定义和使用消息类型，如下例所示这里<code>ResultResponse</code>消息中定义了<code>Result</code>消息——这里<code>ResultResponse</code>消息中定义了<code>Result</code>消息：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SearchResponse</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">message</span> <span class="title">Result</span> </span>&#123;</span><br><span class="line">    <span class="built_in">string</span> url = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">string</span> title = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="built_in">string</span> snippets = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> Result results = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你想在其父消息类型外重复使用此消息类型，请将其称为<code>Parent.Type</code>：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SomeOtherMessage</span> </span>&#123;</span><br><span class="line">  SearchResponse.Result result = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你可以根据需要深度嵌套消息：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Outer</span> </span>&#123;                  <span class="comment">// Level 0</span></span><br><span class="line">  <span class="class"><span class="keyword">message</span> <span class="title">MiddleAA</span> </span>&#123;  <span class="comment">// Level 1</span></span><br><span class="line">    <span class="class"><span class="keyword">message</span> <span class="title">Inner</span> </span>&#123;   <span class="comment">// Level 2</span></span><br><span class="line">      <span class="built_in">int64</span> ival = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">bool</span>  booly = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">message</span> <span class="title">MiddleBB</span> </span>&#123;  <span class="comment">// Level 1</span></span><br><span class="line">    <span class="class"><span class="keyword">message</span> <span class="title">Inner</span> </span>&#123;   <span class="comment">// Level 2</span></span><br><span class="line">      <span class="built_in">int32</span> ival = <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">bool</span>  booly = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更新消息类型"><a href="#更新消息类型" class="headerlink" title="更新消息类型"></a>更新消息类型</h2><p>如果现有的消息类型不再满足你的所有需求——例如，你希望消息格式具有额外的字段——但你仍然希望使用使用旧格式创建的代码，别担心！在不破坏任何现有代码的情况下更新消息类型非常简单。请记住以下规则：</p>
<ul>
<li>不要更改任何现有字段的数字标记。</li>
<li>如果你添加新字段，则任何由代码使用“旧”消息格式序列化的消息仍然可以通过新生成的代码解析。你应该记住这些元素的默认值，以便新代码可以正确地与旧代码生成的消息交互。同样的，由新代码创建的消息可以由旧代码解析：旧的二进制文件在解析时会简单地忽略新字段。有关详情，请参阅未知字段部分。</li>
<li>只有在更新的消息类型中不再使用标签号码，字段就可以被删除。你可能希望重命名该字段，可能会添加前缀“OBSOLETE_”，或者保留标记，以便将来的<code>.proto</code>用户不会意外重用该号码。</li>
<li><code>int32</code>,<code>uint32</code>,<code>int64</code>,<code>uint64</code>,和<code>bool</code>全都兼容——这意味着你可以将字段从这些类型之一更改为另一字段而不破坏向前或向后兼容性。如果一个数字从不适合相应类型的线路中解析出来，则会得到与在C++中将数字转换为该类型相同的效果(例如，如果将64位数字读为int32，它将被截断为32位)。</li>
<li><code>sint32</code>和<code>sint64</code>相互兼容，但与其他整数类型不兼容。</li>
<li>只要字节是有效的UTF-8，<code>string</code>和<code>bytes</code>是兼容的。</li>
<li>嵌入式消息与字节兼容，如果字节包含消息，如果字节包含消息的编码版本。</li>
<li><code>fixed32</code>与<code>sfixed32</code>兼容，而<code>fixed64</code>与<code>sfixed64</code>兼容</li>
<li><code>enum</code>与wire格式的<code>int32</code>，<code>uint32</code>，<code>int64</code>和<code>uint64</code>兼容(请注意，如果它们不适合，值将被截断)。但请注意，当消息被反序列化时，客户端代码可能会以不同的方式处理它们：例如，无法识别的proto3枚举类型将保留在消息中，但消息反序列化时如何表示是语言相关的。 Int域始终只保留它们的值。</li>
</ul>
<h2 id="未知字段"><a href="#未知字段" class="headerlink" title="未知字段"></a>未知字段</h2><p>未知字段是格式良好的 protocal buffer 序列化数据，表示解析器无法识别的字段。例如，当一个旧的二进制文件的解析被包含新字段的新二进制文件发送时，这些新的字段将成为旧的二进制文件中的未知字段。<br>Proto3可以成功解析未知字段的消息，但是，是否能保留这些未知字段就不确定了。你不应该以来保存或删除未知字段。对于大多数 Google protocol buffer的实现，未知字段在proto3中无法通过相应的 proto runtimes 访问，并且在反序列化时被丢弃或遗忘。这是 proto2 的不同行为吗，其中未知字段总是与消息一起保存并序列化。</p>
<h2 id="Any"><a href="#Any" class="headerlink" title="Any"></a>Any</h2><p><code>Any</code> 消息类型允许你将消息用作嵌入类型，而不必具有<code>.proto</code>定义。一个<code>Any</code>包含一个任意的序列化消息作为字节，以及一个充当全局唯一标识符并解析为该消息类型的URL。要使用<code>Any</code>类型，你需要导入<code>google/protobuf/any.proto</code>。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"google/protobuf/any.proto"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">ErrorStatus</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 1;</span></span><br><span class="line"><span class="class">  <span class="title">repeated</span> google.protobuf.Any details = 2;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>
<p>给定消息类型的默认的URL是<code>type.googleapis.com/packagename.messagename</code><br>不同语言实现将支持runtime库帮助程序以类型安全的方式打包和解压缩Any的值——例如，在Java中，Any类型将具有特殊的<code>pack()</code>和<code>unpack()</code>访问器，而在C++中则有<code>PackForm()</code>和<code>UnpackTo()</code>方法：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Storing an arbitrary message type in Any.</span></span><br><span class="line">NetworkErrorDetails details = ...;</span><br><span class="line">ErrorStatus status;</span><br><span class="line">status.add_details()-&gt;PackFrom(details);</span><br><span class="line"></span><br><span class="line">// Reading an arbitrary message from Any.</span><br><span class="line">ErrorStatus status = ...;</span><br><span class="line">for (const Any&amp; detail : status.details()) &#123;</span><br><span class="line">  if (detail.Is&lt;NetworkErrorDetails&gt;()) &#123;</span><br><span class="line">    NetworkErrorDetails network_error;</span><br><span class="line">    detail.UnpackTo(&amp;network_error);</span><br><span class="line">    ... processing network_error ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>当前用于处理Ang类型的的runtime库都在开发中</strong><br>如果你已经熟悉<a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="noopener">proto2语法</a>，则Any类型会替换<a href="https://developers.google.com/protocol-buffers/docs/proto#extensions" target="_blank" rel="noopener">拓展名</a>。</p>
<h2 id="Oneof"><a href="#Oneof" class="headerlink" title="Oneof"></a>Oneof</h2><p>如果你有一个包含多个字段的消息，并且最多只能同时设置一个字段，则可以使用 oneof 功能强制执行此操作并节省内存。<br>Oneof字段与常规字段很相似，但共享中的所有字段除外，并且最多只能同时设置一个字段。设置 oneof 中的任何成员会自动清除所有其他成员。根据你选择的语言，你可以使用特殊的 <code>case()</code>或<code>WhichOneof()</code>方法检查oneof中的哪个值(如果有)被设置。</p>
<h3 id="使用-Oneof"><a href="#使用-Oneof" class="headerlink" title="使用 Oneof"></a>使用 Oneof</h3><p>要在<code>.proto</code>中定义一个oneof关键字，请使用oneof关键字，后跟你的oneof名称，在此例中为<code>test_oneof</code>：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">SampleMessage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">oneof</span> test_oneof &#123;</span><br><span class="line">    <span class="built_in">string</span> name = <span class="number">4</span>;</span><br><span class="line">    SubMessage sub_message = <span class="number">9</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，将你的oneof字段添加到oneof定义中。你可以添加任意类型的字段，但不能使用<code>repeated</code>字段。<br>在你生成的代码中，oneof字段与常规字段具有相同的<code>getter</code>和<code>setter</code>。你还可以获得一种特殊的方法检查oneof中的哪个值(如果有)被设置。你可以在相关的<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">API参考</a>中找到更多关于你所选语言的API。</p>
<h3 id="Oneof-的特点"><a href="#Oneof-的特点" class="headerlink" title="Oneof 的特点"></a>Oneof 的特点</h3><ul>
<li>设置一个oneof字段将自动清除oneof中的其他成员。所以如果你设置了多个字段，则只有你设置的最后一个字段会有值。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">SampleMessage message;</span><br><span class="line">message.set_name("name");</span><br><span class="line">CHECK(message.has_name());</span><br><span class="line">message.mutable_sub_message();   // Will clear name field.</span><br><span class="line">CHECK(!message.has_name());</span><br></pre></td></tr></table></figure>
<ul>
<li>如果解析器在线上遇到多个同一oneof中成员，则只有最后一个成员被用于解析的消息。</li>
<li>一个oneof不能是<code>repeated</code>。</li>
<li>反射API适用于oneof字段。</li>
<li>如果你使用C++，请确保你的代码不会导致内存崩溃。以下示例代码将因为调用<code>set_name()</code>方法删除了<code>sub_message</code>而崩溃。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">SampleMessage message;</span><br><span class="line">SubMessage* sub_message = <span class="class"><span class="keyword">message</span>.<span class="title">mutable_sub_message</span>();</span></span><br><span class="line"><span class="class">message.set_name("name");      // Will delete sub_message</span></span><br><span class="line"><span class="class">sub_message-&gt;set_...            // Crashes here</span></span><br></pre></td></tr></table></figure>
<ul>
<li>还是C++，如果你<code>Swap()</code>两个带有oneof的消息，每个消息都会以另一个 oneof case 结尾：在下面的例子中，<code>msg1</code>将有一个<code>sub_message</code>，而<code>msg2</code>将有一个<code>name</code>。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">SampleMessage msg1;</span><br><span class="line">msg1.set_name("name");</span><br><span class="line">SampleMessage msg2;</span><br><span class="line">msg2.mutable_sub_message();</span><br><span class="line">msg1.swap(&amp;msg2);</span><br><span class="line">CHECK(msg1.has_sub_message());</span><br><span class="line">CHECK(msg2.has_name());</span><br></pre></td></tr></table></figure>
<h3 id="向后兼容性问题"><a href="#向后兼容性问题" class="headerlink" title="向后兼容性问题"></a>向后兼容性问题</h3><p>添加或删除一个字段时请小心。如果检查一个返回值的值为<code>None</code>/<code>NOT_SET</code>，则可能意味着oneof的值没有被设置，或者被设置为不同版本的oneof字段。没有办法分辨这种差异，因为无法知道线路上的未知字段是否为oneof的成员。</p>
<h3 id="标记重用问题"><a href="#标记重用问题" class="headerlink" title="标记重用问题"></a>标记重用问题</h3><ul>
<li><strong>将字段移入或移出oneof字段</strong>：在消息序列化和解析后，可能会丢失一些信息(某些字段将被清除)。</li>
<li><strong>删除一个oneof字段再将其添加回来</strong>：在消息序列化和解析后，这可能会清除你当前设置的oneof字段。</li>
<li><strong>拆分或合并oneof</strong>：这与移动常规字段具有相似的问题。</li>
</ul>
<h2 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h2><p>如果你想创建一个关联映射(map)作为数据定义的一部分，protocol buffer提供了一个方便的快捷语法。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">map&lt;key_type, value_type&gt; map_field = N;</span><br></pre></td></tr></table></figure>
<p>其中<code>key_type</code>可以是任何整数或字符串类型(因此，除了浮点类型和字节外的任何标量类型)。请注意，枚举不是有效的<code>key_type</code>。<code>value_type</code>可以是除另一个map之外的任何类型。</p>
<p>因此，例如，如果你想创建一个项目映射，其中每个<code>Project</code>消息都与一个字符串相关联，则可以像这样定义它：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">map&lt;<span class="built_in">string</span>, Project&gt; projects = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>Map 字段不能被 <code>repeated</code>。</li>
<li>线格式排序和映射迭代排序是不确定的，所以你不能依靠映射项目的特定顺序。</li>
<li>为<code>.proto</code>生成文本格式时，映射按键排序。数字键按数字排序。</li>
<li>从线路解析或合并时，如果有重复的映射键，则使用所看到的最后一个键。从文本格式解析映射时，如果有重复的键，解析可能会失败。</li>
</ul>
<p>生成映射API目前可用于所有proto3支持的语言。你可以在相关的<a href="https://developers.google.com/protocol-buffers/docs/reference/overview" target="_blank" rel="noopener">API参考</a>中找到更多关于你所选语言的映射API的信息。</p>
<h3 id="向后兼容性"><a href="#向后兼容性" class="headerlink" title="向后兼容性"></a>向后兼容性</h3><p>映射语法等同于线路中的以下内容，因此不支持映射的 protocol buffer 接口实现仍然可以处理你的数据：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">MapFieldEntry</span> </span>&#123;</span><br><span class="line">  key_type key = <span class="number">1</span>;</span><br><span class="line">  value_type value = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repeated</span> MapFieldEntry map_field = N;</span><br></pre></td></tr></table></figure>
<h2 id="包"><a href="#包" class="headerlink" title="包"></a>包</h2><p>你可以将可选<code>package</code>说明符添加到<code>.proto</code>文件，以防止协议消息类型之间的名称冲突。</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> foo.bar;</span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Open</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>你可以在定义消息类型的字段时使用包说明符：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  foo.bar.Open open = <span class="number">1</span>;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在C++中，生成的类被封装在C++命名空间中。例如，<code>Open</code>将位于命名空间<code>foo::bar</code>。</li>
<li>在Java中，除非你在<code>.proto</code>文件中明确提供了<code>option java_package</code>，否则该包将用作Java包。</li>
<li>在Python中，package指令被忽略，因为Python模块根据它们在文件系统中的位置进行组织。</li>
<li>在Go中，除非你在<code>.proto</code>文件中明确提供了<code>option go_package</code>，否则该软件包将用作Go软件包名称。</li>
<li>在Ruby中，生成的类将被封装在嵌套的Ruby命名空间中，并转换为所需的Ruby大写样式(首字母大写;如果第一个字符不是字母，则<code>PB_</code>被预置)。例如，<code>Open</code>将位于命名空间<code>Foo::Bar</code>中。</li>
<li>在JavaNano中，该包用作Java包，除非你在<code>.proto</code>文件中明确提供了一个<code>option java_package</code>。</li>
<li>在C＃中，除非你在<code>.proto</code>文件中明确提供了<code>option csharp_namespace</code>，否则在转换为PascalCase之后，该包将用作名称空间。例如，<code>Open</code>将位于名称空间<code>Foo.Bar</code>中。</li>
</ul>
<h3 id="包和名称解决方案"><a href="#包和名称解决方案" class="headerlink" title="包和名称解决方案"></a>包和名称解决方案</h3><p>Protocol buffer 语言中的类型名称解析与C++类似：首先搜索最内层的范围，然后搜索最内层的内容，依此类推，每个包被认为是其父包的“内层”。开头的的’.’ (例如<code>.foo.bar.Baz</code>)意味着从最外层的范围开始。<br>Protocol buffer 编译器通过解析导入的<code>.proto</code>文件来解析所有类型名称。每种语言的代码生成器都知道如何引用该语言中的每种类型，即使它具有不同的作用域规则。</p>
<h2 id="定义服务"><a href="#定义服务" class="headerlink" title="定义服务"></a>定义服务</h2><p>如果你想将消息类型用于RPC(Remote Procedure Call - 远程过程调用)系统，则可以在.proto文件中定义一个RPC服务接口，并且 protocol buffer 编译器将使用你选择的语言生成服务接口代码和存根。所以，例如，如果你想用一个带有你的<code>SearchRequest</code>并返回一个<code>SearchResponse</code>的方法来定义一个RPC服务，你可以在你的<code>.proto</code>文件中定义它，如下所示：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">SearchService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Search (SearchRequest) <span class="keyword">returns</span> (SearchResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与 protocol buffer 一起使用的最直接的RPC系统是gRPC：由谷歌开发的语言无关和平台无关的开源RPC系统。gRPC特别适用于 protocol buffer ，并且可以使用特殊的 protocol buffer 编译器插件直接从.proto文件生成相关的RPC代码。<br>如果你不想使用gRPC，也可以在你自己的RPC接口实现中使用 protocol buffer 。你可以在<a href="https://developers.google.com/protocol-buffers/docs/proto#services" target="_blank" rel="noopener">Proto2语言指南</a>中找到更多关于此的信息。<br>还有一些正在进行的第三方项目为 Protocol Buffers 开发RPC实现。有关我们了解的项目的链接列表，请参阅<a href="https://github.com/google/protobuf/blob/master/docs/third_party.md" target="_blank" rel="noopener">第三方附加组件wiki页面</a>。</p>
<h2 id="JSON映射"><a href="#JSON映射" class="headerlink" title="JSON映射"></a>JSON映射</h2><p>Proto3支持JSON中的规范编码，使系统之间共享数据变得更加容易。编码在下表中按类型逐个描述。<br>如果JSON编码数据中缺少值或其值为空，则在解析为 protocol buffer 时，它将被解释为适当的默认值。如果一个字段在 protocol buffer 中具有默认值，默认情况下它将在JSON编码数据中省略以节省空间。实现可能提供选项以在JSON编码的输出中发送具有默认值的字段。</p>
<table>
<thead>
<tr>
<th>proto3</th>
<th>JSON</th>
<th>JSON example</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>message</td>
<td>object</td>
<td>{“fBar”: v, “g”: null, …}</td>
<td>生成JSON对象。消息字段名称映射到lowerCamelCase并成为JSON对象键。接受null并将其视为相应字段类型的默认值。</td>
</tr>
<tr>
<td>enum</td>
<td>string</td>
<td>“FOO_BAR”</td>
<td>使用proto中指定的枚举值的名称。</td>
</tr>
<tr>
<td>map&lt;K,V&gt;</td>
<td>object</td>
<td>{“k”: v, …}</td>
<td>所有的密钥都转换为字符串。</td>
</tr>
<tr>
<td>repeated V</td>
<td>array</td>
<td>[v, …]</td>
<td>null被接受为空list[]</td>
</tr>
<tr>
<td>bool</td>
<td>true, false</td>
<td>true, false</td>
<td></td>
</tr>
<tr>
<td>string</td>
<td>string</td>
<td>“Hello World!”</td>
<td></td>
</tr>
<tr>
<td>bytes</td>
<td>base64 string</td>
<td>“YWJjMTIzIT8kKiYoKSctPUB+”</td>
<td>JSON值将是使用带填充的标准base64编码作为字符串编码的数据。无论是标准的还是URL安全的base64编码，都可以接受。</td>
</tr>
<tr>
<td>int32, fixed32, uint32</td>
<td>number</td>
<td>1, -10, 0</td>
<td>JSON值将是一个十进制数。数字或字符串都被接受。</td>
</tr>
<tr>
<td>int64, fixed64, uint64</td>
<td>string</td>
<td>“1”, “-10”</td>
<td>JSON值将是一个十进制字符串。数字或字符串都被接受。</td>
</tr>
<tr>
<td>float, double</td>
<td>number</td>
<td>1.1, -10.0, 0, “NaN”, “Infinity”</td>
<td>JSON值将是一个数字或特殊字符串值“NaN”，“Infinity”和“-Infinity”之一。数字或字符串都被接受。指数符号也被接受。</td>
</tr>
<tr>
<td>Any</td>
<td>object</td>
<td>{“@type”: “url”, “f”: v, … }</td>
<td>如果Any包含具有特殊JSON映射的值，则它将按如下所示进行转换： {“@type”: xxx, “value”: yyy}。否则，该值将被转换为JSON对象，并且将插入“@type”字段以指示实际的数据类型。</td>
</tr>
<tr>
<td>Timestamp</td>
<td>string</td>
<td>“1972-01-01T10:00:20.021Z”</td>
<td>使用RFC 3339，其中生成的输出始终是 Z-normalized ，并使用0,3,6或9小数位。</td>
</tr>
<tr>
<td>Duration</td>
<td>string</td>
<td>“1.000340012s”, “1s”</td>
<td>生成的输出总是包含0,3,6或9个小数位，具体取决于所需的精度，后面跟着后缀“s”。接受的是任何小数位（也没有），只要它们符合纳秒精度并且后缀“s”是必需的。</td>
</tr>
<tr>
<td>Struct</td>
<td>object</td>
<td>{ … }</td>
<td>任何JSON对象。请参见<code>struct.proto</code>。</td>
</tr>
<tr>
<td>Wrapper types</td>
<td>various types</td>
<td>2, “2”, “foo”, true, “true”, null, 0, …</td>
<td>包装器在JSON中使用与包装的基本类型相同的表示形式，除了在数据转换和传输期间允许和保留null。</td>
</tr>
<tr>
<td>FieldMask</td>
<td>string</td>
<td>“f.fooBar,h”</td>
<td>见 <code>fieldmask.proto</code>.</td>
</tr>
<tr>
<td>ListValue</td>
<td>array</td>
<td>[foo, bar, …]</td>
<td></td>
</tr>
<tr>
<td>Value</td>
<td>value</td>
<td></td>
<td>任何JSON值</td>
</tr>
<tr>
<td>NullValue</td>
<td>null</td>
<td></td>
<td>JSON null</td>
</tr>
</tbody>
</table>
<h2 id="选项-option"><a href="#选项-option" class="headerlink" title="选项 (option)"></a>选项 (option)</h2><p><code>.proto</code>文件中的各个声明可以用多个<em>选项</em>批注。选项不会更改声明的整体含义，但可能会影响在特定上下文中处理它的方式。可用选项的完整列表在<code>google/protobuf/descriptor.proto</code>中定义。<br>有些选项是文件级选项，这意味着它们应该写在顶层作用域中，而不是任何消息，枚举或服务定义中。有些选项是消息级选项，意味着它们应该写在消息定义中。有些选项是字段级选项，这意味着它们应该写在字段定义中。选项也可以写在枚举类型，枚举值，服务类型和服务方法上;但是，目前没有任何有用的选项。</p>
<p>以下是一些最常用的选项：</p>
<ul>
<li><code>java_package</code>(文件选项)：你要用于生成的Java类的包。如果在<code>.proto</code>文件中没有给出明确的<code>java_package</code>选项，那么默认情况下会使用proto包(在<code>.proto</code>文件中使用“package”关键字指定)。但是，proto软件包通常不会制作出良好的Java软件包，因为proto软件包不希望以反向域名开头。如果不生成Java代码，则此选项不起作用。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">option</span> java_package = <span class="string">"com.example.foo"</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>java_multiple_files</code>(文件选项)：导致在包级别定义顶级消息，枚举和服务，而不是在以<code>.proto</code>文件命名的外部类中定义。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>java_outer_classname</code>(文件选项)：要生成的最外层Java类(因此文件名)的类名。如果没有在<code>.proto</code>文件中指定明确的<code>java_outer_classname</code>，则通过将<code>.proto</code>文件名称转换为驼峰命名(因此<code>foo_bar.proto</code>变为<code>FooBar.java</code>)来构造类名称。如果不生成Java代码，则此选项不起作用。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">option</span> java_outer_classname = <span class="string">"Ponycopter"</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>optimize_for</code>(文件选项)：可以设置为<code>SPEED</code>，<code>CODE_SIZE</code>或<code>LITE_RUNTIME</code>。这会通过以下方式影响C++和Java代码生成器(以及可能的第三方生成器)：<ul>
<li><code>SPEED</code>(默认)： protocol buffer 编译器将生成用于序列化，解析和执行消息类型的其他常见操作的代码。这段代码是高度优化的。</li>
<li><code>CODE_SIZE</code>:  protocol buffer 编译器将生成最少的类，并依靠共享的基于反射的代码来实现序列化，解析和各种其他操作。生成的代码因此比<code>SPEED</code>要小得多，但操作会比较慢。类仍将实现与<code>SPEED</code>模式中完全相同的公共API。这种模式在包含大量<code>.proto</code>文件的应用程序中非常有用，并且不需要所有这些文件都变得非常快速。</li>
<li><code>LITE_RUNTIME</code>: protocol buffer 编译器将生成仅取决于“lite”的runtime库(<code>libprotobuf-lite</code>而不是<code>libprotobuf</code>)的类。lite runtime比整个库小得多（大约小一个数量级），但省略了描述符和反射等特定功能。这对于在移动电话等受限平台上运行的应用程序特别有用。编译器仍然会像在<code>SPEED</code>模式下那样生成所有方法的快速实现。生成的类将仅实现每种语言的<code>MessageLite</code>接口，该接口仅提供完整的<code>Message</code>接口的一部分方法。</li>
</ul>
</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">option</span> optimize_for = CODE_SIZE;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cc_enable_arenas</code>（文件选项）：为C ++生成的代码启用竞技场分配。</li>
<li><code>objc_class_prefix</code>（文件选项）：设置所有Objective-C生成的类和来自此.proto的枚举的Objective-C类前缀。没有默认值。你应该使用<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/Conventions/Conventions.html#//apple_ref/doc/uid/TP40011210-CH10-SW4" target="_blank" rel="noopener">Apple建议</a>的3-5个大写字符之间的前缀。请注意，所有2个字母的前缀都由Apple保留。</li>
<li><code>deprecated</code>（字段选项）：如果设置为true，则表示该字段已被弃用且不应被新代码使用。在大多数语言中，这没有实际影响。在Java中，这变成了<code>@Deprecated</code>注释。将来，其他语言特定的代码生成器可能会在字段的访问器上生成弃用注释，这会在编译试图使用该字段的代码时反过来导致发出警告。如果该字段不被任何人使用，并且你想阻止新用户使用该字段，请考虑用保留语句替换字段声明。</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int32</span> old_field = <span class="number">6</span> [deprecated=<span class="literal">true</span>];</span><br></pre></td></tr></table></figure>
<h3 id="自定义选项"><a href="#自定义选项" class="headerlink" title="自定义选项"></a>自定义选项</h3><p>Protocol Buffers还允许你定义和使用你自己的选项。这是大多数人不需要的<strong>高级功能</strong>。如果你认为需要创建自己的选项，请参阅<a href="https://developers.google.com/protocol-buffers/docs/proto.html#customoptions" target="_blank" rel="noopener">Proto2语言指南</a>了解详细信息。请注意，创建自定义选项使用的扩展只允许proto3中的自定义选项。</p>
<h2 id="生成你的类"><a href="#生成你的类" class="headerlink" title="生成你的类"></a>生成你的类</h2><p>要生成需要使用.proto文件中定义的消息类型的Java，Python，C ++，Go，Ruby，JavaNano，Objective-C或C＃代码，需要在.proto文件上运行 Protocol Buffers 编译器协议。如果你尚未安装编译器，请<a href="https://developers.google.com/protocol-buffers/docs/downloads.html" target="_blank" rel="noopener">下载软件包</a>并按照README中的说明进行操作。对于Go，你还需要为编译器安装特殊的代码生成器插件：你可以在GitHub上的<a href="https://github.com/golang/protobuf/" target="_blank" rel="noopener">golang/protobuf</a>存储库中找到此安装说明。<br>协议编译器调用如下：</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">protoc --proto_path=IMPORT_PATH --cpp_out=DST_DIR --java_out=DST_DIR --python_out=DST_DIR --go_out=DST_DIR --ruby_out=DST_DIR --javanano_out=DST_DIR --objc_out=DST_DIR --csharp_out=DST_DIR path/to/file.proto</span><br></pre></td></tr></table></figure>
<ul>
<li><code>IMPORT_PATH</code>指定解析<code>import</code>指令时要在其中查找<code>.proto</code>文件的目录。如果省略，则使用当前目录。可以通过多次传递<code>--proto_path</code>选项来指定多个导入目录;他们将按顺序搜索。<code>-I=IMPORT_PATH</code>可以用作<code>--proto_path</code>的简短形式。</li>
<li><p>你可以提供一个或多个输出指令：</p>
<ul>
<li><code>--cpp_out</code>在<code>DST_DIR</code>中生成C++代码。有关更多信息，请参阅<a href="https://developers.google.com/protocol-buffers/docs/reference/cpp-generated" target="_blank" rel="noopener">C++生成的代码参考</a>。</li>
<li><code>--java_out</code>在<code>DST_DIR</code>中生成Java代码。查看<a href="https://developers.google.com/protocol-buffers/docs/reference/java-generated" target="_blank" rel="noopener">Java生成的代码参考</a>以获取更多信息。</li>
<li><code>--python_out</code>在<code>DST_DIR</code>中生成Python代码。查看<a href="https://developers.google.com/protocol-buffers/docs/reference/python-generated" target="_blank" rel="noopener">Python生成的代码参考</a>以获取更多信息。</li>
<li><code>--go_out</code>在<code>DST_DIR</code>中生成Go代码。查看<a href="https://developers.google.com/protocol-buffers/docs/reference/go-generated" target="_blank" rel="noopener">Go生成的代码参考</a>了解更多信息。</li>
<li><code>--ruby_out</code>在<code>DST_DIR</code>中生成Ruby代码。 Ruby生成的代码引用即将推出！</li>
<li><code>--javanano_out</code>在<code>DST_DIR</code>中生成JavaNano代码。JavaNano代码生成器有许多选项可用于自定义生成器输出：你可以在生成器<a href="https://github.com/google/protobuf/tree/master/javanano" target="_blank" rel="noopener">README</a>中找到更多关于这些的信息。 JavaNano生成的代码参考即将推出！</li>
<li><code>--objc_out</code>在<code>DST_DIR</code>中生成Objective-C代码。有关更多信息，请参阅<a href="https://developers.google.com/protocol-buffers/docs/reference/objective-c-generated" target="_blank" rel="noopener">Objective-C生成的代码参考</a>。</li>
<li><code>--csharp_out</code>在<code>DST_DIR</code>中生成C＃代码。有关更多信息，请参阅<a href="https://developers.google.com/protocol-buffers/docs/reference/csharp-generated" target="_blank" rel="noopener">C＃生成的代码参考</a>。</li>
<li><code>--php_out</code>在<code>DST_DIR</code>中生成PHP代码。查看<a href="https://developers.google.com/protocol-buffers/docs/reference/php-generated" target="_blank" rel="noopener">PHP生成的代码参考</a>了解更多信息。</li>
</ul>
<p>为了方便起见，如果<code>DST_DIR</code>以<code>.zip</code>或<code>.jar</code>结尾，编译器会将输出写入一个具有给定名称的ZIP格式存档文件。根据Java JAR规范的要求，<code>.jar</code>输出也会被赋予一个清单文件。请注意，如果输出存档已经存在，它将被覆盖;编译器不够聪明，无法将文件添加到现有存档。</p>
</li>
<li><p>你必须提供一个或多个<code>.proto</code>文件作为输入。可以一次指定多个<code>.proto</code>文件。虽然这些文件是相对于当前目录命名的，但每个文件都必须驻留在其中一个<code>IMPORT_PATH</code>中，以便编译器可以确定其规范名称。</p>
</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="RPC-framework"><a href="#RPC-framework" class="headerlink" title="RPC framework"></a>RPC framework</h2><p>RPC (Remote Procedure Call - 远程过程调用) </p>
<ul>
<li><a href="http://www.grpc.io/docs/" target="_blank" rel="noopener">GRPC - Google</a></li>
<li><a href="https://thrift.apache.org/" target="_blank" rel="noopener">Thrift - Apache</a></li>
</ul>
]]></content>
      <categories>
        <category>Protocol</category>
      </categories>
      <tags>
        <tag>Protocol Buffer</tag>
      </tags>
  </entry>
  <entry>
    <title>Google Protocol Buffer with Golang</title>
    <url>/2018/02/11/Google%20Protocol%20Buffer%20with%20Golang/</url>
    <content><![CDATA[<h2 id="了解-Google-Protocol-Buffer"><a href="#了解-Google-Protocol-Buffer" class="headerlink" title="了解 Google Protocol Buffer"></a>了解 Google Protocol Buffer</h2><p><a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener">官网</a></p>
<p>Protocol buffers are a language-neutral, platform-neutral extensible mechanism for serializing structured data.</p>
<a id="more"></a>
<h2 id="下载二进制文件"><a href="#下载二进制文件" class="headerlink" title="下载二进制文件"></a>下载二进制文件</h2><p><a href="https://github.com/google/protobuf/releases" target="_blank" rel="noopener">https://github.com/google/protobuf/releases</a></p>
<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><h3 id="GOPATH"><a href="#GOPATH" class="headerlink" title="GOPATH"></a>GOPATH</h3><p>命令行输入:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go dev</span><br></pre></td></tr></table></figure>
<p>或者在系统环境变量里添加一条GOPATH指向你的自定义目录。</p>
<p>最后将<code>$GOPATH</code>添加到系统环境变量path中。</p>
<h3 id="可执行文件加入-GOPATH"><a href="#可执行文件加入-GOPATH" class="headerlink" title="可执行文件加入$GOPATH"></a>可执行文件加入$GOPATH</h3><p>以Windows为例，将下载的压缩包的bin目录下的<code>protoc.exe</code>复制到你的任意path路径下，我放到<code>$GOPATH/bin</code>目录下。</p>
<h3 id="添加Go语言支持"><a href="#添加Go语言支持" class="headerlink" title="添加Go语言支持"></a>添加Go语言支持</h3><p>命令行执行以下命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">go get -u github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>
<h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><p>先编写一个<code>addressbook.proto</code>文件</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line">package tutorial;</span><br><span class="line">message Person &#123;</span><br><span class="line">  string name = 1;</span><br><span class="line">  int32 id = 2;  // Unique ID number <span class="keyword">for</span> this person.</span><br><span class="line">  string email = 3;</span><br><span class="line"></span><br><span class="line">  enum PhoneType &#123;</span><br><span class="line">    MOBILE = 0;</span><br><span class="line">    HOME = 1;</span><br><span class="line">    WORK = 2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  message PhoneNumber &#123;</span><br><span class="line">    string number = 1;</span><br><span class="line">    PhoneType <span class="built_in">type</span> = 2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  repeated PhoneNumber phones = 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Our address book file is just one of these.</span><br><span class="line">message AddressBook &#123;</span><br><span class="line">  repeated Person people = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>命令行输入以下生成命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">protoc --go_out=./ ./addressbook.proto</span><br><span class="line"><span class="comment"># 命令格式 protoc -I=$SRC_DIR --go_out=$DST_DIR $SRC_DIR/addressbook.proto</span></span><br></pre></td></tr></table></figure>
<p>在当前目录下生成<code>addressbook.pb.go</code>文件</p>
]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
        <tag>Protocol Buffer</tag>
      </tags>
  </entry>
  <entry>
    <title>一些节约生命的操作 (墙内加速 git pip conda npm docker)</title>
    <url>/2017/08/06/%E4%B8%80%E4%BA%9B%E8%8A%82%E7%BA%A6%E7%94%9F%E5%91%BD%E7%9A%84%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<p>你是否感觉  pip， npm, git， docker 之类的工具下载安装奇慢？<br>因为它们的默认服务器都在国外，那么需要必要的设置才能发挥咱百兆光纤的作用。下面介绍方法:</p>
<a id="more"></a>
<details><br><br><summary>如果你用的是 linux，别折腾了挂代理解决一切问题</summary><br><br>简单配置下全局代理，也可以将下面这句加入 profile 中<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 假如你的代理地址是 http://127.0.0.1:1080</span></span><br><span class="line"><span class="built_in">export</span> proxy=http://127.0.0.1:1080; <span class="built_in">export</span> http_proxy=<span class="variable">$proxy</span> https_proxy=<span class="variable">$proxy</span> no_proxy=<span class="string">"localhost, 127.0.0.0/8, ::1"</span></span><br></pre></td></tr></table></figure><br><br>用 <code>privoxy</code> 稍微折腾下见<a href="http://www.findshank.com/2018/04/15/Linux%E4%B8%8B%E4%BD%BF%E7%94%A8SS%E6%9C%AC%E5%9C%B0%E4%BB%A3%E7%90%86/">这篇文章</a><br><br></details>

<h2 id="pip-的配置"><a href="#pip-的配置" class="headerlink" title="pip 的配置"></a>pip 的配置</h2><p>解决方式：使用国内的pypi镜像加速，以阿里源为例。</p>
<h3 id="方法1-修改配置"><a href="#方法1-修改配置" class="headerlink" title="方法1 修改配置"></a>方法1 修改配置</h3><ul>
<li>Linux</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir ~/.pip &amp;&amp; <span class="built_in">echo</span> <span class="string">"[global]</span></span><br><span class="line"><span class="string">trusted-host =  mirrors.aliyun.com</span></span><br><span class="line"><span class="string">index-url = http://mirrors.aliyun.com/pypi/simple"</span> &gt; ~/.pip/pip.conf</span><br></pre></td></tr></table></figure>
<blockquote>
<p>欲使用其他源，自行搜索替换。更多配置参数见<a href="http://www.pip-installer.org/en/latest/configuration.html" target="_blank" rel="noopener">官方文档</a>。</p>
</blockquote>
<ul>
<li>Windows</li>
</ul>
<p>打开powershell(不是cmd!)，粘贴下面命令。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir ~/pip/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[global]</span></span><br><span class="line"><span class="string">trusted-host =  mirrors.aliyun.com</span></span><br><span class="line"><span class="string">index-url = http://mirrors.aliyun.com/pypi/simple</span></span><br><span class="line"><span class="string">"</span> | out-file -encoding ascii ~/pip/pip.ini</span><br></pre></td></tr></table></figure>
<p>解释：在用户目录(C:\Users\Username)下新建名为pip的目录，目录下新建文件pip.ini，写入阿里的镜像源配置。</p>
<blockquote>
<p>P.S 因为默认输出编码为utf16会导致pip出错，必须指定编码。</p>
</blockquote>
<h3 id="方法2-临时使用"><a href="#方法2-临时使用" class="headerlink" title="方法2 临时使用"></a>方法2 临时使用</h3><p>以安装numpy为例。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install numpy -i http://mirrors.aliyun.com/pypi/simple/</span><br></pre></td></tr></table></figure>
<h2 id="conda-的配置"><a href="#conda-的配置" class="headerlink" title="conda 的配置"></a>conda 的配置</h2><h3 id="方法1-配置代理"><a href="#方法1-配置代理" class="headerlink" title="方法1 配置代理"></a>方法1 配置代理</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">conda config --<span class="built_in">set</span> proxy_servers.http http://id:pw@address:port</span><br><span class="line">conda config --<span class="built_in">set</span> proxy_servers.https https://id:pw@address:port</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ref: <a href="https://stackoverflow.com/a/48416007" target="_blank" rel="noopener">Running conda with proxy</a></p>
</blockquote>
<h3 id="方法2-配置国内镜像"><a href="#方法2-配置国内镜像" class="headerlink" title="方法2 配置国内镜像"></a>方法2 配置国内镜像</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加 Anaconda 的清华镜像</span></span><br><span class="line">conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/</span><br><span class="line"><span class="comment"># 搜索时显示通道地址</span></span><br><span class="line">conda config --<span class="built_in">set</span> show_channel_urls yes</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ref: <a href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-channels.html" target="_blank" rel="noopener">Managing channels</a></p>
</blockquote>
<h2 id="git-的配置"><a href="#git-的配置" class="headerlink" title="git 的配置"></a>git 的配置</h2><p>这个就要代理了。</p>
<h3 id="方法1-设置git全局变量"><a href="#方法1-设置git全局变量" class="headerlink" title="方法1 设置git全局变量"></a>方法1 设置git全局变量</h3><p><del>我曾经使用的lantern</del>，它提供两种代理端口： Http(s) 和 Socks5。使用下面命令配置git代理：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config --global http.proxy http://127.0.0.1:50219</span><br><span class="line">git config --global https.proxy https://127.0.0.1:50219</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git config --global http.proxy socks5://127.0.0.1:50221</span><br><span class="line">git config --global https.proxy socks5://127.0.0.1:50221</span><br></pre></td></tr></table></figure>
<p>根据你的代理配置，修改对应部分即可。</p>
<h3 id="方法2-设置临时变量"><a href="#方法2-设置临时变量" class="headerlink" title="方法2 设置临时变量"></a>方法2 设置临时变量</h3><p><code>git clone</code> 时可以这么写:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ALL_PROXY=http://127.0.0.1:1080 git <span class="built_in">clone</span> https://github.com/some/one.git</span><br></pre></td></tr></table></figure>
<h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><p>解决方法：使用国内的加速地址。获取途径很多。我使用的是阿里云的容器镜像服务里的专属加速地址。</p>
<blockquote>
<p><code>PCODE</code> 是阿里云帐户的加速前缀，后文中请自行替换。可以在<a href="https://cr.console.aliyun.com/#/accelerator" target="_blank" rel="noopener">这里</a>获取</p>
</blockquote>
<ul>
<li>Linux</li>
</ul>
<p>修改<code>/etc/docker/daemon.json</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://PCODE.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>
<blockquote>
<p>P.S Docker版本需大于1.10.0</p>
</blockquote>
<ul>
<li>Windows</li>
</ul>
<blockquote>
<p>我的系统是Window10，官方推荐使用 <code>Docker for Windows</code> ，此处不介绍 <code>Docker Toolbox</code></p>
</blockquote>
<p>在系统右下角托盘图标内右键菜单选择 Settings，打开配置窗口后左侧导航菜单选择 Docker Daemon。编辑窗口内的JSON串，填写加速器地址，如下所示：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://PCODE.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编辑完成，点击 Apply 保存按钮，等待Docker重启并应用配置的镜像加速器。</p>
<blockquote>
<p><code>Docker for Windows</code> 和 <code>Docker Toolbox</code>是不兼容的。</p>
</blockquote>
<h2 id="npm-的配置"><a href="#npm-的配置" class="headerlink" title="npm 的配置"></a>npm 的配置</h2><h3 id="挂代理是最好的解决办法"><a href="#挂代理是最好的解决办法" class="headerlink" title="挂代理是最好的解决办法"></a>挂代理是最好的解决办法</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> proxy http://proxy.company.com:8080</span><br><span class="line">npm config <span class="built_in">set</span> https-proxy http://proxy.company.com:8080</span><br></pre></td></tr></table></figure>
<details><br><br><summary> update: 之前的方式均不推荐！ </summary><br><br><del>解决方式：也是替换国内的源，以淘宝源为例。</del><br><br>### <del>方法1 修改默认库配置(不推荐！会有莫名其妙的问题)</del><br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><br><br>### <del>方法2 使用cnpm</del><br><br>使用cnpm命令替代npm命令。<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><br><br>### <del>方法3 临时替换下载源</del><br><br>以安装Express为例。<br><br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm --registry=https://registry.npm.taobao.org install express</span><br></pre></td></tr></table></figure><br><br></details>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p><del>能省一秒是一秒对吧，毕竟不是所有人都有+1s的能力</del></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>npm</tag>
        <tag>git</tag>
        <tag>pip</tag>
        <tag>conda</tag>
      </tags>
  </entry>
  <entry>
    <title>MVC 部分刷新的尝试</title>
    <url>/2017/06/15/MVC%20%E9%83%A8%E5%88%86%E5%88%B7%E6%96%B0%E7%9A%84%E5%B0%9D%E8%AF%95/</url>
    <content><![CDATA[<p><a href="#NewVersion">直接跳到2.0版本</a></p>
<h1 id="版本0-1-简单的异步刷新尝试"><a href="#版本0-1-简单的异步刷新尝试" class="headerlink" title="版本0.1 - 简单的异步刷新尝试"></a>版本0.1 - 简单的异步刷新尝试</h1><ul>
<li>ProcessController中加入</li>
</ul>
<a id="more"></a>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">AllowAnonymous</span>] <span class="comment">// 这是允许匿名访问的声明，没有用ASP.NET IDENTITY可以删掉</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">PartialTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line">[<span class="meta">AllowAnonymous</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Fetch</span>(<span class="params"><span class="keyword">int</span> num</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// 取前num条数据</span></span><br><span class="line">  <span class="keyword">var</span> model = db.Movies.Take(num).ToList();</span><br><span class="line">  <span class="comment">// MovieList是你的Partial页面的名字,model是与该Partial页头部接受的类型一致的model</span></span><br><span class="line">  <span class="keyword">return</span> PartialView(<span class="string">"MovieList"</span>, model);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>/View/Process/PartialTest.cshtml</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>加一条<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"notificationsTable"</span>&gt;</span></span><br><span class="line">    @&#123;Html.RenderAction("Fetch", new &#123; num = 1 &#125;);&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@* 添加JS到布局页，否则找不到jQuery的$标记 *@</span><br><span class="line">@section scripts&#123;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    var n = 2;</span><br><span class="line">    $(document).ready(function () &#123;</span><br><span class="line">        $("#btn").click(function () &#123;</span><br><span class="line">            $("#notificationsTable").load('/Process/Fetch?num=' + n);</span><br><span class="line">            n++;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>地址栏运行/Process/PartialTest 即可</li>
</ul>
<h1 id="更新-1-0-使用-Ajax-ActionLink"><a href="#更新-1-0-使用-Ajax-ActionLink" class="headerlink" title="更新 1.0 - 使用@Ajax.ActionLink"></a>更新 1.0 - 使用@Ajax.ActionLink</h1><p>不希望在cshtml代码里用JS?  Razor Helper 还提供了 @Ajax.ActionLink</p>
<p>感谢下面链接里的大佬 </p>
<p><a href="http://www.c-sharpcorner.com/UploadFile/abhikumarvatsa/ajax-actionlink-and-html-actionlink-in-mvc/" target="_blank">传送门</a></p>
<ul>
<li>先在VS的程序包管理器控制台输入 (PS.如果有问题就在NuGet搜索安装) </li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Package</span> Microsoft.jQuery.Unobtrusive.Ajax</span><br></pre></td></tr></table></figure>
<ul>
<li>修改/View/Process/PartialTest.cshtml为</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@Ajax.ActionLink("一条变两条", "Fetch",new &#123; num = 2 &#125;,</span><br><span class="line">   new AjaxOptions</span><br><span class="line">   &#123;</span><br><span class="line">       UpdateTargetId = "notificationsTable",</span><br><span class="line">       InsertionMode = InsertionMode.Replace,</span><br><span class="line">       HttpMethod = "GET"</span><br><span class="line">   &#125;,</span><br><span class="line">   new</span><br><span class="line">   &#123;</span><br><span class="line">       @class = "btn btn-default",</span><br><span class="line">       @role = "button"</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"notificationsTable"</span>&gt;</span></span><br><span class="line">    @&#123;Html.RenderAction("Fetch", new &#123; num = 1 &#125;);&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@section scripts&#123;</span><br><span class="line">    @Scripts.Render("~/Scripts/jquery.unobtrusive-ajax.min.js")</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于用@Ajax.ActionLink生成的按钮是固定的，所以没法像JS那样动态修改请求变量，但是页面的异步刷新效果还是有的</li>
</ul>
<h1 id="更新-1-1-解决上面的问题"><a href="#更新-1-1-解决上面的问题" class="headerlink" title="更新 1.1 - 解决上面的问题"></a>更新 1.1 - 解决上面的问题</h1><p>动态更改ActionLink的routeValues，StackOverflow的回答基本是用JQuery，下面是解决办法：</p>
<ul>
<li>修改/View/Process/PartialTest.cshtml为：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">@Ajax.ActionLink(<span class="string">"加一条"</span>, <span class="string">"Fetch"</span>,<span class="keyword">new</span> &#123; num = <span class="string">"xxx"</span> &#125;,</span><br><span class="line">   <span class="keyword">new</span> AjaxOptions</span><br><span class="line">   &#123;</span><br><span class="line">       UpdateTargetId = <span class="string">"notificationsTable"</span>,</span><br><span class="line">       InsertionMode = InsertionMode.Replace,</span><br><span class="line">       HttpMethod = <span class="string">"GET"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="keyword">new</span></span><br><span class="line">   &#123;</span><br><span class="line">       @id = <span class="string">"btn"</span>,</span><br><span class="line">       @<span class="keyword">class</span> = <span class="string">"btn btn-default"</span>,</span><br><span class="line">       @role = <span class="string">"button"</span></span><br><span class="line">   &#125;</span><br><span class="line">)</span><br><span class="line">@section scripts&#123;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        <span class="keyword">var</span> n = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">var</span> href = $(<span class="string">'#btn'</span>).attr(<span class="string">'href'</span>);</span><br><span class="line">        $(document).ready(function () &#123;</span><br><span class="line">            $(<span class="string">"#btn"</span>).click(function () &#123;</span><br><span class="line">                <span class="keyword">this</span>.href = href.replace(<span class="string">"xxx"</span>, n++);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    @Scripts.Render(<span class="string">"~/Scripts/jquery.unobtrusive-ajax.min.js"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里实现了0.1版本一样的功能，是不是有种转了一圈回到原点的感觉？好讽刺啊……</li>
</ul>
<p id="NewVersion"></p>

<h1 id="更新2-0-Form表单提交实现指定DIV的异步刷新"><a href="#更新2-0-Form表单提交实现指定DIV的异步刷新" class="headerlink" title="更新2.0 - Form表单提交实现指定DIV的异步刷新"></a>更新2.0 - Form表单提交实现指定DIV的异步刷新</h1><p>上面讨论了如何按下按钮时异步刷新页面，那么在表单提交我不想跳转，我也要异步刷新，怎么办呢？下面介绍解决办法。这部分实现一个展示不同分类下的电影列表。从 Model - View - Controller 一步步来实现：</p>
<ul>
<li>Model - /Models/Movie</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Movie</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Display(Name = <span class="meta-string">"电影名"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Types</span><br><span class="line">    &#123;</span><br><span class="line">        动作, 喜剧, 科幻, 爱情, 纪录, 动画, 恐怖, 悬疑, 青春, 文艺, 励志, 战争, 犯罪</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="meta">Display(Name = <span class="meta-string">"类型"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> Types? Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>View - /View/Process/PartialTest2.cshtml</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@model ZeroMovie.Models.Movie</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">"tForm"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-horizontal"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            @Html.LabelFor(model =&gt; model.Type, htmlAttributes: new &#123; @class = "control-label col-md-2" &#125;)</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-10"</span>&gt;</span></span><br><span class="line">                @Html.EnumDropDownListFor(model =&gt; model.Type, htmlAttributes: new &#123; @class = "form-control" &#125;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-offset-2 col-md-10"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> <span class="attr">id</span>=<span class="string">"btn"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span>   </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"PartialRefreshArea"</span>&gt;</span>刷新这里<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">@section scripts&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">        $(document).ready(function () &#123;</span><br><span class="line">            $('#tform').on('submit', function (e) &#123;</span><br><span class="line">                e.preventDefault();</span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    type: 'post', // Form的Method</span><br><span class="line">                    url: '@Url.Action("Fetch","Process")', // Form的Action</span><br><span class="line">                    data: $('#tform').serialize(), // 序列化提交数据</span><br><span class="line">                    success: function (res) &#123;</span><br><span class="line">                        $('#PartialRefreshArea').html(res);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    @Scripts.Render("~/Scripts/jquery.unobtrusive-ajax.min.js")</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>View - /View/Process/MovieList.cshtml</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@model IEnumerable<span class="tag">&lt;<span class="name">ZeroMovie.Models.Movie</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">"table"</span> <span class="attr">style</span>=<span class="string">"table-layout:fixed"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">            @Html.DisplayNameFor(model =&gt; model.Name)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">th</span>&gt;</span></span><br><span class="line">            @Html.DisplayNameFor(model =&gt; model.Type)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">@foreach (var item in Model) &#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            @Html.DisplayFor(modelItem =&gt; item.Name)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">            @Html.DisplayFor(modelItem =&gt; item.Type)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Controller - /Controller/ProcessController.cs</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProcessController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 上下文类有 DbSet&lt;Movie&gt;</span></span><br><span class="line">    <span class="keyword">private</span> ApplicationDbContext db = <span class="keyword">new</span> ApplicationDbContext(); </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">PartialTest2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> View();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Fetch2</span>(<span class="params">[Bind(Include = <span class="string">"Type"</span></span>)] Movie movie)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> model = db.Movies.ToList();</span><br><span class="line">        <span class="keyword">if</span>(movie.Type != <span class="literal">null</span>)</span><br><span class="line">            model = db.Movies.Where(p =&gt; p.Type == movie.Type).ToList();</span><br><span class="line">        <span class="keyword">return</span> PartialView(<span class="string">"MovieList"</span>, model); <span class="comment">// model的类型要与MovieList接受的类型一致</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>运行后地址栏访问/Process/PartialTest2即可</li>
</ul>
<h2 id="总结：JS大法好"><a href="#总结：JS大法好" class="headerlink" title="总结：JS大法好"></a>总结：JS大法好</h2><p>弱弱问一句垃圾代码有人要看吗：</p>
<p><a href="https://github.com/sko00o/ZeroMovie" target="_blank">传送门</a></p>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
        <tag>MVC</tag>
        <tag>Razor</tag>
      </tags>
  </entry>
  <entry>
    <title>EF框架配置使用各种数据库</title>
    <url>/2017/06/04/EF%E6%A1%86%E6%9E%B6%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<h3 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h3><ul>
<li><a href="#localdb">LocalDB</a></li>
<li><a href="#sql-server">SQL Server</a></li>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#oracle">Oralce</a></li>
</ul>
<a id="more"></a>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p><em>环境： Visual Studio Community 2017，Windows 10.0.15063 pro</em></p>
<ul>
<li>先新建一个ASP.NET MVC项目DbConnectPrac</li>
</ul>
<p><img src="00.png" alt="pic00"></p>
<p><img src="0.png" alt="pic0"></p>
<ul>
<li>程序包管理器控制台安装EF框架</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Install-Package</span> EntityFramework</span><br></pre></td></tr></table></figure>
<p>  <em>PS. 如果解决方里有多个项目，默认项目注意选择DbConnectPrac</em></p>
<ul>
<li><p>Models中新建一个类</p>
<p><img src="pic1.png" alt="pic1"></p>
<p><em>Program.cs</em></p>
</li>
</ul>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DbConnectPrac.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Uid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">StringLength(16, MinimumLength = 3)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> NickName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">StringLength(16, MinimumLength = 6)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">RegularExpression(@<span class="meta-string">"^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$"</span>)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Privilege &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Video</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Vid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">StringLength(30)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Vname &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Vurl &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Thumbnail &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> ViewedNum &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">        [<span class="meta">DisplayFormat(DataFormatString = <span class="meta-string">"&#123;0:yyyy-MM-dd&#125;"</span>, ApplyFormatInEditMode = true)</span>]</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> UploadTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Vtype &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Uid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">StringLength(200)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Vinfo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Comment</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Cid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Uid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Vid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Content &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">        [<span class="meta">DisplayFormat(DataFormatString = <span class="meta-string">"&#123;0:yyyy-MM-dd&#125;"</span>, ApplyFormatInEditMode = true)</span>]</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> CommentTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">History</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Hid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Uid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Vid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">        [<span class="meta">DisplayFormat(DataFormatString = <span class="meta-string">"&#123;0:yyyy-MM-dd&#125;"</span>, ApplyFormatInEditMode = true)</span>]</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> HistoryTime &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成解决方案</li>
</ul>
<p>快捷键 Ctrl+Shift+b</p>
<ul>
<li>Controllers中新建控制器</li>
</ul>
<p><img src="pic2.png" alt="pic2"></p>
<p><img src="3.png" alt="pic3"></p>
<p>点击添加，将生成以下文件</p>
<p><img src="5.png" alt="pic5"></p>
<p><em>分别把另外几个类也创建好带视图的控制器</em></p>
<h3 id="LocalDB"><a href="#LocalDB" class="headerlink" title="LocalDB"></a>LocalDB</h3><p><em>LocalDB是VS自带的简化版SQL Server</em></p>
<ul>
<li>查看项目根目录的Web.config，发现已添加了LocalDB的相关内容</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"DbConnectPracContext"</span> <span class="attr">connectionString</span>=<span class="string">"Data Source=(localdb)\MSSQLLocalDB; Initial Catalog=DbConnectPracContext-20170603111224; Integrated Security=True; MultipleActiveResultSets=True; AttachDbFilename=|DataDirectory|DbConnectPracContext-20170603111224.mdf"</span> <span class="attr">providerName</span>=<span class="string">"System.Data.SqlClient"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entityFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultConnectionFactory</span> <span class="attr">type</span>=<span class="string">"System.Data.Entity.Infrastructure.LocalDbConnectionFactory, EntityFramework"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">parameters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parameter</span> <span class="attr">value</span>=<span class="string">"mssqllocaldb"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">parameters</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">defaultConnectionFactory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">providers</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">provider</span> <span class="attr">invariantName</span>=<span class="string">"System.Data.SqlClient"</span> <span class="attr">type</span>=<span class="string">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">providers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entityFramework</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行项目进入对应的Controller你可以方便的实现增删改查(CRUD)操作。</li>
</ul>
<p><img src="6.png" alt="pic6"></p>
<h3 id="SQL-Server"><a href="#SQL-Server" class="headerlink" title="SQL Server"></a>SQL Server</h3><p><em>版本 2016 Developer edition</em></p>
<ul>
<li>在根目录的Web.config中添加SQL Server的连接字段</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 按实际情况更改 Data Source, User ID, Password --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"MSSQLConnectContext"</span> </span></span><br><span class="line"><span class="tag">     <span class="attr">connectionString</span>=<span class="string">"Data Source=localhost; Initial Catalog=TESTDB; Persist Security Info=True; User ID=sa; Password=123"</span> </span></span><br><span class="line"><span class="tag">     <span class="attr">providerName</span>=<span class="string">"System.Data.SqlClient"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打开Models/DbConnectPracContext.cs</li>
</ul>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbConnectPracContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 修改指定使用的数据库连接</span></span><br><span class="line">  <span class="comment">//public DbConnectPracContext() : base("name=DbConnectPracContext")&#123;&#125; // LocalDB</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DbConnectPracContext</span>(<span class="params"></span>) : <span class="title">base</span>(<span class="params"><span class="string">"name=MSSQLConnectContext"</span></span>)</span> &#123;&#125; <span class="comment">// SQL Server</span></span><br><span class="line">  <span class="comment">// .....省略......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序包管理器控制台输入</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Enable-Migrations</span> <span class="literal">-EnableAutomaticMigrations</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行项目进入对应的Controller你可以方便的实现增删改查(CRUD)操作。</li>
</ul>
<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p><em>版本 5.7.18</em></p>
<ul>
<li>程序包管理器控制台安装EF框架</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Install-Package MySql.Data.Entity</span><br></pre></td></tr></table></figure>
<ul>
<li><p>查看项目根目录的Web.config</p>
<p><em>更新了以下有关MySQL的内容</em></p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">entityFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">providers</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">provider</span> <span class="attr">invariantName</span>=<span class="string">"MySql.Data.MySqlClient"</span> <span class="attr">type</span>=<span class="string">"MySql.Data.MySqlClient.MySqlProviderServices, MySql.Data.Entity.EF6, Version=6.9.9.0, Culture=neutral, PublicKeyToken=c5687fc88969c44d"</span>&gt;</span><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">providers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entityFramework</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system.data</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">DbProviderFactories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remove</span> <span class="attr">invariant</span>=<span class="string">"MySql.Data.MySqlClient"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"MySQL Data Provider"</span> <span class="attr">invariant</span>=<span class="string">"MySql.Data.MySqlClient"</span> <span class="attr">description</span>=<span class="string">".Net Framework Data Provider for MySQL"</span> <span class="attr">type</span>=<span class="string">"MySql.Data.MySqlClient.MySqlClientFactory, MySql.Data, Version=6.9.9.0, Culture=neutral, PublicKeyToken=c5687fc88969c44d"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">DbProviderFactories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.data</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>connectionStrings中添加MySQL的连接字段</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"MySQLConnectContext"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">connectionString</span>=<span class="string">"server=localhost; port=3306; database=TESTDB; uid=root; password=123"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">providerName</span>=<span class="string">"MySql.Data.MySqlClient"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打开Models/DbConnectPracContext.cs完成两处修改</li>
</ul>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 在Context指定mySql的配置文件</span></span><br><span class="line">[<span class="meta">DbConfigurationType(typeof(MySql.Data.Entity.MySqlEFConfiguration))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbConnectPracContext</span> : <span class="title">DbContext</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 修改指定使用的数据库连接</span></span><br><span class="line">  <span class="comment">//public DbConnectPracContext() : base("name=DbConnectPracContext")&#123;&#125; // LocalDB</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DbConnectPracContext</span>(<span class="params"></span>) : <span class="title">base</span>(<span class="params"><span class="string">"name=MySQLConnectContext"</span></span>)</span>&#123;&#125; <span class="comment">// MySQL</span></span><br><span class="line">  <span class="comment">// .....省略......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序包管理器控制台输入</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Enable-Migrations</span> <span class="literal">-EnableAutomaticMigrations</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行项目进入对应的Controller你可以方便的实现增删改查(CRUD)操作。</li>
</ul>
<p>  <em>连接MySQL查看生成的testdb表</em></p>
<p><img src="7.png" alt="pic7"></p>
<h3 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h3><p><em>版本 12.2.0.1.0</em></p>
<ul>
<li>建议先创建一个新用户，否则使用默认用户可能有意想不到的问题</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 用SQLPLUS登录后，连接管理员 (system_password 是你的管理员密码)</span></span><br><span class="line">CONNECT system/system_password@ORCL</span><br><span class="line"><span class="comment">-- 该版本Oracle上创建新用户名必须C##或c##开头，否则不合法</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> C<span class="comment">##TESTUSER IDENTIFIED BY 123;</span></span><br><span class="line"><span class="comment">-- 创建测试用户并授权，要给DBA权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">CONNECT</span>, <span class="keyword">RESOURCE</span>, DBA, <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> <span class="keyword">TO</span>  C<span class="comment">##TESTUSER ;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>程序包管理器控制台安装EF框架</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Install-Package Oracle.ManagedDataAccess.EntityFramework</span><br></pre></td></tr></table></figure>
<ul>
<li><p>查看根目录的Web.config</p>
<p><em>更新了以下有关Oracle的内容</em></p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configSections</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">name</span>=<span class="string">"oracle.manageddataaccess.client"</span> <span class="attr">type</span>=<span class="string">"OracleInternal.Common.ODPMSectionHandler, Oracle.ManagedDataAccess, Version=4.122.1.0, Culture=neutral, PublicKeyToken=89b483f429c47342"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configSections</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"OracleDbContext"</span> <span class="attr">providerName</span>=<span class="string">"Oracle.ManagedDataAccess.Client"</span> <span class="attr">connectionString</span>=<span class="string">"User Id=oracle_user;Password=oracle_user_password;Data Source=oracle"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entityFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">providers</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">provider</span> <span class="attr">invariantName</span>=<span class="string">"Oracle.ManagedDataAccess.Client"</span> <span class="attr">type</span>=<span class="string">"Oracle.ManagedDataAccess.EntityFramework.EFOracleProviderServices, Oracle.ManagedDataAccess.EntityFramework, Version=6.122.1.0, Culture=neutral, PublicKeyToken=89b483f429c47342"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">providers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entityFramework</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system.data</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">DbProviderFactories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remove</span> <span class="attr">invariant</span>=<span class="string">"Oracle.ManagedDataAccess.Client"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"ODP.NET, Managed Driver"</span> <span class="attr">invariant</span>=<span class="string">"Oracle.ManagedDataAccess.Client"</span> <span class="attr">description</span>=<span class="string">"Oracle Data Provider for .NET, Managed Driver"</span> <span class="attr">type</span>=<span class="string">"Oracle.ManagedDataAccess.Client.OracleClientFactory, Oracle.ManagedDataAccess, Version=4.122.1.0, Culture=neutral, PublicKeyToken=89b483f429c47342"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">DbProviderFactories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.data</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">oracle.manageddataaccess.client</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span> <span class="attr">number</span>=<span class="string">"*"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dataSources</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">alias</span>=<span class="string">"SampleDataSource"</span> <span class="attr">descriptor</span>=<span class="string">"(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=localhost)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=ORCL))) "</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dataSources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">oracle.manageddataaccess.client</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>connectionStrings中修改Oracle的连接字段的参数</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 因为生成的&lt;dataSources&gt;中服务名是ORCL，与我的设置相同，所以这里直接用别名SampleDataSource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">"OracleDbContext"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">providerName</span>=<span class="string">"Oracle.ManagedDataAccess.Client"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">connectionString</span>=<span class="string">"User Id=C##TESTUSER;Password=123;Data Source=SampleDataSource"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改Models/DbConnectPracContext.cs</li>
</ul>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DbConnectPrac.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbConnectPracContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 修改指定使用的数据库连接</span></span><br><span class="line">        <span class="comment">//public DbConnectPracContext() : base("name=DbConnectPracContext") &#123; &#125; // LocalDB</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DbConnectPracContext</span>(<span class="params"></span>) : <span class="title">base</span>(<span class="params"><span class="string">"name=OracleDbContext"</span></span>)</span> &#123; &#125; <span class="comment">// Oracle</span></span><br><span class="line">        <span class="comment">// 默认的模式名是dbo，但Oracle中不存在模式名为dbo，需要指定默认模式名</span></span><br><span class="line">      	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">DbModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            modelBuilder.HasDefaultSchema(<span class="string">"C##TESTUSER"</span>); <span class="comment">// 默认模式名就是把你用户名大写</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// .....省略......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Oracle中不存在模式名为dbo，dbo是SQL Server数据库的，如图例。</p>
<p><img src="9.png" alt="pic9"></p>
<ul>
<li>程序包管理器控制台输入</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Enable-Migrations</span> <span class="literal">-EnableAutomaticMigrations</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行项目进入对应的Controller你可以方便的实现增删改查(CRUD)操作。</li>
</ul>
<p><em>连接Oracle查看生成的表</em></p>
<p><img src="10.png" alt="pic10"></p>
<p><strong>最后一次测试时，发现一个BUG，如果把刚生成的表全删除，试图通过重新运行项目重新建表，会失败。这个情况只在Oracle上发生，大概官方还没注意到这个BUG。“一次性”用户真是尴尬……</strong></p>
]]></content>
      <categories>
        <category>.NET</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Database</tag>
        <tag>EntityFramework</tag>
        <tag>Oracle</tag>
        <tag>SQL Server</tag>
        <tag>Visual Studio</tag>
      </tags>
  </entry>
  <entry>
    <title>OSMC的使用</title>
    <url>/2017/01/18/OSMC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>去年某宝上买了 Raspberry Pi 2B，期间玩过一段时间的Raspbian，没有买其他配件，全当练习使用linux了。最近盯上了 OSMC，所以，要搞事情！</p>
<a id="more"></a>
<h2 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h2><ul>
<li><p>Raspberry Pi 2B  </p>
<p>​<em>官方说支持全系列的Pi板子</em></p>
</li>
<li><p>32G SAMSUNG micro SDHC  </p>
<p><em>支持的SD卡可以去官方看支持列表，容量不低于8G</em></p>
</li>
<li><p>HDMI to HDMI 线</p>
<p>​<em>看需求吧，能把Pi连上电视就行</em></p>
</li>
<li><p>EDUP EP-N8508GS USB网卡</p>
<p>​<em>即插即用，支持802.11N。如果你的网线够长可以不用</em></p>
</li>
</ul>
<h2 id="刷系统"><a href="#刷系统" class="headerlink" title="刷系统"></a>刷系统</h2><p>传送门 <a href="https://osmc.tv/download/" target="_blank" rel="noopener">OSMC</a></p>
<p>你可以使用官方的安装器(支持Windows/Linux/OSX)，也可以下载镜像自己刷。</p>
<p>我选择下载镜像在win下刷入：</p>
<ul>
<li>准备<ul>
<li>SD卡 插入电脑</li>
<li>安装 <a href="https://www.sdcard.org/downloads/formatter_4/" target="_blank" rel="noopener">SD Card Formatter</a></li>
<li>安装 <a href="https://sourceforge.net/projects/win32diskimager/" target="_blank" rel="noopener">Win32 Disk Imager</a></li>
<li>解压下载的系统zip包</li>
</ul>
</li>
<li>操作<ul>
<li>使用 SDFormatter V4.0 格式化SD卡<ul>
<li>Drive 选中你的SD卡盘符</li>
<li>选项设置 -&gt; 逻辑大小调整 -&gt; 开启（ON）-&gt; OK -&gt; 格式化</li>
</ul>
</li>
<li>使用 Win32 Disk Imager V0.9.5 刷入系统<ul>
<li>Device 选中你的SD卡盘符</li>
<li>Image File 选中OSMC的img文件</li>
<li>选择 Write</li>
</ul>
</li>
<li>刷好SD卡插入Pi<ul>
<li>Pi 用视频线接电视，开电视，切换信号源到 HDMI</li>
<li>Pi 用microUSB接电源适配器</li>
<li>Pi 上接键盘</li>
</ul>
</li>
<li>开机配置系统……语言暂时用English(US)，联网</li>
</ul>
</li>
</ul>
<h2 id="软件配置"><a href="#软件配置" class="headerlink" title="软件配置"></a>软件配置</h2><ul>
<li><p>语言设置</p>
<p>Settings -&gt; Apperance -&gt; Skin -&gt; Fonts -&gt; Arial</p>
<p>Settings -&gt; Apperance -&gt; International -&gt; Language -&gt; Chinese(Simple)</p>
<p>现在就是显示中文了，下面还有些鸡肋的设置</p>
<p>设置 -&gt; 用户界面 -&gt; 字符集 -&gt; Chinese Simplified (GBK)</p>
<p>设置 -&gt; 用户界面 -&gt; 键盘布局 -&gt; 添加 Chinese BaiduPY</p>
</li>
<li><p>安装插件库</p>
<p><a href="http://dkmc.tv/2013/04/07/xbmc%E6%8F%92%E4%BB%B6%E5%BA%93%E6%B1%87%E6%80%BB/" target="_blank" rel="noopener">传送门</a></p>
<p>使用zip包的安装方式，先在同局域网的电脑上下载</p>
<p> <a href="https://github.com/taxigps/xbmc-addons-chinese/raw/master/repo/repository.xbmc-addons-chinese/repository.xbmc-addons-chinese-1.2.0.zip" target="_blank" rel="noopener">chinese addon</a> 、<a href="http://xbmc.hdpfans.com/repository.hdpfans.xbmc-addons.zip" target="_blank" rel="noopener">hdpfans</a></p>
<p>选择插件，选择安装，按Backspace到最外层，选择zip包安装插件，选择安装刚下的两个插件。</p>
</li>
<li><p>寻找你需要的插件，安装即可。</p>
</li>
</ul>
<h2 id="使用-app-控制"><a href="#使用-app-控制" class="headerlink" title="使用 app 控制"></a>使用 app 控制</h2><p><a href="http://kodi.wiki/view/Remote_controls" target="_blank" rel="noopener">Remote Control</a></p>
<ul>
<li>Android<ul>
<li><a href="http://mirrors.kodi.tv/tools/kore/releases/" target="_blank" rel="noopener">Kore</a> <em>官方软件</em></li>
<li><a href="http://yatse.tv/redmine/projects/yatse/wiki/XbmcStarter#Download-and-install-2" target="_blank" rel="noopener">Yatse</a> <em>功能一样，<a href="https://play.google.com/store/apps/details?id=tv.yatse.android.remotestarter" target="_blank" rel="noopener">Google Play</a>上售价0.99$</em></li>
</ul>
</li>
<li>iOS<ul>
<li><a href="https://itunes.apple.com/cn/app/official-kodi-remote/id520480364?mt=8" target="_blank" rel="noopener">Official Kodi Remote</a> <em>官方软件</em></li>
</ul>
</li>
<li>WP  <em>下面摘抄自kodi.wiki</em><ul>
<li><a href="https://www.microsoft.com/store/apps/9nblggh4qvkx" target="_blank" rel="noopener">mrRemote for Kodi</a> by Domenico Rescigno (free)</li>
<li><a href="http://www.windowsphone.com/s?appid=3897b459-b11b-41eb-9cea-dd9e53c55b78" target="_blank" rel="noopener">Kodi Assist</a> by akshay2000 (free)</li>
<li><a href="http://www.windowsphone.com/s?appid=3a35a8c6-bf35-49a1-b67b-f8104be2b05c" target="_blank" rel="noopener">xbmc remote free</a> by CRW Solutions (free)</li>
<li><a href="http://kodi.wiki/view/XBMC_Maestro" target="_blank" rel="noopener">XBMC Maestro</a> by 3Webers ($0.99 USD)</li>
<li><a href="http://www.windowsphone.com/s?appid=7cdb0b87-1e00-4328-b839-43a6bf9c8556" target="_blank" rel="noopener">Kodi Remote</a> by Fabien Lavocat (free)</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>闲扯</category>
      </categories>
      <tags>
        <tag>OSMC</tag>
      </tags>
  </entry>
  <entry>
    <title>重装Ubuntu的配置及折腾rEFInd</title>
    <url>/2017/01/17/%E9%87%8D%E8%A3%85Ubuntu%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%8A%98%E8%85%BErEFInd/</url>
    <content><![CDATA[<p>为什么突然会折腾这个？因为我格盘重装了系统，因为强迫症发作，以前装得win10竟然不是EFI+GPT……虽然装固态上，启动速度没有区别，但我就是要折腾……既然折腾完了，全部过程记录下，不愿看这么多，也可以直接跳到<a href="#refind">rEFInd的配置</a>。</p>
<a id="more"></a>
<h2 id="先安装win10"><a href="#先安装win10" class="headerlink" title="先安装win10"></a>先安装win10</h2><p>用<a href="https://www.microsoft.com/zh-cn/software-download/windows10" target="_blank" rel="noopener">官方工具</a>做一个安装盘，bios选择中启动方式<strong>EFI Only</strong>，并开启<strong>Secure Boot</strong> 。（<em>对，网上那些辣鸡教程都TM教你关掉，但是不告诉你原因，听我的，不用关，装ubuntu也不用关，因为ubuntu申请了EFI安全证书的！</em>）</p>
<p>接着开机插入U盘，按提示安装就好，记得把分区方式改成<strong>GPT</strong>。（<em>若你之前是MBR，要么把原来分区全删掉，要么按网上教程做个EFI+MBR，反正我是强迫症，我就要格盘！</em>）</p>
<p>如何辨别是不是EFI启动呢？</p>
<p>win + R ，输入 msinfo32 ，回车，引导方式那行是 EFI 就对了。</p>
<h2 id="再安装ubuntu16-04"><a href="#再安装ubuntu16-04" class="headerlink" title="再安装ubuntu16.04"></a>再安装ubuntu16.04</h2><p>这个更简单，把官方iso镜像文件，直接解压到<strong>FAT32</strong>格式U盘的根目录，开机，进U盘，安装。到那个然要现在win下切好未分配空间，这次我切了40G。小本子有8G内存，swap分区完全不用分的。在之前我试过所有未分配空间都挂到根目录，一样用着好好的，只有一点问题，只能挂起，不能休眠。</p>
<p>那么这次的分区方案是8G的swap，剩下全挂 / 根目录。 启动器挂在ubuntu所在硬盘，我是在第二快硬盘 /dev/sdb 上。</p>
<h2 id="ubuntu配置记录"><a href="#ubuntu配置记录" class="headerlink" title="ubuntu配置记录"></a>ubuntu配置记录</h2><p><strong>先要感谢<a href="https://plumz.me/" target="_blank" rel="noopener">plum的博客</a>，看他的博客让我解决的不少问题</strong></p>
<p>既然用了一段时间的ubuntu，解决了不少问题，这里的配置与上一篇有点不同，重新记录如下：</p>
<ul>
<li>修改本地文件夹名称为英文</li>
</ul>
<blockquote>
<p>如果你安装系统时选择了中文，那么用户目录就默认是中文，带你cd目录的时候就知道多蛋疼！</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export LANG=en_US</span><br><span class="line">xdg-user-dirs-gtk-update</span><br><span class="line">export LANG=zh_CN</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<ul>
<li>关闭鼠标加速</li>
</ul>
<blockquote>
<p>Ubuntu16.04默认开启了鼠标加速，用触控板到感觉不到，用鼠标这么飘就不能忍了！</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">在Dashboard里搜索:</span><br><span class="line">gnome-session-properties</span><br><span class="line">点击添加：</span><br><span class="line">名称：setmouse</span><br><span class="line">命令：xset m 0 或者 xset m default</span><br><span class="line">重启。</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 lantern </li>
</ul>
<p><em>接下来要安装软件了，我希望网络要没有阻碍，梯子是必须先装的！</em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/Downloads/</span><br><span class="line">wget https://raw.githubusercontent.com/getlantern/lantern-binaries/master/lantern-installer-beta-64-bit.deb</span><br><span class="line">sudo dpkg -i lantern-installer-beta-64-bit.deb</span><br></pre></td></tr></table></figure>
<p>打开lantern，进入设置，查看两个端口号，我的是：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">HTTP(S) proxy: 127.0.0.1:44045</span><br><span class="line">SOCKS proxy: 127.0.0.1:43355</span><br></pre></td></tr></table></figure>
<p>然后终端输入下面两句来全局代理</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export all_proxy=socks://127.0.0.1:43355</span><br><span class="line">export ALL_PROXY=socks://127.0.0.1:43355</span><br></pre></td></tr></table></figure>
<p>如果想取消掉的话：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">unset all_proxy</span><br><span class="line">unset ALL_PROXY</span><br></pre></td></tr></table></figure>
<p>接着配置 lantern 的开机无界面启动</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">在Dashboard里搜索:</span><br><span class="line">gnome-session-properties</span><br><span class="line">点击添加：</span><br><span class="line">名称：lantern</span><br><span class="line">命令：/usr/bin/lantern -headless</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 git</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install git -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 git 代理（http &amp; https 代理）</span></span><br><span class="line">git config --global http.proxy socks5://127.0.0.1:43355</span><br><span class="line">git config --global https.proxy socks5://127.0.0.1:43355</span><br></pre></td></tr></table></figure>
<ul>
<li>安装功耗控制 TLP</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install tlp tlp-rdw -y</span><br><span class="line">sudo apt-get install tp-smapi-dkms acpi-call-dkms -y</span><br><span class="line">sudo apt-get install thermald -y</span><br><span class="line">sudo apt-get install powertop -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置 TLP</span></span><br><span class="line">sudo vim /etc/default/tlp</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 TLP</span></span><br><span class="line">sudo tlp start</span><br></pre></td></tr></table></figure>
<ul>
<li>消除 Ubuntu LightDM 登陆界面背景白点</li>
</ul>
<blockquote>
<p>不能忍，影响我看锁屏壁纸！</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gsettings set com.canonical.unity-greeter draw-grid false</span><br><span class="line">sudo xhost +SI:localuser:lightdm</span><br><span class="line">sudo su lightdm -s /bin/bash</span><br><span class="line">gsettings set com.canonical.unity-greeter draw-grid false</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 arc-flatabulous 主题</li>
</ul>
<p><em><a href="https://github.com/andreisergiu98/arc-flatabulous-theme" target="_blank" rel="noopener">Arc-Flatabulous Theme</a></em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></span><br><span class="line">sudo apt install autoconf automake libgtk-3-dev -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装 unity-tweek-tool</span></span><br><span class="line">sudo apt install unity-tweak-tool -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 官方安装方式</span></span><br><span class="line">sudo rm -rf /usr/share/themes/&#123;Arc-Flatabulous,Arc-Flatabulous-Darker,Arc-Flatabulous-Dark&#125;</span><br><span class="line">rm -rf ~/.local/share/themes/&#123;Arc-Flatabulous,Arc-Flatabulous-Darker,Arc-Flatabulous-Dark&#125;</span><br><span class="line">rm -rf ~/.themes/&#123;Arc-Flatabulous,Arc-Flatabulous-Darker,Arc-Flatabulous-Dark&#125;</span><br><span class="line">git clone https://github.com/andreisergiu98/arc-flatabulous-theme &amp;&amp; cd arc-flatabulous-theme</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译安装，不想见透明效果，编译时加参数 --<span class="built_in">disable</span>-transparency</span></span><br><span class="line">./autogen.sh --prefix=/usr &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 papirus 图标主题</li>
</ul>
<p><em><a href="https://github.com/PapirusDevelopmentTeam/papirus-icon-theme" target="_blank" rel="noopener">papirus-icon-theme</a></em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install wget git libqt4-svg -y </span><br><span class="line">wget -qO- https://raw.githubusercontent.com/PapirusDevelopmentTeam/papirus-icon-theme/master/install-papirus-root.sh | sh</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 Hardcode-Tray 图标修复</li>
</ul>
<blockquote>
<p>对右上角那些图标风格不统一，可以试试，但是只支持部分图标修复，这个软件蛮鸡肋的……</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:andreas-angerer89/sni-qt-patched</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install sni-qt sni-qt:i386 hardcode-tray -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 Hardcode-Tray</span></span><br><span class="line">hardcode-tray --apply</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果出现 FileNotFoundError: [Errno 2] ，建一个软链接</span></span><br><span class="line">ln -s  /usr/share/icons/ ~/.local/share/icons</span><br><span class="line">hardcode-tray --apply</span><br></pre></td></tr></table></figure>
<ul>
<li>更改鼠标指针样式</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">下载 Breeze-Hacked 并解压</span><br><span class="line">cp -a Breeze-Hacked/ /usr/share/icons/</span><br><span class="line">在 unity-tweek-tool 里更换</span><br></pre></td></tr></table></figure>
<ul>
<li>使用terminator及ZSH</li>
</ul>
<p>普通用户</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install terminator zsh -y</span><br><span class="line">chsh -s /bin/zsh</span><br><span class="line">wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</span><br><span class="line">vim ~/.zshrc # 添加以下内容</span><br><span class="line"><span class="meta">#</span><span class="bash"> ZSH_THEME=<span class="string">"agnoster"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEFAULT_USER=<span class="string">"shank"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> COMPLETION_WAITING_DOTS=<span class="string">"true"</span></span></span><br></pre></td></tr></table></figure>
<p>root用户</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo su</span><br><span class="line">wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</span><br><span class="line">vim ~/.zshrc # 添加以下内容</span><br><span class="line"><span class="meta">#</span><span class="bash"> ZSH_THEME=<span class="string">"agnoster"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> DEFAULT_USER=<span class="string">"root"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> COMPLETION_WAITING_DOTS=<span class="string">"true"</span></span></span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
<p>安装PowerLine字体</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~/Downloads</span><br><span class="line">git clone https://github.com/powerline/fonts</span><br><span class="line">cd fonts</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>常规更新</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 Deluge</li>
</ul>
<p>下载工具，带有BT和磁链下载</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install deluge -y</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 caffeine</li>
</ul>
<p>用于暂时取消屏保和睡眠模式，用linux看视频时记得把它设为Active</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install caffeine -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 gnome-session-properties 开机启动中添加或修改Caffeine的命令为下面这句</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> /usr/bin/caffeine-indicator</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装 mpv</li>
</ul>
<blockquote>
<p>简介而强大的播放器，不用VLC因为它对字幕支持不好！</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install mpv -y</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 flash 支持</li>
</ul>
<blockquote>
<p>B站的Html5播放器总是没速度，所以flash还是必需的！</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">先在设置中允许 Canonical Partners 打包的应用</span></span><br><span class="line">sudo apt install adobe-flashplugin -y</span><br></pre></td></tr></table></figure>
<ul>
<li>解决待机后重启会自动断线的 Bug</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable NetworkManager.service</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 Canonical Livepatch Service</li>
</ul>
<p><em><a href="https://www.ubuntu.com/server/livepatch" target="_blank" rel="noopener">Canonical Livepatch Service</a> 免重新开机做核心</em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo snap install canonical-livepatch</span><br><span class="line">sudo canonical-livepatch enable XXX #XXX从官方获取</span><br></pre></td></tr></table></figure>
<ul>
<li>安装指纹识别支持</li>
</ul>
<blockquote>
<p>这个可以用，但是会觉得的有点烦，因为这个软件有个bug，刷指纹一定要刷两下，验证成功，还要再刷一下指纹灯才会灭，所以我已经不用了……</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:fingerprint/fprint -y &amp;&amp; sudo apt-get update</span><br><span class="line">sudo apt-get install libfprint0 fprint-demo libpam-fprintd gksu -y</span><br></pre></td></tr></table></figure>
<ul>
<li>Fcitx 输入法换回原生 indicator，不用那个 qim</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt remove fcitx-ui-qimpanel -y</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 android studio</li>
</ul>
<p><em><a href="https://developer.android.com/studio/index.html" target="_blank" rel="noopener">官方链接</a>下载zip安装包</em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 jdk</span></span><br><span class="line">sudo apt install openjdk-8-jdk -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></span><br><span class="line">sudo apt-get install lib32z1 lib32ncurses5 lib32stdc++6 -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决无 pixmap 问题</span></span><br><span class="line">sudo apt-get install gtk2-engines-pixbuf -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解决无 adwaita 问题</span></span><br><span class="line">sudo apt-get install gnome-themes-standard gnome-themes-standard-data -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装a.s.，我习惯把a.s.装到 /opt 目录</span></span><br><span class="line">sudo unzip -q ~/Downloads/android-studio……… -d /opt # 省略号部分自己按TAB替换</span><br><span class="line">cd /opt/android-studio/bin/</span><br><span class="line">./studio.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>Firefox 字体问题 （不用改了，新版本好像解决了这个问题）</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">地址栏输入 about:config</span><br><span class="line">找到 gfx.font_rendering.fontconfig.fontlist.enabled</span><br><span class="line">设置为 false</span><br></pre></td></tr></table></figure>
<ul>
<li>安装 typola ,本人最喜欢的 markdown 编辑器</li>
</ul>
<p><em><a href="https://typora.io/" target="_blank" rel="noopener">typola官方链接</a></em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> optional, but recommended</span></span><br><span class="line">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys BA300B7755AFCFAE</span><br><span class="line"><span class="meta">#</span><span class="bash"> add Typora<span class="string">'s repository</span></span></span><br><span class="line">sudo add-apt-repository 'deb https://typora.io ./linux/' -y</span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="meta">#</span><span class="bash"> install typora</span></span><br><span class="line">sudo apt-get install typora -y</span><br></pre></td></tr></table></figure>
<h2 id="rEFInd"><a href="#rEFInd" class="headerlink" title="rEFInd"></a>rEFInd</h2><p><em><a href="http://www.rodsbooks.com/refind/configfile.html" target="_blank" rel="noopener">rEFInd官方链接</a></em></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-add-repository ppa:rodsmith/refind -y </span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install refind -y</span><br><span class="line">sudo cd /boot/eft/EFI/refind</span><br><span class="line">sudo su</span><br><span class="line">mkdir themes</span><br><span class="line">cd themes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载新主题</span></span><br><span class="line">git clone https://github.com/EvanPurkhiser/rEFInd-minimal.git</span><br><span class="line">cd ..</span><br><span class="line">cp refind.conf refind.conf.bak</span><br><span class="line">gedit refind.conf</span><br></pre></td></tr></table></figure>
<p>添加设置到文件结尾，具体看配置文件或者Google</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">resolution 1920 1080</span><br><span class="line">scan_all_linux_kernels false</span><br><span class="line">default_selection Microsoft</span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入主题配置：</span></span><br><span class="line">include themes/rEFInd-minimal/theme.conf</span><br></pre></td></tr></table></figure>
<p>这个时候重启是使用不了rEFInd的，因为开了Secure Boot的缘故。那么要解决允许Secure Boot的问题，就要给他授权。官方提供的方案有 Shim 和 PreLoader，外文博客基本介绍的也是Shim。都比较麻烦，不愿看也不愿做（—。—），偶然发现了 boot-repair 。这个软件是傻瓜化修复启动引导用的，它解决安全引导的同时也会装 Shim，正好省得我动手。<br>先装 boot-repair</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:yannubuntu/boot-repair</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y boot-repair &amp;&amp; boot-repair</span><br></pre></td></tr></table></figure>
<p>选择推荐方案(Recommended repair)，接着都是“yes”<br>引导修复后，可以apt重装下refind，应该同时会申请 *.cer 文件<br>然后重启，和官方 Slim授权的方式一样，Select key选第一个，<br>给EFI/refind/key目录下的<strong>refind.cer</strong>和<strong>refind_local.cer</strong>文件授权，然后选择重启。</p>
<p>授权后的一些调整</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo su</span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除一个多余启动文件</span></span><br><span class="line">rm -f /boot/efi/EFI/Boot/bkpbootx64.efi</span><br><span class="line"><span class="meta">#</span><span class="bash"> 想要refind选择ubuntu就直接进系统，不用再显示grub2菜单</span></span><br><span class="line">vim /etc/default/grub # 修改 GRUB_TIMEOUT=0</span><br><span class="line">rm -f /etc/grub.d/30_os-prober # grub不记录win10引导</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更新gurb</span></span><br><span class="line">update-grub</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Ubuntu</tag>
        <tag>EFI</tag>
        <tag>rEFInd</tag>
      </tags>
  </entry>
  <entry>
    <title>从放弃Windows到使用IRC</title>
    <url>/2017/01/08/%E4%BB%8E%E6%94%BE%E5%BC%83Windows%E5%88%B0%E4%BD%BF%E7%94%A8IRC/</url>
    <content><![CDATA[<p>Windows 已经删了，最近都在 Ubuntu 上，不小心接触了IRC这个古老的东西，研究了一晚上，给破站加点新玩意。</p>
<a id="more"></a>
<p> 博客迁移后，聊天室已不存在。</p>
<blockquote>
<p>IRC（Internet Relay Chat的缩写，“因特网中继聊天”）是一种通过网络的即时聊天方式。</p>
</blockquote>
<p><a href="https://zh.wikipedia.org/wiki/IRC" target="_blank" rel="noopener">见Wiki</a></p>
<h2 id="讲故事"><a href="#讲故事" class="headerlink" title="讲故事"></a>讲故事</h2><ul>
<li><p>背景</p>
<p>准备好好适应使用linux来编程，趁着假期，打算完全不去碰windows，重新安装了双系统，这次仗着内存8G够用，swap分区就不要了，全部40G都挂到 / 目录上。</p>
</li>
<li><p>问题</p>
<p>觉得跟外界联系还是挺重要的，虽然QQ可以挂在手机上，但是用着linux要分享个链接什么的麻烦的要死，没法好好聊天啊。</p>
</li>
<li><p>Telegram</p>
<p>看别人用着Telegram好好的，可是到我想用时，GFW就让它失联了。而且为了找人聊天让别人在装个软件也麻烦。</p>
</li>
<li><p>IRC</p>
<p>第一次见IRC还是上次整越狱的老iTouch时，搜资料偶然发现了Kiwi IRC。正好是开源的，这次拿来练手。</p>
</li>
</ul>
<h2 id="说正事"><a href="#说正事" class="headerlink" title="说正事"></a>说正事</h2><p>其实安装过程官方给的太详细了，没什么好说的 (-_-|||</p>
<p>Kiwi的安装过程参考官方教程：</p>
<p><a href="https://kiwiirc.com/docs/installing" target="_blank" rel="noopener">传送门</a></p>
<p>务必先装好 openssl 和 openssl-dev | openssl-devel</p>
<p>参考另一款老牌IRC （UnrealIRCd）的安装，就可以理解配置文件的设置，下面推荐两个博客</p>
<p><a href="https://www.dadclab.com/archives/6007.jiecao" target="_blank" rel="noopener">博客1</a> <a href="http://soft.dog/2016/03/25/unrealircd-basic/" target="_blank" rel="noopener">博客2</a></p>
<h2 id="讲废话"><a href="#讲废话" class="headerlink" title="讲废话"></a>讲废话</h2><p>为什么我不用 UnrealIRCd 呢？因为只有一个服务端，客户端还要自己另外找。</p>
<p>Kiwi IRC 的易用在于，它把服务端和客户端整合了，在云主机上装好后，直接从端口进入客户端，直接连接另一端口的服务端。</p>
<p><del>去看看本站的聊天室吧： <a href="#missing">Chatting Room</a></del></p>
<blockquote>
<p>来自2018/10/29：“ 放弃 Windows… Steam on linux… 真香~ ”</p>
</blockquote>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>IRC</tag>
      </tags>
  </entry>
  <entry>
    <title>一点数据库笔记</title>
    <url>/2017/01/03/%E4%B8%80%E7%82%B9%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<blockquote>
<p>Markdown 是个好东西，用了一段时间，这次把自己一点数据库课的笔记放上来，练习下 Markdown 。</p>
</blockquote>
<a id="more"></a>
<h1 id="函数介绍"><a href="#函数介绍" class="headerlink" title="函数介绍"></a>函数介绍</h1><h2 id="数据语句"><a href="#数据语句" class="headerlink" title="数据语句"></a>数据语句</h2><ul>
<li>DECLARE <em>声明若干局部变量</em></li>
<li>SET <em>一个变量赋值</em></li>
<li>SELECT <em>多个变量赋值</em></li>
<li>PRINT <em>返回用户自定义信息</em></li>
</ul>
<h2 id="循环控制语句"><a href="#循环控制语句" class="headerlink" title="循环控制语句"></a>循环控制语句</h2><ul>
<li><p>BEGIN END <em>语句块</em></p>
</li>
<li><p>GOTO <em>跳转到标签</em></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">GOTO</span> <span class="keyword">skip</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student</span><br><span class="line"><span class="keyword">skip</span>:</span><br><span class="line">PRINT <span class="string">'hello'</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>IF ELSE <em>条件判断</em></p>
</li>
<li><p>CASE <em>多分支选择</em></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> score,</span><br><span class="line">(<span class="keyword">case</span></span><br><span class="line"><span class="keyword">when</span> score &gt; <span class="number">90</span> <span class="keyword">then</span> <span class="string">'excellent'</span></span><br><span class="line"><span class="keyword">when</span> score &gt; <span class="number">80</span> <span class="keyword">then</span> <span class="string">'good'</span></span><br><span class="line"><span class="keyword">when</span> score &gt; <span class="number">60</span> <span class="keyword">then</span> <span class="string">'ok'</span></span><br><span class="line"><span class="keyword">else</span> <span class="string">'not well'</span></span><br><span class="line"><span class="keyword">end</span>) <span class="keyword">as</span> rate</span><br><span class="line"><span class="keyword">from</span> student</span><br></pre></td></tr></table></figure>
</li>
<li><p>WHILE _循环_</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">while</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="comment">--code here</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>WAITFOR _暂停_</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">WAITFOR DELAY '11:00'</span><br><span class="line">WAITFOR TIME '01:00'</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><ul>
<li>AVG</li>
<li>COUNT</li>
<li>MAX</li>
<li>MIN</li>
<li>SUM</li>
<li>DISTINCT</li>
</ul>
<h2 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h2><ul>
<li>ABS <em>绝对值</em></li>
<li>ceiling <em>大于或等于</em></li>
<li>floor <em>小于或等于</em></li>
<li>rand <em>返回0-1的随机数</em></li>
<li>round <em>四舍五入到指定精度</em></li>
</ul>
<h2 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h2><ul>
<li>ascii <em>第一字符的ascii值</em></li>
<li>char <em>返回ascii对应字符</em></li>
<li>charindex <em>返回匹配位置</em></li>
<li>itrim <em>去除左空格</em></li>
<li>rtrim <em>去除右空格</em></li>
<li>left <em>截断左侧指定长度字符</em></li>
<li>right <em>截断右侧指定长度字符</em></li>
<li>len <em>返回长度</em></li>
<li>lower _小写_</li>
<li>upper _大写_</li>
<li>reverse _转置_</li>
<li>replace <em>指定字符替换</em></li>
<li>space <em>指定空格数</em></li>
<li>stuff <em>替换字符串的指定范围</em></li>
<li>substring <em>返回指定范围字符串</em></li>
</ul>
<h2 id="日期和时间函数"><a href="#日期和时间函数" class="headerlink" title="日期和时间函数"></a>日期和时间函数</h2><ul>
<li>dateadd <em>给指定日期添加一段时间</em></li>
<li>datediff <em>两日期相减</em></li>
<li>datename <em>返回指定日期的部分</em></li>
<li>day <em>指定日期的天数</em></li>
<li>dayofyear <em>年内天数</em></li>
<li>month <em>返回日期的月份</em></li>
<li>year <em>返回日期的年份</em></li>
<li>getdate <em>返回系统时间</em></li>
<li>datepart <em>返回指定部分整数</em></li>
<li>isDate <em>检测日期有效性</em></li>
</ul>
<h1 id="语句提升"><a href="#语句提升" class="headerlink" title="语句提升"></a>语句提升</h1><h2 id="约束与规则"><a href="#约束与规则" class="headerlink" title="约束与规则"></a>约束与规则</h2><h3 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h3><ol>
<li>规则只允许在当前数据库创建</li>
<li>规则不能绑定到数据类型 char、 int、 image、 text 中</li>
</ol>
<ul>
<li>创建规则</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> rule 规则名</span><br><span class="line"><span class="keyword">as</span> 规则</span><br><span class="line"><span class="comment">/* 规则可以是where语句任何有效的表达式 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>绑定规则</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> 数据库名</span><br><span class="line">exec sp_bindrule <span class="string">'规则名'</span>,<span class="string">'数据库表字段'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解绑规则</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> 数据库名</span><br><span class="line">exec sp_unbindrule <span class="string">'数据库表字段'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>删除规则</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> rule <span class="string">'规则名'</span></span><br></pre></td></tr></table></figure>
<h3 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h3><ul>
<li>添加check约束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名</span><br><span class="line"><span class="keyword">add</span> [<span class="keyword">constraint</span> 约束名] <span class="keyword">check</span>(约束)</span><br></pre></td></tr></table></figure>
<ul>
<li>删除check约束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">constraint</span> 约束名</span><br></pre></td></tr></table></figure>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ol>
<li>约束和表的定义联系，删除表的同时约束也删除。规则是单独存储的数据库对象，独立于表外，删除表时并不能删除规则。</li>
<li>一个字段可有多个约束，但只能有一个规则。</li>
</ol>
<h2 id="SELECT高级查询"><a href="#SELECT高级查询" class="headerlink" title="SELECT高级查询"></a>SELECT高级查询</h2><h3 id="IN-NULL"><a href="#IN-NULL" class="headerlink" title="IN, NULL"></a>IN, NULL</h3><ul>
<li>IN <em>查询符合列表中任何一个值的记录</em></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> score <span class="keyword">in</span> (<span class="number">70</span>,<span class="number">80</span>,<span class="number">90</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table2 <span class="keyword">where</span> score <span class="keyword">in</span> (<span class="keyword">select</span> score <span class="keyword">from</span> table1);</span><br></pre></td></tr></table></figure>
<ul>
<li>NULL | NOT NULL <em>字段是否为空</em></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> table1 <span class="keyword">where</span> items <span class="keyword">in</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<h3 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a>SELECT</h3><blockquote>
<p>用于将查询结果存储到另一个表</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> top <span class="number">5</span> *</span><br><span class="line"><span class="keyword">into</span> table3</span><br><span class="line"><span class="keyword">from</span> table2;</span><br></pre></td></tr></table></figure>
<h3 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a>GROUP BY</h3><blockquote>
<p>用于数据汇总</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select name,avg(age) as avg_age</span><br><span class="line">from student</span><br><span class="line">group by name;</span><br></pre></td></tr></table></figure>
<h2 id="嵌套查询"><a href="#嵌套查询" class="headerlink" title="嵌套查询"></a>嵌套查询</h2><ul>
<li>子查询作为新增列 <em>作为外层select语句的列值</em></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> avg_score = (</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(score)</span><br><span class="line">  <span class="keyword">from</span> score</span><br><span class="line">)<span class="keyword">from</span> score</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> score.id;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用IN关键字 <em>主要用于where子句后面的子查询。</em></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name</span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> a.id <span class="keyword">in</span>(</span><br><span class="line"><span class="keyword">select</span> b.id</span><br><span class="line">  <span class="keyword">from</span> score <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">where</span> b.score = <span class="number">80</span></span><br><span class="line">)<span class="keyword">order</span> <span class="keyword">by</span> a.id;</span><br></pre></td></tr></table></figure>
<ul>
<li>比较运算符</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name</span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> a.id <span class="keyword">in</span>(</span><br><span class="line"><span class="keyword">select</span> b.id</span><br><span class="line"><span class="keyword">from</span> score <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">where</span> b.score &lt;= <span class="number">80</span></span><br><span class="line">) <span class="keyword">order</span> <span class="keyword">by</span> a.id;</span><br></pre></td></tr></table></figure>
<ul>
<li>BETWEEN</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.name</span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> a.id <span class="keyword">in</span>(</span><br><span class="line"><span class="keyword">select</span> b.id </span><br><span class="line"><span class="keyword">from</span> score <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">where</span> b.score</span><br><span class="line"><span class="keyword">between</span> <span class="number">80</span> <span class="keyword">and</span> <span class="number">90</span></span><br><span class="line">) <span class="keyword">order</span> <span class="keyword">by</span> a.id;</span><br></pre></td></tr></table></figure>
<ul>
<li>EXISTS</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> table1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span>(</span><br><span class="line"><span class="keyword">select</span> score</span><br><span class="line"><span class="keyword">from</span> table1</span><br><span class="line"><span class="keyword">where</span> score = <span class="number">80</span>)</span><br><span class="line"><span class="comment">/* IN和EXISTS都代表的是子查询存在某个值，但是IN用的时候，子查询只能是一个字段，但是EXISTS可以用多个字段。 */</span></span><br></pre></td></tr></table></figure>
<h2 id="多表连接"><a href="#多表连接" class="headerlink" title="多表连接"></a>多表连接</h2><h3 id="JOIN…ON"><a href="#JOIN…ON" class="headerlink" title="JOIN…ON"></a>JOIN…ON</h3><h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><ul>
<li>表A</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">sex</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">AA</td>
<td style="text-align:center">12</td>
<td style="text-align:center">M</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">BB</td>
<td style="text-align:center">13</td>
<td style="text-align:center">F</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">CC</td>
<td style="text-align:center">24</td>
<td style="text-align:center">M</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">DD</td>
<td style="text-align:center">21</td>
<td style="text-align:center">F</td>
</tr>
</tbody>
</table>
<ul>
<li>表B</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">score</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">40</td>
</tr>
</tbody>
</table>
<h4 id="inner-join"><a href="#inner-join" class="headerlink" title="inner join"></a>inner join</h4><table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">sex</th>
<th style="text-align:center">snum</th>
<th style="text-align:center">score</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">AA</td>
<td style="text-align:center">12</td>
<td style="text-align:center">M</td>
<td style="text-align:center">1</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">BB</td>
<td style="text-align:center">13</td>
<td style="text-align:center">F</td>
<td style="text-align:center">2</td>
<td style="text-align:center">20</td>
</tr>
</tbody>
</table>
<h4 id="left-join"><a href="#left-join" class="headerlink" title="left join"></a>left join</h4><table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">sex</th>
<th style="text-align:center">snum</th>
<th style="text-align:center">score</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">AA</td>
<td style="text-align:center">12</td>
<td style="text-align:center">M</td>
<td style="text-align:center">1</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">BB</td>
<td style="text-align:center">13</td>
<td style="text-align:center">F</td>
<td style="text-align:center">2</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">CC</td>
<td style="text-align:center">24</td>
<td style="text-align:center">M</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">DD</td>
<td style="text-align:center">21</td>
<td style="text-align:center">F</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
</tr>
</tbody>
</table>
<h4 id="right-join"><a href="#right-join" class="headerlink" title="right join"></a>right join</h4><table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">score</th>
<th style="text-align:center">snum</th>
<th style="text-align:center">name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">sex</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">10</td>
<td style="text-align:center">1</td>
<td style="text-align:center">AA</td>
<td style="text-align:center">12</td>
<td style="text-align:center">M</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">20</td>
<td style="text-align:center">2</td>
<td style="text-align:center">BB</td>
<td style="text-align:center">13</td>
<td style="text-align:center">F</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">40</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
</tr>
</tbody>
</table>
<h4 id="full-join"><a href="#full-join" class="headerlink" title="full join"></a>full join</h4><table>
<thead>
<tr>
<th style="text-align:center">snum</th>
<th style="text-align:center">name</th>
<th style="text-align:center">age</th>
<th style="text-align:center">sex</th>
<th style="text-align:center">snum</th>
<th style="text-align:center">score</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">AA</td>
<td style="text-align:center">12</td>
<td style="text-align:center">M</td>
<td style="text-align:center">1</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">BB</td>
<td style="text-align:center">13</td>
<td style="text-align:center">F</td>
<td style="text-align:center">2</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">CC</td>
<td style="text-align:center">24</td>
<td style="text-align:center">M</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">DD</td>
<td style="text-align:center">21</td>
<td style="text-align:center">F</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
</tr>
<tr>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
<td style="text-align:center">null</td>
<td style="text-align:center">5</td>
<td style="text-align:center">40</td>
</tr>
</tbody>
</table>
<h3 id="UNION"><a href="#UNION" class="headerlink" title="UNION"></a>UNION</h3><blockquote>
<p>拼接字段相同的表</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> student <span class="keyword">as</span> b</span><br></pre></td></tr></table></figure>
<h3 id="数据操纵进阶"><a href="#数据操纵进阶" class="headerlink" title="数据操纵进阶"></a>数据操纵进阶</h3><h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><h3 id="插入多行"><a href="#插入多行" class="headerlink" title="插入多行"></a>插入多行</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table2</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">name</span>,sex,phone,email</span><br><span class="line"><span class="keyword">from</span> table2</span><br></pre></td></tr></table></figure>
<h3 id="select-…-into"><a href="#select-…-into" class="headerlink" title="select … into"></a>select … into</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> table1 <span class="keyword">from</span> table2</span><br></pre></td></tr></table></figure>
<h2 id="update"><a href="#update" class="headerlink" title="update"></a>update</h2><h3 id="基于级联"><a href="#基于级联" class="headerlink" title="基于级联"></a>基于级联</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> table1 <span class="keyword">set</span> table1.c = table2.c</span><br><span class="line"><span class="keyword">from</span> table1 <span class="keyword">inner</span> <span class="keyword">join</span> table2</span><br><span class="line"><span class="keyword">on</span> table1.a = table2.a</span><br><span class="line"><span class="keyword">where</span> table1.c <span class="keyword">is</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<h3 id="带有output"><a href="#带有output" class="headerlink" title="带有output"></a>带有output</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 查询新行的属性</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table1(a) <span class="keyword">output</span> inserted.a <span class="keyword">values</span>(<span class="string">'123'</span>)</span><br><span class="line"><span class="comment">-- 查询旧行的属性</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">into</span> table1 <span class="keyword">output</span> deleted.a <span class="keyword">where</span> a = <span class="string">'123'</span></span><br><span class="line"><span class="comment">-- 返回修改后的值</span></span><br><span class="line"><span class="keyword">update</span> table1 <span class="keyword">set</span> a = <span class="string">'b'</span> <span class="keyword">output</span> inserted.a <span class="keyword">where</span> a = <span class="string">'123'</span></span><br><span class="line"><span class="comment">-- 返回修改前的值</span></span><br><span class="line"><span class="keyword">update</span> table1 <span class="keyword">set</span> a = <span class="string">'b'</span> <span class="keyword">output</span> deleted.a wherer a = <span class="string">'123'</span></span><br></pre></td></tr></table></figure>
<h1 id="视图、索引、触发器"><a href="#视图、索引、触发器" class="headerlink" title="视图、索引、触发器"></a>视图、索引、触发器</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ul>
<li>创建视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> 视图名</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure>
<ul>
<li>视图结果集排序</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> stu1</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> top <span class="number">3</span> * <span class="keyword">from</span> table2</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span></span><br></pre></td></tr></table></figure>
<ul>
<li>多张表进行视图查询</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> stu2</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> b.score,b.name,a.name,sex,age</span><br><span class="line"><span class="keyword">from</span> student <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span></span><br><span class="line">score <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">on</span> a.id = b.id</span><br></pre></td></tr></table></figure>
<ul>
<li>修改视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">view</span> 视图名</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure>
<ul>
<li>删除视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> 视图名</span><br></pre></td></tr></table></figure>
<h3 id="增删改"><a href="#增删改" class="headerlink" title="增删改"></a>增删改</h3><ol>
<li>视图可以对基本表的数据进行查询，还可以向基本表增删改</li>
<li>select 子句不可用聚合函数</li>
<li>不能包含算式表达式结果的列</li>
<li>视图引用多表，无法使用delete</li>
</ol>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol>
<li>通过创建唯一索引，可以保证数据记录的唯一性。</li>
<li>可以大大加快数据检索速度。</li>
<li>可以加速表与表之间的连接，这一点在实现数据的参照完整性方面有特别的意义。</li>
<li>在使用order by和group by子句中进行检索数据时，可以显著减少查询中分组和排序的时间。</li>
<li>使用索引可以在检索数据的过程中使用优化隐藏，提高系统性能。</li>
</ol>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol>
<li>创建索引要花费时间和占用存储空间。</li>
<li>建立索引加快了数据检索速度，但是减慢了数据修改速度。</li>
</ol>
<h3 id="不应创建索引列的情况"><a href="#不应创建索引列的情况" class="headerlink" title="不应创建索引列的情况"></a>不应创建索引列的情况</h3><ol>
<li>很少或从来不在查询中引用的列，因为系统很少或从来不根据这个列的值去查找数据行。</li>
<li>只有两个或很少几个值的列，例如性别。</li>
<li>以bit、text、image数据类型定义的列。</li>
<li>数据行输很少的表一般也没有必要创建索引。</li>
</ol>
<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><h3 id="DML触发器"><a href="#DML触发器" class="headerlink" title="DML触发器"></a>DML触发器</h3><ul>
<li>after触发器 <em>记录改变后才激活触发器</em></li>
</ul>
<blockquote>
<p>after触发器包括 insert、delete、update触发器</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">after <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"><span class="comment">/* process */</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<ul>
<li>instead of 触发器 <em>直接执行触发器，不执行sql语句</em></li>
</ul>
<blockquote>
<p>instead of 触发器包括insert、delete、update触发器</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">instead of <span class="keyword">insert</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"><span class="comment">/* process */</span></span><br><span class="line">if @age &gt; 25</span><br><span class="line">print 'Too old!'</span><br><span class="line">else</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> score(<span class="keyword">name</span>,age) <span class="keyword">values</span>(@<span class="keyword">name</span>,@age)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">go</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Database</category>
      </categories>
      <tags>
        <tag>Database</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>iPod touch 上搭建开发环境</title>
    <url>/2017/01/01/iPod%20touch%20%E4%B8%8A%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>老touch在抽屉里躺了好几年，偶然把它翻出来，这么一个PDA，现在顶多用来听歌，怪可惜的，好像用它搞事情啊。</p>
<a id="more"></a>
<h1 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h1><p>闲来无事google了一下”iTouch c++”，发现一个大神的博客</p>
<p><a href="http://blog.csdn.net/jackjones86/article/details/41802515" target="_blank">博客传送门</a></p>
<p>这么详细的教程，妥妥的要动手试一试啊。</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>抄别人的没意思，自己又不愿写，毕竟大神写得太完整了！</p>
<p>虽然有些小问题，我就说说我碰到的问题:</p>
<ul>
<li><p>测试 nic 时，输入nic提示没有找到perl</p>
<p><em>解决：估计是版本升级后安装位置改了，为了不影响老的配置文件，直接建个软链接解决问题</em></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ln -s /usr/<span class="built_in">local</span>/bin/perl /usr/bin/</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试mysql时，我在设置里找半天没看到mysql</p>
<p><em>解决：原来博客未提到要装mysql，直接在cydia里搜索安装就好</em></p>
</li>
</ul>
<h1 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h1><p><img src="IMG_0001.png" alt="IMG_0001"></p>
<p><img src="IMG_0002.png" alt="IMG_0002"></p>
<p><img src="IMG_0003.png" alt="IMG_0003"></p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><ul>
<li>轻量级webserver</li>
</ul>
<p>话说在cydia里搜索”mysql”时，看到还有个搜索结果 “touch-lighttpd-php-mysql”，这个玩意有趣了，轻量级的webserver整合，有了它，可以在touch里搭个wordpress了，哈哈。<br>安装好插件，浏览器访问touch的ip，精简的”is works”页面……<br><img src="20170101133551.jpg" alt="20170101133551"></p>
<p>然后装wordpress我就不在这谈了，直接上结果<br><img src="20170101133908.jpg" alt="20170101133908"></p>
<p>但是装好的wordpress遇到点小问题，进入”仪表盘”会出现 服务器500 错误，这个貌似是内存不足，唉~touch的硬伤，写文章是没有问题的，所以不管了。</p>
<ul>
<li>apt 工具</li>
</ul>
<p>按照博客装了 apt 的插件后，装其他插件完全可以向用 linux 一样爽啊<br>但是同样遇到一个小问题，我使用 “sudo apt-get install XXX” 安装软件时，出现了 “segmentation fault 11…”<br>google了一番，解决方案是：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo rm -rf /var/cache/apt/*.bin</span><br></pre></td></tr></table></figure>
<p>再推荐大家装些常用插件，内容见另一篇的博客</p>
<p><a href="http://m.blog.csdn.net/article/details?id=50855627" target="_blank">博客传送门</a></p>
<h1 id="最后感谢-iOS-Jailbreak"><a href="#最后感谢-iOS-Jailbreak" class="headerlink" title="最后感谢 iOS Jailbreak"></a>最后感谢 iOS Jailbreak</h1><p><a href="https://www.reddit.com/r/jailbreak/" target="_blank">iOS Jailbreak</a></p>
]]></content>
      <categories>
        <category>闲扯</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>将UWP应用部署到其他win10设备</title>
    <url>/2016/12/20/%E5%B0%86UWP%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E5%88%B0%E5%85%B6%E4%BB%96win10%E8%AE%BE%E5%A4%87/</url>
    <content><![CDATA[<h2 id="What"><a href="#What" class="headerlink" title="What"></a>What</h2><p>老夫有台VenuePro8，系统是win10，所以想把它作为UWP测试机，一直不知道怎么把应用部署到平板上。</p>
<a id="more"></a>
<p>最近才发现，原来vs2015早就有这个功能了，下面来讲一讲具体的操作。</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><ul>
<li>首先在开发机上打开vs2015，打开项目</li>
<li>视线先切换到win10平板，cmd -&gt; ipconfig 默默记下它的ip，打开设置 -&gt; 更新和安全 -&gt; 针对开发者 -&gt; 打开“设备发现”<br><img src="4.png" alt="4"></li>
<li>接着出现一个配对按钮，点击。默默记下PIN码。<br><img src="5.png" alt="5"></li>
<li>视线切回开发机，右键vs菜单栏底部，勾上“标准”（默认那个是勾上的……）<br><img src="20161220121241.jpg" alt="20161220121241"></li>
<li>选择你需要的解决方案平台，然后部署设备切换到远程计算机<br><img src="snipaste20161220_115218.png" alt="snipaste20161220_115218"></li>
<li>输入平板的ip，再点击“选择”。<br><img src="snipaste20161220_115923.png" alt="snipaste20161220_115923"></li>
<li>Ctrl+F5，开始执行项目。</li>
<li>编译过程中会弹出对话框，要求输入另一台主机的PIN，输入上面的找到的PIN即可。<br> <img src="snipaste20161220_120059.png" alt="snipaste20161220_120059"></li>
<li>然后你的UWP项目就会在你的平板上安装了。(-_-||) 请无视我的low逼课程表UWP……<br> <img src="snipaste20161220_123214.png" alt="snipaste20161220_123214"></li>
</ul>
]]></content>
      <categories>
        <category>UWP</category>
      </categories>
      <tags>
        <tag>UWP</tag>
      </tags>
  </entry>
  <entry>
    <title>使用 Terminator &amp; ZSH的配置</title>
    <url>/2016/10/01/%E4%BD%BF%E7%94%A8%20Terminator%20%20&amp;%20ZSH%E7%9A%84%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p> 在别人博客里看到 Terminator 挺好用的，特别是和zsh搭配真是漂亮，这里总结下怎么弄吧。</p>
<a id="more"></a>
<h2 id="安装-Terminator"><a href="#安装-Terminator" class="headerlink" title="安装 Terminator"></a>安装 Terminator</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get install terminator</span><br></pre></td></tr></table></figure>
<ul>
<li><em>利用 Debian 的重新配置命令选择默认终端：</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo update-alternatives --config x-terminal-emulator</span><br></pre></td></tr></table></figure>
<ul>
<li><em>非ubuntu系统设置terminator快捷键</em></li>
</ul>
<p>Setting -&gt; Keyboard -&gt; Shortcuts -&gt; Custom Shortcuts -&gt; add(+)<br>Name : Terminal<br>Command : /usr/bin/terminator<br>Apply<br>Click “Disable”<br>press Ctrl + Alt + T</p>
<h2 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/* 打开Terminator ，进行如下操作 */</span><br><span class="line">Preferenvces -&gt; General</span><br><span class="line">Disable ‘Show titlebar’</span><br><span class="line">Preferenvces -&gt; Profiles -&gt; Colors -&gt; Foreground and Background -&gt; Build-in schemes</span><br><span class="line">Choose ‘Solarized dark’</span><br></pre></td></tr></table></figure>
<h2 id="安装zsh"><a href="#安装zsh" class="headerlink" title="安装zsh"></a>安装zsh</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo apt-get install zsh</span><br></pre></td></tr></table></figure>
<ul>
<li><em>设置当前用户使用zsh</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">chsh -s /bin/zsh</span><br></pre></td></tr></table></figure>
<h2 id="安装-on-my-zsh"><a href="#安装-on-my-zsh" class="headerlink" title="安装 on my zsh"></a>安装 on my zsh</h2><ul>
<li><em>自动安装：(推荐)</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</span><br></pre></td></tr></table></figure>
<ul>
<li><em>手动安装：</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh</span><br><span class="line">cp ~/.oh-my-zsh/templates/zshrc.zsh-template ~/.zshrc</span><br></pre></td></tr></table></figure>
<h2 id="安装powerline字体"><a href="#安装powerline字体" class="headerlink" title="安装powerline字体"></a>安装powerline字体</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/powerline/fonts</span><br><span class="line"><span class="built_in">cd</span> fonts</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure>
<p>然后在终端中使用powerline字体</p>
<h2 id="编辑：-zshrc"><a href="#编辑：-zshrc" class="headerlink" title="编辑： ~/.zshrc"></a>编辑： ~/.zshrc</h2><ul>
<li><em>增加自己的用户名：</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DEFAULT_USER=<span class="string">"Shank"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>PS：上面 Shank 替换成你当前的用户名，用whoami查看你的用户名</p>
</blockquote>
<ul>
<li><em>修改主题：</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ZSH_THEME=<span class="string">"agnoster"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><em>启用几个功能：</em></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">COMPLETION_WAITING_DOTS=<span class="string">"true"</span></span><br></pre></td></tr></table></figure>
<h3 id="或者用以下简单粗暴的方式屏蔽zsh中的用户名"><a href="#或者用以下简单粗暴的方式屏蔽zsh中的用户名" class="headerlink" title="或者用以下简单粗暴的方式屏蔽zsh中的用户名"></a>或者用以下简单粗暴的方式屏蔽zsh中的用户名</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.oh-my-zsh/themes</span><br><span class="line">sudo vim 当前主题名称</span><br></pre></td></tr></table></figure>
<p>找到最下面对<code>build_prompt</code>的定义，把<code>prompt_context</code>用<code>#</code>注释掉即可</p>
<blockquote>
<p>来自2018/10/29：“以前的自己 Markdown 写得这么烂还敢贴出来。”</p>
</blockquote>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Terminator</tag>
        <tag>ZSH</tag>
      </tags>
  </entry>
  <entry>
    <title>Thinkpad X250 安装ubuntu16.04.1LTS 的记录</title>
    <url>/2016/10/01/Thinkpad%20X250%20%E5%AE%89%E8%A3%85ubuntu16.04.1LTS%20%E7%9A%84%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>X250 上有两块硬盘，sda有win10，sdb一直坐为数据盘，打算安装一个ubuntu16.04.01LTS。<br>因为轻度使用所以sdb上切20G的分区给ubuntu，压缩卷后不需要新建分区。<br>U盘制作ubuntu安装盘，开机启动到U盘。</p>
<a id="more"></a>
<p>安装时，对空闲20G手动分区 ：</p>
<table>
<thead>
<tr>
<th style="text-align:left">分区类型</th>
<th style="text-align:left">挂载点</th>
<th style="text-align:left">大小</th>
<th style="text-align:left">位置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">主分区</td>
<td style="text-align:left">/boot</td>
<td style="text-align:left">400M</td>
<td style="text-align:left">起始</td>
</tr>
<tr>
<td style="text-align:left">逻辑区</td>
<td style="text-align:left">/</td>
<td style="text-align:left">15000M</td>
<td style="text-align:left">起始</td>
</tr>
<tr>
<td style="text-align:left">逻辑区</td>
<td style="text-align:left">swap</td>
<td style="text-align:left">512M</td>
<td style="text-align:left">末尾</td>
</tr>
<tr>
<td style="text-align:left">逻辑区</td>
<td style="text-align:left">/home</td>
<td style="text-align:left">剩余所有</td>
<td style="text-align:left">起始</td>
</tr>
</tbody>
</table>
<p>因为我不希望ubuntu覆盖我的windows引导，所以启动选择器 sdb<br>（因为内存有8G，交换空间就不分那么多了。启动选择在第二快盘，就不会覆盖win的引导，倒时开机bios改下硬盘启动顺序就行了。<br>我可能随时会把ubuntu的分区格掉，毕竟ssd空间有限，到时候不至于用easybcd或者PE重做引导）<br>安装完成后，重启。</p>
<p><strong>安装burg，美化开机选择界面：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:n-muench/burg &amp;&amp; sudo apt-get update</span><br><span class="line">sudo apt-get install burg burg-themes burg-emu</span><br></pre></td></tr></table></figure>
<p>安装过程可以一路回车，注意在Configuring burg-pc时选择sdb。<br>更换burg themes ，下载Lightness BURG Theme by SWOriginal<br>解压后cp到/boot/burg/themes里。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo update-burg</span><br><span class="line">gedit /boot/burg/burg.cfg</span><br></pre></td></tr></table></figure>
<p>删除一个recoverymode引导，提前win引导项<br>sudo burg-emu -&gt; F2 -&gt; 选择Lightness<br>(每次grub更新后都要重置burg sudo burg-install /dev/sdx )</p>
<p><strong>安装指纹识别fingerprint：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:fingerprint/fprint &amp;&amp; sudo apt-get update</span><br><span class="line">sudo apt-get install libfprint0 fprint-demo libpam-fprintd gksu</span><br></pre></td></tr></table></figure>
<p>在 “系统设置” -&gt; “用户账户” 里会多一个 “指纹登录”，照着提示进行设置就可以了。</p>
<p><strong>关闭鼠标加速：</strong><br>在Dashboard里搜索:<br>gnome-session-properties<br>点击添加：<br>名称：setmouse<br>命令：xset m 0 或者 xset m default<br>重启。</p>
<p><strong>安装TLP电源管理：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install tlp tlp-rdw</span><br><span class="line">sudo apt-get install tp-smapi-dkms acpi-call-dkms</span><br><span class="line">sudo apt-get install thermald</span><br><span class="line">sudo apt-get install powertop</span><br></pre></td></tr></table></figure>
<p>配置 TLP</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo vim /etc/default/tlp</span><br><span class="line">sudo tlp start</span><br></pre></td></tr></table></figure>
<p><strong>使用 terminator <a href="/2016/10/01/使用%20Terminator%20%20&amp;%20ZSH的配置/">替换默认终端以及使用zsh</a></strong> (另外写一篇介绍这个)</p>
<p><strong>安装Arc GTK主题：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo sh -c "echo 'deb http://download.opensuse.org/repositories/home:/Horst3180/xUbuntu_16.04/ /' &gt;&gt; /etc/apt/sources.list.d/arc-theme.list"</span><br><span class="line">wget http://download.opensuse.org/repositories/home:Horst3180/xUbuntu_16.04/Release.key</span><br><span class="line">sudo apt-key add - &lt; Release.key</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install arc-theme</span><br></pre></td></tr></table></figure>
<p>安装Unity Tweak Tool管理主题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt install unity-tweak-tool</span><br></pre></td></tr></table></figure>
<p>个人觉得Arc-darker 好看，更换之。</p>
<p><strong>安装Deadbeef，播放更多音频：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:starws-box/deadbeef-player</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install deadbeef</span><br></pre></td></tr></table></figure>
<p><strong>安装MPV播放器：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install mpv</span><br></pre></td></tr></table></figure>
<p><strong>安装cherrytree笔记本：</strong></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install cherrytree</span><br></pre></td></tr></table></figure>
<p><strong>安装lantern翻墙：</strong><br><a href="https://github.com/getlantern/forum/issues/833" target="_blank" rel="noopener">传送门</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Terminator</tag>
        <tag>ZSH</tag>
      </tags>
  </entry>
</search>
